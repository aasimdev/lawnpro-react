var CodeMirror;!function(){var i=[0],a="data"+(new Date).getTime(),o=function(t,e){return this.parse(t,e)},s=(o.ready=function(t){document.addEventListener("DOMContentLoaded",t)},o.prototype={get length(){return this.nodes.length},parse(t,e){var s;if(t){if(t instanceof o)return this.nodes=t.nodes,t;s=/^\s*<(\w+|!)[^>]*>/.test(t)?this.create(t):"string"!=typeof t?t.nodeType&&11===t.nodeType?t.childNodes:t.nodeType||this._isWindowNode(t)?[t]:t:this._query(t,e)}else s=[];this.nodes=this._slice(s)},create(t){if(/^<(\w+)\s*\/?>(?:<\/\1>|)$/.test(t))return[document.createElement(RegExp.$1)];var e=[],s=document.createElement("div");s.innerHTML=t;for(var i=0,a=s.childNodes.length;i<a;i++)e.push(s.childNodes[i]);return e},dataset(e,s){return this.each(function(t){i[this.dataindex(t.get())][e]=s})},dataget(t){return i[this.dataindex(this.get())][t]},dataindex(t){var e=t[a],s=i.length;return e||(e=s,t&&(t[a]=s),i[e]={}),e},add(t){return this.nodes=this.nodes.concat(this._array(t)),this},get(t){return this.nodes[t||0]||!1},getAll(){return this.nodes},eq(t){return new o(this.nodes[t])},first(){return new o(this.nodes[0])},last(){return new o(this.nodes[this.nodes.length-1])},contents(){return this.get().childNodes},each(t){for(var e=this.nodes.length,s=0;s<e;s++)t.call(this,new o(this.nodes[s]),s);return this},map(t){return this.nodes.map(t)},is(t){return 0<this.filter(t).length},filter(e){return void 0===e?this:new o(this.nodes.filter.call(this.nodes,"function"==typeof e?function(t){return e(new o(t))}:function(t){return e&&e.nodeType||e instanceof Node?e===t:(t.matches=t.matches||t.msMatchesSelector||t.webkitMatchesSelector,1===t.nodeType&&t.matches(e||"*"))}))},not(e){return this.filter(function(t){return!new o(t).is(e||!0)})},find(i){var a=[];return this.each(function(t){for(var t=t.get(),e=this._query(i,t),s=0;s<e.length;s++)a.push(e[s])}),new o(a)},children(t){var i=[];return this.each(function(t){t=t.get();if(t.children)for(var e=t.children,s=0;s<e.length;s++)i.push(e[s])}),new o(i).filter(t)},parent(t){var e=this.get(),e=e.parentNode||!1;return e?new o(e).filter(t):new o},parents(s,i){i=this._context(i);var a=[];return this.each(function(t){for(var e=t.get().parentNode;e&&e!==i;)s&&!new o(e).is(s)||a.push(e),e=e.parentNode}),new o(a)},closest(s,i){i=this._context(i),s="string"==typeof s?s:this._node(s);var a=[],r=s&&s.nodeType;return this.each(function(t){var e=t.get();do{if(e&&(r&&e===s||new o(e).is(s)))return a.push(e)}while((e=e.parentNode)&&e!==i)}),new o(a)},next(t){return this._sibling(t,"nextSibling")},nextElement(t){return this._sibling(t,"nextElementSibling")},prev(t){return this._sibling(t,"previousSibling")},prevElement(t){return this._sibling(t,"previousElementSibling")},css(a,r){var t;return void 0===r&&"object"!=typeof a?(t=this.get(),"width"===a||"height"===a?t.style?this._getHeightOrWidth(a)+"px":void 0:t.style?getComputedStyle(t,null)[a]:void 0):this.each(function(t){var e,s=t.get(),i={};for(e in"object"==typeof a?i=a:i[a]=r,i)s.style&&(s.style[e]=i[e])})},attr(a,r,o){var t;return o=o?"data-":"",void 0===r&&"object"!=typeof a?(t=this.get())&&3!==t.nodeType?"checked"===a?t.checked:this._boolean(t.getAttribute(o+a)):void 0:this.each(function(t){var e,s=t.get(),i={};for(e in"object"==typeof a?i=a:i[a]=r,i)3!==s.nodeType&&("checked"===e?s.checked=i[e]:s.setAttribute(o+e,i[e]))})},data(t,e){if(void 0!==t&&!0!==t)return this.attr(t,e,!0);function s(t){return t[1].toUpperCase()}var i,a,r,o=/^data-(.+)$/,n=this.get().attributes,l={};for(i in n)n[i]&&o.test(n[i].nodeName)&&(a=n[i].nodeName.match(o)[1],r=n[i].value,!0!==t&&(a=a.replace(/-([a-z])/g,s)),r=-1!==r.search(/^{/)?this._object(r):this._number(r)?parseFloat(r):this._boolean(r),l[a]=r);return l},val(e){var t;return void 0===e?(t=this.get()).type&&"checkbox"===t.type?t.checked:t.value:this.each(function(t){t=t.get();t.type&&"checkbox"===t.type?t.checked=e:t.value=e})},removeAttr(s){return this.each(function(t){var e=t.get();s.split(" ").forEach(function(t){3!==e.nodeType&&e.removeAttribute(t)})})},tagName(t){var e=this.get();return 3!==e.nodeType&&(e=e.tagName.toLowerCase(),void 0===t?e:t.toLowerCase()===e)},addClass(t){return this._eachClass(t,"add")},removeClass(t){return this._eachClass(t,"remove")},toggleClass(t){return this._eachClass(t,"toggle")},hasClass(t){var e=this.get();return!!t&&(t=t.split(" "),!!e.classList)&&e.matches("."+t.join("."))},empty(){return this.each(function(t){t.get().innerHTML=""})},html(t){return void 0===t?this.get().innerHTML||"":this.empty().append(t)},text(e){return void 0===e?this.get().textContent||"":this.each(function(t){t.get().textContent=e})},after(t){return this._inject(t,function(t,e){if("string"==typeof t)e.insertAdjacentHTML("afterend",t);else if(null!==e.parentNode)for(var s=t instanceof Node?[t]:this._array(t).reverse(),i=0;i<s.length;i++)e.parentNode.insertBefore(s[i],e.nextSibling);return e})},before(t){return this._inject(t,function(t,e){if("string"==typeof t)e.insertAdjacentHTML("beforebegin",t);else for(var s=t instanceof Node?[t]:this._array(t),i=0;i<s.length;i++)e.parentNode.insertBefore(s[i],e);return e})},append(t){return this._inject(t,function(t,e){if("string"==typeof t||"number"==typeof t)e.insertAdjacentHTML("beforeend",t);else for(var s=t instanceof Node?[t]:this._array(t),i=0;i<s.length;i++)e.appendChild(s[i]);return e})},prepend(t){return this._inject(t,function(t,e){if("string"==typeof t||"number"==typeof t)e.insertAdjacentHTML("afterbegin",t);else for(var s=t instanceof Node?[t]:this._array(t).reverse(),i=0;i<s.length;i++)e.insertBefore(s[i],e.firstChild);return e})},wrap(t){return this._inject(t,function(t,e){t="string"==typeof t||"number"==typeof t?this.create(t)[0]:t instanceof Node?t:this._array(t)[0];return e.parentNode&&e.parentNode.insertBefore(t,e),t.appendChild(e),t})},unwrap(){return this.each(function(t){for(var e=t.get(),s=document.createDocumentFragment();e.firstChild;){var i=e.removeChild(e.firstChild);s.appendChild(i)}e.parentNode&&e.parentNode.replaceChild(s,e)})},replaceWith(t){return this._inject(t,function(t,e){for(var s=document.createDocumentFragment(),i="string"==typeof t||"number"==typeof t?this.create(t):t instanceof Node?[t]:this._array(t),a=0;a<i.length;a++)s.appendChild(i[a]);t=s.childNodes[0];return e.parentNode&&e.parentNode.replaceChild(s,e),t})},remove(){return this.each(function(t){t=t.get();t.parentNode&&t.parentNode.removeChild(t)})},clone(s){var i=[];return this.each(function(t){var t=t.get(),e=this._clone(t);s&&(e=this._cloneEvents(t,e)),i.push(e)}),new o(i)},show(){return this.each(function(t){var e,t=t.get();t.style&&this._hasDisplayNone(t)&&(e=t.getAttribute("domTargetShow"),t.style.setProperty("display",e||"block","important"),t.removeAttribute("domTargetShow"))}.bind(this))},hide(){return this.each(function(t){var e,t=t.get();t.style&&!this._hasDisplayNone(t)&&("block"!==(e=t.style.display)&&t.setAttribute("domTargetShow",e),t.style.setProperty("display","none","important"))})},scrollTop(t){var e=this.get(),s=this._isWindowNode(e),i=9===e.nodeType?e.scrollingElement||e.body.parentNode||e.body||e.documentElement:e;if(void 0===t)return s?e.pageYOffset:i.scrollTop;t=parseInt(t),s?e.scrollTo(0,t):i.scrollTop=t},offset(){return this._getPos("offset")},position(){return this._getPos("position")},width(t){return void 0!==t?this.css("width",parseInt(t)+"px"):this._getSize("width","Width")},height(t){return void 0!==t?this.css("height",parseInt(t)+"px"):this._getSize("height","Height")},outerWidth(){return this._getSize("width","Width","outer")},outerHeight(){return this._getSize("height","Height","outer")},innerWidth(){return this._getSize("width","Width","inner")},innerHeight(){return this._getSize("height","Height","inner")},click(){return this._trigger("click")},focus(){return this._trigger("focus")},blur(){return this._trigger("blur")},on(o,n,l){return this.each(function(t){for(var e=t.get(),s=o.split(" "),i=0;i<s.length;i++){var a=this._getEventName(s[i]),r=this._getEventNamespace(s[i]);n=l?this._getOneHandler(n,o):n,e.addEventListener(a,n),e._e=e._e||{},e._e[r]=e._e[r]||{},e._e[r][a]=e._e[r][a]||[],e._e[r][a].push(n)}})},one(t,e){return this.on(t,e,!0)},off(o,n){function l(t,e,s){return t===s}function h(t,e,s,i){return e===i}function p(t,e,s,i){return t===s&&e===i}function e(){return!0}return void 0===o?this.each(function(t){this._offEvent(t.get(),!1,!1,n,e)}):this.each(function(t){for(var e=t.get(),s=o.split(" "),i=0;i<s.length;i++){var a=this._getEventName(s[i]),r=this._getEventNamespace(s[i]);"_events"===r?this._offEvent(e,a,r,n,l):a||"_events"===r?this._offEvent(e,a,r,n,p):this._offEvent(e,a,r,n,h)}})},serialize(t){for(var e={},s=this.get().elements,i=0;i<s.length;i++){var a=s[i];if((!/(checkbox|radio)/.test(a.type)||a.checked)&&(a.name&&!a.disabled&&"file"!==a.type)){if("select-multiple"===a.type)for(var r=0;r<a.options.length;r++){var o=a.options[r];o.selected&&(e[a.name]=o.value)}e[a.name]=this._number(a.value)?parseFloat(a.value):this._boolean(a.value)}}return t?e:this._params(e)},scroll(){this.get().scrollIntoView({behavior:"smooth"})},fadeIn(t,e){var s=this._anim(t,e,500);return this.each(function(t){t.css({display:"block",opacity:0,animation:"fadeIn "+s.speed+"s ease-in-out"}).removeClass("hidden"),t.one("animationend",function(){t.css({opacity:"",animation:""}),s.fn&&s.fn(t)})})},fadeOut(t,e){var s=this._anim(t,e,300);return this.each(function(t){t.css({opacity:1,animation:"fadeOut "+s.speed+"s ease-in-out"}),t.one("animationend",function(){t.css({display:"none",opacity:"",animation:""}),s.fn&&s.fn(t)})})},slideUp(t,e){var s=this._anim(t,e,300);return this.each(function(t){t.height(t.height()),t.css({overflow:"hidden",animation:"slideUp "+s.speed+"s ease-out"}),t.one("animationend",function(){t.css({display:"none",height:"",animation:""}),s.fn&&s.fn(t)})})},slideDown(t,e){var s=this._anim(t,e,400);return this.each(function(t){t.height(t.height()),t.css({display:"block",overflow:"hidden",animation:"slideDown "+s.speed+"s ease-in-out"}).removeClass("hidden"),t.one("animationend",function(){t.css({overflow:"",height:"",animation:""}),s.fn&&s.fn(t)})})},_queryContext(t,e){return 3!==(e=this._context(e)).nodeType&&"function"==typeof e.querySelectorAll?e.querySelectorAll(t):[]},_query(t,e){var s=document;return e?this._queryContext(t,e):/^[.#]?[\w-]*$/.test(t)?"#"===t[0]?(e=s.getElementById(t.slice(1)))?[e]:[]:"."===t[0]?s.getElementsByClassName(t.slice(1)):s.getElementsByTagName(t):s.querySelectorAll(t)},_context(t){return t?"string"==typeof t?document.querySelector(t):t:document},_sibling(s,i){var a,r=s&&s.nodeType;return this.each(function(t){var e=t.get();do{if((e=e[i])&&(r&&e===s||new o(e).is(s)))return void(a=e)}while(e)}),new o(a)},_slice(t){return t&&0!==t.length?t.length?[].slice.call(t.nodes||t):[t]:[]},_array(t){return void 0===t?[]:t instanceof NodeList?Array.from(t):t instanceof o?t.nodes:t},_object(t){t=t.replace(/(\w+:)|(\w+ :)/g,function(t){return'"'+t.substring(0,t.length-1)+'":'});return JSON.parse(t)},_params(e){var s="";return Object.keys(e).forEach(function(t){s+="&"+this._encodeUri(t)+"="+this._encodeUri(e[t])}.bind(this)),s.replace(/^&/,"")},_boolean(t){return"true"===t||"false"!==t&&t},_number(t){return!isNaN(t)&&!isNaN(parseFloat(t))},_inject(t,e){for(var s=this.nodes.length,i=[];s--;){var a="function"==typeof t?t.call(this,this.nodes[s]):t,a=0===s?a:this._clone(a),a=e.call(this,a,this.nodes[s]);a&&(a.dom?i.push(a.get()):i.push(a))}return new o(i)},_clone(t){if(void 0!==t)return"string"==typeof t?t:t instanceof Node||t.nodeType?t.cloneNode(!0):"length"in t?[].map.call(this._array(t),function(t){return t.cloneNode(!0)}):void 0},_cloneEvents(t,e){var s=t._e;if(s)for(var i in(e._e=s)._events)if(s._events.hasOwnProperty(i))for(var a=0;a<s._events[i].length;a++)e.addEventListener(i,s._events[i][a]);return e},_trigger(t){var e=this.get();return e&&3!==e.nodeType&&e[t](),this},_encodeUri(t){return encodeURIComponent(t).replace(/!/g,"%21").replace(/'/g,"%27").replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/\*/g,"%2A").replace(/%20/g,"+")},_getSize(t,e){var s=this.get(),i=0,i=3===s.nodeType?0:9===s.nodeType?this._getDocSize(s,e):this._isWindowNode(s)?window["inner"+e]:this._getHeightOrWidth(t);return Math.round(i)},_getDocSize(t,e){var s=t.body,t=t.documentElement;return Math.max(s["scroll"+e],s["offset"+e],t["client"+e],t["scroll"+e],t["offset"+e])},_getPos(t){var e,s=this.get(),i={top:0,left:0};return 3===s.nodeType||this._isWindowNode(s)||9===s.nodeType?i:"position"===t?{top:s.offsetTop,left:s.offsetLeft}:"offset"===t?(t=s.getBoundingClientRect(),e=(s=s.ownerDocument).documentElement,s=s.defaultView,{top:t.top+s.pageYOffset-e.clientTop,left:t.left+s.pageXOffset-e.clientLeft}):i},_getHeightOrWidth(t,e){var s,i,t=t.charAt(0).toUpperCase()+t.slice(1),e=e||"offset",a=0,r=this.get(),o=getComputedStyle(r,null),n=this.parents().filter(function(t){t=t.get();return 1===t.nodeType&&"none"===getComputedStyle(t,null).display&&t});return"none"===o.display&&n.add(r),0!==n.length?(s="visibility: hidden !important; display: block !important;",i=[],n.each(function(t){var e=t.attr("style");null!==e&&i.push(e),t.attr("style",null!==e?e+";"+s:s)}),a=r[e+t],n.each(function(t,e){void 0===i[e]?t.removeAttr("style"):t.attr("style",i[e])})):a=r[e+t],a},_eachClass(s,i){return this.each(function(t){var e;s&&(e=t.get(),s.split(" ").forEach(function(t){e.classList&&e.classList[i](t)}))})},_getOneHandler(t,e){var s=this;return function(){t.apply(this,arguments),s.off(e)}},_getEventNamespace(t){var t=t.split("."),e=t[1]||"_events";return t[2]?e+t[2]:e},_getEventName(t){return t.split(".")[0]},_offEvent(t,e,s,i,a){for(var r in t._e)if(t._e.hasOwnProperty(r))for(var o in t._e[r])if(a(o,r,e,s))for(var n=t._e[r][o],l=0;l<n.length;l++)void 0!==i&&n[l].toString()!==i.toString()||(t.removeEventListener(o,n[l]),t._e[r][o].splice(l,1),0===t._e[r][o].length&&delete t._e[r][o],0===Object.keys(t._e[r]).length&&delete t._e[r])},_hasDisplayNone(t){return"none"===t.style.display||"none"===(t.currentStyle||getComputedStyle(t,null)).display},_anim(t,e,s){return t="function"==typeof t?(e=t,s):t||s,{fn:e,speed:t/1e3}},_isWindowNode(t){return t===window||t.parent&&t.parent===window},_node(t){return new o(t).get()}},{}),r=(s.settings={},s.post=function(t){return new r("post",t)},s.get=function(t){return new r("get",t)},s.request=function(t,e){return new r(t,e)},function(t,e){this.p=this.extend({method:t,url:"",before(){},success(){},error(){},data:!1,async:!0,headers:{}},e),this.p=this.extend(this.p,s.settings),this.p.method=this.p.method.toUpperCase(),this.prepareData(),this.xhr=new XMLHttpRequest,this.xhr.open(this.p.method,this.p.url,this.p.async),this.setHeaders(),!1!==("function"!=typeof this.p.before||this.p.before(this.xhr))&&this.send()});r.prototype={extend(e,s){return s&&Object.keys(s).forEach(function(t){e[t]=s[t]}),e},prepareData(){var t;-1===["POST","PUT"].indexOf(this.p.method)||this.isFormData()||(this.p.headers["Content-Type"]="application/x-www-form-urlencoded"),"object"!=typeof this.p.data||this.isFormData()||(this.p.data=this.toParams(this.p.data)),"GET"===this.p.method&&(t=-1!==this.p.url.search(/\?/)?"&":"?",this.p.url=this.p.data?this.p.url+t+this.p.data:this.p.url)},setHeaders(){this.xhr.setRequestHeader("X-Requested-With",this.p.headers["X-Requested-With"]||"XMLHttpRequest"),Object.keys(this.p.headers).forEach(function(t){this.xhr.setRequestHeader(t,this.p.headers[t])}.bind(this))},isFormData(){return void 0!==window.FormData&&this.p.data instanceof window.FormData},isComplete(){return!(this.xhr.status<200||300<=this.xhr.status&&304!==this.xhr.status)},send(){this.p.async?(this.xhr.onload=this.loaded.bind(this),this.xhr.send(this.p.data)):(this.xhr.send(this.p.data),this.loaded.call(this))},loaded(){var t;this.isComplete()?(t=this.parseResponse(),"function"==typeof this.p.success&&this.p.success(t,this.xhr)):(t=this.parseResponse(),"function"==typeof this.p.error&&this.p.error(t,this.xhr,this.xhr.status))},parseResponse(){var t=this.xhr.response,e=this.parseJson(t);return e||t},parseJson(t){try{var e=JSON.parse(t);if(e&&"object"==typeof e)return e}catch(t){}return!1},toParams(e){return Object.keys(e).map(function(t){return encodeURIComponent(t)+"="+encodeURIComponent(e[t])}).join("&")}};let n=0,d=function(s,i){{var a=i;let t=new o(s),e;return t.each(function(t){(e=t.dataget(d.namespace))||(e=new l(t,a,n),t.dataset(d.namespace,e),d.instances[n]=e,n++)}),1<t.length?d.instances:e}},l=(d.dom=function(t,e){return new o(t,e)},d.ajax=s,d.mapping={},d._mixins={},d.instances=[],d.namespace="redactor",d.version="4.2.0",d.settings={},d.lang={},d.triggers={},d.customTags=[],d.keycodes={BACKSPACE:8,DELETE:46,UP:38,DOWN:40,ENTER:13,SPACE:32,ESC:27,TAB:9,CTRL:17,META:91,SHIFT:16,ALT:18,RIGHT:39,LEFT:37},d.add=function(t,e,s){var i;if(s.translations&&(d.lang=d.extend(!0,d.lang,s.translations)),"block"!==t&&s.defaults&&((i={})[e]=s.defaults,d.opts=d.extend(!0,d.opts,i)),"block"===t&&s.props.custom&&d.customTags.push(s.props.custom),s.nested&&(d.opts.nested.push(e),d.opts.nestedValue.push(s.nested)),void 0!==s.parser&&!1===s.parser&&d.opts.nonparse.push(e),s.triggers&&(d.triggers=d.extend(!0,d.triggers,s.triggers)),"mixin"===t)d._mixins[e]=s;else{function a(){}if((a.prototype=s).mixins)for(let t=0;t<s.mixins.length;t++)d.inherit(a,d._mixins[s.mixins[t]]);void 0===d.mapping[t]&&(d.mapping[t]={}),d.mapping[t][e]={type:t,proto:a,obj:s}}},d.error=function(t){throw t},d.message=function(t){console.log(t)},d.addLang=function(t,e){"object"==typeof t?d.lang=d.extend(!0,{},d.lang,t):(void 0===d.lang[t]&&(d.lang[t]={}),d.lang[t]=d.extend(!0,d.lang[t],e))},d.extend=function(){let e={},s=!1,t=0,i,a,r=arguments.length;for("[object Boolean]"===Object.prototype.toString.call(arguments[0])&&(s=arguments[0],t++),a=function(t){for(i in t)Object.prototype.hasOwnProperty.call(t,i)&&(t[i]&&!0===t[i].set&&(e[i]={}),s&&"[object Object]"===Object.prototype.toString.call(t[i])?e[i]=d.extend(!0,e[i],t[i]):e[i]=t[i],void 0!==e[i])&&delete e[i].set};t<r;t++)a(arguments[t]);return e},d.inherit=function(t,e){function s(){}s.prototype=e;var i,a=new s;for(i in t.prototype)t.prototype.__lookupGetter__(i)?a.__defineGetter__(i,t.prototype.__lookupGetter__(i)):a[i]=t.prototype[i];return t.prototype=a,t.prototype.super=e,t},d.opts={plugins:[],focus:!1,tabindex:!1,content:!1,data:!1,output:!1,css:!1,cssFile:"redactor.min.css",frame:{lang:!1,dir:!1},doctype:"<!doctype html>",csscache:!1,custom:{css:!1,js:!1},lang:"en",breakline:!1,markup:"p",command:!0,nocontainer:!1,nostyle:!1,https:!1,clicktoedit:!1,theme:"auto",placeholder:!1,readonly:!1,disabled:!1,dataBlock:"data-block",classname:"rx-content",dir:"ltr",reloadmarker:!0,addPosition:"top",spellcheck:!0,grammarly:!1,notranslate:!1,width:"100%",padding:"20px 28px",minHeight:"72px",maxHeight:!1,classes:!1,templateSyntax:!1,source:!0,enterKey:!0,drop:!0,draggable:!1,reorder:!0,scrollTarget:!1,scrollOverflow:!1,sync:!0,codemirror:!1,codemirrorSrc:!1,ai:!1,bsmodal:!1,paragraphize:!0,block:{outline:!0},colorpicker:{size:!1,wrap:!1,row:!1,width:!1},container:{border:!0},state:{limit:200},autosave:{url:!1,name:!1,data:!1,method:"post"},toolbar:{raised:!1,target:!1,sharedTarget:!1,sticky:!0,stickyMinHeight:200,stickyTopOffset:0},statusbar:{target:!1},pathbar:!1,control:!0,context:!1,clean:{comments:!1,enter:!0,enterinline:!0},tab:{key:!0,spaces:!1},format:!0,addbar:!0,extrabar:!0,addbarItems:{},inlineItems:{},formatItems:{},replaceTags:!1,buttons:{toolbar:["add","ai-tools","html","format","bold","italic","deleted","moreinline","list","link","image","table"],extrabar:["hotkeys"],control:["toggle"],context:["ai-tools","format","bold","italic","deleted","moreinline","link"],icons:!1},popups:{format:["text","h1","h2","h3","h4","quote","bulletlist","numberedlist","todo"],control:["add","move-up","move-down","duplicate","trash"],addbar:["ai-tools","ai-image","text","heading","image","todo","list","embed","table","quote","pre","line","layout","wrapper"],inline:["code","underline","sup","sub","highlight","removeinline"]},active:{tags:{b:["bold"],strong:["bold"],i:["italic"],em:["italic"],del:["deleted"],u:["underline"],a:["link"],code:["code"],mark:["mark"],sub:["subscript"],sup:["superscript"],h1:["h1"],h2:["h2"],h3:["h3"],h4:["h4"],h5:["h5"],h6:["h6"],ul:["bulletlist"],ol:["numberedlist"]},blocks:{listitem:["list"],list:["list"],pre:["pre"],table:["table"],cell:["table"],image:["image"],embed:["embed"],layout:["layout"],wrapper:["wrapper"],todo:["todo"],text:["text"],quote:["quote"]}},paste:{clean:!0,autoparse:!0,paragraphize:!0,plaintext:!1,linkTarget:!1,images:!0,links:!0,keepIdAttr:!1,keepNameAttr:!1,keepClass:[],keepStyle:[],keepAttrs:["td","th"],formTags:["form","input","button","select","textarea","legend","fieldset"],blockTags:["pre","h1","h2","h3","h4","h5","h6","table","tbody","thead","tfoot","th","tr","td","ul","ol","li","dl","dt","dd","blockquote","p","hr","figure","iframe","figcaption","address"],inlineTags:["a","svg","img","br","strong","ins","code","del","span","samp","kbd","sup","sub","mark","var","cite","small","b","u","em","i","abbr"]},link:{create:!1,edit:!1,truncate:24},image:{create:!1,edit:!1,states:!0,upload:!1,url:!0,select:!1,selectMethod:"get",name:"file",data:!1,drop:!0,multiple:!0,clipboard:!0,types:["image/*"],tag:"figure",newtab:!1,link:!0,width:!1},layout:{grid:!1,column:!1},layouts:{single:{title:"## layout.single-column ##",pattern:"100%"},"two-columns":{title:"## layout.two-columns ##",pattern:"50%|50%"},"three-columns":{title:"## layout.three-columns ##",pattern:"33%|33%|33%"},"four-columns":{title:"## layout.four-columns ##",pattern:"25%|25%|25%|25%"},"60-40":{title:"60/40",pattern:"60%|40%"},"40-60":{title:"40/60",pattern:"40%|60%"}},wrapper:{template:"<div></div>"},figcaption:{template:"<figcaption></figcaption>"},line:{template:"<hr>"},noneditable:{remove:!0,select:!0},pre:{template:"<pre></pre>",spaces:4},table:{template:"<table><tr><td></td><td></td></tr><tr><td></td><td></td></tr></table>",nowrap:"nowrap"},todo:{templateItem:"[ ]",templateItemDone:"[x]",templateInput:'<input type="checkbox">',templateContent:"<div></div>",template:!1},quote:{template:'<blockquote><p data-placeholder="Quote..."></p><p><cite data-placeholder="Attribution"></cite></p></blockquote>'},embed:{classname:"embed-content",responsive:!1,responsiveClassname:"embed-responsive",script:!0},outset:{none:"none",left:"outset-left",both:"outset-both",right:"outset-right"},wrap:{none:"none",left:"float-left",center:"wrap-center",right:"float-right"},colors:{base:["#000000","#ffffff"],gray:["#212529","#343a40","#495057","#868e96","#adb5bd","#ced4da","#dee2e6","#e9ecef","#f1f3f5","#f8f9fa"],red:["#c92a2a","#e03131","#f03e3e","#fa5252","#ff6b6b","#ff8787","#ffa8a8","#ffc9c9","#ffe3e3","#fff5f5"],pink:["#a61e4d","#c2255c","#d6336c","#e64980","#f06595","#f783ac","#faa2c1","#fcc2d7","#ffdeeb","#fff0f6"],grape:["#862e9c","#9c36b5","#ae3ec9","#be4bdb","#cc5de8","#da77f2","#e599f7","#eebefa","#f3d9fa","#f8f0fc"],violet:["#5f3dc4","#6741d9","#7048e8","#7950f2","#845ef7","#9775fa","#b197fc","#d0bfff","#e5dbff","#f3f0ff"],indigo:["#364fc7","#3b5bdb","#4263eb","#4c6ef5","#5c7cfa","#748ffc","#91a7ff","#bac8ff","#dbe4ff","#edf2ff"],blue:["#1864ab","#1971c2","#1c7ed6","#228be6","#339af0","#4dabf7","#74c0fc","#a5d8ff","#d0ebff","#e7f5ff"],cyan:["#0b7285","#0c8599","#1098ad","#15aabf","#22b8cf","#3bc9db","#66d9e8","#99e9f2","#c5f6fa","#e3fafc"],teal:["#087f5b","#099268","#0ca678","#12b886","#20c997","#38d9a9","#63e6be","#96f2d7","#c3fae8","#e6fcf5"],green:["#2b8a3e","#2f9e44","#37b24d","#40c057","#51cf66","#69db7c","#8ce99a","#b2f2bb","#d3f9d8","#ebfbee"],lime:["#5c940d","#66a80f","#74b816","#82c91e","#94d82d","#a9e34b","#c0eb75","#d8f5a2","#e9fac8","#f4fce3"],yellow:["#e67700","#f08c00","#f59f00","#fab005","#fcc419","#ffd43b","#ffe066","#ffec99","#fff3bf","#fff9db"],orange:["#d9480f","#e8590c","#f76707","#fd7e14","#ff922b","#ffa94d","#ffc078","#ffd8a8","#ffe8cc","#fff4e6"]},hotkeysAdd:!1,hotkeysRemove:!1,hotkeysBase:{"meta+z":"## hotkeys.meta-z ##","meta+shift+z":"## hotkeys.meta-shift-z ##","meta+a":"## hotkeys.meta-a ##","meta+shift+a":"## hotkeys.meta-shift-a ##"},hotkeys:{"ctrl+shift+o, meta+shift+o":{title:"## hotkeys.meta-shift-o ##",name:"meta+shift+o",command:"addbar.popup"},"ctrl+shift+d, meta+shift+d":{title:"## hotkeys.meta-shift-d ##",name:"meta+shift+d",command:"block.duplicate"},"ctrl+shift+up, meta+shift+up":{title:"## hotkeys.meta-shift-up ##",name:"meta+shift+&uarr;",command:"block.moveUp"},"ctrl+shift+down, meta+shift+down":{title:"## hotkeys.meta-shift-down ##",name:"meta+shift+&darr;",command:"block.moveDown"},"ctrl+shift+m, meta+shift+m":{title:"## hotkeys.meta-shift-m ##",name:"meta+shift+m",command:"inline.removeFormat"},"ctrl+b, meta+b":{title:"## hotkeys.meta-b ##",name:"meta+b",command:"inline.set",params:{tag:"b"}},"ctrl+i, meta+i":{title:"## hotkeys.meta-i ##",name:"meta+i",command:"inline.set",params:{tag:"i"}},"ctrl+u, meta+u":{title:"## hotkeys.meta-u ##",name:"meta+u",command:"inline.set",params:{tag:"u"}},"ctrl+h, meta+h":{title:"## hotkeys.meta-h ##",name:"meta+h",command:"inline.set",params:{tag:"sup"}},"ctrl+l, meta+l":{title:"## hotkeys.meta-l ##",name:"meta+l",command:"inline.set",params:{tag:"sub"}},"ctrl+alt+0, meta+alt+0":{title:"## hotkeys.meta-alt-0 ##",name:"meta+alt+0",command:"format.set",params:{tag:"p"}},"ctrl+alt+1, meta+alt+1":{title:"## hotkeys.meta-alt-1 ##",name:"meta+alt+1",command:"format.set",params:{tag:"h1"}},"ctrl+alt+2, meta+alt+2":{title:"## hotkeys.meta-alt-2 ##",name:"meta+alt+2",command:"format.set",params:{tag:"h2"}},"ctrl+alt+3, meta+alt+3":{title:"## hotkeys.meta-alt-3 ##",name:"meta+alt+3",command:"format.set",params:{tag:"h3"}},"ctrl+alt+4, meta+alt+4":{title:"## hotkeys.meta-alt-4 ##",name:"meta+alt+4",command:"format.set",params:{tag:"h4"}},"ctrl+alt+5, meta+alt+5":{title:"## hotkeys.meta-alt-5 ##",name:"meta+alt+5",command:"format.set",params:{tag:"h5"}},"ctrl+alt+6, meta+alt+6":{title:"## hotkeys.meta-alt-6 ##",name:"meta+alt+6",command:"format.set",params:{tag:"h6"}},"ctrl+shift+7, meta+shift+7":{title:"## hotkeys.meta-shift-7 ##",name:"meta+shift+7",command:"format.set",params:{tag:"ol"}},"ctrl+shift+8, meta+shift+8":{title:"## hotkeys.meta-shift-8 ##",name:"meta+shift+8",command:"format.set",params:{tag:"ul"}},"ctrl+], meta+]":{title:"## hotkeys.meta-indent ##",name:"meta+]",command:"list.indent"},"ctrl+[, meta+[":{title:"## hotkeys.meta-outdent ##",name:"meta+[",command:"list.outdent"},"ctrl+k, meta+k":{title:"## hotkeys.meta-k ##",name:"meta+k",command:"link.popup"}},markerChar:"\ufeff",containers:{main:["toolbox","editor","source","preview","statusbar"],toolbox:["pathbar","toolbar"]},modes:{nocontainer:{toolbar:!1,extrabar:!1,pathbar:!1,padding:"0"}},buttonsObj:{"ai-tools":{title:"## buttons.ai-tools ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M18 3C18.5523 3 19 3.44772 19 4C19 4.26522 19.1054 4.51957 19.2929 4.70711C19.4804 4.89464 19.7348 5 20 5C20.5523 5 21 5.44772 21 6C21 6.55228 20.5523 7 20 7C19.7348 7 19.4804 7.10536 19.2929 7.29289C19.1054 7.48043 19 7.73478 19 8C19 8.55228 18.5523 9 18 9C17.4477 9 17 8.55228 17 8C17 7.73478 16.8946 7.48043 16.7071 7.29289C16.5196 7.10536 16.2652 7 16 7C15.4477 7 15 6.55228 15 6C15 5.44772 15.4477 5 16 5C16.2652 5 16.5196 4.89464 16.7071 4.70711C16.8946 4.51957 17 4.26522 17 4C17 3.44772 17.4477 3 18 3ZM9 5C9.55228 5 10 5.44772 10 6C10 7.32608 10.5268 8.59785 11.4645 9.53553C12.4021 10.4732 13.6739 11 15 11C15.5523 11 16 11.4477 16 12C16 12.5523 15.5523 13 15 13C13.6739 13 12.4021 13.5268 11.4645 14.4645C10.5268 15.4021 10 16.6739 10 18C10 18.5523 9.55228 19 9 19C8.44772 19 8 18.5523 8 18C8 16.6739 7.47322 15.4021 6.53553 14.4645C5.59785 13.5268 4.32608 13 3 13C2.44772 13 2 12.5523 2 12C2 11.4477 2.44772 11 3 11C4.32608 11 5.59785 10.4732 6.53553 9.53553C7.47322 8.59785 8 7.32608 8 6C8 5.44772 8.44772 5 9 5ZM9 9.60559C8.70843 10.0908 8.35673 10.5428 7.94975 10.9497C7.54276 11.3567 7.09082 11.7084 6.60559 12C7.09082 12.2916 7.54276 12.6433 7.94975 13.0503C8.35673 13.4572 8.70843 13.9092 9 14.3944C9.29157 13.9092 9.64327 13.4572 10.0503 13.0503C10.4572 12.6433 10.9092 12.2916 11.3944 12C10.9092 11.7084 10.4572 11.3567 10.0503 10.9497C9.64327 10.5428 9.29157 10.0908 9 9.60559ZM16.7071 16.7071C16.8946 16.5196 17 16.2652 17 16C17 15.4477 17.4477 15 18 15C18.5523 15 19 15.4477 19 16C19 16.2652 19.1054 16.5196 19.2929 16.7071C19.4804 16.8946 19.7348 17 20 17C20.5523 17 21 17.4477 21 18C21 18.5523 20.5523 19 20 19C19.7348 19 19.4804 19.1054 19.2929 19.2929C19.1054 19.4804 19 19.7348 19 20C19 20.5523 18.5523 21 18 21C17.4477 21 17 20.5523 17 20C17 19.7348 16.8946 19.4804 16.7071 19.2929C16.5196 19.1054 16.2652 19 16 19C15.4477 19 15 18.5523 15 18C15 17.4477 15.4477 17 16 17C16.2652 17 16.5196 16.8946 16.7071 16.7071Z"/></svg>',observer:"ai.observe",command:"ai.popup"},"ai-image":{title:"## buttons.ai-image ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M18 3C18.5523 3 19 3.44772 19 4C19 4.26522 19.1054 4.51957 19.2929 4.70711C19.4804 4.89464 19.7348 5 20 5C20.5523 5 21 5.44772 21 6C21 6.55228 20.5523 7 20 7C19.7348 7 19.4804 7.10536 19.2929 7.29289C19.1054 7.48043 19 7.73478 19 8C19 8.55228 18.5523 9 18 9C17.4477 9 17 8.55228 17 8C17 7.73478 16.8946 7.48043 16.7071 7.29289C16.5196 7.10536 16.2652 7 16 7C15.4477 7 15 6.55228 15 6C15 5.44772 15.4477 5 16 5C16.2652 5 16.5196 4.89464 16.7071 4.70711C16.8946 4.51957 17 4.26522 17 4C17 3.44772 17.4477 3 18 3ZM9 5C9.55228 5 10 5.44772 10 6C10 7.32608 10.5268 8.59785 11.4645 9.53553C12.4021 10.4732 13.6739 11 15 11C15.5523 11 16 11.4477 16 12C16 12.5523 15.5523 13 15 13C13.6739 13 12.4021 13.5268 11.4645 14.4645C10.5268 15.4021 10 16.6739 10 18C10 18.5523 9.55228 19 9 19C8.44772 19 8 18.5523 8 18C8 16.6739 7.47322 15.4021 6.53553 14.4645C5.59785 13.5268 4.32608 13 3 13C2.44772 13 2 12.5523 2 12C2 11.4477 2.44772 11 3 11C4.32608 11 5.59785 10.4732 6.53553 9.53553C7.47322 8.59785 8 7.32608 8 6C8 5.44772 8.44772 5 9 5ZM9 9.60559C8.70843 10.0908 8.35673 10.5428 7.94975 10.9497C7.54276 11.3567 7.09082 11.7084 6.60559 12C7.09082 12.2916 7.54276 12.6433 7.94975 13.0503C8.35673 13.4572 8.70843 13.9092 9 14.3944C9.29157 13.9092 9.64327 13.4572 10.0503 13.0503C10.4572 12.6433 10.9092 12.2916 11.3944 12C10.9092 11.7084 10.4572 11.3567 10.0503 10.9497C9.64327 10.5428 9.29157 10.0908 9 9.60559ZM16.7071 16.7071C16.8946 16.5196 17 16.2652 17 16C17 15.4477 17.4477 15 18 15C18.5523 15 19 15.4477 19 16C19 16.2652 19.1054 16.5196 19.2929 16.7071C19.4804 16.8946 19.7348 17 20 17C20.5523 17 21 17.4477 21 18C21 18.5523 20.5523 19 20 19C19.7348 19 19.4804 19.1054 19.2929 19.2929C19.1054 19.4804 19 19.7348 19 20C19 20.5523 18.5523 21 18 21C17.4477 21 17 20.5523 17 20C17 19.7348 16.8946 19.4804 16.7071 19.2929C16.5196 19.1054 16.2652 19 16 19C15.4477 19 15 18.5523 15 18C15 17.4477 15.4477 17 16 17C16.2652 17 16.5196 16.8946 16.7071 16.7071Z"/></svg>',observer:"ai.observe",command:"ai.promptImage"},add:{title:"## buttons.add ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M13 3.75C13 3.19772 12.5523 2.75 12 2.75C11.4477 2.75 11 3.19772 11 3.75V11H3.75C3.19772 11 2.75 11.4477 2.75 12C2.75 12.5523 3.19772 13 3.75 13H11V20.25C11 20.8023 11.4477 21.25 12 21.25C12.5523 21.25 13 20.8023 13 20.25V13H20.25C20.8023 13 21.25 12.5523 21.25 12C21.25 11.4477 20.8023 11 20.25 11H13V3.75Z"/></svg>',command:"addbar.popup"},html:{title:"## buttons.html ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M14.9701 4.24253C15.1041 3.70673 14.7783 3.1638 14.2425 3.02985C13.7067 2.8959 13.1638 3.22166 13.0299 3.75746L9.02986 19.7575C8.89591 20.2933 9.22167 20.8362 9.75746 20.9701C10.2933 21.1041 10.8362 20.7783 10.9701 20.2425L14.9701 4.24253ZM7.70711 7.29289C8.09763 7.68341 8.09763 8.31658 7.70711 8.7071L4.41421 12L7.70711 15.2929C8.09763 15.6834 8.09763 16.3166 7.70711 16.7071C7.31658 17.0976 6.68342 17.0976 6.29289 16.7071L2.29289 12.7071C1.90237 12.3166 1.90237 11.6834 2.29289 11.2929L6.29289 7.29289C6.68342 6.90236 7.31658 6.90236 7.70711 7.29289ZM16.2929 7.29289C16.6834 6.90236 17.3166 6.90236 17.7071 7.29289L21.7071 11.2929C22.0976 11.6834 22.0976 12.3166 21.7071 12.7071L17.7071 16.7071C17.3166 17.0976 16.6834 17.0976 16.2929 16.7071C15.9024 16.3166 15.9024 15.6834 16.2929 15.2929L19.5858 12L16.2929 8.7071C15.9024 8.31658 15.9024 7.68341 16.2929 7.29289Z"/></svg>',command:"source.toggle"},format:{title:"## buttons.format ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M6.32413 6.98804C6.14654 7.2864 6 7.75331 6 8.5C6 9.24669 6.14654 9.7136 6.32413 10.012C6.49608 10.3008 6.73889 10.5026 7.06782 10.6511C7.58542 10.8849 8.24184 10.9625 9 10.9879V6.01213C8.24184 6.03755 7.58542 6.11512 7.06782 6.34887C6.73889 6.49742 6.49608 6.69917 6.32413 6.98804ZM6.24464 12.4739C7.10428 12.8621 8.10853 12.9642 9 12.9908V19C9 19.5523 9.44772 20 10 20C10.5523 20 11 19.5523 11 19V12V6H15V19C15 19.5523 15.4477 20 16 20C16.5523 20 17 19.5523 17 19V6H18C18.5523 6 19 5.55228 19 5C19 4.44772 18.5523 4 18 4H16H15C14.9996 4 14.9993 4 14.9989 4L10 4L9.99773 4L9.90325 3.99997C8.84701 3.99946 7.4124 3.99876 6.24464 4.52613C5.60483 4.81508 5.01952 5.26959 4.60554 5.96509C4.1972 6.65111 4 7.49669 4 8.5C4 9.50331 4.1972 10.3489 4.60554 11.0349C5.01952 11.7304 5.60483 12.1849 6.24464 12.4739Z"/></svg>',command:"format.popup"},bold:{title:"## buttons.bold ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M7 4C6.44772 4 6 4.44772 6 5V12V19C6 19.5523 6.44772 20 7 20H14C15.1935 20 16.3381 19.5259 17.182 18.682C18.0259 17.8381 18.5 16.6935 18.5 15.5C18.5 14.3065 18.0259 13.1619 17.182 12.318C16.9031 12.0391 16.5914 11.8006 16.2559 11.6063C17.0535 10.7703 17.5 9.65816 17.5 8.5C17.5 7.30653 17.0259 6.16193 16.182 5.31802C15.3381 4.47411 14.1935 4 13 4H7ZM13 13H8V18H14C14.663 18 15.2989 17.7366 15.7678 17.2678C16.2366 16.7989 16.5 16.163 16.5 15.5C16.5 14.837 16.2366 14.2011 15.7678 13.7322C15.2989 13.2634 14.663 13 14 13H13ZM13 11C13.663 11 14.2989 10.7366 14.7678 10.2678C15.2366 9.79893 15.5 9.16304 15.5 8.5C15.5 7.83696 15.2366 7.20107 14.7678 6.73223C14.2989 6.26339 13.663 6 13 6H8V11H13Z"/></svg>',command:"inline.set",params:{tag:"b"}},italic:{title:"## buttons.italic ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M14.0222 4H17C17.5523 4 18 4.44772 18 5C18 5.55228 17.5523 6 17 6H14.7543L11.3257 18H13C13.5523 18 14 18.4477 14 19C14 19.5523 13.5523 20 13 20H10.023C10.0081 20.0003 9.99304 20.0003 9.97798 20H7C6.44772 20 6 19.5523 6 19C6 18.4477 6.44772 18 7 18H9.24571L12.6743 6H11C10.4477 6 10 5.55228 10 5C10 4.44772 10.4477 4 11 4H13.9768C13.9919 3.99966 14.007 3.99965 14.0222 4Z"/></svg>',command:"inline.set",params:{tag:"i"}},deleted:{title:"## buttons.deleted ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M14.8776 4.46266C14.0175 4.14012 13.0023 3.98493 11.9923 3.99999H11C9.80652 3.99999 8.66193 4.4741 7.81802 5.31801C6.9741 6.16193 6.5 7.30652 6.5 8.49999C6.5 9.39648 6.76751 10.2654 7.25832 11H5C4.44772 11 4 11.4477 4 12C4 12.5523 4.44772 13 5 13H13.0058C13.6667 13.0015 14.3003 13.2647 14.7678 13.7322C15.2366 14.2011 15.5 14.837 15.5 15.5C15.5 16.163 15.2366 16.7989 14.7678 17.2678C14.2989 17.7366 13.663 18 13 18H11.5L11.4842 18.0001C10.6801 18.0128 9.9163 17.8865 9.32462 17.6647C8.70357 17.4318 8.45244 17.1652 8.38892 17.0419C8.13594 16.551 7.53288 16.3581 7.04194 16.6111C6.551 16.864 6.35809 17.4671 6.61107 17.9581C7.00105 18.7149 7.78931 19.2249 8.62237 19.5373C9.4825 19.8599 10.4977 20.0151 11.5077 20H13C14.1935 20 15.3381 19.5259 16.182 18.682C17.0259 17.8381 17.5 16.6935 17.5 15.5C17.5 14.6035 17.2325 13.7346 16.7417 13H19C19.5523 13 20 12.5523 20 12C20 11.4477 19.5523 11 19 11H13.0083C13.0055 11 13.0028 11 13 11H11C10.337 11 9.70107 10.7366 9.23223 10.2678C8.76339 9.79892 8.5 9.16303 8.5 8.49999C8.5 7.83695 8.76339 7.20107 9.23223 6.73223C9.70107 6.26338 10.337 5.99999 11 5.99999H12L12.0158 5.99987C12.8199 5.98715 13.5837 6.11344 14.1754 6.33532C14.7964 6.56822 15.0476 6.83478 15.1111 6.95805C15.3641 7.44899 15.9671 7.64189 16.4581 7.38892C16.949 7.13594 17.1419 6.53287 16.8889 6.04193C16.4989 5.28513 15.7107 4.77506 14.8776 4.46266Z"/></svg>',command:"inline.set",params:{tag:"del"}},moreinline:{title:"## buttons.more-formatting ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M3 12C3 10.8954 3.89543 10 5 10C6.10457 10 7 10.8954 7 12C7 13.1046 6.10457 14 5 14C3.89543 14 3 13.1046 3 12ZM10 12C10 10.8954 10.8954 10 12 10C13.1046 10 14 10.8954 14 12C14 13.1046 13.1046 14 12 14C10.8954 14 10 13.1046 10 12ZM19 10C17.8954 10 17 10.8954 17 12C17 13.1046 17.8954 14 19 14C20.1046 14 21 13.1046 21 12C21 10.8954 20.1046 10 19 10Z"/></svg>',command:"inline.popup"},link:{title:"## buttons.link ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12.1946 6.14687L11.7568 6.65369C11.3957 7.07164 10.7643 7.11778 10.3463 6.75676C9.92836 6.39573 9.88222 5.76425 10.2432 5.34631L10.7062 4.81031C10.7222 4.79189 10.7387 4.77405 10.7559 4.75684C11.8813 3.63165 13.4075 2.99958 14.9989 2.99969C16.5903 2.99981 18.1165 3.63209 19.2417 4.75744C20.3669 5.8828 20.9989 7.40904 20.9988 9.00042C20.9987 10.5918 20.3664 12.118 19.2411 13.2432C19.2246 13.2596 19.2075 13.2756 19.1899 13.2909L18.6559 13.7549C18.239 14.1171 17.6074 14.0728 17.2452 13.6559C16.8829 13.239 16.9272 12.6074 17.3441 12.2452L17.8502 11.8054C18.5859 11.0576 18.9987 10.0502 18.9988 9.00028C18.9989 7.93934 18.5775 6.92181 17.8273 6.17156C17.0772 5.4213 16.0597 4.99977 14.9988 4.99969C13.9493 4.99962 12.9424 5.41192 12.1946 6.14687ZM15.7071 8.29289C16.0976 8.68342 16.0976 9.31658 15.7071 9.70711L9.70711 15.7071C9.31658 16.0976 8.68342 16.0976 8.29289 15.7071C7.90237 15.3166 7.90237 14.6834 8.29289 14.2929L14.2929 8.29289C14.6834 7.90237 15.3166 7.90237 15.7071 8.29289ZM6.7494 10.3379C7.11509 10.7517 7.07603 11.3837 6.66216 11.7494L6.16037 12.1928C5.7956 12.5583 5.50555 12.9915 5.30653 13.4681C5.10411 13.953 4.99988 14.4731 4.99988 14.9985C4.99988 15.5239 5.10411 16.044 5.30653 16.5289C5.50895 17.0137 5.80554 17.4535 6.17913 17.8229L6.17916 17.8229C6.9407 18.576 7.96851 18.9984 9.03952 18.9984C10.0866 18.9984 11.0923 18.5947 11.8483 17.873L12.1975 17.4034C12.527 16.9602 13.1534 16.868 13.5966 17.1975C14.0399 17.527 14.132 18.1534 13.8025 18.5966L13.4055 19.1306C13.3754 19.1712 13.3421 19.2095 13.3062 19.2451C12.1702 20.3684 10.6371 20.9984 9.03952 20.9984C7.44197 20.9984 5.90886 20.3684 4.77291 19.2451C4.21121 18.6897 3.76528 18.0284 3.46093 17.2994C3.15659 16.5705 2.99988 15.7884 2.99988 14.9985C2.99988 14.2086 3.15659 13.4265 3.46093 12.6976C3.76528 11.9686 4.21121 11.3073 4.77291 10.7519C4.78621 10.7388 4.79987 10.726 4.81388 10.7136L5.33788 10.2506C5.75175 9.88493 6.38371 9.92399 6.7494 10.3379Z"/></svg>',observer:"link.observe",command:"link.popup"},"link-text":{title:"## buttons.link-text ##",command:"link.open"},unlink:{title:"## buttons.unlink ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M7 1C7.55228 1 8 1.44772 8 2V4C8 4.55228 7.55228 5 7 5C6.44772 5 6 4.55228 6 4V2C6 1.44772 6.44772 1 7 1ZM12.1946 6.14687L11.7568 6.65369C11.3957 7.07164 10.7643 7.11778 10.3463 6.75676C9.92836 6.39573 9.88222 5.76425 10.2432 5.34631L10.7062 4.81031C10.7222 4.79189 10.7387 4.77405 10.7559 4.75684C11.8813 3.63165 13.4075 2.99958 14.9989 2.99969C16.5903 2.99981 18.1165 3.63209 19.2417 4.75744C20.3669 5.8828 20.9989 7.40905 20.9988 9.00043C20.9987 10.5918 20.3664 12.118 19.2411 13.2432C19.2246 13.2596 19.2075 13.2756 19.1899 13.2909L18.6559 13.7549C18.239 14.1171 17.6074 14.0728 17.2452 13.6559C16.8829 13.239 16.9272 12.6074 17.3441 12.2452L17.8502 11.8054C18.5859 11.0576 18.9987 10.0502 18.9988 9.00028C18.9989 7.93934 18.5775 6.92181 17.8273 6.17156C17.0772 5.4213 16.0597 4.99977 14.9988 4.99969C13.9493 4.99962 12.9424 5.41192 12.1946 6.14687ZM1 7C1 6.44772 1.44772 6 2 6H4C4.55228 6 5 6.44772 5 7C5 7.55228 4.55228 8 4 8H2C1.44772 8 1 7.55228 1 7ZM15.7071 8.29289C16.0976 8.68342 16.0976 9.31658 15.7071 9.70711L9.70711 15.7071C9.31658 16.0976 8.68342 16.0976 8.29289 15.7071C7.90237 15.3166 7.90237 14.6834 8.29289 14.2929L14.2929 8.29289C14.6834 7.90237 15.3166 7.90237 15.7071 8.29289ZM6.7494 10.3379C7.11509 10.7517 7.07603 11.3837 6.66216 11.7494L6.16037 12.1928C5.7956 12.5583 5.50555 12.9915 5.30653 13.4681C5.10411 13.953 4.99988 14.4731 4.99988 14.9985C4.99988 15.5239 5.10411 16.044 5.30653 16.5289C5.50895 17.0137 5.80554 17.4535 6.17913 17.8229L6.17916 17.8229C6.9407 18.576 7.96851 18.9984 9.03952 18.9984C10.0866 18.9984 11.0923 18.5947 11.8483 17.873L12.1975 17.4034C12.527 16.9602 13.1534 16.868 13.5966 17.1975C14.0399 17.527 14.132 18.1534 13.8025 18.5966L13.4055 19.1306C13.3754 19.1712 13.3421 19.2095 13.3062 19.2451C12.1702 20.3684 10.6371 20.9984 9.03952 20.9984C7.44197 20.9984 5.90886 20.3684 4.77291 19.2451C4.21121 18.6897 3.76528 18.0284 3.46093 17.2994C3.15659 16.5705 2.99988 15.7884 2.99988 14.9985C2.99988 14.2086 3.15659 13.4265 3.46093 12.6976C3.76528 11.9686 4.21121 11.3073 4.77291 10.7519C4.78621 10.7388 4.79987 10.726 4.81388 10.7136L5.33788 10.2506C5.75175 9.88493 6.38371 9.92399 6.7494 10.3379ZM19 17C19 16.4477 19.4477 16 20 16H22C22.5523 16 23 16.4477 23 17C23 17.5523 22.5523 18 22 18H20C19.4477 18 19 17.5523 19 17ZM17 19C17.5523 19 18 19.4477 18 20V22C18 22.5523 17.5523 23 17 23C16.4477 23 16 22.5523 16 22V20C16 19.4477 16.4477 19 17 19Z"/></svg>',command:"link.unlink"},image:{title:"## buttons.image ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M5 7C5 5.89543 5.89543 5 7 5H17C18.1046 5 19 5.89543 19 7V12.5858L18.7071 12.2929L18.6934 12.2794C18.091 11.6998 17.3358 11.3301 16.5 11.3301C15.6642 11.3301 14.909 11.6998 14.3066 12.2794L14.2929 12.2929L14 12.5858L11.7071 10.2929L11.6934 10.2794C11.091 9.6998 10.3358 9.33014 9.5 9.33014C8.66419 9.33014 7.909 9.6998 7.30662 10.2794L7.29289 10.2929L5 12.5858V7ZM15.4142 14L15.6997 13.7146C16.0069 13.4213 16.2841 13.3301 16.5 13.3301C16.7159 13.3301 16.9931 13.4213 17.3003 13.7146L19 15.4142V17C19 18.1046 18.1046 19 17 19H7C5.89543 19 5 18.1046 5 17V15.4142L8.69966 11.7146C9.0069 11.4213 9.28406 11.3301 9.5 11.3301C9.71594 11.3301 9.9931 11.4213 10.3003 11.7146L13.2929 14.7071L15.2929 16.7071C15.6834 17.0976 16.3166 17.0976 16.7071 16.7071C17.0976 16.3166 17.0976 15.6834 16.7071 15.2929L15.4142 14ZM21 15.001V17C21 19.2091 19.2091 21 17 21H7C4.79086 21 3 19.2091 3 17V15.0002V14.9998V7C3 4.79086 4.79086 3 7 3H17C19.2091 3 21 4.79086 21 7V14.999C21 14.9997 21 15.0003 21 15.001ZM15 7C14.4477 7 14 7.44772 14 8C14 8.55228 14.4477 9 15 9H15.01C15.5623 9 16.01 8.55228 16.01 8C16.01 7.44772 15.5623 7 15.01 7H15Z"/></svg>',observer:"image.observe",command:"image.popup"},unwrap:{title:"## buttons.unwrap ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M2.29289 2.29289C2.68342 1.90237 3.31658 1.90237 3.70711 2.29289L21.7071 20.2929C22.0976 20.6834 22.0976 21.3166 21.7071 21.7071C21.3166 22.0976 20.6834 22.0976 20.2929 21.7071L18 19.4142V20C18 20.5523 17.5523 21 17 21C16.4477 21 16 20.5523 16 20V18H8V20C8 20.5523 7.55228 21 7 21C6.44772 21 6 20.5523 6 20V18H4C3.44772 18 3 17.5523 3 17C3 16.4477 3.44772 16 4 16H6V8H4C3.44772 8 3 7.55228 3 7C3 6.44772 3.44772 6 4 6H4.58579L2.29289 3.70711C1.90237 3.31658 1.90237 2.68342 2.29289 2.29289ZM8 9.41421L14.5858 16H8V9.41421ZM17 3C17.5523 3 18 3.44772 18 4V6H20C20.5523 6 21 6.44772 21 7C21 7.55228 20.5523 8 20 8H18V13C18 13.5523 17.5523 14 17 14C16.4477 14 16 13.5523 16 13V8H11C10.4477 8 10 7.55228 10 7C10 6.44772 10.4477 6 11 6H16V4C16 3.44772 16.4477 3 17 3Z"/></svg>',command:"block.unwrap"},outset:{title:"## buttons.outset ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M6 4C6 3.44772 6.44772 3 7 3H17C17.5523 3 18 3.44772 18 4C18 4.55229 17.5523 5 17 5L7 5C6.44772 5 6 4.55228 6 4ZM3.58579 7.58579C3.96086 7.21071 4.46957 7 5 7H19C19.5304 7 20.0391 7.21071 20.4142 7.58579C20.7893 7.96086 21 8.46957 21 9V15C21 15.5304 20.7893 16.0391 20.4142 16.4142C20.0391 16.7893 19.5304 17 19 17H5C4.46957 17 3.96086 16.7893 3.58579 16.4142C3.21071 16.0391 3 15.5304 3 15V9C3 8.46957 3.21071 7.96086 3.58579 7.58579ZM19 9H5L5 15H19V9ZM7 19C6.44772 19 6 19.4477 6 20C6 20.5523 6.44772 21 7 21H17C17.5523 21 18 20.5523 18 20C18 19.4477 17.5523 19 17 19H7Z"/></svg>',observer:"image.observe",command:"image.popupOutset"},wrap:{title:"## buttons.wrap-image ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M3.58579 4.58579C3.96086 4.21071 4.46957 4 5 4H9C9.53043 4 10.0391 4.21071 10.4142 4.58579C10.7893 4.96086 11 5.46957 11 6V10C11 10.5304 10.7893 11.0391 10.4142 11.4142C10.0391 11.7893 9.53043 12 9 12H5C4.46957 12 3.96086 11.7893 3.58579 11.4142C3.21071 11.0391 3 10.5304 3 10V6C3 5.46957 3.21071 4.96086 3.58579 4.58579ZM9 6L5 6L5 10H9V6ZM13 7C13 6.44772 13.4477 6 14 6H20C20.5523 6 21 6.44772 21 7C21 7.55228 20.5523 8 20 8H14C13.4477 8 13 7.55228 13 7ZM13 11C13 10.4477 13.4477 10 14 10H20C20.5523 10 21 10.4477 21 11C21 11.5523 20.5523 12 20 12H14C13.4477 12 13 11.5523 13 11ZM3 15C3 14.4477 3.44772 14 4 14H20C20.5523 14 21 14.4477 21 15C21 15.5523 20.5523 16 20 16H4C3.44772 16 3 15.5523 3 15ZM3 19C3 18.4477 3.44772 18 4 18H20C20.5523 18 21 18.4477 21 19C21 19.5523 20.5523 20 20 20H4C3.44772 20 3 19.5523 3 19Z"/></svg>',observer:"image.observe",command:"image.popupWrap"},"move-up":{title:"## buttons.move-up ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M11.2929 4.29289C11.6834 3.90237 12.3166 3.90237 12.7071 4.29289L16.7071 8.29289C17.0976 8.68342 17.0976 9.31658 16.7071 9.70711C16.3166 10.0976 15.6834 10.0976 15.2929 9.70711L13 7.41421V19C13 19.5523 12.5523 20 12 20C11.4477 20 11 19.5523 11 19V7.41421L8.70711 9.70711C8.31658 10.0976 7.68342 10.0976 7.29289 9.70711C6.90237 9.31658 6.90237 8.68342 7.29289 8.29289L11.2929 4.29289Z"/></svg>',command:"block.moveUp"},"move-down":{title:"## buttons.move-down ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 4C12.5523 4 13 4.44772 13 5V16.5858L15.2929 14.2929C15.6834 13.9024 16.3166 13.9024 16.7071 14.2929C17.0976 14.6834 17.0976 15.3166 16.7071 15.7071L12.7071 19.7071C12.3166 20.0976 11.6834 20.0976 11.2929 19.7071L7.29289 15.7071C6.90237 15.3166 6.90237 14.6834 7.29289 14.2929C7.68342 13.9024 8.31658 13.9024 8.70711 14.2929L11 16.5858V5C11 4.44772 11.4477 4 12 4Z"/></svg>',command:"block.moveDown"},list:{title:"## buttons.list ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M6 6C6 5.44772 5.55228 5 5 5C4.44772 5 4 5.44772 4 6V6.01C4 6.56228 4.44772 7.01 5 7.01C5.55228 7.01 6 6.56228 6 6.01V6ZM9 5C8.44772 5 8 5.44772 8 6C8 6.55228 8.44772 7 9 7H20C20.5523 7 21 6.55228 21 6C21 5.44772 20.5523 5 20 5H9ZM9 11C8.44772 11 8 11.4477 8 12C8 12.5523 8.44772 13 9 13H20C20.5523 13 21 12.5523 21 12C21 11.4477 20.5523 11 20 11H9ZM8 18C8 17.4477 8.44772 17 9 17H20C20.5523 17 21 17.4477 21 18C21 18.5523 20.5523 19 20 19H9C8.44772 19 8 18.5523 8 18ZM5 11C5.55228 11 6 11.4477 6 12V12.01C6 12.5623 5.55228 13.01 5 13.01C4.44772 13.01 4 12.5623 4 12.01V12C4 11.4477 4.44772 11 5 11ZM6 18C6 17.4477 5.55228 17 5 17C4.44772 17 4 17.4477 4 18V18.01C4 18.5623 4.44772 19.01 5 19.01C5.55228 19.01 6 18.5623 6 18.01V18Z"/></svg>',command:"list.popup"},numberedlist:{title:"## buttons.numbered-list ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M6.38267 3.07612C6.75635 3.2309 6.99999 3.59554 6.99999 4V10C6.99999 10.5523 6.55227 11 5.99999 11C5.44771 11 4.99999 10.5523 4.99999 10V6.41421L4.7071 6.70711C4.31657 7.09763 3.68341 7.09763 3.29288 6.70711C2.90236 6.31658 2.90236 5.68342 3.29288 5.29289L5.29288 3.29289C5.57888 3.00689 6.009 2.92134 6.38267 3.07612ZM9.99999 6C9.99999 5.44771 10.4477 5 11 5H20C20.5523 5 21 5.44771 21 6C21 6.55228 20.5523 7 20 7H11C10.4477 7 9.99999 6.55228 9.99999 6ZM9.99999 12C9.99999 11.4477 10.4477 11 11 11H20C20.5523 11 21 11.4477 21 12C21 12.5523 20.5523 13 20 13H11C10.4477 13 9.99999 12.5523 9.99999 12ZM5.99999 15C5.73477 15 5.48042 15.1054 5.29288 15.2929C5.10535 15.4804 4.99999 15.7348 4.99999 16C4.99999 16.5523 4.55227 17 3.99999 17C3.44771 17 2.99999 16.5523 2.99999 16C2.99999 15.2043 3.31606 14.4413 3.87867 13.8787C4.44128 13.3161 5.20434 13 5.99999 13C6.79564 13 7.5587 13.3161 8.12131 13.8787C8.68392 14.4413 8.99999 15.2043 8.99999 16C8.99999 16.6051 8.73548 17.0689 8.47379 17.402C8.28592 17.6411 8.03874 17.8824 7.84515 18.0714C7.79485 18.1205 7.74818 18.166 7.7071 18.2071C7.68572 18.2285 7.66339 18.2489 7.64017 18.2682L6.76204 19H7.99999C8.55228 19 8.99999 19.4477 8.99999 20C8.99999 20.5523 8.55228 21 7.99999 21H3.99999C3.57897 21 3.20304 20.7363 3.05972 20.3404C2.91639 19.9445 3.03637 19.5013 3.35981 19.2318L6.32564 16.7602C6.37812 16.7081 6.42975 16.6576 6.47777 16.6106L6.4872 16.6014C6.54925 16.5407 6.605 16.4861 6.65796 16.4328C6.76524 16.3249 6.84297 16.2404 6.90119 16.1663C6.95852 16.0933 6.98291 16.0478 6.99308 16.0238C7.00043 16.0064 7.00009 16.0014 7 16.0002C7 16.0001 6.99999 16.0001 6.99999 16C6.99999 15.7348 6.89463 15.4804 6.7071 15.2929C6.51956 15.1054 6.26521 15 5.99999 15ZM11 18C11 17.4477 11.4477 17 12 17H20C20.5523 17 21 17.4477 21 18C21 18.5523 20.5523 19 20 19H12C11.4477 19 11 18.5523 11 18Z"/></svg>',command:"format.set"},bulletlist:{title:"## buttons.bullet-list ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M6 6C6 5.44772 5.55228 5 5 5C4.44772 5 4 5.44772 4 6V6.01C4 6.56228 4.44772 7.01 5 7.01C5.55228 7.01 6 6.56228 6 6.01V6ZM9 5C8.44772 5 8 5.44772 8 6C8 6.55228 8.44772 7 9 7H20C20.5523 7 21 6.55228 21 6C21 5.44772 20.5523 5 20 5H9ZM9 11C8.44772 11 8 11.4477 8 12C8 12.5523 8.44772 13 9 13H20C20.5523 13 21 12.5523 21 12C21 11.4477 20.5523 11 20 11H9ZM8 18C8 17.4477 8.44772 17 9 17H20C20.5523 17 21 17.4477 21 18C21 18.5523 20.5523 19 20 19H9C8.44772 19 8 18.5523 8 18ZM5 11C5.55228 11 6 11.4477 6 12V12.01C6 12.5623 5.55228 13.01 5 13.01C4.44772 13.01 4 12.5623 4 12.01V12C4 11.4477 4.44772 11 5 11ZM6 18C6 17.4477 5.55228 17 5 17C4.44772 17 4 17.4477 4 18V18.01C4 18.5623 4.44772 19.01 5 19.01C5.55228 19.01 6 18.5623 6 18.01V18Z"/></svg>',command:"format.set"},indent:{title:"## buttons.indent ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M8 6C8 5.44772 8.44772 5 9 5H20C20.5523 5 21 5.44772 21 6C21 6.55228 20.5523 7 20 7H9C8.44772 7 8 6.55228 8 6ZM3.29289 7.29289C3.68342 6.90237 4.31658 6.90237 4.70711 7.29289L8.70711 11.2929C9.09763 11.6834 9.09763 12.3166 8.70711 12.7071L4.70711 16.7071C4.31658 17.0976 3.68342 17.0976 3.29289 16.7071C2.90237 16.3166 2.90237 15.6834 3.29289 15.2929L6.58579 12L3.29289 8.70711C2.90237 8.31658 2.90237 7.68342 3.29289 7.29289ZM13 11H20C20.5523 11 21 11.4477 21 12C21 12.5523 20.5523 13 20 13H13C12.4477 13 12 12.5523 12 12C12 11.4477 12.4477 11 13 11ZM8 18C8 17.4477 8.44772 17 9 17H20C20.5523 17 21 17.4477 21 18C21 18.5523 20.5523 19 20 19H9C8.44772 19 8 18.5523 8 18Z"/></svg>',command:"list.indent"},outdent:{title:"## buttons.outdent ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 6C12 5.44772 12.4477 5 13 5H20C20.5523 5 21 5.44772 21 6C21 6.55228 20.5523 7 20 7H13C12.4477 7 12 6.55228 12 6ZM8.70711 7.29289C9.09763 7.68342 9.09763 8.31658 8.70711 8.70711L5.41421 12L8.70711 15.2929C9.09763 15.6834 9.09763 16.3166 8.70711 16.7071C8.31658 17.0976 7.68342 17.0976 7.29289 16.7071L3.29289 12.7071C2.90237 12.3166 2.90237 11.6834 3.29289 11.2929L7.29289 7.29289C7.68342 6.90237 8.31658 6.90237 8.70711 7.29289ZM10 12C10 11.4477 10.4477 11 11 11H20C20.5523 11 21 11.4477 21 12C21 12.5523 20.5523 13 20 13H11C10.4477 13 10 12.5523 10 12ZM12 18C12 17.4477 12.4477 17 13 17H20C20.5523 17 21 17.4477 21 18C21 18.5523 20.5523 19 20 19H13C12.4477 19 12 18.5523 12 18Z"/></svg>',command:"list.outdent"},dlist:{title:"## buttons.definition-list ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M5.5 5C5.36739 5 5.24021 5.05268 5.14645 5.14645C5.05268 5.24021 5 5.36739 5 5.5V7H6V5.5C6 5.36739 5.94732 5.24021 5.85355 5.14645C5.75979 5.05268 5.63261 5 5.5 5ZM8 5.5C8 4.83696 7.73661 4.20107 7.26777 3.73223C6.79893 3.26339 6.16304 3 5.5 3C4.83696 3 4.20107 3.26339 3.73223 3.73223C3.26339 4.20107 3 4.83696 3 5.5V10C3 10.5523 3.44772 11 4 11C4.55228 11 5 10.5523 5 10V9H6V10C6 10.5523 6.44772 11 7 11C7.55228 11 8 10.5523 8 10V5.5ZM10 6C10 5.44772 10.4477 5 11 5H20C20.5523 5 21 5.44772 21 6C21 6.55228 20.5523 7 20 7H11C10.4477 7 10 6.55228 10 6ZM10 12C10 11.4477 10.4477 11 11 11H20C20.5523 11 21 11.4477 21 12C21 12.5523 20.5523 13 20 13H11C10.4477 13 10 12.5523 10 12ZM3 14C3 13.4477 3.44772 13 4 13H5.5C6.16304 13 6.79893 13.2634 7.26777 13.7322C7.73661 14.2011 8 14.837 8 15.5C8 16.044 7.82267 16.5698 7.50001 17C7.82267 17.4302 8 17.956 8 18.5C8 19.163 7.73661 19.7989 7.26777 20.2678C6.79893 20.7366 6.16304 21 5.5 21H4C3.44772 21 3 20.5523 3 20V14ZM5 18V19H5.5C5.63261 19 5.75978 18.9473 5.85355 18.8536C5.94732 18.7598 6 18.6326 6 18.5C6 18.3674 5.94732 18.2402 5.85355 18.1464C5.75978 18.0527 5.63261 18 5.5 18H5ZM5.5 16C5.63261 16 5.75978 15.9473 5.85355 15.8536C5.94732 15.7598 6 15.6326 6 15.5C6 15.3674 5.94732 15.2402 5.85355 15.1464C5.75979 15.0527 5.63261 15 5.5 15H5V16H5.5ZM10 18C10 17.4477 10.4477 17 11 17H20C20.5523 17 21 17.4477 21 18C21 18.5523 20.5523 19 20 19H11C10.4477 19 10 18.5523 10 18Z"/></svg>',command:"block.add"},hotkeys:{title:"## buttons.hotkeys ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M3 8C3 7.44772 3.44772 7 4 7H20C20.5523 7 21 7.44772 21 8V16C21 16.5523 20.5523 17 20 17H4C3.44772 17 3 16.5523 3 16V8ZM4 5C2.34315 5 1 6.34315 1 8V16C1 17.6569 2.34315 19 4 19H20C21.6569 19 23 17.6569 23 16V8C23 6.34315 21.6569 5 20 5H4ZM7 14C7 13.4477 6.55228 13 6 13C5.44772 13 5 13.4477 5 14V14.01C5 14.5623 5.44772 15.01 6 15.01C6.55228 15.01 7 14.5623 7 14.01V14ZM6 9C6.55228 9 7 9.44772 7 10V10.01C7 10.5623 6.55228 11.01 6 11.01C5.44772 11.01 5 10.5623 5 10.01V10C5 9.44772 5.44772 9 6 9ZM11 10C11 9.44772 10.5523 9 10 9C9.44771 9 9 9.44772 9 10V10.01C9 10.5623 9.44771 11.01 10 11.01C10.5523 11.01 11 10.5623 11 10.01V10ZM14 9C14.5523 9 15 9.44772 15 10V10.01C15 10.5623 14.5523 11.01 14 11.01C13.4477 11.01 13 10.5623 13 10.01V10C13 9.44772 13.4477 9 14 9ZM19 10C19 9.44772 18.5523 9 18 9C17.4477 9 17 9.44772 17 10V10.01C17 10.5623 17.4477 11.01 18 11.01C18.5523 11.01 19 10.5623 19 10.01V10ZM18 13C18.5523 13 19 13.4477 19 14V14.01C19 14.5623 18.5523 15.01 18 15.01C17.4477 15.01 17 14.5623 17 14.01V14C17 13.4477 17.4477 13 18 13ZM10 13C9.44771 13 9 13.4477 9 14C9 14.5523 9.44771 15 10 15H14C14.5523 15 15 14.5523 15 14C15 13.4477 14.5523 13 14 13H10Z"/></svg>',command:"hotkeys.popup"},undo:{title:"## buttons.undo ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M9.70711 4.29289C10.0976 4.68342 10.0976 5.31658 9.70711 5.70711L7.41421 8H16C17.3261 8 18.5979 8.52678 19.5355 9.46447C20.4732 10.4021 21 11.6739 21 13C21 14.3261 20.4732 15.5979 19.5355 16.5355C18.5979 17.4732 17.3261 18 16 18H15C14.4477 18 14 17.5523 14 17C14 16.4477 14.4477 16 15 16H16C16.7956 16 17.5587 15.6839 18.1213 15.1213C18.6839 14.5587 19 13.7956 19 13C19 12.2044 18.6839 11.4413 18.1213 10.8787C17.5587 10.3161 16.7956 10 16 10H7.41421L9.70711 12.2929C10.0976 12.6834 10.0976 13.3166 9.70711 13.7071C9.31658 14.0976 8.68342 14.0976 8.29289 13.7071L4.29329 9.7075C4.29316 9.70737 4.29303 9.70724 4.29289 9.70711C4.29219 9.7064 4.29148 9.70569 4.29078 9.70498C4.19595 9.6096 4.12432 9.49986 4.07588 9.38278C4.02699 9.26488 4 9.13559 4 9C4 8.86441 4.02699 8.73512 4.07588 8.61722C4.12468 8.49927 4.19702 8.38877 4.29289 8.29289L8.29289 4.29289C8.68342 3.90237 9.31658 3.90237 9.70711 4.29289Z"/></svg>',command:"state.undo"},redo:{title:"## buttons.redo ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M15.2929 4.29289C14.9024 4.68342 14.9024 5.31658 15.2929 5.70711L17.5858 8H9C7.67392 8 6.40215 8.52678 5.46447 9.46447C4.52678 10.4021 4 11.6739 4 13C4 14.3261 4.52678 15.5979 5.46447 16.5355C6.40215 17.4732 7.67392 18 9 18H10C10.5523 18 11 17.5523 11 17C11 16.4477 10.5523 16 10 16H9C8.20435 16 7.44129 15.6839 6.87868 15.1213C6.31607 14.5587 6 13.7956 6 13C6 12.2044 6.31607 11.4413 6.87868 10.8787C7.44129 10.3161 8.20435 10 9 10H17.5858L15.2929 12.2929C14.9024 12.6834 14.9024 13.3166 15.2929 13.7071C15.6834 14.0976 16.3166 14.0976 16.7071 13.7071L20.7067 9.7075C20.7068 9.70737 20.707 9.70724 20.7071 9.70711C20.7078 9.7064 20.7085 9.70569 20.7092 9.70498C20.804 9.6096 20.8757 9.49986 20.9241 9.38278C20.973 9.26488 21 9.13559 21 9C21 8.86441 20.973 8.73512 20.9241 8.61722C20.8753 8.49927 20.803 8.38877 20.7071 8.29289L16.7071 4.29289C16.3166 3.90237 15.6834 3.90237 15.2929 4.29289Z"/></svg>',command:"state.redo"},toggle:{title:"## buttons.toggle ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M4 7C3.44772 7 3 7.44772 3 8C3 8.55228 3.44772 9 4 9H20C20.5523 9 21 8.55228 21 8C21 7.44772 20.5523 7 20 7H4ZM4 15C3.44772 15 3 15.4477 3 16C3 16.5523 3.44772 17 4 17H20C20.5523 17 21 16.5523 21 16C21 15.4477 20.5523 15 20 15H4Z"/></svg>',command:"control.popup"},duplicate:{title:"## buttons.duplicate ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M6 3C5.20435 3 4.44129 3.31607 3.87868 3.87868C3.31607 4.44129 3 5.20435 3 6V14C3 14.7956 3.31607 15.5587 3.87868 16.1213C4.44129 16.6839 5.20435 17 6 17H7V18C7 19.6569 8.34315 21 10 21H18C19.6569 21 21 19.6569 21 18V10C21 8.34315 19.6569 7 18 7H17V6C17 5.20435 16.6839 4.44129 16.1213 3.87868C15.5587 3.31607 14.7956 3 14 3H6ZM15 7V6C15 5.73478 14.8946 5.48043 14.7071 5.29289C14.5196 5.10536 14.2652 5 14 5H6C5.73478 5 5.48043 5.10536 5.29289 5.29289C5.10536 5.48043 5 5.73478 5 6V14C5 14.2652 5.10536 14.5196 5.29289 14.7071C5.48043 14.8946 5.73478 15 6 15H7V10C7 8.34315 8.34315 7 10 7H15ZM9 16V18C9 18.5523 9.44772 19 10 19H18C18.5523 19 19 18.5523 19 18V10C19 9.44772 18.5523 9 18 9H16H10C9.44772 9 9 9.44772 9 10V16Z"/></svg>',command:"block.duplicate"},trash:{title:"## buttons.delete ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M10 2C9.46957 2 8.96086 2.21071 8.58579 2.58579C8.21071 2.96086 8 3.46957 8 4V6H5.01218H4.99004H4C3.44772 6 3 6.44772 3 7C3 7.55229 3.44772 8 4 8H4.07986L5.00034 19.0458C5.01222 19.8249 5.32687 20.5695 5.87867 21.1213C6.44128 21.6839 7.20434 22 7.99999 22H16C16.7956 22 17.5587 21.6839 18.1213 21.1213C18.6731 20.5695 18.9878 19.8249 18.9996 19.0458L19.9201 8H20C20.5523 8 21 7.55229 21 7C21 6.44772 20.5523 6 20 6H19.0099H18.9878H16V4C16 3.46957 15.7893 2.96086 15.4142 2.58579C15.0391 2.21071 14.5304 2 14 2H10ZM14 6V4L10 4L10 6H14ZM9 8H6.08679L6.99654 18.9169C6.99884 18.9446 6.99999 18.9723 6.99999 19C6.99999 19.2652 7.10535 19.5196 7.29289 19.7071C7.48042 19.8946 7.73478 20 7.99999 20H16C16.2652 20 16.5196 19.8946 16.7071 19.7071C16.8946 19.5196 17 19.2652 17 19C17 18.9723 17.0011 18.9446 17.0034 18.9169L17.9132 8H15H9ZM10 10C10.5523 10 11 10.4477 11 11V17C11 17.5523 10.5523 18 10 18C9.44772 18 9 17.5523 9 17V11C9 10.4477 9.44772 10 10 10ZM15 11C15 10.4477 14.5523 10 14 10C13.4477 10 13 10.4477 13 11V17C13 17.5523 13.4477 18 14 18C14.5523 18 15 17.5523 15 17V11Z"/></svg>',danger:!0,command:"block.remove"},table:{title:"## buttons.table ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M5 4C4.73478 4 4.48043 4.10536 4.29289 4.29289C4.10536 4.48043 4 4.73478 4 5V9H9V4H5ZM5 2C4.20435 2 3.44129 2.31607 2.87868 2.87868C2.31607 3.44129 2 4.20435 2 5V19C2 19.7957 2.31607 20.5587 2.87868 21.1213C3.44129 21.6839 4.20435 22 5 22H19C19.7957 22 20.5587 21.6839 21.1213 21.1213C21.6839 20.5587 22 19.7957 22 19V5C22 4.20435 21.6839 3.44129 21.1213 2.87868C20.5587 2.31607 19.7957 2 19 2H5ZM11 4V9H20V5C20 4.73478 19.8946 4.48043 19.7071 4.29289C19.5196 4.10536 19.2652 4 19 4H11ZM20 11H11V20H19C19.2652 20 19.5196 19.8946 19.7071 19.7071C19.8946 19.5196 20 19.2652 20 19V11ZM9 20V11H4V19C4 19.2652 4.10536 19.5196 4.29289 19.7071C4.48043 19.8946 4.73478 20 5 20H9Z"/></svg>',observer:"table.observe",command:"block.add"},"cell-setting":{title:"## table.cell-setting ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M6 3C6.55228 3 7 3.44772 7 4V7.17157C7.4179 7.31933 7.80192 7.55928 8.12132 7.87868C8.68393 8.44129 9 9.20435 9 10C9 10.7956 8.68393 11.5587 8.12132 12.1213C7.80192 12.4407 7.4179 12.6807 7 12.8284V20C7 20.5523 6.55228 21 6 21C5.44772 21 5 20.5523 5 20V12.8284C4.5821 12.6807 4.19808 12.4407 3.87868 12.1213C3.31607 11.5587 3 10.7956 3 10C3 9.20435 3.31607 8.44129 3.87868 7.87868C4.19808 7.55928 4.5821 7.31933 5 7.17157V4C5 3.44772 5.44772 3 6 3ZM12 3C12.5523 3 13 3.44772 13 4V13.1716C13.4179 13.3193 13.8019 13.5593 14.1213 13.8787C14.6839 14.4413 15 15.2043 15 16C15 16.7957 14.6839 17.5587 14.1213 18.1213C13.8019 18.4407 13.4179 18.6807 13 18.8284V20C13 20.5523 12.5523 21 12 21C11.4477 21 11 20.5523 11 20V18.8284C10.5821 18.6807 10.1981 18.4407 9.87868 18.1213C9.31607 17.5587 9 16.7957 9 16C9 15.2043 9.31607 14.4413 9.87868 13.8787C10.1981 13.5593 10.5821 13.3193 11 13.1716V4C11 3.44772 11.4477 3 12 3ZM18 3C18.5523 3 19 3.44772 19 4V4.17157C19.4179 4.31933 19.8019 4.55927 20.1213 4.87868C20.6839 5.44129 21 6.20435 21 7C21 7.79565 20.6839 8.55871 20.1213 9.12132C19.8019 9.44072 19.4179 9.68067 19 9.82843V20C19 20.5523 18.5523 21 18 21C17.4477 21 17 20.5523 17 20V9.82843C16.5821 9.68067 16.1981 9.44072 15.8787 9.12132C15.3161 8.55871 15 7.79565 15 7C15 6.20435 15.3161 5.44129 15.8787 4.87868C16.1981 4.55927 16.5821 4.31933 17 4.17157V4C17 3.44772 17.4477 3 18 3ZM18 6C17.7348 6 17.4804 6.10536 17.2929 6.29289C17.1054 6.48043 17 6.73478 17 7C17 7.26522 17.1054 7.51957 17.2929 7.70711C17.4804 7.89464 17.7348 8 18 8C18.2652 8 18.5196 7.89464 18.7071 7.70711C18.8946 7.51957 19 7.26522 19 7C19 6.73478 18.8946 6.48043 18.7071 6.29289C18.5196 6.10536 18.2652 6 18 6ZM6 9C5.73478 9 5.48043 9.10536 5.29289 9.29289C5.10536 9.48043 5 9.73478 5 10C5 10.2652 5.10536 10.5196 5.29289 10.7071C5.48043 10.8946 5.73478 11 6 11C6.26522 11 6.51957 10.8946 6.70711 10.7071C6.89464 10.5196 7 10.2652 7 10C7 9.73478 6.89464 9.48043 6.70711 9.29289C6.51957 9.10536 6.26522 9 6 9ZM12 15C11.7348 15 11.4804 15.1054 11.2929 15.2929C11.1054 15.4804 11 15.7348 11 16C11 16.2652 11.1054 16.5196 11.2929 16.7071C11.4804 16.8946 11.7348 17 12 17C12.2652 17 12.5196 16.8946 12.7071 16.7071C12.8946 16.5196 13 16.2652 13 16C13 15.7348 12.8946 15.4804 12.7071 15.2929C12.5196 15.1054 12.2652 15 12 15Z"/></svg>',command:"table.cellSetting"},embed:{title:"## buttons.embed ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M6 6C5.73478 6 5.48043 6.10536 5.29289 6.29289C5.10536 6.48043 5 6.73478 5 7V11C5 11.2652 4.89464 11.5196 4.70711 11.7071L4.41421 12L4.70711 12.2929C4.89464 12.4804 5 12.7348 5 13V17C5 17.2652 5.10536 17.5196 5.29289 17.7071C5.48043 17.8946 5.73478 18 6 18C6.55228 18 7 18.4477 7 19C7 19.5523 6.55228 20 6 20C5.20435 20 4.44129 19.6839 3.87868 19.1213C3.31607 18.5587 3 17.7956 3 17V13.4142L2.29289 12.7071C1.90237 12.3166 1.90237 11.6834 2.29289 11.2929L3 10.5858V7C3 6.20435 3.31607 5.44129 3.87868 4.87868C4.44129 4.31607 5.20435 4 6 4C6.55228 4 7 4.44772 7 5C7 5.55228 6.55228 6 6 6ZM17 5C17 4.44772 17.4477 4 18 4C18.7956 4 19.5587 4.31607 20.1213 4.87868C20.6839 5.44129 21 6.20435 21 7V10.5858L21.7071 11.2929C22.0976 11.6834 22.0976 12.3166 21.7071 12.7071L21 13.4142V17C21 17.7957 20.6839 18.5587 20.1213 19.1213C19.5587 19.6839 18.7957 20 18 20C17.4477 20 17 19.5523 17 19C17 18.4477 17.4477 18 18 18C18.2652 18 18.5196 17.8946 18.7071 17.7071C18.8946 17.5196 19 17.2652 19 17V13C19 12.7348 19.1054 12.4804 19.2929 12.2929L19.5858 12L19.2929 11.7071C19.1054 11.5196 19 11.2652 19 11V7C19 6.73478 18.8946 6.48043 18.7071 6.29289C18.5196 6.10536 18.2652 6 18 6C17.4477 6 17 5.55228 17 5ZM12 8C12.5523 8 13 8.44772 13 9V11H15C15.5523 11 16 11.4477 16 12C16 12.5523 15.5523 13 15 13H13V15C13 15.5523 12.5523 16 12 16C11.4477 16 11 15.5523 11 15V13H9C8.44772 13 8 12.5523 8 12C8 11.4477 8.44772 11 9 11H11V9C11 8.44772 11.4477 8 12 8Z"/></svg>',observer:"embed.observe",command:"embed.popup"},quote:{title:"## buttons.quote ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M4.58579 5.58579C4.96086 5.21071 5.46957 5 6 5H9C9.53043 5 10.0391 5.21071 10.4142 5.58579C10.7893 5.96086 11 6.46957 11 7V13C11 14.5025 10.6219 15.8236 9.78098 16.8747C8.94259 17.9227 7.72684 18.5989 6.24262 18.9701C5.70684 19.1041 5.16387 18.7784 5.02988 18.2426C4.89588 17.7068 5.2216 17.1639 5.75738 17.0299C6.94016 16.7341 7.72441 16.2438 8.21927 15.6253C8.7116 15.0099 9 14.1645 9 13V12H6C5.46957 12 4.96086 11.7893 4.58579 11.4142C4.21071 11.0391 4 10.5304 4 10V7C4 6.46957 4.21071 5.96086 4.58579 5.58579ZM9 10V7L6 7L6 10H9ZM13.5858 5.58579C13.9609 5.21071 14.4696 5 15 5H18C18.5304 5 19.0391 5.21071 19.4142 5.58579C19.7893 5.96086 20 6.46957 20 7V13C20 14.5025 19.6219 15.8236 18.781 16.8747C17.9426 17.9227 16.7268 18.5989 15.2426 18.9701C14.7068 19.1041 14.1639 18.7784 14.0299 18.2426C13.8959 17.7068 14.2216 17.1639 14.7574 17.0299C15.9402 16.7341 16.7244 16.2438 17.2193 15.6253C17.7116 15.0099 18 14.1645 18 13V12H15C14.4696 12 13.9609 11.7893 13.5858 11.4142C13.2107 11.0391 13 10.5304 13 10V7C13 6.46957 13.2107 5.96086 13.5858 5.58579ZM18 10L18 7H15V10H18Z"/></svg>',command:"format.set"},layout:{title:"## buttons.layout ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M2.58579 2.58579C2.96086 2.21071 3.46957 2 4 2H20C20.5304 2 21.0391 2.21071 21.4142 2.58579C21.7893 2.96086 22 3.46957 22 4V20C22 20.5304 21.7893 21.0391 21.4142 21.4142C21.0391 21.7893 20.5304 22 20 22H4C3.46957 22 2.96086 21.7893 2.58579 21.4142C2.21071 21.0391 2 20.5304 2 20V4C2 3.46957 2.21071 2.96086 2.58579 2.58579ZM13 20H20V4H13V20ZM11 4V20H4V4H11Z"/></svg>',command:"layout.popup"},wrapper:{title:"## buttons.wrapper ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M5 6C4.73478 6 4.48043 6.10536 4.29289 6.29289C4.10536 6.48043 4 6.73478 4 7V17C4 17.2652 4.10536 17.5196 4.29289 17.7071C4.48043 17.8946 4.73478 18 5 18H19C19.2652 18 19.5196 17.8946 19.7071 17.7071C19.8946 17.5196 20 17.2652 20 17V7C20 6.73478 19.8946 6.48043 19.7071 6.29289C19.5196 6.10536 19.2652 6 19 6H5ZM2.87868 4.87868C3.44129 4.31607 4.20435 4 5 4H19C19.7957 4 20.5587 4.31607 21.1213 4.87868C21.6839 5.44129 22 6.20435 22 7V17C22 17.7957 21.6839 18.5587 21.1213 19.1213C20.5587 19.6839 19.7957 20 19 20H5C4.20435 20 3.44129 19.6839 2.87868 19.1213C2.31607 18.5587 2 17.7956 2 17V7C2 6.20435 2.31607 5.44129 2.87868 4.87868Z"/></svg>',command:"block.add"},todo:{title:"## buttons.todo ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M6.79289 3.79289C7.18342 3.40237 7.81658 3.40237 8.20711 3.79289C8.59763 4.18342 8.59763 4.81658 8.20711 5.20711L5.70711 7.70711C5.31658 8.09763 4.68342 8.09763 4.29289 7.70711L2.79289 6.20711C2.40237 5.81658 2.40237 5.18342 2.79289 4.79289C3.18342 4.40237 3.81658 4.40237 4.20711 4.79289L5 5.58579L6.79289 3.79289ZM10 6C10 5.44772 10.4477 5 11 5H20C20.5523 5 21 5.44772 21 6C21 6.55228 20.5523 7 20 7H11C10.4477 7 10 6.55228 10 6ZM8.20711 9.79289C8.59763 10.1834 8.59763 10.8166 8.20711 11.2071L5.70711 13.7071C5.31658 14.0976 4.68342 14.0976 4.29289 13.7071L2.79289 12.2071C2.40237 11.8166 2.40237 11.1834 2.79289 10.7929C3.18342 10.4024 3.81658 10.4024 4.20711 10.7929L5 11.5858L6.79289 9.79289C7.18342 9.40237 7.81658 9.40237 8.20711 9.79289ZM10 12C10 11.4477 10.4477 11 11 11H20C20.5523 11 21 11.4477 21 12C21 12.5523 20.5523 13 20 13H11C10.4477 13 10 12.5523 10 12ZM8.20711 15.7929C8.59763 16.1834 8.59763 16.8166 8.20711 17.2071L5.70711 19.7071C5.31658 20.0976 4.68342 20.0976 4.29289 19.7071L2.79289 18.2071C2.40237 17.8166 2.40237 17.1834 2.79289 16.7929C3.18342 16.4024 3.81658 16.4024 4.20711 16.7929L5 17.5858L6.79289 15.7929C7.18342 15.4024 7.81658 15.4024 8.20711 15.7929ZM10 18C10 17.4477 10.4477 17 11 17H20C20.5523 17 21 17.4477 21 18C21 18.5523 20.5523 19 20 19H11C10.4477 19 10 18.5523 10 18Z"/></svg>',command:"format.set"},pre:{title:"## buttons.code-snippet ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M14.2425 3.02986C14.7783 3.16381 15.1041 3.70674 14.9701 4.24254L10.9701 20.2425C10.8362 20.7783 10.2933 21.1041 9.75746 20.9701C9.22167 20.8362 8.89591 20.2933 9.02986 19.7575L13.0299 3.75746C13.1638 3.22167 13.7067 2.89591 14.2425 3.02986ZM7.70711 7.29289C8.09763 7.68342 8.09763 8.31658 7.70711 8.70711L4.41421 12L7.70711 15.2929C8.09763 15.6834 8.09763 16.3166 7.70711 16.7071C7.31658 17.0976 6.68342 17.0976 6.29289 16.7071L2.29289 12.7071C1.90237 12.3166 1.90237 11.6834 2.29289 11.2929L6.29289 7.29289C6.68342 6.90237 7.31658 6.90237 7.70711 7.29289ZM16.2929 7.29289C16.6834 6.90237 17.3166 6.90237 17.7071 7.29289L21.7071 11.2929C22.0976 11.6834 22.0976 12.3166 21.7071 12.7071L17.7071 16.7071C17.3166 17.0976 16.6834 17.0976 16.2929 16.7071C15.9024 16.3166 15.9024 15.6834 16.2929 15.2929L19.5858 12L16.2929 8.70711C15.9024 8.31658 15.9024 7.68342 16.2929 7.29289Z"/></svg>',command:"block.add"},line:{title:"## buttons.line ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M3 12C3 11.4477 3.44772 11 4 11H20C20.5523 11 21 11.4477 21 12C21 12.5523 20.5523 13 20 13H4C3.44772 13 3 12.5523 3 12Z"/></svg>',command:"block.add"},parent:{title:"## buttons.parent ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M7 6H16C16.5523 6 17 6.44772 17 7C17 7.55228 16.5523 8 16 8H9.41421L17.7071 16.2929C18.0976 16.6834 18.0976 17.3166 17.7071 17.7071C17.3166 18.0976 16.6834 18.0976 16.2929 17.7071L8 9.41421V16C8 16.5523 7.55228 17 7 17C6.44772 17 6 16.5523 6 16V7C6 6.44772 6.44772 6 7 6Z"/></svg>',command:"block.setParent"},code:{title:"## buttons.code ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M14.2425 3.02986C14.7783 3.16381 15.1041 3.70674 14.9701 4.24254L10.9701 20.2425C10.8362 20.7783 10.2933 21.1041 9.75746 20.9701C9.22167 20.8362 8.89591 20.2933 9.02986 19.7575L13.0299 3.75746C13.1638 3.22167 13.7067 2.89591 14.2425 3.02986ZM7.70711 7.29289C8.09763 7.68342 8.09763 8.31658 7.70711 8.70711L4.41421 12L7.70711 15.2929C8.09763 15.6834 8.09763 16.3166 7.70711 16.7071C7.31658 17.0976 6.68342 17.0976 6.29289 16.7071L2.29289 12.7071C1.90237 12.3166 1.90237 11.6834 2.29289 11.2929L6.29289 7.29289C6.68342 6.90237 7.31658 6.90237 7.70711 7.29289ZM16.2929 7.29289C16.6834 6.90237 17.3166 6.90237 17.7071 7.29289L21.7071 11.2929C22.0976 11.6834 22.0976 12.3166 21.7071 12.7071L17.7071 16.7071C17.3166 17.0976 16.6834 17.0976 16.2929 16.7071C15.9024 16.3166 15.9024 15.6834 16.2929 15.2929L19.5858 12L16.2929 8.70711C15.9024 8.31658 15.9024 7.68342 16.2929 7.29289Z"/></svg>',command:"inline.set",params:{tag:"code"}},underline:{title:"## buttons.underline ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M7 4C7.55228 4 8 4.44772 8 5V10C8 11.0609 8.42143 12.0783 9.17157 12.8284C9.92172 13.5786 10.9391 14 12 14C13.0609 14 14.0783 13.5786 14.8284 12.8284C15.5786 12.0783 16 11.0609 16 10V5C16 4.44772 16.4477 4 17 4C17.5523 4 18 4.44772 18 5V10C18 11.5913 17.3679 13.1174 16.2426 14.2426C15.1174 15.3679 13.5913 16 12 16C10.4087 16 8.88258 15.3679 7.75736 14.2426C6.63214 13.1174 6 11.5913 6 10V5C6 4.44772 6.44772 4 7 4ZM4 19C4 18.4477 4.44772 18 5 18H19C19.5523 18 20 18.4477 20 19C20 19.5523 19.5523 20 19 20H5C4.44772 20 4 19.5523 4 19Z"/></svg>',command:"inline.set",params:{tag:"u"}},highlight:{title:"## buttons.highlight ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12.7929 3.79289C13.5109 3.07492 14.4846 2.67157 15.5 2.67157C16.5154 2.67157 17.4891 3.07492 18.2071 3.79289C18.9251 4.51086 19.3284 5.48464 19.3284 6.5C19.3284 7.51536 18.9251 8.48913 18.2071 9.2071L17.2085 10.2057C17.2081 10.2061 17.2076 10.2066 17.2071 10.2071C17.2066 10.2076 17.2061 10.2081 17.2057 10.2085L9.20854 18.2057C9.20807 18.2061 9.20759 18.2066 9.20711 18.2071C9.20663 18.2076 9.20615 18.2081 9.20567 18.2085L7.70711 19.7071C7.51957 19.8946 7.26522 20 7 20H3C2.44772 20 2 19.5523 2 19V15C2 14.7348 2.10536 14.4804 2.29289 14.2929L12.7929 3.79289ZM12.5 6.91421L5.91421 13.5L8.5 16.0858L15.0858 9.5L12.5 6.91421ZM16.5 8.08579L13.9142 5.5L14.2071 5.2071C14.55 4.86421 15.0151 4.67157 15.5 4.67157C15.9849 4.67157 16.45 4.86421 16.7929 5.2071C17.1358 5.55 17.3284 6.01507 17.3284 6.5C17.3284 6.98493 17.1358 7.44999 16.7929 7.79289L16.5 8.08579ZM7.08579 17.5L4.5 14.9142L4 15.4142V18H6.58579L7.08579 17.5ZM16.2929 14.2929C16.4804 14.1054 16.7348 14 17 14H21C21.5523 14 22 14.4477 22 15V19C22 19.5523 21.5523 20 21 20H13C12.5955 20 12.2309 19.7564 12.0761 19.3827C11.9213 19.009 12.0069 18.5789 12.2929 18.2929L16.2929 14.2929ZM20 16H17.4142L15.4142 18H20V16Z"/></svg>',command:"inline.set",params:{tag:"mark"}},sup:{title:"## buttons.superscript ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M17.9565 3.09068C18.7281 2.88025 19.5517 2.98495 20.2461 3.38175C20.5899 3.57822 20.8917 3.8405 21.1342 4.1536C21.3767 4.4667 21.5551 4.82449 21.6593 5.20655C21.7635 5.5886 21.7914 5.98744 21.7415 6.38029C21.6915 6.77313 21.5647 7.1523 21.3682 7.49613C21.3352 7.55397 21.2964 7.60836 21.2526 7.6585L19.2037 9.99999H21C21.5523 9.99999 22 10.4477 22 11C22 11.5523 21.5523 12 21 12H17C16.6076 12 16.2515 11.7705 16.0893 11.4132C15.9272 11.0559 15.989 10.6368 16.2474 10.3415L19.6701 6.42985C19.7146 6.33455 19.7441 6.23275 19.7574 6.12807C19.7743 5.99576 19.7648 5.86144 19.7298 5.73278C19.6947 5.60411 19.6346 5.48362 19.5529 5.37818C19.4713 5.27273 19.3696 5.1844 19.2538 5.11824C19.02 4.9846 18.7426 4.94934 18.4828 5.02021C18.2229 5.09108 18.0019 5.26227 17.8682 5.49613C17.5942 5.97565 16.9834 6.14225 16.5038 5.86824C16.0243 5.59423 15.8577 4.98337 16.1317 4.50385C16.5285 3.80945 17.1849 3.30112 17.9565 3.09068ZM4.37528 6.21913C4.80654 5.87412 5.43584 5.94404 5.78084 6.3753L8.99998 10.3992L12.2191 6.3753C12.5641 5.94404 13.1934 5.87412 13.6247 6.21913C14.0559 6.56414 14.1259 7.19343 13.7808 7.62469L10.2806 12L13.7808 16.3753C14.1259 16.8066 14.0559 17.4359 13.6247 17.7809C13.1934 18.1259 12.5641 18.056 12.2191 17.6247L8.99998 13.6008L5.78084 17.6247C5.43584 18.056 4.80654 18.1259 4.37528 17.7809C3.94402 17.4359 3.8741 16.8066 4.21911 16.3753L7.71935 12L4.21911 7.62469C3.8741 7.19343 3.94402 6.56414 4.37528 6.21913Z"/></svg>',command:"inline.set",params:{tag:"sup"}},sub:{title:"## buttons.subscript ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M4.37528 6.21914C4.80654 5.87413 5.43584 5.94405 5.78084 6.37531L8.99998 10.3992L12.2191 6.37531C12.5641 5.94405 13.1934 5.87413 13.6247 6.21914C14.0559 6.56415 14.1259 7.19344 13.7808 7.6247L10.2806 12L13.7808 16.3753C14.1259 16.8066 14.0559 17.4359 13.6247 17.7809C13.1934 18.1259 12.5641 18.056 12.2191 17.6247L8.99998 13.6008L5.78084 17.6247C5.43584 18.056 4.80654 18.1259 4.37528 17.7809C3.94402 17.4359 3.8741 16.8066 4.21911 16.3753L7.71935 12L4.21911 7.6247C3.8741 7.19344 3.94402 6.56415 4.37528 6.21914ZM17.9565 12.0907C18.3386 11.9865 18.7374 11.9586 19.1303 12.0085C19.5231 12.0585 19.9023 12.1853 20.2461 12.3818C20.5899 12.5782 20.8917 12.8405 21.1342 13.1536C21.3767 13.4667 21.5551 13.8245 21.6593 14.2066C21.7635 14.5886 21.7914 14.9875 21.7415 15.3803C21.6915 15.7731 21.5647 16.1523 21.3682 16.4961C21.3352 16.554 21.2964 16.6084 21.2526 16.6585L19.2037 19H21C21.5523 19 22 19.4477 22 20C22 20.5523 21.5523 21 21 21H17C16.6076 21 16.2515 20.7705 16.0893 20.4132C15.9272 20.0559 15.989 19.6368 16.2474 19.3415L19.6701 15.4299C19.7146 15.3346 19.7441 15.2328 19.7574 15.1281C19.7743 14.9958 19.7648 14.8615 19.7298 14.7328C19.6947 14.6041 19.6346 14.4836 19.5529 14.3782C19.4713 14.2727 19.3696 14.1844 19.2538 14.1182C19.138 14.0521 19.0104 14.0094 18.878 13.9926C18.7457 13.9757 18.6114 13.9851 18.4828 14.0202C18.3541 14.0553 18.2336 14.1154 18.1282 14.1971C18.0227 14.2787 17.9344 14.3804 17.8682 14.4961C17.5942 14.9757 16.9834 15.1423 16.5038 14.8682C16.0243 14.5942 15.8577 13.9834 16.1317 13.5039C16.3282 13.16 16.5905 12.8583 16.9036 12.6158C17.2167 12.3733 17.5745 12.1949 17.9565 12.0907Z"/></svg>',command:"inline.set",params:{tag:"sub"}},removeinline:{title:"## buttons.clear-all-styles ##",position:"last",command:"inline.removeFormat"},heading:{title:"## buttons.heading ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M2 6C2 5.44772 2.44772 5 3 5H5C5.55228 5 6 5.44772 6 6C6 6.55228 5.55228 7 5 7V11H11V7C10.4477 7 10 6.55228 10 6C10 5.44772 10.4477 5 11 5H13C13.5523 5 14 5.44772 14 6C14 6.55228 13.5523 7 13 7V17C13.5523 17 14 17.4477 14 18C14 18.5523 13.5523 19 13 19H11C10.4477 19 10 18.5523 10 18C10 17.4477 10.4477 17 11 17V13H5V17C5.55228 17 6 17.4477 6 18C6 18.5523 5.55228 19 5 19H3C2.44772 19 2 18.5523 2 18C2 17.4477 2.44772 17 3 17V7C2.44772 7 2 6.55228 2 6ZM19.3827 9.07612C19.7564 9.2309 20 9.59554 20 10V18C20 18.5523 19.5523 19 19 19C18.4477 19 18 18.5523 18 18V12.4142L17.7071 12.7071C17.3166 13.0976 16.6834 13.0976 16.2929 12.7071C15.9024 12.3166 15.9024 11.6834 16.2929 11.2929L18.2929 9.29289C18.5789 9.0069 19.009 8.92134 19.3827 9.07612Z"/></svg>',command:"block.add"},text:{title:"## buttons.text ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M5 6C5 5.44772 5.44772 5 6 5H18C18.5523 5 19 5.44772 19 6C19 6.55228 18.5523 7 18 7H13V18C13 18.5523 12.5523 19 12 19C11.4477 19 11 18.5523 11 18V7H6C5.44772 7 5 6.55228 5 6Z"/></svg>',command:"format.set"},h1:{title:"## buttons.heading ## 1",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M2 6C2 5.44772 2.44772 5 3 5H5C5.55228 5 6 5.44772 6 6C6 6.55228 5.55228 7 5 7V11H11V7C10.4477 7 10 6.55228 10 6C10 5.44772 10.4477 5 11 5H13C13.5523 5 14 5.44772 14 6C14 6.55228 13.5523 7 13 7V17C13.5523 17 14 17.4477 14 18C14 18.5523 13.5523 19 13 19H11C10.4477 19 10 18.5523 10 18C10 17.4477 10.4477 17 11 17V13H5V17C5.55228 17 6 17.4477 6 18C6 18.5523 5.55228 19 5 19H3C2.44772 19 2 18.5523 2 18C2 17.4477 2.44772 17 3 17V7C2.44772 7 2 6.55228 2 6ZM19.3827 9.07612C19.7564 9.2309 20 9.59554 20 10V18C20 18.5523 19.5523 19 19 19C18.4477 19 18 18.5523 18 18V12.4142L17.7071 12.7071C17.3166 13.0976 16.6834 13.0976 16.2929 12.7071C15.9024 12.3166 15.9024 11.6834 16.2929 11.2929L18.2929 9.29289C18.5789 9.0069 19.009 8.92134 19.3827 9.07612Z"/></svg>',command:"format.set"},h2:{title:"## buttons.heading ## 2",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M2 6C2 5.44772 2.44772 5 3 5H5C5.55228 5 6 5.44772 6 6C6 6.55228 5.55228 7 5 7V11H11V7C10.4477 7 10 6.55228 10 6C10 5.44772 10.4477 5 11 5H13C13.5523 5 14 5.44772 14 6C14 6.55228 13.5523 7 13 7V17C13.5523 17 14 17.4477 14 18C14 18.5523 13.5523 19 13 19H11C10.4477 19 10 18.5523 10 18C10 17.4477 10.4477 17 11 17V13H5V17C5.55228 17 6 17.4477 6 18C6 18.5523 5.55228 19 5 19H3C2.44772 19 2 18.5523 2 18C2 17.4477 2.44772 17 3 17V7C2.44772 7 2 6.55228 2 6ZM19 11C18.7348 11 18.4804 11.1054 18.2929 11.2929C18.1054 11.4804 18 11.7348 18 12C18 12.5523 17.5523 13 17 13C16.4477 13 16 12.5523 16 12C16 11.2043 16.3161 10.4413 16.8787 9.87868C17.4413 9.31607 18.2043 9 19 9C19.7957 9 20.5587 9.31607 21.1213 9.87868C21.6839 10.4413 22 11.2043 22 12C22 12.5095 21.8269 12.9956 21.6442 13.3786C21.4547 13.776 21.2129 14.1483 20.9883 14.4523L20.9769 14.4674L19.0297 17.001H21C21.5523 17.001 22 17.4487 22 18.001C22 18.5533 21.5523 19.001 21 19.001H17C16.6191 19.001 16.2713 18.7846 16.103 18.443C15.9346 18.1013 15.975 17.6936 16.2071 17.3916L19.3851 13.2564C19.5575 13.0223 19.7216 12.7639 19.839 12.5176C19.9646 12.2544 20 12.0815 20 12C20 11.7348 19.8946 11.4804 19.7071 11.2929C19.5196 11.1054 19.2652 11 19 11Z"/></svg>',command:"format.set"},h3:{title:"## buttons.heading ## 3",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M2 6C2 5.44772 2.44772 5 3 5H5C5.55228 5 6 5.44772 6 6C6 6.55228 5.55228 7 5 7V11H11V7C10.4477 7 10 6.55228 10 6C10 5.44772 10.4477 5 11 5H13C13.5523 5 14 5.44772 14 6C14 6.55228 13.5523 7 13 7V17C13.5523 17 14 17.4477 14 18C14 18.5523 13.5523 19 13 19H11C10.4477 19 10 18.5523 10 18C10 17.4477 10.4477 17 11 17V13H5V17C5.55228 17 6 17.4477 6 18C6 18.5523 5.55228 19 5 19H3C2.44772 19 2 18.5523 2 18C2 17.4477 2.44772 17 3 17V7C2.44772 7 2 6.55228 2 6ZM17.8519 9.22836C18.4001 9.0013 19.0033 8.94189 19.5853 9.05764C20.1672 9.1734 20.7018 9.45912 21.1213 9.87868C21.5409 10.2982 21.8266 10.8328 21.9424 11.4147C22.0581 11.9967 21.9987 12.5999 21.7716 13.1481C21.6417 13.4618 21.4601 13.7495 21.2361 14C21.4601 14.2505 21.6417 14.5382 21.7716 14.8519C21.9987 15.4001 22.0581 16.0033 21.9424 16.5853C21.8266 17.1672 21.5409 17.7018 21.1213 18.1213C20.7018 18.5409 20.1672 18.8266 19.5853 18.9424C19.0033 19.0581 18.4001 18.9987 17.8519 18.7716C17.3038 18.5446 16.8352 18.1601 16.5056 17.6667C16.1759 17.1734 16 16.5933 16 16C16 15.4477 16.4477 15 17 15C17.5523 15 18 15.4477 18 16C18 16.1978 18.0586 16.3911 18.1685 16.5556C18.2784 16.72 18.4346 16.8482 18.6173 16.9239C18.8 16.9996 19.0011 17.0194 19.1951 16.9808C19.3891 16.9422 19.5673 16.847 19.7071 16.7071C19.847 16.5673 19.9422 16.3891 19.9808 16.1951C20.0194 16.0011 19.9996 15.8 19.9239 15.6173C19.8482 15.4346 19.72 15.2784 19.5556 15.1685C19.3911 15.0587 19.1978 15 19 15C18.4477 15 18 14.5523 18 14C18 13.4477 18.4477 13 19 13C19.1978 13 19.3911 12.9414 19.5556 12.8315C19.72 12.7216 19.8482 12.5654 19.9239 12.3827C19.9996 12.2 20.0194 11.9989 19.9808 11.8049C19.9422 11.6109 19.847 11.4327 19.7071 11.2929C19.5673 11.153 19.3891 11.0578 19.1951 11.0192C19.0011 10.9806 18.8 11.0004 18.6173 11.0761C18.4346 11.1518 18.2784 11.28 18.1685 11.4444C18.0586 11.6089 18 11.8022 18 12C18 12.5523 17.5523 13 17 13C16.4477 13 16 12.5523 16 12C16 11.4067 16.1759 10.8266 16.5056 10.3333C16.8352 9.83994 17.3038 9.45543 17.8519 9.22836Z"/></svg>',command:"format.set"},h4:{title:"## buttons.heading ## 4",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M2 6C2 5.44772 2.44772 5 3 5H5C5.55228 5 6 5.44772 6 6C6 6.55228 5.55228 7 5 7V11H11V7C10.4477 7 10 6.55228 10 6C10 5.44772 10.4477 5 11 5H13C13.5523 5 14 5.44772 14 6C14 6.55228 13.5523 7 13 7V17C13.5523 17 14 17.4477 14 18C14 18.5523 13.5523 19 13 19H11C10.4477 19 10 18.5523 10 18C10 17.4477 10.4477 17 11 17V13H5V17C5.55228 17 6 17.4477 6 18C6 18.5523 5.55228 19 5 19H3C2.44772 19 2 18.5523 2 18C2 17.4477 2.44772 17 3 17V7C2.44772 7 2 6.55228 2 6ZM20.2898 9.04291C20.7115 9.17061 21 9.55933 21 10V15C21.5523 15 22 15.4477 22 16C22 16.5523 21.5523 17 21 17V18C21 18.5523 20.5523 19 20 19C19.4477 19 19 18.5523 19 18V17H16C15.6312 17 15.2923 16.797 15.1183 16.4719C14.9443 16.1467 14.9634 15.7522 15.1679 15.4453L19.1679 9.4453C19.4124 9.07864 19.868 8.91521 20.2898 9.04291ZM19 15V13.3028L17.8685 15H19Z"/></svg>',command:"format.set"},h5:{title:"## buttons.heading ## 5",command:"format.set"},h6:{title:"## buttons.heading ## 6",command:"format.set"},address:{title:"## buttons.address ##",command:"format.set"}},nested:[],nestedValue:[],nonparse:[],inlineGroups:{},tags:{denied:["font","html","head","link","title","body","meta","applet","marquee"],incode:["!DOCTYPE","!doctype","html","head","link","title","body","meta","textarea","style"],form:["form","input","button","select","textarea","legend","fieldset"],inline:["a","svg","span","strong","strike","b","u","em","i","code","del","ins","samp","kbd","sup","sub","mark","var","cite","small","abbr"],block:["pre","hr","ul","ol","li","p","h1","h2","h3","h4","h5","h6","dl","dt","dd","div","table","tbody","thead","tfoot","tr","th","td","blockquote","output","figcaption","figure","address","main","section","header","footer","aside","article","iframe"],parser:["pre","hr","ul","ol","p","h1","h2","h3","h4","h5","h6","table","address","blockquote","figure","iframe","form","dl","div","section","header","footer","article","main","aside"]},regex:{mp4video:/https?:\/\/\S+\.mp4/gi,youtube:/^https?\:\/\/(?:www\.youtube(?:\-nocookie)?\.com\/|m\.youtube\.com\/|youtube\.com\/)?(?:ytscreeningroom\?vi?=|youtu\.be\/|vi?\/|live|user\/.+\/u\/\w{1,2}\/|embed\/|watch\?(?:.*\&)?vi?=|\&vi?=|\?(?:.*\&)?vi?=)([^#\&\?\n\/<>"']*)/gi,vimeo:/(http|https)?:\/\/(?:www.|player.)?vimeo.com\/(?:channels\/(?:\w+\/)?|groups\/(?:[^/]*)\/videos\/|album\/(?:\d+)\/video\/|video\/|)(\d+)(?:\/[a-zA-Z0-9_-]+)?/gi,imageurl:/((https?|www)[^\s]+\.)(jpe?g|png|gif)(\?[^\s-]+)?/gi,url:/https?:\/\/(www\.)?[-a-zA-Z0-9@:%._+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z\u00F0-\u02AF0-9()!@:%_+.~#?&//=]*)/gi,aurl1:/(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim,aurl2:/(^|[^\/])(www\.[\S]+(\b|$))/gim}},d.lang.en={accessibility:{"help-label":"Rich text editor"},placeholders:{figcaption:"Type caption (optional)"},modal:{link:"Link",image:"Image","add-image":"Add Image"},embed:{embed:"Embed",title:"Title",poster:"Poster image",caption:"Caption",description:"Paste any embed/html code or enter the url (vimeo or youtube video only)","responsive-video":"Responsive video"},image:{or:"or","alt-text":"Alt Text",link:"Link",width:"Width",caption:"Caption","link-in-new-tab":"Open link in new tab","url-placeholder":"Paste url of image...","upload-new-placeholder":"Drag to upload a new image<br>or click to select"},link:{link:"Link","edit-link":"Edit Link",unlink:"Unlink","link-in-new-tab":"Open link in new tab",text:"Text",url:"URL"},table:{width:"Width (px or %)",nowrap:"Nowrap","table-cell":"Table cell","select-table":"Select table","select-cell":"Select cell","cell-setting":"Cell setting","add-head":"Add head","remove-head":"Remove head","add-row-below":"Add row below","add-row-above":"Add row above","remove-row":"Remove row","add-column-after":"Add column after","add-column-before":"Add column before","remove-column":"Remove column","delete-table":"Delete table"},buttons:{add:"Add",insert:"Insert",save:"Save",cancel:"Cancel",delete:"Delete","ai-tools":"AI Tools","ai-image":"AI Image",html:"HTML",format:"Format",bold:"Bold",italic:"Italic",deleted:"Deleted","more-formatting":"More formatting",link:"Link","link-text":"Link Text",unlink:"Unlink",image:"Image",unwrap:"Unwrap",outset:"Outset","wrap-image":"Wrap image","move-up":"Move up","move-down":"Move down",list:"List","numbered-list":"Numbered list","bullet-list":"Bullet list",indent:"Indent",outdent:"Outdent","definition-list":"Definition list",hotkeys:"Hotkeys",undo:"Undo",redo:"Redo",toggle:"Toggle",duplicate:"Duplicate",table:"Table",embed:"Embed",quote:"Quote",layout:"Layout",wrapper:"Wrapper",todo:"Todo","code-snippet":"Code snippet",line:"Line",parent:"Parent",code:"Code",underline:"Underline",highlight:"Highlight",superscript:"Superscript",subscript:"Subscript","clear-all-styles":"Clear all styles",heading:"Heading",text:"Text",address:"Address"},colorpicker:{"remove-color":"Remove color","remove-background":"Remove background color",color:"Color",background:"Background","set-color":"Set color"},pathbar:{title:"Body"},layout:{"select-layout":"Select layout","select-column":"Select column","single-column":"Single column","two-columns":"Two columns","three-columns":"Three columns","four-columns":"Four columns"},outset:{"outset-none":"Outset none","outset-left":"Outset left","outset-both":"Outset both","outset-right":"Outset right"},wrap:{"wrap-none":"Wrap none","wrap-left":"Wrap left","wrap-center":"Wrap center","wrap-right":"Wrap right"},blocks:{address:"Address",cell:"Cell",column:"Column",dlist:"Definition List",embed:"Embed",figcaption:"Figcaption",heading:"Heading",image:"Image",wrapper:"Wrapper",layout:"Layout",line:"Line",list:"List",listitem:"Item",noneditable:"Noneditable",pre:"Pre",quote:"Quote",row:"Row",table:"Table",text:"Text",todo:"Todo",todoitem:"Item",mergetag:"Mergetag"},hotkeys:{"meta-shift-a":"Select text in the block","meta-a":"Select all blocks","meta-z":"Undo","meta-shift-z":"Redo","meta-shift-m":"Remove inline format","meta-b":"Bold","meta-i":"Italic","meta-u":"Underline","meta-h":"Superscript","meta-l":"Subscript","meta-k":"Link","meta-alt-0":"Normal text","meta-alt-1":"Heading 1","meta-alt-2":"Heading 2","meta-alt-3":"Heading 3","meta-alt-4":"Heading 4","meta-alt-5":"Heading 5","meta-alt-6":"Heading 6","meta-shift-7":"Ordered List","meta-shift-8":"Unordered List","meta-indent":"Indent","meta-outdent":"Outdent","meta-shift-backspace":"Delete block","meta-shift-o":"Add block","meta-shift-d":"Duplicate block","meta-shift-up":"Move line up","meta-shift-down":"Move line down"}},function(t,e,s){this.dom=d.dom,this.ajax=d.ajax,this.uuid=s,this.$win=this.dom(window),this.$doc=this.dom(document),this.$body=this.dom("body"),this.keycodes=d.keycodes,this.element=new h(t),(this.app=this).disableMode=!1,this.readonlyMode=!1,this._priority=["container","source","editor","theme","toolbar","extrabar"],this._plugins=[],this._triggers={},this._props={},this._mode="default",this.initialSettings=e,this.started=!1,this.loaded=!1,this._initCore(),this._initModes(),this.opts.get("clicktoedit")?this.click():this.start()});l.prototype={click(){this.element.one("click.rx-clicktoedit",this.startClick.bind(this))},startClick(t){t.preventDefault(),t.stopPropagation();t=this.create("marker");this.broadcast("clicktoedit.before.start"),t.save(),this.start(!1,!0),t.restore(),this._iterate("click"),this.broadcast("clicktoedit.start"),this.editor.setBlurOther()},start(t,e){if(!this.isStarted())if(t&&(this.initialSettings=t),this.opts.get("clicktoedit")&&!0!==e)this.element.off("click.rx-clicktoedit"),this.startClick(!1);else{this._initCore(),this._initModes(),this.broadcast("app.before.start"),this.element.hideElement(),this._iterate("init"),this._iterate("start"),this._iterate("load");let t=setInterval(()=>{this.app.loaded&&(clearInterval(t),this._iterate("loaded"))},100);this.started=!0,this.broadcast("app.start"),this._buildReadonly(),this._buildDisabled()}},isStarted(){return this.started},stop(){this.isStopped()||(this.broadcast("app.before.stop"),this._iterate("stop"),this.element.showElement(),this._plugins=[],this.started=!1,this.opts.get("clicktoedit")&&this.element.one("click.rx-clicktoedit",this.startClick.bind(this)),this.broadcast("app.stop"))},isStopped(){return!this.started},disable(){this.editor.disable(),this._disable(),this.disableMode=!0},readonly(){this.editor.readonly(),this._disable(),this.readonlyMode=!0},isDisabled(){return this.disableMode},isReadonly(){return this.readonlyMode},_disable(){this.source.close(),this.ui.disable(),this.ui.close(),this.block.unset(),this.blocks.unset(),this.app.create("selection").remove()},enable(){this.editor.enable(),this.ui.enable(),this.disableMode=!1},editable(){this.editor.editable(),this.ui.enable(),this.readonlyMode=!1},getLayout(){return!!this.editor&&this.editor.getLayout()},getEditor(){return!!this.editor&&this.editor.getEditor()},getWin(){return this.isMode("iframe")?this.getFrameWin():this.$win},getWinNode(){return this.isMode("iframe")?this.getFrameWinNode():this.$win.get()},getDoc(){return this.isMode("iframe")?this.getFrameDoc():this.$doc},getDocNode(){return this.isMode("iframe")?this.getFrameDocNode():this.$doc.get()},getBody(){return this.$body},getFrameBody(){return this.isMode("iframe")?this.getFrameDoc().find("body"):this.$body},getFrameHead(){return this.getFrameDoc().find("head")},getFrameDoc(){return this.dom(this.getFrameDocNode())},getFrameDocNode(){var t=this.getEditor().get();return t.contentWindow?t.contentWindow.document:null},getFrameWin(){return this.dom(this.getFrameWinNode())},getFrameWinNode(){var t=this.getEditor().get();return t.contentWindow||null},has(t){return this[t]||this._plugins[t]},addTrigger(t,e,s){void 0===this._triggers[t]&&(this._triggers[t]=[]),this._triggers[t].push({instance:e,func:s})},destroy(){this.sync.destroy(),this.theme.destroy(),this.stop(),this.broadcast("app.destroy"),this.element.dataset(d.namespace,!1),this._clearInstance()},isProp(t){return this.getProp(t)},setProp(t,e){this._props[t]=e},getProp(t){return this._props[t]},removeProp(t){delete this._props[t]},isMode(t){return this._mode===t},setMode(t){this._mode=t},getMode(){return this._mode},broadcast(t,e){e=e instanceof p?e:new p(t,e);return this._broadcastTriggers(t,e),this._broadcastPlugins(t,e),this._broadcastCallbacks(t,e),e},broadcastHtml(t,e){return this.broadcast(t,{html:e}).get("html")},_broadcastTriggers(t,e){if(void 0!==this._triggers[t]){var s=this._triggers[t];for(let t=0;t<s.length;t++){var i=s[t];i.instance[i.func].call(i.instance,e)}}},_broadcastPlugins(t,e){let s=0,i,a=this._plugins.length,r,o,n;for(s;s<a;s++)if(void 0!==this[n=this._plugins[s]].subscribe){r=this[n].subscribe;for(var[l,h]of Object.entries(r))for(o=l.split(","),i=0;i<o.length;i++)o[i].trim()===t&&("string"==typeof h?this[n][h]:h).call(this[n],e)}},_broadcastCallbacks(t,e){var s=this.opts.get("callbacks"),s=s||{};"function"==typeof s[t]&&s[t].call(this,e)},api(o){if(o){let t=[].slice.call(arguments,1),e=o.split("."),s=e.pop(),i=this,a=0,r=e.length;for(a=0;a<r;a++)i=i[e[a]];return i&&"function"==typeof i[s]?i[s].apply(i,t):void 0}},create(t){let e=t.split("."),s="class";1<e.length&&(s=e[0],t=e[1]),void 0===d.mapping[s][t]&&("block"===s?(d.message(s+' "'+t+'" not found'),t="wrapper"):d.error("The "+s+' "'+t+'" does not exist.'));for(var i=[].slice.call(arguments,1),a=new d.mapping[s][t].proto,r=(a._name=t,a.app=this,["uuid","dom","ajax","$win","$doc","$body"]),o=0;o<r.length;o++)a[r[o]]=this[r[o]];this.lang&&(a.lang=this.lang),this.opts&&(a.opts=this.opts);let n;return(n=a.init?a.init.apply(a,i):n)||a},_initCore(){this.opts=this.create("opts"),this.lang=this.create("lang",this.opts)},_initModes(){this.opts.is("nocontainer")&&this.opts.extend(this.opts.get("modes.nocontainer")),this.opts.is("css")&&this.setMode("iframe")},_iterate(e){let s,i;for(let t=0;t<this._priority.length;t++)s=this._priority[t],void 0!==d.mapping.module[s]&&this._iterateItem("module",s,e);for(s of Object.keys(d.mapping.module))this._priority.includes(s)||this._iterateItem("module",s,e);if(void 0!==d.mapping.plugin){i=this.opts.get("plugins");for(let t=0;t<i.length;t++)s=i[t],void 0!==d.mapping.plugin[s]&&("init"===e&&this._plugins.push(s),this._iterateItem("plugin",s,e))}},_iterateItem(t,e,s){"init"===s?this[e]=this.create(t+"."+e):this._call(this[e],s)},_call(t,e){"function"==typeof t[e]&&t[e].apply(t)},_buildDisabled(){this.disableMode=this.opts.get("disabled")||this.element.isDisabled(),this.disableMode&&this.disable()},_buildReadonly(){this.readonlyMode=this.opts.get("readonly")||this.element.isReadonly(),this.readonlyMode&&this.readonly()},_clearInstance(){var t=d.instances.indexOf(this.uuid);-1<t&&d.instances.splice(t,1)}};class h extends o{constructor(t){super(),this.parse(t)}isTextarea(){return this.tagName("textarea")}isDisabled(){return null!==this.attr("disabled")}isReadonly(){return null!==this.attr("readonly")}hideElement(){this.isTextarea()&&this.hide()}showElement(){this.isTextarea()&&this.show()}setHtml(t){this.isTextarea()?this.val(t):this.html(t)}getHtml(){return this.isTextarea()?this.val():this.html()}getName(){return this.attr("name")}getPlaceholder(){return this.attr("placeholder")}}class p{constructor(t,e){this.name=t,this.params=void 0===e?{}:e,this.stopped=!1}is(e){if(!Array.isArray(e))return this.get(e);for(let t=0;t<e.length;t++)if(this.params[e[t]])return!0}has(t){return void 0!==this.params[t]}get(t){return this.has(t)?this.params[t]:null}getName(){return this.name}dump(){return this.params}set(t,e){this.params[t]=e}stop(){this.stopped=!0}isStopped(){return this.stopped}}d.add("mixin","block",{commonDefaults:{uid:{getter:"getUid",setter:"setUid"},time:{getter:"getTime",setter:"setTime",trigger:"updateTime"},id:{getter:"getId",setter:"setId"},style:{getter:"getStyle",setter:"setStyle"},classname:{getter:"getClassname",setter:"setClassname"},attrs:{getter:"getAttrs",setter:"setAttrs"},placeholder:{getter:"getPlaceholder",setter:"setPlaceholder"},noneditable:{getter:"getNoneditable",setter:"setNoneditable"}},init(t,e,s){t instanceof o||t instanceof Element?(this.element=t,this.params=e):this.params=t,this.renderDataBlock=s,this.params=this.params||{},this.start&&this.start(),this.render()},render(){if(this._createData(this.params),this.element?(this.$block=this.dom(this.element),this.parse&&this.parse()):(this.element=this.create(),this.$block=this.element,this.build&&this.build()),this.data.build(),!1!==this.renderDataBlock){let t=this.$block.attr("data-rx-attrs");t&&(t=t.replace(/'/g,'"'),this.setAttrs(JSON.parse(t)),this.$block.removeAttr("data-rx-attrs")),this._renderInlineBlocks(),this.$block.dataset("instance",this),this.$block.attr("data-rx-type",this.getType()),this.isInline()&&this.$block.attr("data-rx-inline",!0),this.isEditable()?this.$block.attr("contenteditable",!0):!1===this.isEditable()&&this.$block.attr("contenteditable",!1),(this.isNondeletable()||this.isNondeletableParent())&&this.$block.attr("contenteditable",!1),this.isFocusable()&&this.$block.attr("data-rx-focusable",!0)}},trigger(t){var e,s,i=this._buildTriggers();for([e,s]of Object.entries(i))1===s.trigger.split(".").length?this[s.trigger].apply(this):this.app.api(s.trigger,this)},isAllowedButton(t,e){var s=e.blocks,i=this.getType();if(void 0===e.blocks)return!0;if(s.except&&-1!==s.except.indexOf(i))return!1;if(s.all){if(!0===s.all||"all"===s.all)return!0;if("editable"===s.all&&this.isEditable())return!0;if("first-level"===s.all&&this.isFirstLevel())return!0;if("noneditable"===s.all&&this.isType("noneditable"))return!0}return!(!Array.isArray(s.types)||-1===s.types.indexOf(i))},isFocusable(){return void 0!==this.props.focusable},isInline(){return this.props.inline},isEditable(){return this.props.editable},isNondeletable(){return this.$block.attr("data-noneditable")},isNondeletableParent(){return 0!==this.$block.closest("[data-noneditable=true]").length},isType(t){return-1!==(Array.isArray(t)?t:[t]).indexOf(this.props.type)},isFigure(){return"figure"===this.getTag()},isFirstLevel(){return this.$block.attr("data-rx-first-level")},isEmpty(t,e){return this._isEmpty(this.$block,t,e)},isParent(){return this.props.parent},isLastElement(){return!0},isAllSelected(){return!this.isEditable()||this.app.create("selection").isFullySelected(this.$block)},isCaretStart(){var t=this.app.create("caret"),e=this.app.create("selection");return this.isType(["list","todo"])?!e.is()||(e=e.getCurrent(),0===this.dom(e).closest("li").prevElement().length&&t.is(this.$block,"start")):!this.isEditable()||t.is(this.$block,"start")},isCaretEnd(){var t=this.app.create("caret");return this.isType("address")?t.is(this.$block,"end",!1,!0,!1):!this.isEditable()&&!this.isType(["todo","list"])||t.is(this.$block,"end")},isReorder(){return!1!==this.props.reorder},isContext(){return this.props.context},hasTime(){return this.$block.attr("data-time")},hasUid(){return this.$block.attr("data-uid")},findPreviousElement(){var t=this.app.editor.getLayout().get();let e=this.$block.get(),s=e.previousElementSibling;for(;!s&&e.parentElement;)e=e.parentElement,s=e.previousElementSibling;return s&&t.contains(s)?this.dom(s)?.dataget("instance"):null},findNextElement(){var t=this.app.editor.getLayout().get();let e=this.$block.get(),s=e.nextElementSibling;for(;!s&&e.parentElement;)e=e.parentElement,s=e.nextElementSibling;return s&&t.contains(s)?this.dom(s)?.dataget("instance"):null},getTitle(){var t=this.getType(),e=this.lang.get("blocks"),s=this.$block.attr("data-title");return(void 0!==e[t]?e[t]:s)||t.charAt(0).toUpperCase()+t.slice(1)},getProp(t){return void 0!==this.props[t]?this.props[t]:null},getType(){return this.props.type},getTag(){return this.$block.tagName()},getBlock(){return this.$block},getJson(){return this.data.getData(!0)},getOuterHtml(){return this.$block.get().outerHTML},getHtml(){return this.$block.html()},getPlainText(){return this._getPlainText(this.$block)},getOffset(){return this.$block.offset()},getFirstLevel(){var t=this.$block.closest("[data-rx-first-level]").last();return 0!==t.length&&t.dataget("instance")},getClosest(t){t=this.$block.parent().closest(this._buildTraverseSelector(t));return 0!==t.length&&t.dataget("instance")},getNextParent(){var t=this.isType("todoitem")?this.getClosest(["todo"]):this.getClosest(["table","wrapper","layout"]);let e=!1;return e=t?t.getNext():e},getPrevParent(){var t=this.isType("todoitem")?this.getClosest(["todo"]):this.getClosest(["table","wrapper","layout"]);let e=!1;return e=t?t.getPrev():e},getParent(){let t=this.props.parent,e;return!(!(e=void 0!==t?this.$block.parent().closest(this._buildTraverseSelector(t)):this.$block.parent().closest("[data-rx-type]"))||0===e.length)&&e.dataget("instance")},getFirst(t){t=this.$block.find("[data-rx-type"+(t=t?"="+t:"")+"]").first();return 0!==t.length&&t.dataget("instance")},getLast(t){t=this.$block.find("[data-rx-type"+(t=t?"="+t:"")+"]").last();return 0!==t.length&&t.dataget("instance")},getNext(t){var e=this.$block.nextElement();return!(0===e.length||!e.is(this._buildTraverseSelector(t)))&&e.dataget("instance")},getPrev(t){var e=this.$block.prevElement();return!(0===e.length||!e.is(this._buildTraverseSelector(t)))&&e.dataget("instance")},getControl(){return!this.isInline()&&this.props.control},getToolbar(){return this.props.toolbar},getExtrabar(){return this.props.extrabar},getButtons(t){return this.props[t]},getPlaceholder(){return this.$block.attr("data-placeholder")},getId(){return this.$block.attr("id")},getStyle(){var t=this.$block.clone(),e=this.app.create("utils"),t=t.attr("style"),e=e.cssToObject(t);return this.isType("column")&&delete e["flex-basis"],0!==Object.keys(e).length?e:null},getAttrs(){var t={};if(this.params.attrs)for(var e of Object.keys(this.params.attrs))t[e]=this.$block.data(e);return 0!==Object.keys(t).length?t:null},getAttr(t){return this.params.attrs&&this.params.attrs[t]?this.params.attrs[t]:null},getClassname(t){let e=this.$block.clone(),s;if(t){s="none";for(var[i,a]of Object.entries(t))this.$block.hasClass(a)&&(s=i);return s}return e.removeClass("rx-block-placeholder rx-block-focus rx-layout-grid rx-block-control-focus data-rx-parsed data-rx-first-level data-rx-inline data-rx-focusable"),""===(s=e.attr("class"))?null:s},getContent(){var t=this.$block.clone(),t=this.unparseInlineBlocks(t);return(t=this.unparseInlineStyle(t)).html().trim()},getChildren(){let t=this.$block.children(),e=[],s;return t.each(function(t){(s=t.dataget("instance"))&&e.push(s.getJson())}),e},getUid(){return this.$block.attr("data-uid")},getTime(){var t=this.$block.attr("data-time");return!0===t||!1===t?null:t},getData(t){return this.data.getData(t)},getNoneditable(){return this.$block.data("noneditable")},get(t){return this.data.get(t)},set(t,e){this.data.set(t,e)},setData(t){this.data.setData(t)},setEmpty(t){if(this.isType("todoitem"))this.$content.html("");else{if(t){t=this.$block.find(this.opts.get("tags.inline").join(",")).first();if(0!==t.length)return void t.html("")}this.$block.html("")}},setContent(t){this.$block.html(t)},setId(t){this._setAttr(this.$block,"id",t)},setStyle(t){var e=this.app.create("cleaner");this.$block.css(t),""===this.$block.attr("style")&&this.$block.removeAttr("style"),e.cacheElementStyle(this.$block)},setClassname(t,e){e&&this._removeObjClasses(e),"none"!==t&&this.$block.addClass(t)},setAttr(t,e){this.params.attrs=this.params.attrs||{},this.params.attrs[t]=e,this.$block.attr(t,e,!0)},setAttrs(t){if(t)for(var[e,s]of Object.entries(t))this.setAttr(e,s)},setUid(t){this._setAttr(this.$block,"data-uid",t)},setTime(t){this._setAttr(this.$block,"data-time",t)},setPlaceholder(t){this._setAttr(this.$block,"data-placeholder",t)},setCaret(t){this.app.create("caret").set(this.$block,t)},setNoneditable(t){this._setAttr(this.$block,"data-noneditable",t)},updateTime(){this.hasTime()&&this.setTime((new Date).getTime())},generateUid(){return Date.now().toString(36)+Math.floor(Math.pow(10,12)+9*Math.random()*Math.pow(10,12)).toString(36)},duplicate(t){var e=this.getType(),s=this.$block.clone(),t=(s.removeClass("rx-block-focus"),s.removeAttr("data-rx-type"),this._renderInsideClone(s),t&&s.html(""),this.app.create("block."+e,s));return this._renderInlineBlocks(t.getBlock(),!0),t},duplicateEmpty(){return this.duplicate(!0)},removeAttr(t){this.params.attrs&&this.params.attrs[t]&&delete this.params.attrs[t],this.$block.removeAttr(t)},removeData(t){this.data.remove(t)},removeCaption(){this.figcaption&&(this.$figcaption.remove(),this.figcaption=!1,this.$figcaption=!1)},remove(t){var e=this.getType(),s=!!this.isInline()&&this.getParent();(t=d.extend({},{traverse:!1,broadcast:!1},t)).traverse?this._removeTraverse():(this.$block.remove(),s&&this.app.block.set(s)),t.broadcast&&this.app.broadcast("block.remove",{type:e})},insert(t){this._compositionCutting();var e=this.app.create("insertion"),s={instance:!1,position:"after",caret:!1,remove:!0,type:"add",current:this},s=(t=d.extend({},s,t),e.insert(t));return"add"===t.type&&this.app.broadcast("block.add",{inserted:s}),this._isIOS()&&s.getBlock().focus(),s},insertEmpty(t){return(t=t||{}).instance=this.app.block.create(),this.insert(t)},_compositionCutting(){var t;this._isIOS()&&(t=document.activeElement,document.querySelector("#rxCompositionCutter"+this.uuid).focus({preventScroll:!0}),t.focus({preventScroll:!0}))},_isIOS(){var t=navigator.userAgent||navigator.vendor||window.opera;return/iPad|iPhone|iPod/.test(t)&&!window.MSStream},change(t,e){var s=t.getBlock();this.$block.after(s),this.$block.remove(),this.app.editor.build(),this.app.block.set(s),!1!==e&&this.app.broadcast("block.change",{instance:t})},move(t){var e="up"===t?this.getPrev():this.getNext(),t="up"===t?"before":"after";e&&(this.isEditable()&&this.app.editor.save(this.getBlock()),e.getBlock()[t](this.getBlock()),this.app.block.set(this,!1,!0),this.isEditable())&&this.app.editor.restore(!1)},appendNext(){let t=this.getNext(),e=t.getHtml(),s=this.getType(),i=t.getType(),a=!0,r=!0,o,n,l=!0;if(!t.isNondeletable())if(t.isEmpty())t.remove();else if(this.isEmpty())this.remove(),this.app.block.set(t,"start");else{var h;if("pre"===s&&"pre"!==i&&(e=t.getPlainText()),"list"===i&&(r="list"===s?(h=t.getBlock().children(),this.$block.append(h),!(a=!1)):(e=this._appendListHtml(t.getBlock(),e),t.isEmpty())),a){if("dlist"===i&&"dlist"===s)return n=t.getBlock().children(),this.$block.append(n),void t.remove();"dlist"===i?e=this._appendDlistHtml(e):"todo"===i?(o=t.getFirstItem(),e=t.getFirstContent().html(),o.remove(),r=t.isEmpty()):"pre"===i?(e=t.getContent(),l=!1):"quote"===i&&(e=t.getPlainText()),this._insertHtml(e,l)}r&&t.remove()}},appendToPrev(){let t=this.getPrev(),e=t.getType(),s=this.getHtml(),i=this.getType(),a=!0,r=!0,o,n=this.app.create("caret"),l;if(!t.isNondeletable())if(this.isEmpty())this.remove(),this.app.block.set(t,"end");else if(t.isEmpty())t.remove();else{var h;if("pre"!==i&&"pre"===e&&(s=this.getPlainText()),"list"===i&&(r="list"===e?(h=this.getBlock().children(),this.app.block.set(t,"end"),t.getBlock().append(h),!(a=!1)):(s=this._appendListHtml(this.getBlock(),s),this.isEmpty())),"dlist"===i&&(s=this._appendDlistHtml(s)),a){if(l="pre"!==e&&"todo"!==e,"dlist"===i&&"dlist"===e)return o=this.$block.children(),t.getBlock().append(o),n.set(o.first(),"start"),void this.remove();"quote"===i&&(s=this.$block.text()),this.app.block.set(t,"end"),this._insertHtml(s,l)}r&&this.remove()}},parseItems(t,e){this.$block.find(t).each(function(t){t.attr("data-rx-type")||this.app.create("block."+e,t)}.bind(this))},parseCaption(){var t=this.$block.find("figcaption");0!==t.length&&(this.figcaption=this.app.create("block.figcaption",t),this.$figcaption=this.figcaption.getBlock())},unparseInlineBlocks(t){return t.find("[data-rx-inline]").removeAttr("data-rx-type data-rx-inline contenteditable tabindex").removeClass("rx-block-focus"),""===t.attr("class")&&t.removeAttr("class"),t},unparseInlineStyle(t){return t.find("[data-rx-style-cache]").removeAttr("data-rx-style-cache"),t},_buildCaption(t){var e;this.isFigure()&&t&&(0!==(e=this.$block.find("figcaption")).length?(this.figcaption=this.app.create("block.figcaption",e,{content:t}),this.$figcaption=this.figcaption.getBlock()):(this.figcaption=this.app.create("block.figcaption",{content:t}),this.$figcaption=this.figcaption.getBlock(),this.$block.append(this.$figcaption)))},_buildTraverseSelector(t){let e;return e=Array.isArray(t)?"[data-rx-type="+t.join("],[data-rx-type=")+"]":"[data-rx-type"+(t=t?"="+t:"")+"]"},_buildTriggers(){var t,e,s=d.extend(!0,{},d.triggers),i=this.data.dump();for([t,e]of Object.entries(i))e.trigger&&(s[t]={trigger:e.trigger});return s},_setAttr(t,e,s){""===s?t.removeAttr(e):t.attr(e,s)},_createData(t){this.data=this.app.create("block-data",this,this.defaults,this.commonDefaults,t)},_createInstance(t,e){return this.app.create("block."+t,e)},_renderInlineBlocks(t,s){this.isType("noneditable")||(t=t||this.$block).find("["+this.opts.get("dataBlock")+"]").each(function(t){var e;!s&&t.attr("data-rx-type")||(e=t.attr(this.opts.get("dataBlock")),this.app.create("block."+e,t))}.bind(this))},_renderInsideClone(t){t.find("[data-rx-type]").each(t=>{var e=t.attr("data-rx-type");this.app.create("block."+e,t)})},_isEmpty(t,e,s){t=this.dom(t);let i=t.text();var a=this.app.create("utils"),r=t.find("br").length,o=t.find("svg").length;if((i=(i=a.removeInvisibleChars(i)).replace(/\r?\n/g,""),e&&(i=i.trim()),s&&""===i)&&0!==t.find(this.opts.get("tags.inline").join(",")).first().length)return!1;return""===i&&0===o&&r<2},_insertHtml(t,e){var s=this.app.create("caret"),i=this.app.create("selection"),a=this.app.create("insertion"),i=i.getInlineTop();!1!==e&&i&&s.set(i,"after"),a.insertHtml(t,"start")},_appendListHtml(t,e){var t=t.find("li").first(),s=this.app.create("cleaner");return e=(e=(e=t.html().trim()).replace(/<\/li>/gi,"</li><br>")).replace(/<(ul|ol)/gi,"<br><$1"),e=(e=(e=s.removeTags(e,["ul","ol","li"])).trim()).replace(/<br\s?\/?>$/gi,""),t.remove(),e},_appendDlistHtml(t){return this.app.create("utils").wrap(t,function(t){t.find("dt, dd").unwrap()}.bind(this))},_getPlainText(t){var t=t.html(),e=this.app.create("marker"),s=this.app.create("utils"),t=e.replaceToText(t);return t=s.getTextFromHtml(t,{nl:!0}),e.replaceToMarker(t)},_buildObjClasses(t){var e,s=[];for(e of Object.values(t))s.push(e);return s},_removeObjClasses(t){var t=this._buildObjClasses(t),e=this.app.create("element");this.$block.removeClass(t.join(" ")),e.removeEmptyAttr(this.$block,"class")},_removeTraverse(){let t=this.getNext(),e=this.getPrev();var s=this.getClosest(["wrapper","todo","list"]),i=this.getClosest(["column","cell"]);this.$block.remove(),s&&s.isEmpty(!0)&&(t=s.getNext(),e=s.getPrev(),s.remove()),i&&i.isEmpty(!0)?(s=this.app.block.create(),i.insert({instance:s,position:"append"}),this.app.block.set(s,"start")):t?this.app.block.set(t,"start"):e?this.app.block.set(e,"end"):this.app.block.unset()}}),d.add("mixin","tool",{init(t,e,s,i){this.name=t,this.setter=s.getSetter(),this.popup=s,this.data=i,this.obj=this._observe(e),this.prefix="rx",this.obj&&this._build()},getElement(){return this.$tool},getInput(){return this.$input},getValue(){return this.$input.val().trim()},setValue(t){this.$input.val(t)},setFocus(){this.$input.focus()},trigger(t){this.setValue(t),this.setter&&this.app.api(this.setter,this.popup)},_build(){this._buildTool(),this._buildLabel(),this._buildInputElement(),this._buildInput(),this._buildEvent(),this._has("placeholder")&&this.$input.attr("placeholder",this.lang.parse(this.obj.placeholder)),this._has("width")&&this.$input.css("width",this.obj.width),this._has("classname")&&this.$input.addClass(this.obj.classname)},_buildInputElement(){this.$input=this.dom("<"+this._getInputParam("tag")+">").addClass(this.prefix+this._getInputParam("classname")),this.$input.attr({name:this.name,type:this._getInputParam("type"),"data-type":this.type}),this.$input.dataset("instance",this)},_buildInput(){},_buildEvent(){var t;-1===["segment"].indexOf(this.type)&&this.setter&&(t="checkbox"===this.type||"select"===this.type?"change":"input blur",t="number"===this.type?t+" change":t,this.$input.on(t,this._catchSetter.bind(this)))},_buildTool(){this.$tool=this.dom("<div>").addClass(this.prefix+"-form-item").dataset("instance",this),this._has("hidden")&&this.obj.hidden&&this.$tool.hide()},_buildLabel(){var t;"checkbox"!==this.type&&this._has("label")&&(this.$label=this.dom("<label>").addClass(this.prefix+"-form-label").html(this.lang.parse(this.obj.label)),this.obj.hint&&(t=this.dom('<span class="rx-form-hint">').html("("+this.lang.parse(this.obj.hint)+")"),this.$label.append(t)),this.$tool.append(this.$label))},_getInputParam(t){return this.input&&void 0!==this.input[t]?this.input[t]:""},_get(t){return this.obj[t]},_has(t){return Object.prototype.hasOwnProperty.call(this.obj,t)},_observe(t){return t=Object.prototype.hasOwnProperty.call(t,"observer")?this.app.api(t.observer,t,this.name):t},_catchSetter(t){"keydown"===t.type&&13!==t.which||("keydown"===t.type&&t.preventDefault(),this.app.api(this.setter,this.popup))}}),d.add("class","opts",{init(){this.opts=this._initializeOptions(this.app.initialSettings)},dump(){return this.opts},is(t){t=this.get(t);return void 0!==t&&!1!==t},set(t,a){t.split(".").reduce((t,e,s,i)=>t[e]=s===i.length-1?a:t[e]||{},this.opts)},get(t){return t.split(".").reduce((t,e)=>t?.[e],this.opts)},extend(t){this.opts=d.extend(!0,{},this.opts,t)},remove(t){var t=t.split("."),e=t.pop();delete t.reduce((t,e)=>t[e]||{},this.opts)[e]},_initializeOptions(t){var e=d.extend(!0,{},d.opts),e=d.extend(!0,e,d.settings),s=this._parseDataAttributes(),e=(this._updateObject(e,s),d.extend(!0,e,s,t));return this._configureCallbacks(e),this._configureTranslations(e),e},_updateObject(s,i){Object.keys(s).forEach(t=>{var e=t.toLowerCase();i.hasOwnProperty(e)&&("object"==typeof s[t]&&null!==s[t]&&"object"==typeof i[e]?this._updateObject(s[t],i[e]):s[t]=i[e])})},_parseDataAttributes(){var t=this.app.element.get();const e={};return Array.from(t.attributes).forEach(t=>{t.name.startsWith("data-")&&this._processAttribute(t,e)}),e},_processAttribute(s,t){const i=s.name.slice(5).split("-");let a=t;i.forEach((t,e)=>{e===i.length-1?a[t]=this._parseValue(s.value):a=this._getOrCreateNextLevel(a,t)})},_parseValue(e){try{return JSON.parse(e)}catch(t){try{var s=e.replace(/(\w+)\s*:/g,'"$1":').replace(/:\s*([\w\[\]{]+)\s*/g,': "$1"').replace(/'/g,'"');return JSON.parse(s)}catch(t){return e}}},_getOrCreateNextLevel(t,e){return t[e]&&"object"==typeof t[e]&&!Array.isArray(t[e])||(t[e]={}),t[e]},_configureCallbacks(s){s.subscribe&&(s.callbacks={},Object.entries(s.subscribe).forEach(([t,e])=>{t.split(",").map(t=>t.trim()).forEach(t=>{s.callbacks[t]=e})}))},_configureTranslations(t){t.translations&&d.addLang(t.translations)}}),d.add("class","lang",{init(t){this.opts=t,this.langKey=this.opts.get("lang"),this.vars=this._initializeLanguage()},dump(){return this.vars},has(t){return""!==this.get(t)},set(t){d.extend(!0,d.lang,t),this.vars=this._initializeLanguage()},get(t){t=this._fetchFromVars(t)||"en"!==this.langKey&&this._fetchFromDefaultLang(t);return void 0===t?"":t},parse(t){return"string"!=typeof t?t:this._replaceLanguageVariables(t)},_fetchFromVars(t){return this._getValue(t,this.vars)},_fetchFromDefaultLang(t){return this._getValue(t,d.lang.en)},_replaceLanguageVariables(s){var t=s.match(/## (.*?) ##/g);return t&&t.forEach(t=>{var e=t.replace(/## /g,"").replace(/ ##/g,"");s=s.replace(t,this.get(e))}),s},_getValue(t,e){return t.split(".").reduce((t,e)=>t&&t[e],e)},_initializeLanguage(){return d.lang[this.langKey]||d.lang.en}}),d.add("class","accessibility",{init(t){this.$editor=t.getEditor(),this._assignAriaAttributes(),this._prependAccessibilityLabel()},destroy(){this.$editor.removeAttr("aria-labelledby role")},_assignAriaAttributes(){this.$editor.attr({"aria-labelledby":"rx-voice",role:"presentation"})},_prependAccessibilityLabel(){var t=this.lang.get("accessibility.help-label"),t=this._createAccessibilityLabel(t);this.app.container.get("main").prepend(t)},_createAccessibilityLabel(t){return this.dom("<span>").attr({id:"rx-voice-"+this.uuid,"aria-hidden":!1}).addClass("rx-voice-label").html(t)}}),d.add("class","content",{init(){this.sourceType="element",this.type=this.opts.is("data")?"json":"html",this._buildContent(),this._buildBroadcast(),this._buildParsed(),this._buildUnparsed()},getSourceType(){return this.sourceType},getType(){return this.type},getContent(t){let e=this.app.editor.getHtml();var s=this.app.create("unparser"),i=this.app.create("tidy");return e=s.unparse(e),e=t?i.parse(e):e},getJson(){let e=[];return this.app.editor.getLayout().children("[data-rx-type]").each(function(t){t=t.dataget("instance");e.push(t.getJson())}),e},set(t,e){this.content=t,this.type=e||"html",this._buildParsed(),this._buildUnparsed()},isJson(){return"json"===this.type},_buildContent(){this.content=this._getElementContent()},_buildBroadcast(){this.content=this.app.broadcastHtml("editor.before.load",this.content)},_buildParsed(){var t=this.app.create("parser").parse(this.content,{type:this.type,start:!0,nodes:!0});this.app.editor.setHtml(t)},_buildUnparsed(){var t=this.app.create("unparser"),e=this.app.editor.getHtml(),e=t.unparse(e);this.app.source.setContent(e),!this.isJson()&&this.app.element.isTextarea()&&this.app.editor.setSource(e)},_getElementContent(){let t;return t=this.opts.is("content")?(this.sourceType="content",this.opts.get("content")):this.opts.is("data")?(this.sourceType="data",this.opts.get("data")):this.app.element.getHtml()}}),d.add("class","offset",{get(t){this.node=this._node(t);t=this.app.getWinNode().getSelection();if(t&&0<t.rangeCount){var e=t.getRangeAt(0);if(this.node.contains(t.anchorNode))return{start:t=this._cloneRangeForNode(e).toString().length,end:t+e.toString().length}}return!1},set(t,e){this.node=this._node(e);e=this._createRangeForOffset(t),t=this.app.getWinNode().getSelection();t&&(t.removeAllRanges(),t.addRange(e))},_node(t){return(t?this.dom(t):this.app.getLayout()).get()},_createRangeForOffset(t){var e=this.app.getDocNode().createRange();e.setStart(this.node,0),e.collapse(!0);let s=0,i=[this.node],a,r=!1;for(;a=i.pop();)if(3===a.nodeType){var o=s+a.length;if(!r&&t.start>=s&&t.start<=o&&(e.setStart(a,t.start-s),r=!0),r&&t.end>=s&&t.end<=o)return e.setEnd(a,t.end-s),e;s=o}else for(let t=a.childNodes.length-1;0<=t;t--)i.push(a.childNodes[t]);return e},_cloneRangeForNode(t){var e=t.cloneRange();return e.selectNodeContents(this.node),e.setEnd(t.startContainer,t.startOffset),e}}),d.add("class","marker",{create(t){return this._buildMarker(t)},createHtml(t){return this._buildMarker(t).outerHTML},insert(){this.remove();var t,e,s,i,a=this.app.create("selection"),r=a.getRange();r&&(t=this._buildMarker("start"),e=this._buildMarker("end"),s=r.cloneRange(),i=a.isCollapsed(),this._insertMarkers(r,s,t,e,i),a.updateRange(r))},save(){this.insert()},restore(){var t,e=this.find("start"),s=this.find("end");e&&(t=this._restoreSelection(e,s),this._cleanUpMarkers(e,s),this.app.editor.setWinFocus(),this.app.create("selection").setRange(t))},find(t){let e=this.app.getLayout(),s=!1;var i;return e&&(i={start:this._getMarkerById(e,"start"),end:this._getMarkerById(e,"end")},s=t?i[t]:i),s},replaceToText(t){return this._replaceMarkersWithText(t)},replaceToMarker(t){return this._replaceTextWithMarkers(t)},remove(){this._remove(this.find("start")),this._remove(this.find("end"))},_insertMarkers(t,e,s,i,a){a||(e.collapse(!1),e.insertNode(i)),e.setStart(t.startContainer,t.startOffset),e.collapse(!0),e.insertNode(s),t.setStartAfter(s),a||t.setEndBefore(i)},_restoreSelection(t,e){var s=this.app.getDocNode().createRange(),i=this._getNextNode(t),a=this._getPreviousNode(e);return this._setRangeBasedOnMarkers(s,t,e,i,a),s},_cleanUpMarkers(t,e){this._remove(t),this._remove(e)},_getMarkerById(t,e){t=t.find("#rx-selection-marker-"+e);return 0!==t.length&&t.get()},_replaceMarkersWithText(t){return this.app.create("utils").wrap(t,t=>{t.find("#rx-selection-marker-start").replaceWith("---marker-start---"),t.find("#rx-selection-marker-end").replaceWith("---marker-end---")})},_replaceTextWithMarkers(t){var e=this._buildMarker("start").outerHTML,s=this._buildMarker("end").outerHTML;return t.replace("---marker-start---",e).replace("---marker-end---",s)},_remove(t){var e;t&&(e=this._getParent(t),t.parentNode.removeChild(t),e)&&e.normalize()},_buildMarker(t="start"){var e=this.dom("<span>");return e.attr("id","rx-selection-marker-"+t).addClass("rx-selection-marker").html(this.opts.get("markerChar")),e.get()},_getParent(t){t=this.dom(t).closest(["p","h1","h2","h3","h4","h5","h6","pre","div","address","li","ul","ol","dl","td","th","blockquote"].join(","));return 0!==t.length&&t.get()},_getNextNode(t){return(!t.nextSibling||3!==t.nextSibling.nodeType||""!==t.nextSibling.textContent.replace(/[\n\t]/g,""))&&t.nextSibling},_getPreviousNode(t){return!!t&&t.previousSibling},_setRangeBasedOnMarkers(t,e,s,i,a){s?i&&"rx-selection-marker-end"===i.id?(t.selectNodeContents(e),t.collapse(!1),t.setStart(i,0)):(t.setStartAfter(e),s&&t.setEndBefore(s)):i?(t.selectNodeContents(i),t.collapse(!0)):(t.selectNodeContents(e),t.collapse(!1))}}),d.add("class","caret",{set(t,e){var t=this._node(t),s=this.app.create("selection"),i=this.app.getDocNode().createRange();e&&t&&this._isInPage(t)&&(this.app.editor.setWinFocus(),this._isInline(t)&&this._isNoneditable(t)&&(e=this._adjustTypeForNonEditable(e)),this[{start:"_setStart",end:"_setEnd",before:"_setBefore",after:"_setAfter"}[e]](i,t),s.setRange(i))},is(t,e,s,i,a){var t=this._node(t),r=this.app.getWinNode().getSelection();return!(!t||!r.isCollapsed)&&(r=this._getPosition(t,i,a),a=this._getSize(t,s,i),this._comparePositionWithType(r,a,e))},_node(t){return this.dom(t).get()},_adjustTypeForNonEditable(t){return"start"===t?"before":"end"===t?"after":t},_comparePositionWithType(t,e,s){return"end"===s?t===e:"start"===s&&0===t},_setStart(t,e){this._setRangeStartToNodeStart(t,e),this._handleInlineNodeAtStart(t,e)},_setRangeStartToNodeStart(t,e){t.setStart(e,0),t.collapse(!0)},_handleInlineNodeAtStart(t,e){var s=this._getInlineInside(e);s?this._setRangeStartInline(t,s):this._isInline(e)&&this._insertInvisibleNode(t)},_setRangeStartInline(t,e){e=this.app.create("element").getInlines(e)[0];t.selectNodeContents(e),t.collapse(!0)},_setEnd(t,e){var s=e.lastChild;s&&this._isInline(s)?1===s.childNodes.length&&1===s.childNodes[0].nodeType&&["svg","br"].includes(s.childNodes[0].tagName.toLowerCase())?this._setAfter(t,s):(t.selectNodeContents(s),t.collapse(!1)):(t.selectNodeContents(e),t.collapse(!1))},_setBefore(t,e){t.setStartBefore(e),t.collapse(!0),this._isInline(e)&&this._insertInvisibleNode(t,e)},_setAfter(t,e){t.setStartAfter(e),t.collapse(!0);var s=3!==e.nodeType&&e.tagName.toLowerCase();!this._isInline(e)&&"br"!==s&&"svg"!==s||this._insertInvisibleNode(t)},_insertInvisibleNode(t,e){var s=this.app.create("utils").createInvisibleChar();e?e.parentNode.insertBefore(s,e):t.insertNode(s),t.selectNodeContents(s),t.collapse(!1)},_getInlineInside(t){let e=t.firstChild;for(;e&&this._isInline(e);){if(!e.firstChild||!this._isInline(e.firstChild))return e;e=e.firstChild}return this._isInline(e)?e:null},_getSize(t,e,s){let i,a=3===t.nodeType;return i=e&&0!==e.length?this._removeSpecifiedBlocks(t,e):(i=a?t.textContent:t.innerHTML,a||!1===s?i:i.trim()),this._trimmed(i,a,s).length},_removeSpecifiedBlocks(t,e){t=this.dom(t).clone(),e=e.join(",");return t.find(e).remove(),t.html().trim()},_getPosition(t,e,s){var i,a,r,o=this.app.getWinNode().getSelection();return 0!==o.rangeCount&&(i=(o=o.getRangeAt(0)).cloneRange(),a=document.createElement("div"),r=3===t.nodeType,i.selectNodeContents(t),i.setEnd(o.endContainer,o.endOffset),a.appendChild(i.cloneContents()),t=r||!1===e?a.innerHTML:a.innerHTML.trim(),o=this._adjustForBr(t,s),(t=this._trimmed(t,r,e)).length+o)},_adjustForBr(t,e){t=/<\/?br\s?\/?>$/i.test(t);return e&&t?1:0},_trimmed(t,e,s){var i=this.app.create("utils");return!1===s?t.replace(/\n$/g,""):""===(t=(t=(t=i.removeInvisibleChars(t)).replace(/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,"")).replace(/\s+/g," "))||e?t:t.replace(/\s$/,"")},_isInline(t){return this.app.create("element").is(t,"inline")},_isInPage(t){return t&&t.nodeType&&this.app.getDocNode().body.contains(t)},_isNoneditable(t){return"false"===t.getAttribute("contenteditable")}}),d.add("class","selection",{init(){this.sel=this._get()},is(t){return void 0===t?!!this.sel:(t=this._node(t),this.getNodes().includes(t))},contains(t){var e=this.getCurrent();return!!e&&this._node(t).contains(e)},isCollapsed(){return this._collapsed(this.sel,this.getRange())},isFullySelected(t){var e,s;return!this.isCollapsed()&&(e=t?this._node(t):this.app.editor.getLayout().get(),t=!t||this.is(e),s=this.getRange(),t)&&e.textContent&&e.textContent.trim().length===s.toString().trim().length},isBackwards(){var t,e=this.sel;return!(!e||e.collapsed)&&((t=this.app.getDocNode().createRange()).setStart(e.anchorNode,e.anchorOffset),t.setEnd(e.focusNode,e.focusOffset),e=t.collapsed,t.detach(),e)},isCursorInFirstOrLastLine(){var t,e,s=this.app.getWinNode().getSelection();return s.rangeCount&&(s=s.getRangeAt(0),(t=this.app.getDocNode().createRange()).setStart(s.startContainer,0),t.setEnd(s.startContainer,s.startOffset),(t=t.getClientRects()).length)&&((e=this.app.getDocNode().createRange()).setStart(s.endContainer,s.endOffset),e.setEnd(s.endContainer,s.endContainer.length||s.endContainer.childNodes.length),(e=e.getClientRects()).length)?(t=t[0].top,e=e[e.length-1].bottom,{isFirstLine:s.getBoundingClientRect().top<=t,isLastLine:e<=s.getBoundingClientRect().bottom}):{isFirstLine:!1,isLastLine:!1}},getRange(){return!!(this.sel&&0<this.sel.rangeCount)&&this.sel.getRangeAt(0)},setRange(t){var e=this.app.getWinNode().getSelection();this.updateRange(t,e),this.update()},updateRange(t,e){(e=e||this.sel)&&(e.removeAllRanges(),e.addRange(t))},getCurrent(){return!!this.sel&&this.sel.anchorNode},getParent(){var t=this.getCurrent();return!!t&&t.parentNode},getClosest(t){var e=this.getCurrent(),e=this.dom(e).closest(t);return 0!==e.length&&e.get()},getElement(t){return this._element(t,"element")},getInline(t){return this._element(t,"inline")},getInlineTop(t,e){var s=this.app.create("element");let i=t?this._node(t):this.getCurrent(),a=(i.nodeType===Node.TEXT_NODE&&(i=i.parentNode),null);for(;i&&(i.nodeType!==Node.ELEMENT_NODE||!s.is(i,"inline")||(a=i).tagName.toLowerCase()!==e);)i=i.parentNode;return a},getBlock(t){return this._element(t,"block")},getBlockControlled(t){let e=t?this._node(t):this.getCurrent();for(;e;){if(1===e.nodeType&&e.getAttribute("data-rx-type"))return this.dom(e);e=e.parentNode}return this.dom()},getNodes(t){var e,s;return this.is()?(e=this.getRange(),s=this.app.editor.isSelectAll()?[...this.app.editor.getLayout().get().getElementsByTagName("*")]:this._nodes(e,t?.partial),0<(s=[...new Set(s)]).length?this._filter(s,e,t):s):[]},getPosition(t){let e=this.getRange(),s={top:0,left:0,right:0,bottom:0,width:0,height:0},i,a;return this.app.getWinNode().getSelection&&e.getBoundingClientRect&&(a=(e.startContainer===e.endContainer&&this.isFullySelected(e.startContainer)||(e=e.cloneRange(),"end"===t?e.setStart(e.endContainer,e.endOffset):(i=e.startOffset-1,e.setStart(e.startContainer,i<0?0:i))),e.getBoundingClientRect()),s={top:a.top,bottom:a.bottom,left:a.left,right:a.right,width:a.right-a.left,height:a.bottom-a.top}),s},getText(t,e,s){if(!this.sel)return!1;var i,a=this.getRange();let r;return t&&a?(s=s?this._node(s):this.app.editor.getLayout().get(),e=void 0===e?1:e,i=a.cloneRange(),"before"===t?(i.collapse(!0),i.setStart(s,0),r=!0===e?i.toString():i.toString().slice(-e)):"after"===t&&(i.selectNodeContents(s),i.setStart(a.endContainer,a.endOffset),r=!0===e?i.toString():i.toString().slice(0,e))):r=this.sel?this.sel.toString():"",r},getHtml(){var t,e;return this.sel?(t=this.getRange().cloneContents(),(e=document.createElement("div")).appendChild(t),e.innerHTML.replace(/<p><\/p>$/i,"")):""},update(){this.sel=this._get()},select(t){var e,t=t?this._node(t):this.app.editor.getLayout().get();t&&((e=this.app.getDocNode().createRange()).selectNodeContents(t),this.setRange(e))},remove(){this.sel&&(this.sel.removeAllRanges(),this.sel=!1)},truncate(){var t=this.getRange();!this.isCollapsed()&&t&&t.deleteContents()},collapse(t){t=t||"start",this.sel&&!this.isCollapsed()&&("start"===t?this.sel.collapseToStart():this.sel.collapseToEnd())},_node(t){return this.dom(t).get()},_element(e,s){if(this.sel){var i=this.app.create("element");let t=e||this.getCurrent();for(t=this._node(t);t;){if(i.is(t,s))return t;t=t.parentNode}}return!1},_get(){var t=this.app.getWinNode().getSelection(),e=this.app.getLayout();return 0<t.rangeCount&&0<this.dom(t.anchorNode).closest(e).length&&t},_collapsed(t,e){return!t||!e||t.isCollapsed||0===e.toString().length},_nodes(t,e){let s;var i=t.startContainer.childNodes[t.startOffset]||t.startContainer,a=t.endContainer.childNodes[t.endOffset]||t.endContainer,r=t.commonAncestorContainer,o=[];if(this.app.editor.isEditor(i)||o.push(i),e)for(3===i.nodeType&&o.unshift(this.getBlock(i)),s=i;s&&s!==r&&(3===s.nodeType||0!==this.dom(s.parentNode).closest(r).length)&&(o.push(s),s!==a);s=this._next(s));else{for(s=i.parentNode;s&&!this.app.editor.isEditor(s)&&(o.push(s),s!==r);s=s.parentNode);for(o.reverse(),s=i;s&&(3!==s.nodeType&&"TR"===s.tagName&&o.unshift(this.dom(s).closest("table").get()),3===s.nodeType||0!==this.dom(s.parentNode).closest(r).length)&&(o.push(s),s!==a);s=this._next(s));}return o},_next(t){if(t.firstChild)return t.firstChild;for(;t;){if(t.nextSibling)return t.nextSibling;t=t.parentNode}},_text(){var t=this.getText();return t?t.replace(/[-[\]/{}()*+?.\\^$|]/g,"\\$&"):""},_filter(t,s,i){const a=this._text(),r=this.app.create("element");return t.filter(t=>{if(this.app.editor.isEditor(t))return!1;let e=!0;return i&&(e=i.types?this._filterByTypes(e,i,t,r):e,e=i.selected?this._filterBySelected(e,i,t,s,a):e,e=i.tags?this._filterByTags(e,i,t):e,e=i.type?this._filterByType(e,i,t,r):e),e})},_filterByTags(t,e,s){var i=void 0!==s.tagName;return t=i&&-1!==e.tags.indexOf(s.tagName.toLowerCase())?t:!1},_filterBySelected(t,e,s,i,a){return!0!==e.selected||this._textIn(i,s)?"inside"===e.selected&&(t=1===s.nodeType&&"A"===s.tagName||this._textSel(s,a)):t=!1,t},_filterByType(t,e,s,i){var a=!1===e.inline?"block-data-not-inline":e.type;return"inline"===e.type?(e.link?i.is(s,e.type)||(t=!1):(1!==s.nodeType||"A"!==s.tagName)&&i.is(s,e.type)||(t=!1),e.buttons&&i.is(s,e.type,!1)&&(t=!0)):i.is(s,a)||(t=!1),t},_filterByTypes(t,e,s,i){i=i.getType(s);return t=-1===e.types.indexOf(i)?!1:t},_isInNodesArray(t,e){return-1!==t.indexOf(e)},_textSel(t,e){var s=this.app.create("utils"),t=9!==t.nodeType?s.removeInvisibleChars(t.textContent):"";return e===t||t.includes(e)||new RegExp(`^${s.escapeRegExp(t)}$`).test(e)},_textIn(t,e){var s=this.app.getDocNode().createTreeWalker(e,NodeFilter.SHOW_TEXT,t=>NodeFilter.FILTER_ACCEPT,!1);let i,a,r;for(;r=s.nextNode();)i=i||r,a=r;var o=t.cloneRange();return i?(o.setStart(i,0),o.setEnd(a,a.length)):o.selectNodeContents(e),t.compareBoundaryPoints(Range.START_TO_START,o)<=0&&0<=t.compareBoundaryPoints(Range.END_TO_END,o)},get(){return this.sel},isAll(t){return this.isFullySelected(t)}}),d.add("class","utils",{isMobileDevice(){var t="ontouchstart"in window||0<navigator.maxTouchPoints||0<navigator.msMaxTouchPoints,e=navigator.userAgent.toLowerCase(),e=/mobile|android|iphone|ipad|tablet|blackberry|phone/i.test(e);return t||e},isFirefox(){return"undefined"!=typeof navigator&&navigator.userAgent.toLowerCase().includes("firefox")},createInvisibleChar(){return document.createTextNode(this.opts.get("markerChar"))},searchInvisibleChars(t){return t.search(/^\uFEFF$/g)},removeInvisibleChars(t){return t.replace(/\uFEFF/g,"")},wrap(t,e){var s=this.dom("<div>").html(t);return e(s),t=s.html(),s.remove(),t},isEmptyHtml(t,e){var s=this.app.create("cleaner");return t=t.trim(),t=(t=(t=(t=(t=(t=(t=(t=(t=s.removeInvisibleChars(t)).replace(/^&nbsp;$/gi,"1")).replace(/&nbsp;/gi,"")).replace(/<\/?br\s?\/?>/g,"")).replace(/\s/g,"")).replace(/^<p>\s\S<\/p>$/i,"")).replace(/<hr(.*?[^>])>$/i,"hr")).replace(/<iframe(.*?[^>])>$/i,"iframe")).replace(/<source(.*?[^>])>$/i,"source"),t=s.removeComments(t),t=e?t.replace(/<p[^>]*><\/p>/gi,""):t,""===(t=(t=(t=(t=e?t.replace(/<div[^>]*><\/div>/gi,""):t).replace(/<[^/>]><\/[^>]+>/gi,"")).replace(/<[^/>]><\/[^>]+>/gi,"")).trim())},isLine(t,e){var s,i,a;return!(this.opts.is("breakline")||(s=this.dom(document.createElement("div")).html(t),i=this.opts.get("tags"),s=0===s.find(i.block.join(",")+",img").length,i=-1!==t.search(/div><br\s?\/?><div/i),a=-1!==t.search(/<br(.*?[^>])><br(.*?[^>])>/i),this.isPlainText(t)&&-1!==t.search(/\n\n/gi))||a||i||s&&"paste"===e&&-1!==t.search(/\n\n/gi)||!s)},isPlainText(t){var e=this.opts.get("tags.block");return!new RegExp(`</?(${e.join("|")})\\b[^>]*>`,"i").test(t)},extractHtmlFromCaret(t){var e,t=this._getNode(t),s=this.app.create("selection").getRange();if(s)return(e=s.cloneRange()).selectNodeContents(t),e.setStart(s.endContainer,s.endOffset),e.extractContents()},getTextFromHtml(t,e){let s,i="",a,r=0,o=this.app.create("cleaner");if(e=d.extend({},{br:!1,nl:!1,trimlines:!0,images:!1,links:!1},e),t=o.store(t,"code"),t=e.links?o.store(t,"links"):t,t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=e.images?o.store(t,"images"):t).replace(/\n\s+<span/gi," <span")).replace(/span>\n\s+/gi,"span> ")).replace(/<(ul|ol)>\s+<li>/gi,"<$1><li>")).replace(/<li[^>]*>\n/gi,"<li$1>")).replace(/<p[^>]*>(\s+|)<\/p>/gi,"xemptyz")).replace(/<!--[\s\S]*?-->/gi,"")).replace(/<style[\s\S]*?style>/gi,"")).replace(/<script[\s\S]*?script>/gi,"")).replace(/<\/(div|li|dt|dd|td|p|H[1-6])>\n?/gi,"</$1>\n")).replace(/&(lt|gt);/gi,"x$1z"),s=this.dom("<div>").html(t),t=this.getText(s.get()),e.trimlines){for(i="",a=t.split("\n"),r;r<a.length;r++)i+=a[r].trim()+"\n";t=i}return t=(t=(t=t.replace(/[\n]+/g,"\n")).replace(/xemptyz/g,"\n")).replace(/x(lt|gt)z/gi,"&$1;"),t=e.br?(t=t.replace(/\n/g,"<br>\n")).replace(/<br\s?\/?>\n?$/gi,""):e.nl?t:t.replace(/\n/gi," "),t=o.restore(t,"code"),t=e.links?o.restore(t,"links"):t,t=(t=(t=(t=(t=e.images?o.restore(t,"images"):t).replace(/<pre[^>]*>/g,"")).replace(/<code[^>]*>/g,"")).replace(/<\/pre>\n?/g,"")).replace(/<\/code>/g,""),(t=e.images?t:(t=t.replace(/<img[\s\S]*?>/gi,"")).replace(/<a[^>]*>(\s+|)<\/a>/gi,"")).trim()},getText(t){var e="";if(3===t.nodeType)e=t.nodeValue;else{for(var s=0;s<t.childNodes.length;s++)e+=this.getText(t.childNodes[s]);var i=1===t.nodeType?getComputedStyle(t).getPropertyValue("display"):"";(i.match(/^block/)||i.match(/list/)||"BR"===t.tagName||"HR"===t.tagName)&&(e+="\n")}return e},findTodoItemTag(){return this.dom("<div>").html(this.opts.get("todo.templateContent")).children().first().tagName()},parseMarkdown(t){t=t.split("\n");const i=/^(#{1,6})\s+(.*)$/,a=/!\[([^\]]*)\]\(([^)\s]+)(?:\s+"([^"]+)")?\)/g,r=/\[([^\]]+)\]\(([^)\s]+)(?:\s+"([^"]+)")?\)/g;return t.map(t=>{var e,s=t.match(i);return t=(t=(t=(t=s?`<h${e=s[1].length}>${s[2]}</h${e}>`:t).replace(/^(\-|\d\.)\s?\*\*/g,"**").replace(/^\- (.*)$/g,"<ul><li>\n$1</li></ul>").replace(/^\d\.(.*)$/g,"<ol><li>\n$1</li></ol>")).replace(a,(t,e,s,i)=>{return`<img src="${s}" alt="${e}"${i?` title="${i}"`:""}>`})).replace(r,(t,e,s,i)=>{return`<a href="${s}"${i?` title="${i}"`:""}>${e}</a>`})}).join("\n").replace(/(<\/ul>\n<ul>|<\/ol>\n<ol>)/g,"")},extendArrayWithoutDuplicates(t,e){return[...new Set([...t,...e])]},extendArray(e,s){if(e=[...e],s)for(let t=0;t<s.length;t++)e.push(s[t]);return e},removeFromArrayByValue(t,e){let s,i=0,a;for(e=Array.isArray(e)?e:[e],i=0,a=e.length;i<a;i++)-1<(s=t.indexOf(e[i]))&&t.splice(s,1);return t},sumOfArray(t){return t.reduce(function(t,e){return parseInt(t)+parseInt(e)},0)},cssToObject(t){for(var e,s=/([\w-]*)\s*:\s*([^;]*)/g,i={};null!=(e=s.exec(t))&&(i[e[1]]=this._normalizeValue(e[1],e[2].trim())),e;);return i},_normalizeValue(t,e){return e=(e="string"==typeof e?e.replace(/'/g,'"'):e).trim().replace(/;$/,""),-1!==t.search(/color|background/)&&(e=(e=this.convertRgb2hex(e)).toLowerCase()),-1!==t.search(/family/)&&(e=e.replace(/"/g,"")),e="border"===t&&(t=e.match(/rgb\((.*?)\)/gi))?e.replace(t[0],this.convertRgb2hex(t[0])):e},getInvertedColor(t){return t=this.normalizeColor(t=""===t||null==t?"#ffffff":t),t=this._removeHexDiese(t),186<.299*parseInt(t.slice(0,2),16)+.587*parseInt(t.slice(2,4),16)+.114*parseInt(t.slice(4,6),16)?"black":"white"},normalizeColor(t){return t=(t=t&&this.convertRgb2hex(t))&&this.convertShorthex2long(t)},convertRgb2hex(t){return-1===t.search(/^rgb/i)?t:(t=t.match(/^rgba?[\s+]?\([\s+]?(\d+)[\s+]?,[\s+]?(\d+)[\s+]?,[\s+]?(\d+)[\s+]?/i))&&4===t.length?"#"+("0"+parseInt(t[1],10).toString(16)).slice(-2)+("0"+parseInt(t[2],10).toString(16)).slice(-2)+("0"+parseInt(t[3],10).toString(16)).slice(-2):""},convertShorthex2long(t){return 3===(t=this._removeHexDiese(t)).length?"#"+t[0]+t[0]+t[1]+t[1]+t[2]+t[2]:"#"+t},replaceRgbToHex(t){return t.replace(/rgb\((.*?)\)/g,function(t,e){return"#"+e.split(",").map(function(t){return 1===(t=parseInt(t).toString(16)).length?"0"+t:t}).join("")})},escapeRegExp(t){return t.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&")},escapeBackslash(t){return t.replace(/\//g,"/")},extendData(t,e){for(var s in e)t="elements"===s?this._extendDataElements(t,e[s]):this._setData(t,s,e[s]);return t},getRandomId(){let e="",s="abcdefghijklmnopqrstuvwxyz0123456789";for(let t=0;t<12;t++)e+=s.charAt(Math.floor(Math.random()*s.length));return e},_extendDataElements(s,t){return this.dom(t).each(function(t){if(t.tagName("form")){let e=t.serialize(!0);Object.keys(e).forEach(function(t){s=this._setData(s,t,e[t])}.bind(this))}else{var e=t.attr("name")?t.attr("name"):t.attr("id");s=this._setData(s,e,t.val())}}.bind(this)),s},_setData(t,e,s){return t instanceof FormData?t.append(e,s):t[e]=s,t},_getNode(t){return this.dom(t).get()},_removeHexDiese(t){return 0===t.indexOf("#")?t.slice(1):t}}),d.add("class","block-data",{init(t,e,s,i){this.block=t,this.data=d.extend(!0,e,s),this._initializeData(i)},build(){Object.entries(this.data).forEach(([,t])=>{t.value&&t.setter&&"function"==typeof this.block[t.setter]&&this.block[t.setter](t.value)})},dump(){return this.data},is(t){return!!this.get(t)},get(t){return this.data[t]?.value},set(t,e){this.data[t]||(this.data[t]={}),this.data[t].value=e},add(t,e){Array.isArray(this.data[t])||(this.data[t]=[]),this.data[t].push(e)},remove(t){delete this.data[t]},setData(t){Object.entries(t).forEach(([t,e])=>{this.data[t]&&this.data[t].setter&&this.block[this.data[t].setter](e)})},getData(s){let i={type:this.block.getType()};return Object.entries(this.data).forEach(([t,e])=>{(!0===s||"items"!==t&&"children"!==t)&&(s&&"getHtml"===e.getter&&"text"===t&&(e.getter="getContent"),e.getter)&&"function"==typeof this.block[e.getter]&&null!==(e=this.block[e.getter].apply(this.block))&&(i[t]=e)}),i},getValues(){return Object.entries(this.data).filter(([,t])=>void 0!==t.value).reduce((t,[e,s])=>(t[e]=s.value,t),{})},_initializeData(t){t&&Object.entries(t).forEach(([t,e])=>{this.set(t,e)})}}),d.add("class","parser",{init(){this.defaults={type:"html",start:!1,nodes:!1,state:!1,paragraphize:this.opts.get("paragraphize")},this.parsedAttr="data-rx-type"},build(t){return this._buildNodes(t)},parse(t,e){let s,i="";switch(this.defaults=d.extend(!0,this.defaults,e),this.defaults.type){case"json":s=this.app.create("parser-json",this);break;case"line":s=this.app.create("parser-line",this);break;default:s=this.app.create("parser-html",this)}return i=s.parse(t,this.defaults),i="json"!==this.defaults.type?this._buildResult(i):i},clean(e,t){var s=this.opts.get("templateSyntax"),i=this.opts.get("nonparse"),a=this.app.create("utils"),r=this.app.create("cleaner");s&&(this.opts.set("clean.comments",!1),e=r.storeTemplateSyntax(e,s)),this.app.has("email")&&(e=this.app.email.parseBlocks(e)),e=(e=(e=r.storeComments(e)).replace(/¤t/gi,"&current")).replace(/<[^>]+>/g,function(t){return t.replace(/\s+/g," ")}),t&&t.start&&this.app.element.isTextarea()&&(e=r.encodeCode(e)),e=r.sanitize(e),e=r.convertForms(e),e=r.convertFrames(e);for(let t=0;t<i.length;t++)e=r.store(e,i[t]);e=r.store(e,"embed"),e=r.store(e,"svg"),e=r.store(e,"noparse"),e=r.removeTags(e,this.opts.get("tags.denied")),e=r.removeDoctype(e),e=r.removeTagsWithContent(e,["script","style"]),e=r.removeEmptySpans(e),e=r.addHttps(e),e=r.removeBlockTagsInside(e,["li","dt","dd","address"]),e=r.cacheStyle(e);for(let t=0;t<i.length;t++)e=r.restore(e,i[t]);return e=r.restore(e,"embed"),e=r.restore(e,"noparse"),e=r.restore(e,"svg"),e=r.restoreComments(e),e=this.opts.is("clean.comments")?r.removeComments(e):e,e=(e=a.isEmptyHtml(e)?this.app.block.createHtml():this.app.create("paragraphizer",t.paragraphize).parse(e)).replace(/<div>\s*<\/div>/gi,"<div></div>")},replaceTags(t){let i=this.opts.get("replaceTags");if(i){let e=Object.keys(i);var a=this.app.create("utils");let s=this.app.create("element");"string"==typeof t?t=a.wrap(t,function(t){t.find(e.join(",")).each(function(t){s.replaceToTag(t,i[t.tagName()])})}):t.find(e.join(",")).each(function(t){s.replaceToTag(t,i[t.tagName()])})}return t},_buildResult(e){if(this.defaults.nodes){let t=this._buildNodes(e);e=(t=this.app.has("email")?this.app.email.parse(t):t).get().childNodes}return e},_buildNodes(t){var e=this.dom("<div>");return e.html(t),e.find("["+this.parsedAttr+"]").each(this._buildNode.bind(this)),e},_buildNode(t){var e=t.attr(this.parsedAttr);this.app.create("block."+e,t)}}),d.add("class","parser-html",{init(t){this.parser=t,this.parsedAttr=t.parsedAttr},parse(t,e){this.defaults=e,this.utils=this.app.create("utils"),this.elm=this.app.create("element");e=this.app.create("paragraphizer",this.parser.defaults.paragraphize);return t=t.trim(),t=this.app.broadcastHtml("editor.before.parse",t),t=this.utils.isEmptyHtml(t)?this.app.block.createHtml():(t=this.parser.clean(t,this.defaults),t=this._parseBlocks(t),t=this.parser.replaceTags(t),t=e.parseLayers(t),this._parseLayersNodes(t)),t=this.app.broadcastHtml("editor.parse",t)},_parseBlocks(t){let e=this.app.create("predefined");return this.utils.wrap(t,function(t){this._parseElements(t),e.parse(t)}.bind(this))},_parseElements(t){let e=this.elm.getBlocks(t),s=0,i;for(s=0,i=e.length;s<i;s++)this._parseNode(e[s])},_parseNode(t){var t=this.dom(t),e=this.opts.get("nested"),s=this.opts.get("nestedValue"),i=t.tagName(),i=this._parseType(t,i);i&&t.attr(this.parsedAttr,i),-1!==(e=e.indexOf(i))&&(!0===s[e]?this._parseElements(t):t.find(s[e]).each(this._parseElements.bind(this)))},_parseType(t,e){let s;var i=this.opts.get("dataBlock");return s=t.attr(this.parsedAttr)?t.attr(this.parsedAttr):t.attr(i)?t.attr(i):this._parseTypeByTag(t,e)},_parseTypeByTag(t,e){let s;switch(e){case"p":s="text",this._isImageBlock(t,"p")&&(s="image");break;case"figure":s="embed",this._isImageBlock(t,"figure")?s="image":this._hasChild(t,"pre")?s="pre":this._hasChild(t,"blockquote")&&(s="quote");break;case"div":s="wrapper",this._isLayoutBlock(t,"div")?s="layout":this._isColumnBlock(t,"div")?s="column":this._isImageBlock(t,"div")?s="image":this._isTextBlock(t)&&(s="text");break;case"h1":case"h2":case"h3":case"h4":case"h5":case"h6":s="heading";break;case"blockquote":s="quote";break;case"table":s="table";break;case"pre":s="pre";break;case"hr":s="line";break;case"dl":s="dlist";break;case"address":s="address";break;case"ul":case"ol":s="list",this._isTodo(t)&&(s="todo");break;default:s="wrapper"}return s},_parseLayersNodes(t){let e=this.app.create("predefined");return this.utils.wrap(t,function(t){t.find("[data-rx-tag]").each(this._parseLayersDataTag.bind(this)),t.find("[data-rx-type=wrapper],[data-rx-type=column]").each(function(t){this._parseElements(t),e.parse(t)}.bind(this))}.bind(this))},_parseLayersDataTag(e){if(!e.attr("data-rx-type")){let t="text";this._isImageBlock(e,"div")&&(t="image",e.removeAttr("data-rx-tag")),e.attr(this.parsedAttr,t)}},_isLayoutBlock(t,e){var s=this.opts.get("layout.grid");if(s&&t.hasClass(s))return!0},_isColumnBlock(t,e){var s=this.opts.get("layout.column");if("layout"===t.parent().data("rx-type")||s&&t.hasClass(s))return!0},_isImageBlock(s,i){var a=s.find("img");if(0!==a.length&&("div"!==i||0===a.closest("figure").length)){let t=a;a=a.parent();let e=a;var r=0!==a.length&&a.tagName();if(r&&["a","span"].includes(r)&&(t=a,e=a.parent()),e.get()===s.get()&&0===t.prevElement().length&&("figure"===i||0===t.nextElement().length))return!0}},_isTextBlock(t){var e=t.children().first();return 0===this.app.create("element").getBlocks(t).length&&(0===e.length||!this.elm.is(e,"block")||void 0)},_isTodo(t){t=t.children().first();if(0!=t.length){var e=this.opts.get("todo.template"),s=this.opts.get("todo.templateItem"),i=s.replace(/\s/g,""),a=this.opts.get("todo.templateItemDone"),t=t.html();if(e)return this._checkToTemplateMatch(e,t);e=t.startsWith(s)||t.startsWith(i),s=t.startsWith(a);if(e||s)return!0}return!1},_checkToTemplateMatch(t,e){t="^"+t.replace(/\$checked/g,"\\[(x| )\\]").replace(/\$content/g,"(.*)")+"$";return new RegExp(t).test(e)},_hasChild(t,e){if("pre"===e){if(0!==t.find("pre").length)return!0}else if("blockquote"===e&&(e=t.find("blockquote"),0===t.find("script").length)&&0!==e.length)return!0}}),d.add("class","parser-json",{init(t){this.parser=t,this.parsedAttr=t.parsedAttr},parse(t,e){this.defaults=e;let s,i=(this.app.create("utils"),this.app.create("predefined")),a=this.dom("<div>");return a=this._render(a,t.blocks),i.parse(a),s=this.defaults.nodes?a.children():a.html(),s=this.parser.replaceTags(s)},_render(t,e,s){let i,a,r;var o=this.opts.get("nonparse");for(i of Object.values(e))a=this.app.create("block."+i.type,i,s).getBlock(),r=-1===o.indexOf(i.type)&&!1!==s&&void 0,i.children&&this._render(a,i.children,r),t.append(a);return t}}),d.add("class","parser-line",{init(t){this.parser=t,this.parsedAttr=t.parsedAttr},parse(t,e){return this.defaults=e,t=" "===t?"&nbsp;":(t=this.app.broadcastHtml("editor.before.parse",t),t=this._parseInlineBlocks(t),t=this._clean(t),this.app.broadcastHtml("editor.parse",t))},_clean(t){var e=this.app.create("cleaner");return t=e.encodeCode(t),t=e.removeTags(t,this.opts.get("tags.denied")),t=e.removeTagsWithContent(t,["script","style"]),t=e.sanitize(t),t=e.removeEmptySpans(t),t=e.addHttps(t),t=this.parser.replaceTags(t)},_parseInlineBlocks(t){let e,s=this.app.create("utils");return s.wrap(t,function(t){t.find("["+this.opts.get("dataBlock")+"]").each(function(t){t.attr("data-rx-type")||(e=t.attr(this.opts.get("dataBlock")),this.app.create("block."+e,t))}.bind(this))}.bind(this))}}),d.add("class","unparser",{init(){this.defaults={type:"html",state:!1,clipboard:!1},this.parsedAttr="data-rx-type"},unparse(t,e){return this.defaults=d.extend(!0,this.defaults,e),this._unparse(t)},unparseClasses(t){return t.removeClass("rx-block-placeholder rx-block-focus rx-block-meta-focus rx-block-control-focus rx-layout-grid"),t.removeClass("rx-nowrap"),t},_unparse(t){let e=this.opts.get("templateSyntax"),s=this.app.create("utils"),i=this.app.create("predefined"),a=this.app.create("parser"),r=this.app.create("cleaner"),o=this.opts.get("classes");return t=t.trim(),t=this.app.broadcastHtml("editor.before.unparse",t),this.app.has("email")&&!this.defaults.clipboard&&(t=this.app.email.unparseBlocks(t)),s.isEmptyHtml(t)?"":(t=r.revertForms(t),t=r.revertFrames(t),t=r.store(t,"noneditable"),t=r.store(t,"embed"),t=r.addNofollow(t),t=r.removeMarkers(t),t=r.removeInvisibleChars(t),t=r.restore(t,"noneditable"),t=r.restore(t,"embed"),t=r.recacheStyle(t),t=r.removeEmptyAttrs(t,["style","class","rel","alt","title"]),t=a.replaceTags(t),t=this._unparseAllTags(t),t=this._unparseDataType(t),t=this._unparseDataTag(t),t=r.removeEmptyAttrs(t,["style","class","rel","alt","title"]),o&&(t=s.wrap(t,function(t){i.parse(t)}.bind(this))),"<p></p>"===(t=e?r.restoreTemplateSyntax(t,e):t)&&(t=""),this.app.has("email")&&(t=this.app.email.unparse(t)),t=(t=(t=r.decodeSpecialCharsInAttributes(t)).replace(/&amp;/g,"&")).replace(/&quot;(.*?)&quot;/gi,"'$1'"),t=s.replaceRgbToHex(t),this.app.broadcastHtml("editor.unparse",t))},_unparseAllTags(t){return this.app.create("utils").wrap(t,function(t){t.find(".rx-ai-main").remove(),t.find(".rx-inserted-node").remove(),t.find("#rx-image-resizer").remove(),t.find("*").removeAttr("contenteditable data-gramm_editor data-rx-cont-width"),this.opts.is("image.states")||t.find("img").removeAttr("data-image")}.bind(this))},_unparseDataType(t,e){let s=this.defaults.state,i=this.app.create("utils"),a=this.app.create("cleaner"),r;return i.wrap(t,function(t){r=t.find("[data-rx-type]"),!0!==s&&r.removeClass("rx-block-state"),r.removeAttr("tabindex data-rx-parsed data-rx-width data-rx-first-level data-rx-inline data-rx-focusable"),(r=this.unparseClasses(r)).each(this._unparseByType.bind(this)),r.removeAttr("data-rx-type"),t.find("figcaption").removeAttr("data-rx-type data-placeholder").each(a.removeEmptyTag.bind(this))}.bind(this))},_unparseByType(t){var e=t.attr("data-rx-type");"embed"===e?this._unparseEmbed(t):"todo"===e&&this._unparseTodo(t)},_unparseDataTag(t){let s=this.app.create("utils");return t=(t=(t=s.wrap(t,function(t){t.find("[data-rx-tag]").each(function(t){var e=this.dom(t);e.removeAttr("data-rx-tag"),""===e.attr("style")&&e.removeAttr("style"),""===e.attr("class")&&e.removeAttr("class"),0===e.get().attributes.length&&this._unwrapNode(e,t,s)}.bind(this))}.bind(this))).replace(/<br\s?\/?>$/g,"")).replace(/<br\s?\/?><\/(td|th|div)>/g,"</$1>")},_unwrapNode(t,e,s){(s.isEmptyHtml(t.html())?t.html("<br>"):e.lastChild&&"BR"===e.lastChild.tagName?t:t.append("<br>")).unwrap()},_unparseEmbed(t){var e=decodeURI(t.attr("data-embed-content"));t.find("."+this.opts.get("embed.classname")).html(e),t.removeAttr("data-embed-content")},_unparseTodo(t){let a=this.app.create("utils").findTodoItemTag(),r=this.opts.get("todo.templateItem"),o=this.opts.get("todo.templateItemDone"),n=this.opts.get("todo.template");t.find("li").each(t=>{var e="0"===t.attr("data-checked")?r:o,s=(t.find("[data-rx-type]").removeAttr("data-rx-type"),t.removeAttr("data-checked"),t.find(a).html());let i=e+" "+s;n&&(i=(i=n.replace(/\$checked/gi,e)).replace(/\$content/gi,s)),t.html(i)})}}),d.add("class","event-action",{drop(t,e,s,i){var a=this.app.create("element"),r=this.app.create("insertion"),o=this.app.create("utils"),n=this.app.create("autoparse"),a=0===(a=a["after"===s?"getFirstLevel":"getDataBlock"](t.target)).length?this.app.blocks.get({first:!0}):a;this.app.block.set(a),s||r.insertPoint(t);let l=!0,h=!0;a=this.app.block.get(),t=this.app.editor.isSelectAll();if(a&&a.isType("pre")&&!t&&(l=!1,h=!1,e=o.getTextFromHtml(e,{nl:!0,trimlines:!1})),!1===i&&(l=!1,e=n.parse(e)),""!==e)return e=l?n.parse(e):e,r.insert({html:e,clean:l,parse:h,position:s})},paste(t){t.preventDefault();let e=t.clipboardData,s=this.app.create("clipboard"),i=this.app.create("utils"),a=this.app.create("cleaner"),r=this.app.create("insertion"),o=this.app.create("autoparse"),n=this.app.block.get(),l=e.getData("URL"),h=e.getData("text/rtf"),p=s.getContent(e),d=this.opts.is("image")&&this.opts.is("image.upload"),c=this.app.image.insertFromClipboard(e),u,g,m,b=!1,f=!0,v=!0,C=this.app.editor.isSelectAll();d&&c||(this.app.event.setPasteEvent(),(g=this.app.broadcast("editor.before.paste",{e:t,html:p})).isStopped()||(p=g.get("html"),p=l&&""!==l?l:p,this.opts.is("paste.plaintext")?(f=!1,v=!1,p=i.getTextFromHtml(p,{br:!0})):n&&"pre"===n.getType()&&!C?(b=!0,f=!1,v=!1,p=i.getTextFromHtml(p,{nl:!0,trimlines:!1})):this.opts.is("paste.clean")||(f=!1),p=this.opts.is("paste.links")?p:a.removeTags(p,["a"]),""!==(p=this.opts.is("paste.images")?p:a.removeTags(p,["img"]))&&(h&&(u=this._findLocalImages(p),p=this._replaceLocalImages(p,u,this._extractImagesFromRtf(h))),p=f?o.parse(p):p,s.isPlainText(e)&&!b&&(p=p.replace(/\n/g,"<br>")),m=r.insert({html:p,clean:f,type:"paste",parse:v}),this.opts.is("image.upload")&&this.app.image.parseInserted(m),this.app.placeholder.toggle(),this.app.broadcast("editor.paste",m))),this.app.event.unsetPasteEvent())},copy(t){this._action(t,"copy")},cut(t){this._action(t,"cut")},_action(t,e){let s,i={},a=this.app.create("clipboard"),r=this.app.create("selection"),o=this.app.block.get();if(!(o&&o.isEditable()&&r.isCollapsed())){t.preventDefault(),this.app.editor.isSelectAll()?i={html:this.app.editor.getLayout().html(),remove:"all"}:this.app.blocks.is()?i={html:r.getHtml(),remove:"content"}:o&&o.isEditable()?i=this._copyFromEditable(e,o,r):o&&(i=this._copyFromNonEditable(e,o));var n=this.app.broadcast("editor.before."+e,{e:t,html:i.html});if(!n.isStopped())return"cut"===e&&this._cutDeleteContent(i,r),s=n.get("html"),a.setContent(t,s),this.app.broadcastHtml("editor."+e,s)}},_cutDeleteContent(t,e){this.app.control.close(),this.app.context.close(),"instance"===t.remove?t.instance.remove({broadcast:!0}):"all"===t.remove?this.app.editor.setEmpty():!1!==t.remove&&e.truncate()},_copyFromEditable(t,e,s){let i=e.getType(),a=s.getHtml(),r="content";var o;return"figcaption"===i||"cell"===i||"paragraph"===i?r="content":e.isAllSelected()?(a=e.getOuterHtml(),r="instance"):"list"===i&&(o=e.getTag(),-1!==(a=s.getHtml()).search(/<li/gi))&&(a="<"+o+">"+(a=-1===a.search(/^<li/g)?"<li>"+a+"</li>":a)+"</"+o+">"),{html:a,remove:r,instance:e}},_copyFromNonEditable(t,e){let s=e.getOuterHtml(),i="cut"===t?"instance":!1;return{html:s,remove:i,instance:e}},_findLocalImages(t){let e=[],s=this.app.create("utils");return s.wrap(t,function(t){t.find("img").each(function(t){-1!==t.attr("src").search(/^file:\/\//)&&e.push(t.attr("src"))})}),e},_extractImagesFromRtf(t){if(!t)return[];let e=/{\\pict[\s\S]+?\\bliptag-?\d+(\\blipupi-?\d+)?({\\\*\\blipuid\s?[\da-fA-F]+)?[\s}]*?/,s=new RegExp("(?:("+e.source+"))([\\da-fA-F\\s]+)\\}","g"),i=t.match(s),a=[],r=0,o;if(!i)return[];for(r;r<i.length;r++)o=!1,-1!==i[r].indexOf("\\pngblip")?o="image/png":-1!==i[r].indexOf("\\jpegblip")&&(o="image/jpeg"),o&&a.push({hex:i[r].replace(e,"").replace(/[^\da-fA-F]/g,""),type:o});return a},_convertHexToBase64(t){return btoa(t.match(/\w{2}/g).map(function(t){return String.fromCharCode(parseInt(t,16))}).join(""))},_replaceLocalImages(s,i,a){if(i.length===a.length){let t=0,e;for(t;t<i.length;t++)e="data:"+a[t].type+";base64,"+this._convertHexToBase64(a[t].hex),s=s.replace(new RegExp('src="'+i[t]+'"',"g"),'src="'+e+'"')}return s}}),d.add("class","cleaner",{init(){this.stored={},this.storedIndex=0,this.storedComments=[],this._selectors={code:["pre","code"],embed:["figure"],noneditable:["["+this.opts.get("dataBlock")+"=noneditable]"],noparse:["[data-noparse]"],images:["img"],svg:["svg"],links:["a"],lists:["ul","ol"],headings:["h1","h2","h3","h4","h5","h6"]}},clean(t){t=this.app.broadcastHtml("editor.before.clean",t);var e={},s=this._isPages(t),i=this._isHtmlMsWord(t),a=this._isEditor(t),r=this._isGDocs(t),o=this.opts.get("paste.blockTags"),n=this.opts.get("paste.inlineTags"),l=this.opts.get("paste.formTags"),h=this.opts.get("tags.denied");let p=o.concat(n).concat(l);return t=this.store(t,"embed",e,0),t=this.store(t,"svg",e,0),t=this.removeDoctype(t),t=(t=this.removeTags(t,h)).trim(),t=this.removeComments(t),t=(t=this.removeTagsWithContent(t,["script","style"])).replace(/div><br\s?\/?><div/gi,"div><br><br><div"),t=s?this._cleanPages(t):t,t=r?this._cleanGDocs(t):t,t=this.encodePhp(t),a&&(p=p.concat(["div"])),t=this.removeTagsExcept(t,p),t=i?this._cleanMsWord(t):t,t=(o=this._removeClassesAttrs(t,e,a)).html,o.flag||(t=this.restore(t,"embed",e)),t=this.restore(t,"svg",e),t=a?this.cacheStyle(t):this.removeStyleAttr(t),t=this.removeEmptyInlines(t),t=(t=(t=(t=(t=(t=(t=(t=(t=this.removeEmptySpans(t)).replace(/<figure[^>]*><\/figure>/gi,"")).replace(/<p>&nbsp;<\/p>/gi,"<p></p>")).replace(/<p><br\s?\/?><\/p>/gi,"<p></p>")).replace(/^<li/gi,"<ul><li")).replace(/<\/li>$/gi,"</li></ul>")).replace(/<br\s?\/?><\/li>/gi,"</li>")).replace(/<span><br\s?\/?>{1,2}<\/span>/gi,"")).replace(/<br\s?\/?><br\s?\/?>$/gi,""),(i||s||r)&&(t=(t=(t=(t=t.replace(/<p><\/p>/gi,"")).replace(/<p>\s<\/p>/gi,"")).replace(/<\/p><br\s?\/?><p>/gi,"</p><p>")).replace(/<\/(p|ul|ol)><br\s?\/?><h/gi,"</$1><h")),t=this._tidyCleanUp(t),this.app.broadcastHtml("editor.clean",t)},_tidyCleanUp(t){return this.app.create("utils").wrap(t,function(t){t.find(".Apple-converted-space").unwrap(),t.find("ul, ol").each(this._placeListToItem.bind(this)),t.find("li p").unwrap()}.bind(this))},_removeClassesAttrs(t,e,s){let i=!1,a=this.app.create("utils"),r=this.opts.get("paste.keepClass"),o=this.opts.get("paste.keepAttrs"),n=0!==r.length?r.join(","):"",l=0!==o.length?o.join(","):"",h,p,d,c,u;return!s&&this.app.event.isPasteEvent()&&(t=this.restore(t,"embed",e),i=!0),{html:t=s?t:a.wrap(t,t=>{(h=t.find("*")).not(n).removeAttr("class"),h.not(l).each(t=>{for(p=t.get(),d=p.attributes,c=d.length-1;0<=c;c--)"class"===(u=d[c].name)||"dir"===u||-1!==u.search(/^data-/)||"IMG"===p.tagName&&("src"===u||"alt"===u)||"A"===p.tagName&&("href"===u||"id"===u&&this.opts.is("paste.keepIdAttr")||"target"===u)||p.removeAttribute(u)})}),flag:i}},_isEditor(t){return t.match(new RegExp('meta\\stype="rx-editor"',"i"))},_isHtmlMsWord(t){return t.match(/class="?Mso|style="[^"]*\bmso-|style='[^'']*\bmso-|w:WordDocument/i)},_isPages(t){return t.match(/name="Generator"\scontent="Cocoa\sHTML\sWriter"/i)},_cleanPages(t){return t=(t=t.replace(/\sclass="s[0-9]"/gi,"")).replace(/\sclass="p[0-9]"/gi,"")},_isGDocs(t){return-1!==t.search(/docs-internal-guid/i)},_cleanGDocs(t){return t=(t=(t=(t=(t=(t=(t=this.app.create("utils").wrap(t,function(t){t.find("h1, h2, h3, h4, h5, h6").each(function(t){t.find("span").unwrap()})})).replace(/ dir="[^>]*"/gi,"")).replace(/<b\sid="internal-source-marker(.*?)">([\w\W]*?)<\/b>/gi,"$2")).replace(/<b(.*?)id="docs-internal-guid(.*?)">([\w\W]*?)<\/b>/gi,"$3")).replace(/<span[^>]*(font-style:\s?italic;\s?font-weight:\s?(bold|600|700)|font-weight:\s?(bold|600|700);\s?font-style:\s?italic)[^>]*>([\w\W]*?)<\/span>/gi,"<b><i>$4</i></b>")).replace(/<span[^>]*font-style:\s?italic[^>]*>([\w\W]*?)<\/span>/gi,"<i>$1</i>")).replace(/<span[^>]*font-weight:\s?(bold|600|700)[^>]*>([\w\W]*?)<\/span>/gi,"<b>$2</b>")},_cleanMsWord(t){var e=this.app.create("utils");t=(t=(t=(t=(t=(t=t.replace(/<!--[\s\S]+?-->/gi,"")).trim()).replace(/<(!|script[^>]*>.*?<\/script(?=[>\s])|\/?(\?xml(:\w+)?|meta|link|style|\w:\w+)(?=[\s/>]))[^>]*>/gi,"")).replace(/<(\/?)s>/gi,"<$1strike>")).replace(/&nbsp;/gi," ")).replace(/<span\s+style\s*=\s*"\s*mso-spacerun\s*:\s*yes\s*;?\s*"\s*>([\s\u00a0]*)<\/span>/gi,function(t,e){return 0<e.length?e.replace(/./," ").slice(Math.floor(e.length/2)).split("").join(" "):""});let s="",i=(t=(t=(t=(t=(t=(t=e.wrap(t,t=>{t.find("p").each(function(t){var e=/mso-list:\w+ \w+([0-9]+)/.exec(t.attr("style"));e&&t.attr("data-listLevel",parseInt(e[1],10))}),this._parseWordLists(t),t.find("[align]").removeAttr("align"),this.opts.is("paste.keepNameAttr")||t.find("[name]").removeAttr("name"),t.find("span").each(function(t){var e=t.attr("style");/mso-list:Ignore/.exec(e)?t.remove():t.unwrap()}),t.find("[style]").removeAttr("style"),t.find("[class^='Mso']").removeAttr("class"),t.find("a").filter(function(t){return!t.attr("href")}).unwrap()})).replace(/<p><img(.*?)>/gi,"<p><img$1></p><p>")).replace(/<p[^>]*><\/p>/gi,"")).replace(/<li>·/gi,"<li>")).trim()).replace(/\/(p|ul|ol|h1|h2|h3|h4|h5|h6|blockquote)>\s+<(p|ul|ol|h1|h2|h3|h4|h5|h6|blockquote)/gi,"/$1>\n<$2")).split(/\n/),a=i.length,r=0,o;for(r;r<a;r++)o=""!==i[r]&&-1===i[r].search(/>$/)?" ":"\n",s+=i[r]+o;return s=s.trim()},_parseWordLists(t){let i=0,a=null,r=null,o;t.find("p").each(function(t){let s=t.attr("data-listLevel");if(null!==(s=null===s&&t.hasClass("MsoListParagraphCxSpMiddle")?1:s)){var e=t.text(),e=/^\s*\w+\./.test(e)?"<ol></ol>":"<ul></ul>";if(t.hasClass("MsoListParagraphCxSpFirst")||t.hasClass("MsoNormal")?(r=this.dom(e),t.before(r)):s>i&&0!==i&&(o=this.dom(e),a.append(o),r=o),s<i){let t=i-s+1,e=0;for(e;e<t;e++)r=r.parent()}t.find("span").first().unwrap(),a=this.dom("<li>"+t.html().trim()+"</li>"),null===r&&(t.before(e),r=t.prev()),r.append(a),t.remove(),i=s}else r=null,i=0}.bind(this))},_placeListToItem(t){var t=t.get(),e=t.previousSibling;e&&"LI"===e.tagName&&((e=this.dom(e)).find("p").unwrap(),e.append(t))},escapeHtml(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")},removeDoctype(t){return t.replace(new RegExp("<!doctype[^>]*>","gi"),"")},removeComments(t){return t=t.replace(/<!--[\s\S]*?-->\n?/g,"")},removeInvisibleChars(t){return t.replace(/\uFEFF/g,"")},removeMarkers(t){return this.app.create("utils").wrap(t,function(t){t.find(".rx-plus-button").remove(),t.find(".rx-pastemarker").removeClass("rx-pastemarker"),t.find(".rx-pasteitems").removeClass("rx-pasteitems"),t.find(".rx-selection-marker").remove()}.bind(this))},removeEmptySpans(t){return this.app.create("utils").wrap(t,function(t){t.find("span").each(this.removeEmptySpan.bind(this))}.bind(this))},removeEmptyInlines(t){let e=this.app.create("utils"),s=this.opts.get("tags");return e.wrap(t,function(t){t.find(s.inline.join(",")).each(this.removeEmptyTag.bind(this))}.bind(this))},removeEmptyAttrs(t,s){return this.app.create("utils").wrap(t,function(t){for(var e=0;e<s.length;e++)t.find("["+s[e]+'=""]').removeAttr(s[e])})},removeEmptyTag(t){var e=t.html().trim();0===t.get().attributes.length&&""===e&&t.unwrap()},removeEmptySpan(t){0===t.get().attributes.length&&t.unwrap()},removeTags(t,s){return t.replace(s?/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi:/(<([^>]+)>)/gi,s?function(t,e){return-1===s.indexOf(e.toLowerCase())?t:""}:"")},removeTagsWithContent(t,e){return this.app.create("utils").wrap(t,function(t){t.find(e.join(",")).remove()})},removeTagsExcept(t,s){return void 0===s?t.replace(/(<([^>]+)>)/gi,""):t.replace(/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,function(t,e){return-1===s.indexOf(e.toLowerCase())?"":t})},removeBlockTags(t,e,s){let i=this.opts.get("tags"),a=this.app.create("utils"),r=[...i.block];return s&&(r=a.removeFromArrayByValue(r,s)),e&&(r=e?a.extendArray(r,e):r),this.removeTags(t,r)},removeBlockTagsInside(t,e){var s=this.app.create("utils");return this.blockListTags=s.removeFromArrayByValue(this.opts.get("tags.block").concat(),["ul","ol","li"]),s.wrap(t,function(t){t.find(e.join(",")).each(this._removeBlockTagsInside.bind(this))}.bind(this))},_removeBlockTagsInside(t){var e=t.tagName("li")?this.blockListTags:this.opts.get("tags.block");t.find(e.join(",")).append("<br>").unwrap()},removeInlineStyles(t){var e=this.app.create("utils");let s=e.removeFromArrayByValue(this.opts.get("tags.inline"),"a");return e.wrap(t,function(t){t.find(s.join(",")).removeAttr("style")})},removeStyleAttr(t,e){var s=this.app.create("utils");return e=e||"",s.wrap(t,function(t){t.find("*").not("[data-rx-style-cache]"+e).removeAttr("style")}.bind(this))},removeBreakline(t){return t.replace(/<br\s?\/?>/gi,"")},addNofollow(t){return this.opts.is("link.nofollow")?this.app.create("utils").wrap(t,function(t){t.find("a").attr("rel","nofollow")}):t},addHttps(t){return t=this.opts.is("editor.https")?(t=(t=t.replace('href="http://','href="https://')).replace('src="http://','src="https://')).replace('srcset="http://','srcset="https://'):t},addBrToBlocks(t){return t.replace(/<\/(div|li|dt|dd|td|p|H[1-6])>\n?/gi,"</$1><br>")},convertForms(t){return this.app.create("utils").wrap(t,function(t){t.find("form").each(this._convertForm.bind(this))}.bind(this))},convertFrames(t){return this.app.create("utils").wrap(t,function(t){t.find("iframe").each(this._convertFrame.bind(this))}.bind(this))},revertForms(t){return this.app.create("utils").wrap(t,function(t){t.find(".rx-div-form").each(this._revertForm.bind(this))}.bind(this))},revertFrames(t){return this.app.create("utils").wrap(t,function(t){t.find(".rx-figure-iframe").each(this._revertFrame.bind(this))}.bind(this))},_convertForm(t){this.app.create("element").replaceToTag(t,"div").addClass("rx-div-form")},_convertFrame(t){0===t.closest("figure").length&&(t.wrap("<figure>"),t.parent().addClass("rx-figure-iframe"))},_revertForm(t){this.app.create("element").replaceToTag(t,"form").removeClass("rx-div-form")},_revertFrame(t){0===t.get().attributes.length&&0===t.find("figcaption").length&&0===t.find("div").length?t.unwrap():t.removeClass("rx-figure-iframe")},encodeEntities(t){return this.decodeEntities(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},encodePhp(t){return t=(t=(t=t.replace("<?php","&lt;?php")).replace("<?","&lt;?")).replace("?>","?&gt;")},encodeCode(t){return t=(t=(t=(t=(t=(t=(t=(t=this.encodeAttrSings(t)).replace(/<\s/gi,"&lt; ")).replace(/<([^>]+)</gi,"&lt;$1<")).replace(/<(.*?)>/gi,"xtagstartz$1xtagendz")).replace(/xtagstartzpre(.*?)xtagendz/g,"<pre$1>")).replace(/xtagstartzcode(.*?)xtagendz/g,"<code$1>")).replace(/xtagstartz\/codextagendz/g,"</code>")).replace(/xtagstartz\/prextagendz/g,"</pre>"),t=(t=(t=this._encodeCode(t)).replace(/xtagstartz([\w\W]*?)xtagendz/g,"<$1>")).replace(/xtagstartz\/(.*?)xtagendz/g,"</$1>"),t=this.decodeAttrSings(t)},encodeAttrSings(t){let e=t.match(/="(.*?)"/g),s=0,i,a;if(null!==e)for(s=0,i=e.length;s<i;s++)-1===e[s].search(/^"</)&&-1===e[s].search(/>"$/)&&(a=(a=e[s].replace(">","xmoresignz")).replace("<","xlesssignz"),t=t.replace(e[s],a));return t},decodeAttrSings(t){return t=(t=t.replace(/xmoresignz/gi,">")).replace(/xlesssignz/gi,"<")},decodeEntities(t){return String(t).replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&amp;/g,"&")},decodeHref(t){let e=t.match(new RegExp('(href=".*?)(&amp;)(.*?">)',"g")),s=0,i;if(null!==e)for(s=0,i=e.length;s<i;s++)t=t.replace(e[s],e[s].replace(/&amp;/g,"&"));return t},decodeSpecialCharsInAttributes(t){return t.replace(/<([a-z][a-z0-9]*)\b([^>]*)>/gi,function(t,e,s){return`<${e}${s.replace(/(["'])(?:(?=(\\?))\2.)*?\1/g,function(t){return t.replace(/&amp;/g,"&")})}>`})},_encodeCode(t){return this.app.create("utils").wrap(t,function(t){t.find("pre code, pre, code").each(this._encodeNode.bind(this))}.bind(this))},_encodeNode(t){let e=t.get(),s=e.firstChild,i=e.innerHTML,a;"PRE"===e.tagName&&s&&"CODE"===s.tagName||(i=(i=i.replace(/xtagstartz/g,"<")).replace(/xtagendz/g,">"),a=this.decodeEntities(i),e.textContent=this._encodeNodeHtml(a))},_encodeNodeHtml(t){var e=this.opts.get("pre.spaces");return t=t.replace(/&nbsp;/g," ").replace(/<br\s?\/?>/g,"\n"),t=e?t.replace(/\t/g,new Array(e+1).join(" ")):t},store(t,e){let s=this._selectors[e],i=0,a,r;for(i=0,a=s.length;i<a;i++)r=this._getElementsFromHtml(t,s[i]),t=this._store(t,e,r);return t},storeComments(e){var s=e.match(new RegExp("\x3c!--([\\w\\W]*?)--\x3e","gi"));if(null!==s){e=this.store(e,"code");for(let t=0;t<s.length;t++)e=e.replace(s[t],"#####xstarthtmlcommentzz"+t+"xendhtmlcommentzz#####"),this.storedComments.push(s[t]);e=this.restore(e,"code")}return e},storeTemplateSyntax(t,e){var s,i,a;for([i,a]of Object.entries(e))s="ts__"+i,t=t.replace(new RegExp(a[0]+"(.*?)"+a[1],"gi"),"\x3c!--"+s+"$1"+s+"--\x3e");return t},restore(t,e){let s=0,i;if(void 0!==this.stored[e])for(s=0,i=this.stored[e].length;s<i;s++)t=t.replace("####_"+e+s+"_####",this.stored[e][s]);return t},restoreComments(e){var s;for(let t=0;t<this.storedComments.length;t++)s=this.storedComments[t].replace(/\$/gi,"&#36;"),e=e.replace("#####xstarthtmlcommentzz"+t+"xendhtmlcommentzz#####",s);return e},restoreTemplateSyntax(t,e){var s,i,a,r=this.app.create("utils");for([i,a]of Object.entries(e))s="ts__"+i,t=t.replace(new RegExp("\x3c!--"+s+"(.*?)"+s+"--\x3e","gi"),r.escapeBackslash(a[0])+"$1"+r.escapeBackslash(a[1]));return t=t.replace(/\{\{&gt;/gi,"{{>")},cacheStyle(t){var e=this.app.create("utils"),s=this.opts.get("tags");let i=s.block.join(",")+",img,"+s.inline.join(",");return e.wrap(t,function(t){t.find(i).each(this.cacheElementStyle.bind(this))}.bind(this))},cacheElementStyle(t){let e="data-rx-style-cache",s=t.attr("style");s?(s=s.replace(/"/g,""),t.attr(e,s)):s&&""!==s||t.removeAttr(e)},recacheStyle(t){return this.app.create("utils").wrap(t,function(t){t.find("[data-rx-style-cache]").each(this.recacheElementStyle.bind(this))}.bind(this))},recacheElementStyle(t){var e="data-rx-style-cache",s=t.attr(e);t.attr("style",s).removeAttr(e)},_store(s,i,a){if(a){void 0===this.stored[i]&&(this.stored[i]=[]);for(let t=0,e=a.length;t<e;t++)this.stored[i][this.storedIndex]=a[t],s=s.replace(a[t],"####_"+i+this.storedIndex+"_####"),this.storedIndex++}return s},_getElementsFromHtml(t,e){let s=[],i=this.dom("<div>").html(t);return i.find(e).each(function(t){s.push(t.get().outerHTML)}),s},sanitize(t){return t=this.app.create("utils").wrap(t,function(t){t.find("[src]").each(this._sanitizeSrc),t.find("a").each(this._sanitizeHref),t.find("a,b,i,strong,em,svg,img,details,audio").each(this._sanitizeEvents)}.bind(this))},_sanitizeSrc(t){var t=t.get(),e=t.getAttribute("src");(-1!==e.search(/^javascript:/i)||"IMG"!==t.tagName&&-1!==e.search(/^data:/i))&&t.setAttribute("src","")},_sanitizeHref(t){var t=t.get(),e=t.getAttribute("href");e&&-1!==e.search(/^javascript:/i)&&t.setAttribute("href","")},_sanitizeEvents(t){t.removeAttr("onload onerror ontoggle onwheel onmouseover oncopy")}}),d.add("class","button",{init(t,e,s,i){this.$container=s,this.name=t,this.type=i,this.$button=null,this.icon=null,this.$title=null,this.props=new c(this,e),this.builder=new g(this),this.styler=new f(this),this.state=new b(this),this.behavior=new u(this),this.command=new m(this),this.behavior.checkObserve()&&this.behavior.checkPermissions()&&this.builder.build()},observe(){this.behavior.observe()},has(t){return this.props.has(t)},isButton(){return!0},getType(){return this.type},getToolbarType(){return this.$button.attr("data-toolbar")},getName(){return this.name},getContainer(){return this.$container},getTemplate(){return this.props.get("template")},getObj(){return this.props.dump()},getParams(){return this.props.get("params")},getElement(){return this.$button},getIcon(){return this.$icon.html()},getTitle(){return this.title},getTitleText(){return this.$title.text()},getOffset(){return this.$button.offset()},getRect(){var t=this.$button.offset(),e=this.$button.width(),s=this.$button.height(),i=Math.round(t.top),t=Math.round(t.left);return{top:i,left:t,bottom:i+s,right:t+e,width:e,height:s}},getWidth(){return this.$button.width()},getHeight(){return this.$button.height()},getDimension(){return{width:this.getWidth(),height:this.getHeight()}},setColor(t){this.styler.setColor(t)},setBackground(t){this.styler.setBackground(t)},resetColor(){this.styler.resetColor()},resetBackground(){this.styler.resetBackground()},setToggled(){this.state.setToggled()},setActive(){this.state.setActive()},unsetToggled(){this.state.unsetToggled()},unsetActive(){this.state.unsetActive()},disable(){this.state.disable()},enable(){this.state.enable()},setCommand(t){this.command.setCommand(t)},getCommand(){return this.command.getCommand()},trigger(t,e){this.command.trigger(t,e)},setTitle(t){this.builder.setTitle(t)},setIcon(t){this.builder.setIcon(t)}}),d.add("class","predefined",{parse(t){t=t||this.app.getLayout(),this.opts.get("classes")&&(this._parseElements(t,"tags",this._addTagClass.bind(this)),this._parseElements(t,"blocks",this._addBlockClass.bind(this)))},_parseElements(t,e,s){var i=this.opts.get("classes."+e);i&&(e=this._buildSelector(e,i),t.find(e).each(s))},_buildSelector(t,e){if("tags"===t)return Object.keys(e).join(",");if("blocks"===t)return Object.keys(e).map(t=>`[data-rx-type="${t}"]`).join(",")},_addTagClass(t){var e=t.tagName(),s=this.opts.get("classes.tags");s[e]&&t.addClass(s[e])},_addBlockClass(t){var e=t.attr("data-rx-type"),s=this.opts.get("classes.blocks");s[e]&&t.addClass(s[e])}}),d.add("class","tidy",{parse(t,e){var s;let i=["li"],a=["li"],r=["p","ul","ol","li","div","h1","h2","h3","h4","h5","h6","blockquote","figure","figcaption","table","thead","tbody","tfoot","tr","td","th","dl","dt","dd"],o=0,n=(t=this.app.create("cleaner").encodeAttrSings(t)).length,l=0,h,p,d="",c="",u="";for("email"===e&&(i=[...i,"style","meta"],r=[...r,"title","head","body"]),this.lineBefore=new RegExp("^<(/?"+i.join("|/?")+"|"+a.join("|")+")[ >]"),this.lineAfter=new RegExp("^<(/?"+i.join("|/?")+"|/"+a.join("|/")+")[ >]"),this.newLevel=new RegExp("^</?("+r.join("|")+")[ >]"),this.cleanlevel=0;o<n;o++){if(l=o,-1===t.substr(o).indexOf("<"))return c+=t.substr(o),this.finish(c);for(;l<n&&"<"!==t.charAt(l);)l++;for(o===l||(u=t.substr(o,l-o)).match(/^\s{2,}$/g)||("\n"===c.charAt(c.length-1)?c+=this.getTabs():"\n"===u.charAt(0)&&(c+="\n"+this.getTabs(),u=u.replace(/^\s+/,"")),c+=u),h=l;l<n&&">"!==t.charAt(l);)l++;if(d=t.substr(h,l-h),o=l,"!--"===d.substr(1,3)){if(!d.match(/--$/)){for(;"--\x3e"!==t.substr(l,3);)l++;l+=2,d=t.substr(h,l-h),o=l}"\n"!==c.charAt(c.length-1)&&(c+="\n"),c=(c+=this.getTabs())+(d+">\n")}else"!"===d[1]?c=this.placeTag(d+">",c):"?"===d[1]?c+=d+">\n":s===d.match(/^<(script|style|pre)/i)?(s[1]=s[1].toLowerCase(),d=this.cleanTag(d),c=this.placeTag(d,c),(p=String(t.substr(o+1)).toLowerCase().indexOf("</"+s[1]))&&(u=t.substr(o+1,p),o+=p,c+=u)):(d=this.cleanTag(d),c=this.placeTag(d,c))}return this.finish(c)},getTabs(){let t="",e=0;for(e;e<this.cleanlevel;e++)t+="    ";return t},finish(t){var e=this.app.create("cleaner");return t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=t.replace(/\n\s*\n/g,"\n")).replace(/^[\s\n]*/,"")).replace(/[\s\n]*$/,"")).replace(/<li(.*?)>[\s\n]*/gi,"<li$1>")).replace(/<(p|h1|h2|h3|h4|h5|h6|li|td|th)(.*?)>[\s\n]*<\/\1>/gi,"<$1$2></$1>")).replace(/[\s\n]*<\/li>/gi,"</li>")).replace(/<script(.*?)>\n<\/script>/gi,"<script$1><\/script>")).replace(/\n(.*?)<link(.*?)><style/gi,"\n$1<link$2>\n$1<style")).replace(/\n\s*<pre/gi,"\n<pre")).replace(/><link/gi,">\n<link")).replace(/><\/head/gi,">\n</head"),t=e.decodeAttrSings(t),this.cleanlevel=0,t},cleanTag(t){let e="",s="",i;for((t=(t=(t=t.replace(/\n/g," ")).replace(/\s{2,}/g," ")).replace(/^\s+|\s+$/g," ")).match(/\/$/)&&(s="/",t=t.replace(/\/+$/,""));i=/\s*([^= ]+)(?:=((['"']).*?\3|[^ ]+))?/.exec(t);)i[2]?e+=i[1].toLowerCase()+"="+i[2]:i[1]&&(e+=i[1].toLowerCase()),e+=" ",t=t.substr(i[0].length);return e.replace(/\s*$/,"")+s+">"},placeTag(t,e){var s=t.match(this.newLevel);return(t.match(this.lineBefore)||s)&&(e=e.replace(/\s*$/,""),e+="\n"),s&&"/"===t.charAt(1)&&this.cleanlevel--,"\n"===e.charAt(e.length-1)&&(e+=this.getTabs()),s&&"/"!==t.charAt(1)&&this.cleanlevel++,e+=t,(t.match(this.lineAfter)||t.match(this.newLevel))&&(e=e.replace(/ *$/,""),e+="\n"),e}}),d.add("class","paragraphizer",{init(t){this.setting=t},parse(t){return!1!==this.setting&&(t=this._parse(t),t=this._parseTable(t)),t},parseLayers(t){let e,s=this.app.create("utils");return s.wrap(t,function(t){t.find('[data-rx-type="wrapper"]').each(function(t){e=this._parse(t.html()),t.html(e)}.bind(this)),t.find('[data-rx-type="column"]').each(function(t){e=this._parse(t.html()),t.html(e)}.bind(this))}.bind(this))},_parse(t,e){this.remStart="#####replace",this.remEnd="#####",this.tags=this._getTags(),this.tags=[...this.tags,...d.customTags];let s=this.opts.get("breakline"),i=s||e?"sdivtag":this.opts.get("markup"),a=e?"tbr":"br",r="",o,n=0,l,h=[],p=this.app.create("cleaner");for(t=this._storeTags(t,h),t=p.store(t,"svg"),t=(t=p.storeComments(t)).trim(),t=(t=(t=(t=(t=this._trimLinks(t)).replace(/xparagraphmarkerz(?:\r\n|\r|\n)$/g,"")).replace(/xparagraphmarkerz$/g,"")).replace(/xparagraphmarkerz(?:\r\n|\r|\n)/g,"\n")).replace(/xparagraphmarkerz/g,"\n"),t=s?(t=(t=t.replace(/<br\s?\/?>(?:\r\n|\r|\n)/gi,"xbreakmarkerz\n")).replace(/<br\s?\/?>/gi,"xbreakmarkerz\n")).replace(/xbreakmarkerz\n<\//gi,"xbreakmarkerz</"):(t=(t=t.replace(/<br\s?\/?><br\s?\/?>$/gi,"")).replace(/[\n]+/g,"\n")).replace(/<br\s?\/?><br\s?\/?>/g,"\n"),r="",o=t.split("\n"),n=0,l=o.length;n<l;n++)r+="<"+i+">"+o[n].trim()+"</"+i+">\n";return t=(t=(t=(t=r.replace(/\n$/,"")).replace(new RegExp("<"+i+">\\s+#####","gi"),"#####")).replace(new RegExp("<"+i+">#####","gi"),"#####")).replace(new RegExp("#####</"+i+">","gi"),"#####"),t=s?t.replace(/xbreakmarkerz/gi,"<br>"):t,t=this._restoreTags(t,h),t=p.restore(t,"svg"),t=p.restoreComments(t),t=(t=s?(t=t.replace(new RegExp("<"+i+"></"+i+">","gi"),"<"+i+"><br></"+i+">")).replace(/<\/?br\s?\/?><\/div>/gi,"</div>"):t).replace(/<(p|h1|h2|h3|h4|h5|h6|li|td|th)(.*?)>[\s\n]*<\/\1>/gi,"<$1$2></$1>"),t=(t=(t=(t=(t=(t=(t=this._has("cleanBreakline")&&!this._is("cleanBreakline")?t:t.replace(/<p(.*?)><\/?br\s?\/?><\/p>/gi,"<p$1></p>")).replace(/<div(.*?)><\/?br\s?\/?><\/div>/gi,"<div$1></div>")).replace(/<\/?br\s?\/?><\/div>/gi,"</div>")).replace(/<\/?br\s?\/?><\/li>/gi,"</li>")).replace(new RegExp("<sdivtag>","gi"),'<div data-rx-tag="'+a+'">')).replace(new RegExp("sdivtag","gi"),"div")).replace(/<\/([^>]+)><div data-rx-tag/g,"</$1>\n<div data-rx-tag"),t=s?t.replace(/<\/?br\s?\/?><\/div>/gi,"</div>"):t},_parseTable(t){return this.app.create("utils").wrap(t,function(t){t.find("td, th").each(this._parseCell.bind(this))}.bind(this))},_parseCell(t){var t=this.dom(t),e=this._parse(t.html(),"table");t.html(e)},_getTags(){return["pre","hr","ul","ol","p","h1","h2","h3","h4","h5","h6","table","address","blockquote","figure","iframe","form","dl","div","section","header","footer","article","main","aside","form","audio","figcaption","object","style","script","iframe","select","input","textarea","button","option","map","area","math","fieldset","legend","hgroup","nav","details","menu","summary"]},_storeTags(t,s){return this.app.create("utils").wrap(t,function(t){t.find(this.tags.join(", ")).each(function(t,e){this._replaceTag(t,e,s)}.bind(this))}.bind(this))},_restoreTags(e,s){for(let t=0;t<s.length;t++){var i=s[t].replace(/\$/gi,"&#36;");e=e.replace(this.remStart+t+this.remEnd,i)}return e},_replaceTag(t,e,s){t=t.get(),e=document.createTextNode(this.remStart+e+this.remEnd+"xparagraphmarkerz");s.push(t.outerHTML),t.parentNode.replaceChild(e,t)},_trimLinks(t){return this.app.create("utils").wrap(t,function(t){t.find("a").each(this._trimLink.bind(this))}.bind(this))},_trimLink(t){t.html(t.html().trim())},_has(t){return this.setting&&void 0!==this.setting[t]},_is(t){return this.setting[t]}}),d.add("class","tooltip",{init(t,e){this.eventname="rx-button-"+this.uuid,this._attachTooltipHandlers(t,e)},_attachTooltipHandlers(t,e){(e=this._sanitizeTitle(e))&&(t.on("mouseover."+this.eventName,this._showTooltip.bind(this)),t.on("mouseout."+this.eventName,this._hideTooltip.bind(this)))},_sanitizeTitle(t){return!!t&&t.replace(/(<([^>]+)>)/gi,"")},_hideTooltip(){this.$tooltip&&(this.$tooltip.remove(),this.$tooltip=null)},_showTooltip(t){t=this._getButtonFromEvent(t);this._shouldPreventTooltip(t)||(this.$tooltip=this._createTooltip(t),this.app.$body.append(this.$tooltip),this._setPosition(t))},_shouldPreventTooltip(t){return this.app.modal.isOpen()||t.hasClass("disable")||this.app.dropdown.isOpen()&&"toolbar"===this.app.ui.getState().type},_getButtonFromEvent(t){return this.dom(t.target).closest(".rx-button")},_createTooltip(t){return this.dom("<span>").addClass("rx-tooltip").html(t.attr("data-tooltip")).css("z-index",this._calculateZIndex())},_calculateZIndex(){return this.app.isProp("fullscreen")?10002:1060},_setPosition(t){var e=t.attr("data-toolbar"),s=t.offset(),t=this._getButtonDimensions(t),i=this._getTooltipDimensions(),e=this._calculatePosition(e,s,t,i);this.$tooltip.css({top:e.top+"px",left:e.left+"px","z-index":this._calculateZIndex()}),this.$tooltip.attr({dir:this.opts.get("dir"),"rx-data-theme":this.app.theme.get()})},_calculatePosition(t,e,s,i){let a=this.app.editor.getRect(),r=e.top+s.height,o=e.left;return a.right<e.left+i.width&&(o=e.left+s.width-i.width),"context"===t?r=e.top-i.height-2:this.app.dropdown.isPositionTop()&&(r=e.top+s.height+2),{top:r,left:o}},_getTooltipDimensions(){return{width:this.$tooltip.width(),height:this.$tooltip.height()}},_getButtonDimensions(t){return{height:t.height(),width:t.width()}}}),d.add("class","element",{is(t,e,s=!0){const i="text"===e?t:this._node(t);t={inline:()=>this._isElement(i)&&this._isInlineTag(i.tagName,s&&i),"block-data":()=>this._isElement(i)&&i.hasAttribute("data-rx-type"),"block-data-not-inline":()=>this._isElement(i)&&i.hasAttribute("data-rx-type")&&!i.hasAttribute("data-rx-inline"),"block-first":()=>this._isElement(i)&&i.hasAttribute("data-rx-first-level"),block:()=>this._isElement(i)&&this._isBlockTag(i.tagName),element:()=>this._isElement(i),text:()=>"string"==typeof i&&!/^\s*<(\w+|!)[^>]*>/.test(i)||this._isTextNode(i),list:()=>this._isElement(i)&&["ul","ol"].includes(i.tagName.toLowerCase()),heading:()=>this._isElement(i)&&["h1","h2","h3","h4","h5","h6"].includes(i.tagName.toLowerCase())};return!!t[e]&&t[e]()},isTool(t){return 0<this.dom(t).closest(".rx-in-tool").length},isType(t,e){return e==this.getType(t)},isTag(t,e){return this._node(t).tagName.toLowerCase()===e},isEmpty(t){t=this._node(t);return!t||(3===t.nodeType?!t.textContent.trim().replace(/\n/,""):!t.innerHTML)},isScrollVisible(t,e=null){t=this.dom(t).offset().top,e=e||this.app.scroll.getTarget();return t<=e.scrollTop()+e.height()},isElementVisibleInScroll(t){var e=this.app.editor.getEditor(),e=this.dom(e).get().getBoundingClientRect(),t=this.dom(t).get().getBoundingClientRect();return t.top>=e.top&&t.bottom<=e.bottom},scrollTo(t,e=60){if(t=this.dom(t),!this.isScrollVisible(t)){const s=t.offset().top-e,i=this.app.scroll.getTarget();i.scrollTop(s),setTimeout(()=>i.scrollTop(s),1)}},getInlines(t,e){var s=this.app.create("element");let i=this._node(t);i.nodeType===Node.TEXT_NODE&&(i=i.parentNode);for(var a=[];i;){if(i.nodeType===Node.ELEMENT_NODE&&s.is(i,"inline")){if(i.tagName.toLowerCase()===e)break;a.push(i)}i=i.parentNode}return a},getType(t){return this.dom(t).attr("data-rx-type")},getDataBlock(t,e){e=e?`[data-rx-type=${e}]`:"[data-rx-type]",t=this.dom(t).closest(e);return!!t.length&&t},getFirstLevel(t){return this.dom(t).closest("[data-rx-first-level]")},compareStyle(t,e){var s=this.app.create("utils"),t=this.dom(t);const i=s.cssToObject(t.attr("style"));return Object.keys(i).length===Object.keys(e).length&&Object.entries(e).every(([t,e])=>{var s=i[t];return void 0!==s&&this._normalizeValue(t,s)===this._normalizeValue(t,e)})},hasAttrs(t,e){const s=this.dom(t);return Object.entries(e).every(([t,e])=>s.attr(t)===e)},hasStyle(t,e){if(!e)return!1;const i=this.dom(t);return Object.entries(e).every(([t,e])=>{var s=i.css(t);return this._normalizeValue(t,s)===this._normalizeValue(t,e)})},hasParent(t,e){return 0!==this.dom(t).closest("[data-rx-type="+e+"]").length},splitAtCaret(t){t=this.split(t);this.app.block.set(t,"start")},split(t){var e=this.dom(t),s=this._node(t).tagName.toLowerCase(),i=this.app.create("utils").extractHtmlFromCaret(t),s=this.dom(`<${s}>`),s=this.cloneAttrs(t,s),t=(11===i.nodeType?s.append(this.dom(i.childNodes)):s.append(i),e.after(s),e.children().last()),i=(this.is(t,"inline")&&!t.html().trim()&&t.remove(),this.getType(s));return i&&this.app.create("block."+i,s),e.html().trim()||e.remove(),s},cloneEmpty(t){t=this.dom(t).get().tagName.toLowerCase();return this.dom(`<${t}>`)},cloneAttrs(t,e){var s=this.dom(t),i=this.dom(e);if(s.length&&i.length)for(const a of this._node(t).attributes)i.attr(a.name,a.value);return i},getAttrs(t){var t=this._node(t),e={};if(t&&t.attributes)for(const i of t.attributes){var s=i.nodeValue,s=this._convertAttributeValue(i.nodeName,s);e[i.nodeName]=s}return e},removeEmptyAttr(t,e){t=this.dom(t);return""===t.attr(e)&&(t.removeAttr(e),!0)},replaceToTag(t,e,s){t=this.dom(t);const i=this.dom(`<${e}>`);return Array.from(t.get().attributes).forEach(t=>{i.attr(t.name,t.value)}),s?t.contents().appendTo(i):i.html(t.html()),t.replaceWith(i),i},getBlocks(t,e){t=this._node(t);let s=e||this.opts.get("tags.parser");return s=[...s,...d.customTags],Array.from(t.childNodes).filter(t=>1===t.nodeType&&s.includes(t.tagName.toLowerCase()))},_node(t){return this.dom(t).get()},_convertAttributeValue(t,e){return this._isNumber(e)?parseFloat(e):this._isBooleanString(e)?"true"===e.toLowerCase():e},_getBooleanFromStr(t){return"true"===t||"false"!==t&&t},_isNumber(t){return!isNaN(t)&&!isNaN(parseFloat(t))},_isTag(t){return void 0!==t&&t},_isTextNode(t){return t&&3===t.nodeType},_isBlockTag(t){return this.opts.get("tags.block").includes(t.toLowerCase())},_isInlineTag(t,e){return this.opts.get("tags.inline").includes(t.toLowerCase())&&(!e||!this.dom(e).hasClass("email-button"))},_isElement(t){return t&&t.nodeType&&1===t.nodeType},_normalizeValue(t,e){var s=this.app.create("utils");return e=(e="string"==typeof e?e.replace(/'/g,'"'):e).trim().replace(/;$/,""),(t.includes("color")||t.includes("background"))&&(e=(e=s.convertRgb2hex(e)).toLowerCase()),e=t.includes("family")?e.replace(/"/g,""):e}}),d.add("class","fragment",{create(t){return this.is(t)?t:this._createFragment(t)},is(t){return"object"==typeof t&&t.frag},insert(t){var e=this.app.create("selection"),s=e.getRange();s&&(this._clearRangeIfNecessary(s,e),this._insertFragmentIntoRange(t,s))},_createFragment(t){var t=this._createContainer(t),e=document.createDocumentFragment(),s=[],[t,i]=this._appendChildrenToFragment(t,e,s);return{frag:e,first:t,last:i,nodes:s}},_createContainer(t){var e=this.dom("<div>");return"string"==typeof t?e.html(t):e.append(this.dom(t).clone(!0)),e.get()},_appendChildrenToFragment(t,e,s){let i=null,a=null,r,o=0;for(;r=t.firstChild;)s.push(e.appendChild(r)),0==o++&&(i=s[0]),a=r;return[i,a]},_clearRangeIfNecessary(t,e){e.isCollapsed()?3!==(e=t.startContainer).nodeType&&"BR"===e.tagName&&e.parentNode.removeChild(e):t.deleteContents()},_insertFragmentIntoRange(t,e){t.frag?e.insertNode(t.frag):e.insertNode(t)}}),d.add("class","insertion",{set(t){return this.insert(t,"set")},setEmpty(){this.app.editor.getLayout().html("")},insert(t,e){let s;return this.p=d.extend({},{target:!1,position:!1,html:!1,clean:!1,parse:!0,current:!1,instance:!1,caret:!1,remove:!0,type:!1,paragraphize:!0},t),this.p.html&&(this.p.html=this.app.broadcastHtml("editor.before.insert",this.p.html)),(s="set"===e||this.app.editor.isSelectAll()?this._setContent():this._insertContent())&&this.app.broadcast("editor.insert",{inserted:s}),setTimeout(function(){this.app.observer.observe()}.bind(this),0),s},insertNewline(t,e){return this._insertFragment({node:document.createTextNode(e?"\n\n":"\n")},t||"after")},insertPoint(t){let e,s=this.app.create("utils"),i=this.app.create("caret"),a=s.createInvisibleChar(),r=t.clientX,o=t.clientY,n,l,h=this.app.getDocNode();h.caretPositionFromPoint?(n=h.caretPositionFromPoint(r,o),l=h.getSelection(),(e=l.getRangeAt(0)).setStart(n.offsetNode,n.offset),e.collapse(!0),e.insertNode(a)):h.caretRangeFromPoint&&(e=h.caretRangeFromPoint(r,o)).insertNode(a),i.set(a,"after")},insertBreakline(t,e){var s=this.app.create("selection"),i=s.getNodes({type:"inline"});return!1!==e&&s.isCollapsed()&&0!==i.length?this._splitInline(i,document.createElement("br")):this._insertFragment({node:document.createElement("br")},t||"after")},insertNode(t,e,s){var i=this.app.create("selection");if(s){s=i.getNodes({type:"inline"});if(0!==s.length)return this._splitInline(s,t)}return this._insertFragment({node:this.dom(t).get()},e)},insertHtml(t,e){return this._insertFragment({html:t},e)},insertText(t,e,s){var i=this.app.block.get(),a=this.app.create("selection"),r=this.app.create("caret"),o=this.app.create("utils");let n,l;return i&&i.isEditable()?(a.is()&&(t=s?t:o.getTextFromHtml(t,{nl:!0}),n=document.createTextNode(t),(l=a.getRange()).deleteContents(),l.insertNode(n),e=e||"end",r.set(n,e)),n):this.insert({html:t,caret:e})},detectPosition(t,e){var s,i;return e||(i=(s=this.app.create("caret")).is(t,"start"),e=s.is(t,"end")?"after":i?"before":"split"),e},_splitInline(t,e){var s=this.app.create("element"),i=this.app.create("caret"),s=s.split(t[0]);return s.before(e),""===s.html()&&s.remove(),i.set(s,"start"),this.dom(e)},_insertContent(){let t;return t=this.p.instance?this._insertInstance():"<br>"===this.p.html.trim()?this.insertBreakline():this._insertHtml()},_insertHtml(){var t=this.p.current||this.app.block.get(),e=this.app.create("utils");if("string"!=typeof this.p.html&&(this.p.html=this.dom(this.p.html).get().outerHTML),this.isEmpty=e.isEmptyHtml(this.p.html),this.isLine=e.isLine(this.p.html,this.p.type),!this.isEmpty){if(this.p.target)return this._createEmptyBlock(),this._insertToTarget();if(this.app.blocks.is())return this._createEmptyBlock(),this.app.context.close(),this._insertToBlocks();if(!t)return this._createEmptyBlock(),this._insertToEditor();if(!this._isTableToTable(t,this.p.html)){if(this._isListToList(t,this.p.html))return this._insertToList(t);if(t&&(t.isEditable()||t.isType("quote")||t.isInline())){if(!this.isEmpty)return this._insertToOneEditable(t)}else if(t&&!t.isEditable())return this._createEmptyBlock(),this._insertToOneNotEditable(t)}}},_insertToTarget(){var t=this.p.position||"after";let e=this.dom(this.p.target);this.p.html=this._clean(this.p.html);var s=this._parse(this.p.html),i=this.dom(s);let a=this._getLastNode(s);return e[t](s),this.p.remove&&e.fadeOut(500,function(){e.remove(),this.app.block.set(a,"end",!1,!0)}.bind(this)),this.app.editor.build(),this.p.remove||this.app.block.set(a,"end",!1,!0),i},_insertToBlocks(){let t=this.app.create("selection"),e,s,i,a,r,o;return this.p.html=this._clean(this.p.html),e=this._parse(this.p.html),a=this.dom(e),this.isLine?e=this._insertFragment({fragment:e}):(t.truncate(),this.app.context.close(),r=this.app.blocks.get({last:!0,selected:!0,instances:!0}),o=r.getBlock(),r.isType("listitem")&&this._isListToList(r,this.p.html)?(s=this.dom(e),o.before(s.children())):o.before(e)),i=this._getLastNode(e),this.app.editor.build(),this.app.block.set(i,"end"),a},_insertToEditor(){let t=this.app.create("element"),e,s,i,a,r;return this.p.html=this._clean(this.p.html),e=this._parse(this.p.html),a=this.dom(e),r=this._getLastNode(e),i="top"===this.opts.get("addPosition")?(s=this.app.blocks.get({first:!0,instances:!0}),"before"):(s=this.app.blocks.get({last:!0,instances:!0}),"after"),s.getBlock()[i](e),t.scrollTo(r),this.app.editor.build(),this.app.block.set(r,"end"),a},_insertToList(t){let e=this.app.create("selection"),s,i,a,r,o,n=t.getBlock();return this.p.html=this._clean(this.p.html),a=this._parse(this.p.html),r=this.dom(a),o=this._getLastNode(a),t.isType("list")?(i=r.children(),n.append(i)):(s=this.detectPosition(n,void 0),e.truncate(),this.app.context.close(),"split"===s?(i=a,this._insertFragment({fragment:a})):(i=r.children(),n[s](i))),this.app.editor.build(),this.app.block.set(o,"end"),i},_insertToTable(t){},_insertToOneEditable(t){let e=this.app.create("utils"),s=this.app.create("selection"),i=this.app.create("element"),a=this.app.create("caret"),r,o=!1,n=this.p.position,l,h,p=t.getBlock();var d,c;return this.p.html=this._clean(this.p.html),this.p.html=this._cleanSpecial(this.p.html,t),r=this._parse(this.p.html),h=this.dom(r),l=this._getLastNode(r),t.isInline()&&!t.isEditable()&&(a.set(p,"after"),t.remove()),this.isLine?(d=this.dom(r).find("li"),t.isType("todoitem")&&(c=this.dom("<div>").append(r),r=this._insertFragment({html:c.text()},this.p.caret||"end")),r=t.isType("listitem")&&0!==d.length?(r=this.dom(r).find("li").html(),this._insertFragment({html:r},this.p.caret||"end")):this._insertFragment({fragment:r},this.p.caret||"end"),h=this.dom(r)):(n=e.isEmptyHtml(p.html())?(o="input"!==this.p.type,"after"):n||this.detectPosition(p,n),o||(s.truncate(),this.app.context.close()),"split"===n?(c=i.split(p).before(r),this._cleanUpPart(c)):p[n](r),o&&t.remove(),this.app.editor.build(),this.app.block.set(l,"end")),h},_insertToOneNotEditable(t){let e,s,i,a=t.getBlock();return this.p.html=this._clean(this.p.html),e=this._parse(this.p.html),i=this.dom(e),s=this._getLastNode(e),t.isType(["cell","row","column"])&&(t=t.getParent(),a=t.getBlock()),a.after(e),this.app.editor.build(),this.app.block.set(s,"end"),i},_insertInstance(){let t=this.p.current||this.app.block.get(),e=this.p.position,s=this.app.create("element"),i=this.app.create("caret"),a=this.p.instance.getBlock(),r,o,n,l=!1,h=!1,p;var d,c;if(this.p.caret=this.p.instance.isType(["table","quote","layout"])?"start":this.p.caret||"end",t){if(t.isEditable()&&(e=this.detectPosition(t.getBlock(),e)),this.p.instance.isType("table")&&(t.isType("table")||t.getClosest("table"))){if(!t.isType("table"))return;e="after"}"duplicate"===this.p.type?(p=t.getBlock()).after(a):this.p.instance.isType("list")&&t.isType("listitem")?1===(n=this.p.instance.getItems()).length&&""===n[0]?(n=this.p.instance.getBlock(),t.getBlock().append(n)):(o=s.split(t.getBlock())).prepend(n):this.p.instance.isType("list")&&t.isType("list")?(n=this.p.instance.getItems(),t.getBlock().append(n)):(p=t.getBlock(),this.p.instance.isInline()?t.isInline()?e="after":t.isEditable()?e="fragment":t.isEditable()||(e="after",d=this.app.block.create(),(r=d.getBlock()).append(a)):t.isInline()?(e="split",i.set(p,"after"),p=p.parent().closest("[data-rx-type]"),l=!0):t.isType(["cell","column"])?e=this.p.position?e:"prepend":t.isType(["row","figcaption"])?(e="split"===e?"after":e,p=t.getParent().getBlock()):t.isType("todo")?this.p.instance.isType("todoitem")?e="append":this.p.instance.isType("todo")&&(a=this.p.instance.getItems(),e="append"):t.isType("quote")?e=t.isCaretStart()?"before":t.isCaretEnd()?"after":"split":t.isType("todoitem")?this.p.instance.isType("todoitem")?e="after":this.p.instance.isType("todo")?(a=this.p.instance.getItems(),e="after"):(p=t.getParent().getBlock(),t.getParent().isCaretStart()?e="before":t.getParent().isCaretEnd()?e="after":(e="split",h="list-empty",t.setCaret("end"))):t.isType("listitem")?(p=t.getBlock().parents("ul, ol").last(),t.getParentTopInstance().isCaretStart()?e="before":t.getParentTopInstance().isCaretEnd()?e="after":(e="split",h="list-normalize")):t.isType("list")&&"split"===e&&(h="list-empty"),"split"===(e="duplicate"===this.p.type?"after":e)?((o=s.split(p)).before(a),"list-empty"===h?o.find("li").first().remove():"list-normalize"===h&&((c=(d=o.find("li").first()).clone()).find("ol, ul").remove(),""===c.text().trim())&&((c=d.find("ol, ul").first().children()).find("ul, ol").each(function(t){t.removeAttr("data-rx-type"),this.app.create("block.list",t)}.bind(this)),o.find("li").each(function(t){t.removeAttr("data-rx-type"),this.app.create("block.listitem",t)}.bind(this)),d.before(c),d.remove()),this._cleanUpPart(o)):"fragment"===e?this._insertFragment({node:a.get()},"start"):r?p[e](r):p[e](a),(l||this.p.remove&&t.isEditable()&&t.isEmpty())&&t.remove()),this.app.editor.build(),this.p.caret&&setTimeout(function(){this.app.block.set(a,this.p.caret)}.bind(this),0)}else e="top"===this.opts.get("addPosition")?(t=this.app.blocks.get({first:!0,instances:!0}),"before"):(t=this.app.blocks.get({last:!0,instances:!0}),"after"),p=t.getBlock(),this.p.instance.isInline()?(c=this.app.block.create(),(r=c.getBlock()).append(a)):this.p.instance.isType("list")&&t.isType("list")&&(n=this.p.instance.getItems(),t.getBlock().append(n)),r?p[e](r):p[e](a),this.app.editor.build(),this.p.caret&&setTimeout(function(){this.app.block.set(a,this.p.caret),s.scrollTo(a)}.bind(this),0);return this.p.instance},_insertFragment(t,e){let s;var i=this.app.create("fragment"),a=this.app.create("caret");let r;if(void 0!==t.html||t.fragment?(s=i.create(t.html||t.fragment),i.insert(s)):i.insert(t.node),e&&(i=t.node||("start"===e?s.first:s.last),a.set(i,e)),r=t.node||s.nodes,Array.isArray(r))for(var o of r){var n,o=this.dom(o);o.dataget("instance")||(n=o.attr("data-rx-type"))&&this.app.create("block."+n,o)}return this.dom(r)},_setContent(){let t=this.app.create("utils"),e,s,i,a,r;return this.isEmpty=t.isEmptyHtml(this.p.html),this.isLine=t.isLine(this.p.html),this._createEmptyBlock(),this.p.html=this._clean(this.p.html),r=this._parse(this.p.html),a=this.dom(r),e=this._getLastNode(r),s=this._getFirstNode(r),this.app.editor.unsetSelectAll(),this.setEmpty(),this.app.editor.getLayout().append(r),this.p.caret&&(i="start"===this.p.caret?s:e,setTimeout(function(){this.app.block.set(i,this.p.caret)}.bind(this),0)),this.isEmpty&&this.app.broadcast("editor.empty"),this.app.editor.build(),this.app.broadcast("editor.set",{inserted:a}),a},_parse(t){var e=this.app.create("parser");let s;return s=this.p.parse?e.parse(t,{type:this._getParseType(),nodes:!0,paragraphize:this.p.paragraphize}):(s=e.build(t)).get().childNodes},_getParseType(){return this.isLine?"line":"html"},_clean(t){var e=this.app.create("cleaner");return this.p.clean?e.clean(t):t},_cleanSpecial(t,e){let s,i=this.app.create("cleaner"),a,r=e.getType();return-1!==["address","figcaption","quote","todoitem","dlist"].indexOf(r)?s=!0:"list"===r||"listitem"===r?(s=!0,a=["ul","ol","li"]):"pre"===r&&(s=!0),s&&(this.isLine=!0,"pre"===r?t=i.removeBreakline(t):"list"!==r&&"listitem"!==r&&(t=i.addBrToBlocks(t)),t=(t=i.removeBlockTags(t,void 0,a)).replace(/<br\s?\/?>\n?$/gi,"")),t},_cleanUpPart(t){t.find(".rx-block-focus").removeClass("rx-block-focus rx-block-control-focus"),t.removeClass("rx-block-focus rx-block-control-focus")},_createEmptyBlock(){this.isLine&&(this.p.html=this.app.block.createHtml(this.p.html))},_isListToList(t,e){t.getBlock();let s=t.getType(),i=this.dom("<div>").html(e);return i.find("meta").remove(),i.find("b").unwrap(),i=i.children().first(),("list"===s||"listitem"===s)&&0!==i.length&&-1!==["ul","ol"].indexOf(i.tagName())},_isTableToTable(t,e){t=t.getClosest("table"),e=this.dom("<div>").html(e);return t&&0!==e.find("table").length},_getFirstNode(t){return this.dom(t).first()},_getLastNode(t){return this.dom(t).last()}}),d.add("class","clipboard",{getContent(t){var e=this._determineContentType(t),t=t.getData(e),s=this.app.create("cleaner");return"text/plain"===e?s.escapeHtml(t):t},setContent(t,e,s){var t=t.clipboardData,i=this.app.create("utils"),a=this.app.create("unparser");e=this._cleanSvgWhitespace(e),e=this._prepareHtmlForClipboard(e,a),s=this._prepareTextForClipboard(e,s,i),t.setData("text/html",e),t.setData("text/plain",s)},isPlainText(t){var e=t.getData("text/plain"),t=t.getData("text/html");return!(t&&t.trim())&&null!==e},_cleanSvgWhitespace(t){return t.replace(/(\s*)<svg([^>]*?)>([\s\S]*?)<\/svg>(\s*)/g,function(t,e,s,i,a,r,o){return" <svg"+s+">"+i.trim()+"</svg> "})},_determineContentType(t){return this.isPlainText(t)?"text/plain":"text/html"},_prepareHtmlForClipboard(t,e){return'<meta type="rx-editor"/>'+(t=e.unparse(t,{clipboard:!0}))},_prepareTextForClipboard(t,e,s){return e||s.getTextFromHtml(t,{nl:!0})}}),d.add("class","autoparse",{parse(t){var e,s,i;return this.opts.is("paste.autoparse")&&(e=this.app.block.get(),s=[],i=this.app.create("cleaner"),t=this._preprocessHtml(t,i),t=this._storeAndReplaceTags(t,["figure","html","form","pre","div","span","video","object","iframe","code","a","img","link","script"],["div","img","html","span"],s),t=this._replaceLinksAndImages(t,e),t=this._restoreStoredHtml(t,s,i),t=this._restoreStoredHtml(t,s,i)),t},_preprocessHtml(t,e){return t=e.storeComments(t),t=e.store(t,"svg"),e.removeDoctype(t)},_replaceLinksAndImages(t,e){return t=t.replace("&amp;","&"),t=this._formatLinks(t),this._replaceImages(t,e)},_storeAndReplaceTags(s,t,e,i){return t.forEach(t=>{t=e.includes(t)?`<${t}[^>]*>`:`<${t}[^>]*>([\\w\\W]*?)</${t}>`,t=s.match(new RegExp(t,"gi"));t&&t.forEach((t,e)=>{s=s.replace(t,`#####replaceparse${i.length}#####`),i.push(t)})}),s},_formatLinks(e){var s=this.opts.get("regex.aurl1"),r=this.opts.get("regex.aurl2"),t=this.opts.get("regex.imageurl");if((e.match(s)||e.match(r))&&!e.match(t)){let t=this.opts.get("paste.linkTarget"),i=this.opts.get("https")?"https":"http",a=!1!==t?` target="${t}"`:"";e=(e=e.replace(s,t=>`<a href="${t}"${a}>${this._subLinkText(t)}</a>`)).replace(r,(t,e,s)=>`${e}<a href="${i}://${s}"${a}>${this._subLinkText(s)}</a>`)}return e},_replaceImages(e,s){var t=this.opts.get("regex.imageurl"),t=e.match(t);return t&&t.forEach(t=>{e=e.replace(t,this._splitBlock(s,`<img src="${t}">`))}),e},_restoreStoredHtml(s,t,e){return t.forEach((t,e)=>{s=s.replace(`#####replaceparse${e}#####`,t)}),s=e.restoreComments(s),e.restore(s,"svg")},_splitBlock(t,e){return t?`
${e}
`:e},_subLinkText(t){var e=this.opts.get("link.size");return t=(t=t.length>e?t.substring(0,e)+"...":t).includes("%")?t:decodeURIComponent(t)}}),d.add("class","stack",{init(){this.data=!1},create(t,e){this.params=d.extend({},{title:!1,footer:!1,setter:!1,getter:!1,form:!1,button:!1,width:"240px"},e),this.name=t,this._build(),this._buildBody(),this._buildFooter()},render(){this._renderForm(),this._renderFooter(),this.app.modal.updateWidth(this.params.width)},renderFocus(t){this.form&&this.form.renderFocus(t)},setData(t){this.data=t},hasForm(){return this.params.form},getTitle(){return this.params.title},getStack(){return this.$stack},getBody(){return this.$body},getForm(){return this.form},getButtonPrimary(){return this.$footer.find(".rx-form-button-primary")},getFooter(){return this.$footer},getFormItem(t){return this.form?this.form.getItem(t):null},getInput(t){return this.form?this.form.getInput(t):null},getTool(t){return this.form?this.form.getTool(t):null},getData(t){return this.form?this.form.getData(t):null},_build(){this.$stack=this.dom("<div>").addClass("rx-modal-stack")},_buildBody(){this.$body=this.dom("<div>").addClass("rx-modal-body"),this.$stack.append(this.$body)},_buildFooter(){this.$footer=this.dom("<div>").addClass("rx-modal-footer"),this.$stack.append(this.$footer)},_renderForm(){this.params.form&&(this.form=this.app.create("form"),this.form.create({data:this.data,setter:this.params.setter,getter:this.params.getter,items:this.params.form}),this.$form=this.form.getElement(),this.$body.append(this.$form))},_renderFooter(){this.footerbuttons=0;var t=this.params.footer;if(t){this.$footer.html("");for(var[e,s]of Object.entries(t))!1!==s&&(e=this.app.create("stack-button",e,this,s),this.$footer.append(e.getElement()),this.footerbuttons++)}}}),d.add("class","stack-button",{init(t,e,s){this.prefix="rx",this.name=t,this.obj=s,this.popup=e,this.$button=this.dom("<button>").addClass(this.prefix+"-form-button"),this.$button.attr("data-name",this.name),this.$button.html(this.lang.parse(this.obj.title)),this.$button.dataset("instance",this),this._has("type")&&this.$button.addClass(this.prefix+"-form-button-"+this.obj.type),this._has("classname")&&this.$button.addClass(this.obj.classname),this._has("fullwidth")&&this.$button.addClass(this.prefix+"-form-button-fullwidth"),this._has("right")&&this.$button.addClass(this.prefix+"-form-button-push-right"),this.$button.on("click."+this.prefix+"-popup-button"+this.uuid,this._catch.bind(this))},getName(){return this.name},getElement(){return this.$button},invokeCommand(){this._invoke()},_has(t){return Object.prototype.hasOwnProperty.call(this.obj,t)},_catch(t){t.preventDefault(),t.stopPropagation(),this._has("command")?this._invoke(t):this._has("close")&&this.app.popup.close()},_invoke(t){this.app.api(this.obj.command,this.popup,this.name,t)}}),d.add("class","upload",{defaults:{type:"image",box:!1,url:!1,cover:!0,name:"file",data:!1,multiple:!0,placeholder:!1,progress:!0,hidden:!0,target:!1,success:!1,error:!1,remove:!1,trigger:!1,input:!1},init(t,e,s){this.eventname="rx-upload",t&&this._build(t,e,s)},send(t,e,s,i){this.p=this._buildParams(s,i),this._send(t,e)},complete:function(t,e){this._complete(t,e)},setImage(t){this.p.input||(this.$image&&this.$image.remove(),this.Redactoremove&&this.Redactoremove.remove(),""===t?this.$placeholder.show():(this.$placeholder.hide(),this._buildImage(t),this.p.remove&&this._buildRemove()))},_build(t,e,s){this.p=this._buildParams(e,s),this.$element=this.dom(t),this.$element.tagName("input")?this._buildByInput():this._buildByBox()},_buildImage(t){this.$image=this.dom("<img>"),this.$image.attr("src",t),this.$box.append(this.$image),!1===this.p.input&&(this.$box.off("click."+this.eventname),this.$image.on("click."+this.eventname,this._click.bind(this)))},_buildRemove(){this.Redactoremove=this.dom("<span>"),this.Redactoremove.addClass("rx-upload-remove"),this.Redactoremove.on("click",this._removeImage.bind(this)),this.$box.append(this.Redactoremove)},_buildParams(t,e){return t=d.extend(!0,this.defaults,t),e&&(t.trigger=e),t},_buildByInput(){this.$input=this.$element,this.p.box?(this._buildBox(),this._buildPlaceholder()):this.p.input=!0,this._buildAccept(),this._buildMultiple(),this._buildEvents()},_buildByBox(){this._buildInput(),this._buildAccept(),this._buildMultiple(),this._buildBox(),this._buildPlaceholder(),this._buildEvents()},_buildBox(){this.$box=this.dom("<div>").addClass("rx-form-upload-box"),this.$element.before(this.$box),!1===this.p.cover&&this.$box.addClass("rx-form-upload-cover-off"),this.p.hidden&&this.$element.hide()},_buildPlaceholder(){this.p.placeholder&&(this.$placeholder=this.dom("<span>").addClass("rx-form-upload-placeholder"),this.$placeholder.html(this.p.placeholder),this.$box.append(this.$placeholder))},_buildInput(){this.$input=this.dom("<input>"),this.$input.attr("type","file"),this.$input.attr("name",this._getUploadParam()),this.$input.hide(),this.$element.before(this.$input)},_buildAccept(){var t;"image"===this.p.type&&(t=this.opts.get("image.types").join(","),this.$input.attr("accept",t))},_buildMultiple(){"image"===this.p.type&&(this.p.multiple?this.$input.attr("multiple","multiple"):this.$input.removeAttr("multiple"))},_buildEvents(){this.$input.on("change."+this.eventname+"-"+this.uuid,this._change.bind(this)),!1===this.p.input&&(this.$box.on("click."+this.eventname,this._click.bind(this)),this.$box.on("drop."+this.eventname,this._drop.bind(this)),this.$box.on("dragover."+this.eventname,this._dragover.bind(this)),this.$box.on("dragleave."+this.eventname,this._dragleave.bind(this)))},_buildData(t,e,s){if("single"===this.p.multiple)s.append(t,e[0]);else if(this.p.multiple)for(var i=0;i<e.length;i++)s.append(t+"[]",e[i]);else s.append(t+"[]",e[0]);return s},_removeImage(t){t&&(t.preventDefault(),t.stopPropagation()),this.$image&&this.$image.remove(),this.Redactoremove&&this.Redactoremove.remove(),this.$placeholder.show(),!1===this.p.input&&this.$box.on("click."+this.eventname,this._click.bind(this)),t&&this.app.api(this.p.remove,t)},_getUploadParam(){return this.p.name},_click(t){t.preventDefault(),this.$input.click()},_change(t){this._send(t,this.$input.get().files)},_drop(t){t.preventDefault(),this._send(t)},_dragover(t){return t.preventDefault(),this._setStatus("hover"),!1},_dragleave(t){return t.preventDefault(),this._removeStatus(),!1},_setStatus(t){!this.p.input&&this.p.box&&(this._removeStatus(),this.$box.addClass("rx-form-upload-"+t))},_removeStatus(){if(!this.p.input&&this.p.box)for(var t=["hover","error"],e=0;e<t.length;e++)this.$box.removeClass("rx-form-upload-"+t[e])},_send(t,e){e=e||t.dataTransfer.files;var s=new FormData,i=this._getUploadParam(),a=this.app.create("utils"),s=this._buildData(i,e,s);s=a.extendData(s,this.p.data),this._sendData(t,e,s)},_sendData(e,s,i){"function"==typeof this.p.url?this.p.url.call(this.app,this,{data:i,files:s,e:e}):(this.app.progress.show(),this.ajax.post({url:this.p.url,data:i,before:function(t){if(this.app.broadcast("upload.before.send",{xhr:t,data:i,files:s,e:e}).isStopped())return this.app.progress.hide(),!1}.bind(this),success:function(t){this._complete(t,e)}.bind(this),error:function(t){this._complete(t,e)}.bind(this)}))},_complete(t,e){t&&t.error?(this._setStatus("error"),this.p.error&&(this.app.broadcast("upload.error",{response:t}),this.app.api(this.p.error,t,e))):(this._removeStatus(),this._trigger(t),this.p.success&&(this.app.broadcast("upload.complete",{response:t}),this.app.api(this.p.success,t,e))),setTimeout(function(){this.app.progress.hide()}.bind(this),500)},_trigger(t){var e;this.p.trigger&&t&&t.url&&(e=this.p.trigger.instance)[this.p.trigger.method].call(e,t.url)}}),d.add("class","colorpicker",{build(t){return this.$colorpicker=this.dom('<div class="rx-colorpicker rx-colorpicker-'+this.uuid+'">'),this._build(t,this.$colorpicker),this.app.$body.append(this.$colorpicker),this._buildPosition(),this._buildEvents(),this.$colorpicker},create(t){return this.$dropdown=this.dom('<div class="rx-dropdown-box">'),this._build(t,this.$dropdown),this.$dropdown.on("mouseleave.rx-colorpicker",this._outLayerColor.bind(this)),this.$dropdown},_buildPosition(t){var e=this.params.$toggle.offset(),s=this.params.$toggle.width(),i=e.top,s=e.left+s;0===e.left?this.$colorpicker.hide():this.$colorpicker.show(),this.$colorpicker.css({top:i+"px",left:s+"px"}),this.app.ui.buildDepth("colorpicker",this.$colorpicker)},_buildEvents(){this.app.scroll.getTarget().on("resize.rx-colorpicker scroll.rx-colorpicker",this._buildPosition.bind(this)),this.$colorpicker.on("mouseleave.rx-colorpicker",this._outLayerColor.bind(this))},_build(t,e){this.params=d.extend({},{$toggle:!1,colors:!1,method:!1,style:{},name:"color",tabs:!1,instant:!1,set:!1,input:!1,remove:!1},t),this.currentColor=this.params.style.color||!1,this.currentBackgroundColor=this.params.style.background||!1;let s=this.dom('<div class="rx-dropdown-layer rx-dropdown-layer-'+this.params.name+'">').attr("data-type",this.params.name),i,a;if(this.params.tabs){var r=this.dom('<div class="rx-dropdown-tabs">'),o=(e.append(r),this.params.tabs);for(let t=0;t<o.length;t++){var n=this.dom('<a href="#">').attr("data-tab",o[t]).addClass("rx-dropdown-tab rx-dropdown-tab-"+o[t]).html(this.lang.get("colorpicker."+o[t]));n.on("click.rx-dropdown-tab",this._selectTab.bind(this)),0===t&&n.addClass("active"),r.append(n),i=this._buildPicker(o[t]),(s=this.dom('<div class="rx-dropdown-layer rx-dropdown-layer-'+o[t]+'">').attr("data-type",o[t])).append(i),s.on("mouseover",this._outColor.bind(this)),this._createInput(s,o[t]),this.params.remove&&this.params.remove[o[t]]&&(n=this.params.remove[o[t]],a=this.app.create("button","remove",this._createRemoveButton(o[t],n),!1,"dropdown"),s.append(a.getElement())),t===o.length-1&&s.hide(),e.append(s)}}else i=this._buildPicker(this.params.name),s.append(i),s.on("mouseover",this._outColor.bind(this)),this._createInput(s,this.params.name),this.params.remove&&(a=this.app.create("button","remove",this._createRemoveButton(this.params.name,this.params.remove),!1,"dropdown"),s.append(a.getElement())),e.append(s)},_createInput(t,e){var s,i,a,r,o;this.params.input&&(s=this.dom("<div>").addClass("rx-form-box"),i=this.dom("<label>").addClass("rx-form-label").html(this.lang.get("colorpicker.set-color")),a=this.dom("<div>").addClass("rx-form-flex"),r=this.dom('<input type="input">').addClass("rx-form-input rx-form-input-"+e+" rx-in-tool"),(o=this.dom('<button">').attr("data-rule",e).addClass("rx-form-button rx-in-tool").html("&rarr;")).on("click",this._setFromInput.bind(this)),e="color"===e?this.currentColor:this.currentBackgroundColor,r.val(e=e||""),a.append(r),a.append(o),s.append(i),s.append(a),t.append(s),this.input=!0)},_createRemoveButton(t,e){return{position:"last",title:this.lang.get("colorpicker.remove-"+t),command:e}},_inColor(t){var t=this.dom(t.target).closest("a"),e=t.data("rule"),s=t.attr("rel"),t=t.closest(".rx-dropdown-layer"),i=t.find(".rx-form-input-"+e);this.params.instant&&this._setInstant(e,s),t.attr("data-color")||(e=this.input?i.val():this.params.style.color,t.attr("data-color",e="false"===e||""===e?"empty":e)),this.input&&i.val(s)},_outLayerColor(t){var t=this.dom(t.target).find(".rx-dropdown-layer[data-color]"),e=t.data("type"),s=t.attr("data-color");this._clearColor(t,s,e)},_outColor(t){var e,s,t=this.dom(t.target);0===t.closest(".rx-dropdown-color-box").length&&(e=(t=t.closest(".rx-dropdown-layer")).data("type"),s=t.attr("data-color"),this._clearColor(t,s,e))},_clearColor(t,e,s){e&&(e="empty"===e?"":e,this.params.instant&&this._setInstant(s,e),t.removeAttr("data-color"),this.input)&&t.find(".rx-form-input-"+s).val(e)},_selectTab(t){t.preventDefault(),t.stopPropagation();var t=this.dom(t.target),e=t.closest(".rx-dropdown-box"),t=t.attr("data-tab");e.find(".rx-dropdown-layer").hide(),e.find(".rx-dropdown-tab").removeClass("active"),e.find(".rx-dropdown-layer-"+t).show(),e.find(".rx-dropdown-tab-"+t).addClass("active")},_buildPicker(t){var e,s,i=this.dom('<div class="rx-dropdown-color-box rx-dropdown-box-'+t+'">'),a=this.dom('<div class="rx-dropdown-swatches">'),r="background"==t?"background":"color",o=(this.params.colors.length,this.opts.get("colorpicker.row")),n=this.opts.get("colorpicker.size"),t=this.opts.get("colorpicker.wrap"),l=this.opts.get("colorpicker.width");t&&a.addClass("rx-dropdown-swatches-wrap"),l&&a.css("max-width",l);for([e,s]of Object.entries(this.params.colors)){var h=this.dom('<div class="rx-dropdown-swatches-colors">');o&&h.addClass("rx-dropdown-swatches-colors-row");for(let t=0;t<s.length;t++){var p=s[t],d=this.dom('<a href="#" tabindex="-1" class="rx-dropdown-swatch">');n&&d.addClass("rx-dropdown-swatch-size-"+n),d.attr({rel:p,"data-rule":r}),d.css({background:p}),d.on("click",this._set.bind(this)),d.on("mouseover",this._inColor.bind(this)),d.attr({title:e+"-"+t}),"#fff"!==p&&"#ffffff"!==p||d.addClass("rx-dropdown-color-contrast"),"color"==r&&this.currentColor===p&&d.addClass("active"),"background"==r&&this.currentBackgroundColor===p&&d.addClass("active"),h.append(d)}a.append(h)}return i.append(a),i},_setFromInput(t){t.preventDefault(),t.stopPropagation();var e,t=this.dom(t.target),s=t.prev().val();""!==s&&(e=this.app.create("utils"),this.app.create("offset"),e=e.normalizeColor(s),s={tag:"span",style:"color"===t.data("rule")?{color:e}:{background:e}},this.app.inline.restoreOffset(),this._call(e,s,!1,!0))},_set(t){t.preventDefault(),t.stopPropagation(),this.$colorpicker&&this.$colorpicker.off(".rx-colorpicker"),this.params.instant&&!this.params.method?(this.app.create("selection"),this.app.dropdown.close(),this.app.editor.restore(),this.$dropdown&&this.$dropdown.off(".rx-colorpicker")):this._setCall(t)},_setCall(t){var t=this.dom(t.target).closest("a"),e=t.attr("rel"),t="color"===t.data("rule")?{color:e}:{background:e};this._call(e,{tag:"span",style:t})},_setInstant(t,e){this._call(e,{tag:"span",style:"color"===t?{color:e}:{background:e}},!0)},_call(t,e,s,i){this.params.method?this.params.method.apply(this,[t,s,i]):this.app.api(this.params.set,e,s,i)}}),d.add("class","form",{init(){this.tools={},this.data=!1},create(t){this.params=d.extend({},{title:!1,data:!1,width:!1,items:!1,focus:!1,setter:!1,getter:!1,footer:!1},t),this.data=this.params.data,this._build(),this._buildTitle(),this._buildData(),this._buildForm(),this._buildFocus(),this._buildFooter()},renderFocus(t){this._buildFocus(t)},setData(t){this.data=t},getSetter(){return this.params.setter},getElement(){return this.$form},getItem(t){t=this.getTool(t);return t?t.getInput().closest(".rx-form-item"):this.dom()},getInput(t){t=this.getTool(t);return t?t.getInput():this.dom()},getTool(t){return void 0!==this.tools[t]&&this.tools[t]},getData(t){let e;return t?void 0!==this.tools[t]&&(e=this.tools[t].getValue()):(e={},Object.keys(this.tools).forEach(function(t){e[t]=this.tools[t].getValue()}.bind(this))),e},_build(){this.$form=this.dom("<div>").addClass("rx-form rx-form-"+this.uuid),this.params.width&&this.$form.css("width",this.params.width)},_buildData(){this.data||(this.data=!!this.params.getter&&this.app.api(this.params.getter,this))},_buildFocus(t){(t=t||this.params.focus)&&void 0!==this.tools[t]&&this.tools[t].setFocus()},_buildTitle(){this.params.title&&(this.$title=this.dom("<div>").addClass("rx-form-title"),this.$title.html(this.lang.parse(this.params.title)),this.$form.append(this.$title))},_buildFooter(){if(this.params.footer){this.$footer=this.dom("<div>").addClass("rx-form-footer"),this.$form.append(this.$footer);var t,e,s=this.params.footer;for([t,e]of Object.entries(s)){var i=this.app.create("stack-button",t,this,e);this.$footer.append(i.getElement())}}},_buildForm(){this._renderTools(),this._renderData(),this.$form.find("input[type=text],input[type=url],input[type=email]").on("keydown.rx-form",function(t){if(13===t.which)return t.preventDefault(),!1}.bind(this))},_renderTools(){for(var[t,e]of Object.entries(this.params.items))if(e.title){var s=this.dom('<div class="rx-form-section-title">');s.html(this.lang.parse(e.title)),this.$form.append(s)}else if("flex"===t){var i,a,r=this.dom('<div class="rx-form-container-flex">');this.$form.append(r);for([i,a]of Object.entries(e))this._renderTool(i,a,r)}else this._renderTool(t,e,this.$form)},_renderTool(t,e,s){var e=this.app.create("tool."+e.type,t,e,this,this.data),i=e.getElement();i&&(this.tools[t]=e,s.append(i))},_renderData(){if(this.data)for(var t in this.data)void 0!==this.tools[t]&&this.tools[t].setValue(this.data[t])}}),d.add("class","editor",{init(t){this.editor=t,this._build(),this._buildOptions(),this.editor._buildBlurClass(),this.editor._buildAccessibility(),this.editor._buildEditable(),this.editor._buildContent(),this._load()},_build(){let t=!1;var e=this.app.container.get("editor"),s=(this.app.element.isTextarea()?(this.editor.$editor=this.dom("<div>"),this.editor.$source=this.app.element):(this.editor.$editor=this.app.element,this.editor.$source=this.dom("<textarea>").hide(),t=!0),this.opts.get("classname"));this.opts.is("nostyle")&&"rx-content"===s||this.editor.$editor.addClass(s),this.opts.is("breakline")&&this.editor.$editor.addClass("rx-editor-breakline"),this.editor.$editor.addClass("rx-editor rx-editor-"+this.uuid+" rx-empty"),e.append(this.editor.$editor),t&&e.append(this.editor.$source)},_buildOptions(){var t=this.opts.dump();let e=t.dir;var s=t.width||"100%",s=(this.app.element.isTextarea()||(this.editor.savedStyles=this.app.element.attr("style"),this.editor.savedDir=this.app.element.attr("dir")),this.opts.is("tabindex")&&this.editor.$editor.attr("tabindex",this.opts.get("tabindex")),this.opts.is("nocontainer")||this.editor.$editor.css("max-width",s),this.app.element.attr("dir")&&(e=this.app.element.attr("dir")),this.editor.$editor.attr("dir",e),this.opts.is("nocontainer")||this.editor.$editor.css("padding",t.padding),t.minHeight&&this.editor.$editor.css("min-height",t.minHeight),t.maxHeight&&this.editor.$editor.css({"max-height":t.maxHeight,overflow:"auto"}),this.app.container.get("main"));this.opts.is("container.border")||s.css("border","none"),t.notranslate&&this.editor.$editor.addClass("notranslate"),t.spellcheck||this.editor.$editor.attr("spellcheck",!1),t.grammarly||this.editor.$editor.attr("data-gramm_editor",!1)},_load(){try{this._loaded()}catch(t){d.error(t)}},_loaded(){this.app.event.build(),this.app.placeholder.build(),this.app.placeholder.trigger(),this.app.blocks.build(),this.app.sync.build(),this.app.embed.build(),this.app.observer.build(),this.app.image.observeStates(),this.editor._buildDraggable(),this.app.loaded=!0,this.app.broadcast("editor.load")}}),d.add("class","editor-iframe",{init(t){this.editor=t,this._build(),this.editor._buildBlurClass(),this.editor._buildAccessibility(),this._buildStartHtml()},_build(){var t=this.app.container.get("editor");this.editor.$editor=this.dom("<iframe>").addClass("rx-editor-frame"),this.editor.$editor.css({visibility:"hidden",margin:"0",padding:"0"}),this.editor.$source=this.app.element,this.opts.is("maxHeight")||this.editor.$editor.attr("scrolling","no"),t.append(this.editor.$editor),this.editor.$editor.on("load",this._onload.bind(this))},_buildOptions(){var t=this.opts.dump();let e=t.dir;var s=t.width||"100%",s=(this.app.element.isTextarea()||(this.editor.savedStyles=this.app.element.attr("style"),this.editor.savedDir=this.app.element.attr("dir")),this.opts.is("tabindex")&&this.editor.$editor.attr("tabindex",this.opts.get("tabindex")),this.editor.$layout.css("max-width",s),this.app.element.attr("dir")&&(e=this.app.element.attr("dir")),this.editor.$layout.attr("dir",e),this.editor.$layout.css("padding",t.padding),t.minHeight&&this.editor.$editor.css("min-height",t.minHeight),t.maxHeight&&this.editor.$editor.css({"max-height":t.maxHeight,overflow:"auto"}),this.app.container.get("main"));this.opts.is("container.border")||s.css("border","none"),t.notranslate&&this.editor.$layout.addClass("notranslate"),t.spellcheck||this.editor.$layout.attr("spellcheck",!1),t.grammarly||this.editor.$layout.attr("data-gramm_editor",!1)},_buildLayout(){var t=this.app.getFrameBody();this.editor.$layout=t.children().first(),this.editor.$layout.attr("dir",this.opts.get("dir")),this.opts.is("nostyle")||this.editor.$layout.addClass(this.opts.get("classname")),this.opts.is("breakline")&&this.editor.$layout.addClass("rx-editor-breakline"),this.editor.$layout.addClass("rx-editor rx-editor-"+this.uuid+" rx-empty"),t.css("height","auto")},_buildStartHtml(){var t=this._createDoctype(),e=this._createScripts(),s='<div class="'+this.opts.get("classname")+'"></div>',i=this._buildCustomJs(),a=this.opts.is("frame.lang")?' lang="'+this.opts.get("frame.lang")+'"':"",r=this.opts.is("frame.dir")?' dir="'+this.opts.get("frame.dir")+'"':"";this._writeCode(t+"<html"+a+r+'><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">'+i+'</head><body style="padding: 0; margin: 0; width: 100%;">'+s+e+"</body></html>")},_buildCustomJs(){if(!this.opts.is("custom.js"))return"";var e,s=this.opts.get("custom.js");let i="";for(let t=0;t<s.length;t++)"object"==typeof s[t]&&void 0!==s[t].head&&(e=this.dom("<script>").attr("src",s[t].src),i+=e.get().outerHTML);return i},_buildVisibility(){this.editor.$editor.css("visibility","visible")},_buildEditorCss(){var t=this.opts.get("css"),e=this.opts.get("cssFile");this._buildCssLink(t+e)},_buildCustomCss(){if(this.opts.is("custom.css")){var e=this.opts.get("custom.css");for(let t=0;t<e.length;t++)this._buildCssLink(e[t])}},_buildCssLink(t){var e="object"==typeof t?t:{href:t},t=-1===("string"==typeof t?t:t.href).search(/\?/g)?"?":"&",t=this.opts.is("csscache")?"":t+(new Date).getTime(),t=(e.href=e.href+t,this.dom("<link>").attr({class:"rx-css",rel:"stylesheet"}));t.attr(e),this.app.getFrameHead().append(t)},_writeCode(t){var e=this.app.getDocNode();e.open(),e.write(t),e.close()},_createDoctype(){return this.opts.get("doctype")+"\n"},_createScripts(){if(!this.opts.is("custom.js"))return"";let e="";var s=this.opts.get("custom.js");for(let t=0;t<s.length;t++){var i="object"==typeof s[t]?s[t]:{src:s[t]};i.src=i.src+"?"+(new Date).getTime(),i.head||(i=this.dom("<script>").addClass("rx-js").attr(i),e+=i.get().outerHTML)}return e},_onload(){this._buildLayout(),this._buildOptions(),this.editor._buildContent(),this.editor._buildEditable(),this._loaded()},_loaded(){this.app.event.build(),this.app.placeholder.build(),this.app.placeholder.trigger(),this.app.blocks.build(),this.app.sync.build(),this.app.embed.build(),this.app.image.observeStates(),this._buildVisibility(),this._buildEditorCss(),this._buildCustomCss(),this.editor._buildDraggable(),this.app.getWin().on("resize.rx-editor-frame",this.editor.adjustHeight.bind(this)),this.app.loaded=!0,this.app.broadcast("editor.load"),this.editor.adjustHeight(),setTimeout(function(){this.app.isStopped()||(this.editor.adjustHeight(),this.app.editor.getEditor().focus(),this.editor.setFocus(this.opts.get("focus")),this.app.observer.build(),this.app.broadcast("editor.ready"))}.bind(this),500),setTimeout(this.editor.adjustHeight.bind(this),3e3)}}),d.add("class","event",{init(t){this.event=t,this.events={editor:["click","touchstart","mouseover","mouseup","mousedown","keyup","keydown","drop","dragstart","dragover","dragleave","focus"],doc:["keydown","mousedown","mouseup","click","paste","cut","copy"],win:["focus"]}},start(){this._buildTargetEvents(this.app.editor.getEditor(),this.events.editor,""),this._buildTargetEvents(this.$doc,this.events.doc,"doc"),this._buildTargetEvents(this.$win,this.events.win,"win")},stop(){this.app.editor.getEditor().off("."+this.event.eventname),this.$doc.off("."+this.event.eventname),this.$win.off("."+this.event.eventname)},onfocus(t){this.event.isTabFocus&&!this.app.editor.hasFocus()&&(this.app.editor.setFocus("start"),this.event.isTabFocus=!1)},onmouseup(t){return this.event._onmouseup(t)},onmousedown(t){return this.event._onmousedown(t)},onclick(t){return this.event._onclick(t)},ontouchstart(t){return this.event._ontouchstart(t)},onmouseover(t){return this.event._onmouseover(t)},onkeyup(t){return this.event._onkeyup(t)},onkeydown(t){this.app.broadcast("editor.keydown",{e:t})},ondrop(t){return this.event._ondrop(t)},ondragstart(t){return this.event._ondragstart(t)},ondragover(t){return this.event._ondragover(t)},ondragleave(t){return this.event._ondragleave(t)},ondockeydown(t){if(this.event.trigger&&!(this.app.block.isTool()||(this.app.broadcast("editor.before.keydown",{e:t}),this.event._checkTabFocus(t),this.event._checkPopupsOpen(t),this.event._checkPanelKeys(t))||this.event._checkModalEnter(t)||this.event._isOutsideEditor(t)))return this.event._onkeydown(t)},ondocmousedown(t){if(this.event.trigger)return this.event._ondocmousedown(t)},ondocmouseup(t){!this.event.trigger||this.event._isToolClick(t)||(!1===this.event.isPopupMouseUp&&this.event._checkContainerClick(t),this.app.broadcast("document.mouseup",{e:t}))},ondocclick(t){return this.event._ondocclick(t)},ondocpaste(t){return this.event._onpaste(t)},ondoccopy(t){return this.event._oncopy(t)},ondoccut(t){return this.event._oncut(t)},onwinfocus(t){return this.event._onwinfocus(t)},_buildTargetEvents(t,e,s){for(var i=0;i<e.length;i++)t.on(e[i]+"."+this.event.eventname,this["on"+s+e[i]].bind(this))}}),d.add("class","event-iframe",{init(t){this.event=t,this.events={body:["click","touchstart","mouseover","mouseup","mousedown","keydown","keyup","paste","copy","cut","drop","dragstart","dragover","dragleave"],doc:["keydown","mousedown","click"],win:["focus"],frame:["click"],layout:["focus"]}},start(){this._buildTargetEvents(this.app.getFrameBody(),this.events.body,""),this._buildTargetEvents(this.app.getWin(),this.events.win,"win"),this._buildTargetEvents(this.app.getFrameDoc(),this.events.frame,"frame"),this._buildTargetEvents(this.app.$doc,this.events.doc,"doc"),this._buildTargetEvents(this.app.editor.getLayout(),this.events.layout,"layout")},stop(){this.app.getFrameBody().off("."+this.event.eventname),this.app.getWin().off("."+this.event.eventname),this.app.getFrameDoc().off("."+this.event.eventname),this.app.$doc.off("."+this.event.eventname),this.app.editor.getLayout().off("."+this.event.eventname)},onlayoutfocus(t){this.event.isTabFocus&&!this.app.editor.hasFocus()&&(this.app.editor.setFocus("start"),this.event.isTabFocus=!1)},onclick(t){this.event._ondocclick(t),this.event._onclick(t)},ontouchstart(t){return this.event._ontouchstart(t)},onmouseover(t){return this.event._onmouseover(t)},onmouseup(t){return this.event._onmouseup(t)},onmousedown(t){return this.event._onmousedown(t)},onkeydown(t){if(!this.event._checkPanelKeys(t))return this.event._onkeydown(t,!0)},onkeyup(t){return this.event._onkeyup(t)},onpaste(t){return this.event._onpaste(t)},oncopy(t){return this.event._oncopy(t)},oncut(t){return this.event._oncut(t)},ondrop(t){return this.event._ondrop(t)},ondragstart(t){return this.event._ondragstart(t)},ondragover(t){return this.event._ondragover(t)},ondragleave(t){return this.event._ondragleave(t)},ondockeydown(t){!this.event.trigger||this.app.block.isTool()||(this.app.broadcast("editor.before.keydown",{e:t}),this.event._checkTabFocus(t),this.event._checkPopupsOpen(t),this.event._checkPanelKeys(t))||this.event._checkModalEnter(t)},ondocmousedown(t){return this.event._ondocmousedown(t)},ondocclick(t){return this.event._ondocclick(t)},onwinfocus(t){return this.event._onwinfocus(t)},onframeclick(t){this.event.trigger&&"HTML"===t.target.tagName&&this.event._setBlockByClick(t)},_buildTargetEvents(t,e,s){for(var i=0;i<e.length;i++)t.on(e[i]+"."+this.event.eventname,this["on"+s+e[i]].bind(this))}});class c{constructor(t,e){this.button=t,this.app=t.app,this.obj=e||{}}has(t){return Object.hasOwn(this.obj,t)}dump(){return this.obj}update(t){this.obj=t}get(t){return!!this.has(t)&&this.obj[t]}}class u{constructor(t){this.button=t,this.app=t.app,this.props=t.props}checkPermissions(){var t=this.app.block.get();return!(t&&!t.isAllowedButton(this.button.name,this.props.dump()))}checkObserve(){if(this.props.has("observer")){var t=this.fetchUpdatedObject();if(!t)return!1;this.props.update(t)}return!0}observe(){this.checkObserve()&&this.button.builder.update()}fetchUpdatedObject(){var t=this.app.api(this.props.get("observer"),this.props.dump(),this.button.name,this.button.type);return t||!1}}class g{constructor(t){this.button=t,this.app=t.app,this.lang=t.lang,this.dom=t.dom,this.opts=t.opts,this.props=t.props,this.initializeElements()}setTitle(t){t=this.lang.parse(t),this.$title.html(t),this.$button.attr({"aria-label":t,"data-tooltip":t})}setIcon(t){t.startsWith("<")?this.$icon.html(t):(t=this.opts.get("buttonsObj")[t])&&(t=this.getIconCode(t.icon),this.$icon.html(t))}initializeElements(){this.$button=this.dom("<a>").addClass("rx-button"),this.$icon=this.dom("<span>").addClass("rx-button-icon"),this.$title=this.dom("<span>").addClass("rx-button-title"),this.$button.append(this.$icon),this.$button.append(this.$title),this.button.$button=this.$button,this.button.$icon=this.$icon,this.button.$title=this.$title}build(){this.buildToolbarType(),this.configureButton(),this.configureIcon(),this.configureTitle(),this.configureData(),this.configureTooltip(),this.buildPosition(),this.button.state.build()}buildToolbarType(){"toolbar"===this.button.type||"extrabar"===this.button.type?this.toolbarType="toolbar":"dropdown"===this.button.type?this.toolbarType=!1:this.toolbarType=this.button.type}configureHtmlButton(){this.title=this.button.name,this.$button=this.dom("<div>"),this.$button.html(this.props.get("html")),this.renderClassname(this.props.get("classname"))}configureButton(){if(this.props.has("html"))return this.configureHtmlButton();this.$button.attr({href:"#",role:"button",tabindex:-1}),this.$button.dataset("instance",this.button),this.props.has("text")&&this.$button.addClass("rx-button-text"),this.props.has("danger")&&this.$button.addClass("rx-button-danger"),this.button.type&&this.$button.addClass("rx-button-"+this.button.type),this.renderClassname(this.props.get("classname"))}configureIcon(){let t=this.props.has("icon")?this.getIconCode(this.props.get("icon")):"";t=t||"",this.$icon.html(t)}configureTitle(){this.renderTitle(this.props.get("title"))}configureTooltip(){this.props.has("tooltip")&&!this.props.get("tooltip")||this.props.has("text")||-1===["control","dropdown","addbar","formatbar","inlinebar"].indexOf(this.button.type)&&(this.tooltip=this.app.create("tooltip",this.$button,this.title))}configureData(){this.$button.attr({"data-name":this.button.name,"data-toolbar":this.toolbarType}),this.renderCommand(this.props.get("command"))}buildPosition(){var t;this.button.$container&&(t=this.props.dump()["position"],this.props.has("position")?this.positionButton(t):this.button.$container.append(this.$button))}positionButton(t){var e=Object.hasOwn(t,"after")?"after":"before",s=Object.hasOwn(t,"first"),i=t[e];"first"===t?this.button.$container.prepend(this.$button):"last"===t?this.button.$container.append(this.$button):"object"!=typeof t||0<this.findPosition(this.button.name).length||((t=this.findPosition(i))?t[e](this.$button):this.button.$container[s?"prepend":"append"](this.$button))}findPosition(t){return(Array.isArray(t)?t:[t]).map(t=>this.button.$container.find(`[data-name="${t}"]`)).find(t=>t.length)||!1}update(){this.renderTitle(this.props.get("title")),this.renderClassname(this.props.get("classname")),this.renderCommand(this.props.get("command")),this.renderIcon(this.props.get("icon"))}renderTitle(t){this.title=void 0!==t?this.lang.parse(t):"",this.$title.html(this.title),this.$button.attr({"data-tooltip":this.title,"aria-label":this.title}),this.button.title=this.title}renderClassname(t){t&&this.$button.addClass(t)}renderCommand(t){this.$button.attr("data-command",t||!1);t=t?"catch":"stop";this.$button.off(".rx-button"),this.$button.on("click.rx-button",this.button.command[t].bind(this.button.command)),this.$button.on("dragstart.rx-button",t=>t.preventDefault())}renderIcon(t){(t=t&&this.getIconCode(t))&&this.$icon.html(t)}getIconCode(t){return t=this.opts.is("buttons.icons")&&this.opts.is("buttons.icons."+this.button.name)?this.opts.get("buttons.icons."+this.button.name):t}}class m{constructor(t){this.button=t,this.dom=t.dom,this.app=t.app}setCommand(t){this.button.builder.renderCommand(t)}getCommand(){return this.button.$button.attr("data-command")}trigger(t,e){this.preventActions(t),this.app.editor.setFocus(),this.button.$button.hasClass("rx-in-dropdown")?this.catchDropdownClose():this.catchCommand(t,this.button.$button,e)}stop(t){this.preventActions(t)}catch(t){this.preventActions(t);var e=this.dom(t.target).closest(".rx-button");e.hasClass("disable")||(this.app.editor.setFocus(),e.hasClass("rx-in-dropdown")?this.catchDropdownClose(t):this.catchCommand(t,e))}catchDropdownClose(){this.app.dropdown.close(),this.app.ui.closeTooltip()}catchCommand(t,e,s){var i=e.attr("data-command"),a=e.attr("data-name"),e=e.dataget("instance"),r=this.button.getParams(),s=s||this.button.getToolbarType();s&&this.app.ui.setState({button:this.button,type:s}),this.app.api(i,r,e,a,t),this.app.ui.closeTooltip()}preventActions(t){t.preventDefault(),t.stopPropagation()}}class b{constructor(t){this.button=t,this.props=t.props,this.activeClass="active",this.disableClass="disable",this.toggledClass="toggled"}build(){this.props.get("active")&&this.button.$button.addClass(this.activeClass)}setToggled(){this.updateState([this.disableClass],[this.toggledClass])}setActive(){this.updateState([this.disableClass],[this.activeClass])}unsetToggled(){this.button.$button.removeClass(this.toggledClass)}unsetActive(){this.button.$button.removeClass(this.activeClass)}disable(){this.updateState([this.toggledClass,this.activeClass],[this.disableClass])}enable(){this.button.$button.removeClass(this.disableClass)}updateState(t,e){this.button.$button.removeClass(t.join(" ")).addClass(e.join(" "))}}class f{constructor(t){this.button=t,this.app=t.app}setColor(t){this.getSvg().attr("fill",t)}setBackground(t){var e=this.app.create("utils").getInvertedColor(t);this.button.$button.addClass("rx-button-icon-color"),this.button.$icon.css({"background-color":t}),this.getSvg().attr("fill",e)}resetColor(){this.getSvg().removeAttr("fill")}resetBackground(){this.button.$button.removeClass("rx-button-icon-color"),this.resetIconStyle()}resetIconStyle(){this.button.$icon.css("background-color",""),this.getSvg().removeAttr("fill")}getSvg(){return this.button.$icon.find("svg path")}}d.add("module","container",{init(){this.containers={},this.targets={},this.blur="rx-in-blur",this.focus="rx-in-focus"},start(){this.$container=this._createMain(),this._buildBSModal(),this._build(this.$container,this.opts.get("containers.main")),this._buildExternal("toolbox"),this._buildExternal("statusbar")},stop(){this.app.editor.destroy();for(var[t,e]of Object.entries(this.containers))e.remove();this.$container.remove(),this.containers={},this.targets={}},get(t){return"main"===t?this.$container:this.containers[t]},toggle(){this._focusExternal("toolbox"),this._focusExternal("statusbar")},setFocus(){this.$container.removeClass(this.blur).addClass(this.focus)},setBlur(){this.$container.removeClass(this.focus).addClass(this.blur)},hasFocus(){return this.$container.hasClass(this.focus)},isExternal(t){return this.targets[t]},_build(t,e){let s,i=0,a;for(i=0,a=e.length;i<a;i++)s=e[i],this.containers[s]=this._createContainer(s,t),this._buildNested(s,this.containers[s])},_buildNested(t,e){t=this.opts.get("containers."+t);t&&this._build(e,t)},_buildExternal(t){this.opts.is("toolbar.sharedTarget")&&((t=this.app.$body.find(".rx-"+t+"-external")).css("display","none"),t.last().css("display",""))},_buildBSModal(){this.opts.set("bsmodal",0!==this.$container.closest(".modal-dialog").length)},_buildTarget(t){return t?this.dom(t):this.$container},_focusExternal(t){this.opts.is("toolbar.sharedTarget")&&(this.app.$body.find(".rx-"+t+"-external").css("display","none"),this.app.$body.find(".rx-"+t+"-external.rx-"+t+"-container-"+this.uuid).css("display",""))},_createMain(){var t=this.dom("<div>").attr("rx-uuid",this.uuid).addClass("rx-container rx-container-"+this.uuid);return this.opts.is("nocontainer")||t.addClass("rx-main-container"),this.app.element.after(t),t},_createContainer(t,e){var s="toolbox"===t?this.opts.get("toolbar.target"):this.opts.get(t+".target"),s=((s="toolbar"!==t&&s)&&(e=this.targets[t]=s),this.dom("<div>").addClass("rx-"+t+"-container rx-"+t+"-container-"+this.uuid)),e=this._buildTarget(e);return this.isExternal(t)&&s.addClass("rx-"+t+"-external"),e.append(s),s}}),d.add("module","source",{init(){this.eventname="rx-source-events"},start(){this._build()},setContent(t){this.$source.val(t)},getContent(){var t=this.$source.val();return this.app.codemirror.val(t)},getElement(){return this.$source},getSource(){return this.$source},update(t){this.app.editor.setSource(t)},is(){var t=this.app.container.get("source");return!(!t||0===t.length)&&"none"!==t.css("display")},toggle(){this.is()?this.close():this.open()},open(){var t=this.app.container.get("editor"),e=this.app.container.get("source"),s=this.app.create("tidy"),i=(this.app.broadcast("source.before.open"),this.app.editor.getContent()),i=s.parse(i),s=(this.$source.val(i),this.$source.on("focus."+this.eventname,this._handleFocus.bind(this)),this.$source.on("input."+this.eventname,this._handleChanges.bind(this)),this.$source.on("keydown."+this.eventname,this.app.input.handleTextareaTab.bind(this)),this.app.blocks.unset(),this.app.block.unset(),this.app.editor.unsetSelectAll(),t.hide(),e.show(),this.$source.get().scrollHeight),i=parseInt(this.opts.get("minHeight")),s=s<i?i:s,e=(this.$source.css("height","auto"),this.$source.css("height",s+"px"),t.height()),s=this.app.codemirror.create({el:this.$source,height:e=e<i?i:e,focus:!0});s&&(s.on("change",this._handleChanges.bind(this)),s.on("focus",this._handleFocus.bind(this))),this.app.ui.close(),this.app.ui.disable(),this.app.toolbar.enableSticky(),this.app.toolbar.setToggled("html"),this.app.extrabar.setToggled("html"),this.app.broadcast("source.open")},close(){var t,e,s;this.is()&&(this.app.broadcast("source.before.close"),t=this.app.container.get("editor"),e=this.app.container.get("source"),s=this.getContent(),this.app.codemirror.destroy(),e.hide(),t.show(),this.app.editor.setContent({html:s,caret:"start"}),this.app.ui.enable(),this.app.toolbar.unsetToggled("html"),this.app.extrabar.unsetToggled("html"),this.app.broadcast("source.close"))},_build(){this.$source=this.dom("<textarea>"),this.$source.addClass("rx-source"),this.$source.attr("data-gramm_editor",!1),this.app.container.get("source").append(this.$source)},_handleFocus(){this.app.editor.setFocus()},_handleChanges(t){var e=this.getContent();this.update(e),this.$source.css("height",this.$source.get().scrollHeight+"px"),this.app.broadcast("source.change",{e:t})}}),d.add("module","editor",{init(){this.savedSelection=!1,this.savedInline=!1,this.rawhtml=""},start(){var t=this.app.isMode("default")?"":"-"+this.app.getMode();this.editorClass=this.app.create("editor"+t,this),this.inputComposition=this.dom('<input type="text" id="rxCompositionCutter'+this.uuid+'" style="position: fixed; z-index: -1000; width: 1px; height: 1px;" />'),this.app.isMode("default")?this.app.element.after(this.inputComposition):this.app.getFrameBody().append(this.inputComposition)},stop(){this.$overlay&&this.$overlay.remove(),this.inputComposition.remove(),this.app.element.isTextarea()||(this.$editor.removeClass("rx-editor rx-empty rx-editor-breakline "+this.opts.get("classname")),this.$editor.removeAttr("style dir"),this.savedStyles&&this.$editor.attr("style",this.savedStyles),this.savedDir&&this.$editor.attr("dir",this.savedDir),this.$editor.html(this.getContent()))},load(){!this.app.isMode("iframe")&&this.opts.is("focus")&&this.setFocus(this.opts.get("focus"))},click(){let t=this.app.create("selection").getBlockControlled();setTimeout(function(){this.app.block.set(t)}.bind(this),1)},readonly(){this.app.event.pause(),this.$editor.addClass("rx-editor-readonly"),this.getLayout().attr("contenteditable",!1),this.getLayout().find("[contenteditable=true]").each(t=>{t.attr("rx-readonly",!0),t.attr("contenteditable",!1)})},disable(){this.$editor.addClass("rx-editor-disabled"),this.$overlay=this.dom("<div>").addClass("rx-editor-overlay"),this.app.container.get("main").append(this.$overlay)},editable(){this.$editor.removeClass("rx-editor-readonly"),this.getLayout().attr("contenteditable",!0),this.getLayout().find("[rx-readonly=true]").each(t=>{t.removeAttr("rx-readonly"),t.attr("contenteditable",!0)}),this.app.event.run()},enable(){this.$editor.removeClass("rx-editor-disabled"),this.$overlay.remove()},destroy(){this.app.element.isTextarea()||(this.$editor.removeClass("rx-editor rx-editor-"+this.uuid+" rx-empty rx-editor-breakline rx-editor-disabled rx-placeholder"),this.$editor.removeAttr("contenteditable data-gramm_editor"),this.app.container.get("main").before(this.$editor),this.a11y.destroy())},build(){var t=this.app.create("predefined");this.app.blocks.build(),this.app.embed.build(),this.app.image.observeStates(),t.parse(this.$editor),this.app.observer.observe()},save(t){var e,s=this.app.create("offset");!1!==t&&(t=(e=this.app.block.get())&&!this.app.blocks.is()?e.getBlock():this.getLayout()),this.savedSelection={el:t,offset:s.get(t)}},saveInline(t){this.savedInline=t},restore(t){var e,s;this.savedSelection&&(this.setWinFocus(),e=this.app.create("offset"),s=this.app.create("caret"),this.savedInline?(this.savedInline.innerHTML="",s.set(this.savedInline,"start")):(s=this.savedSelection.el,this.dom(s).dataget("instance")&&!1!==t&&this.app.block.set(s),s&&this.savedSelection.offset&&s.focus(),this.savedSelection.offset&&e.set(this.savedSelection.offset,s)),this.savedSelection=!1,this.savedInline=!1)},hasFocus(){return this.app.container.hasFocus()},unsetSelectAll(){this.isSelectAll()&&(this.$editor.removeClass("rx-select-all"),this.app.block.unset(),this.app.blocks.unset(),this.app.broadcast("editor.unselect"))},getLayout(){return this.app.isMode("iframe")?this.$layout:this.$editor},getEditor(){return this.$editor},getRect(){var t=this.$editor.offset(),e=this.$editor.width(),s=this.$editor.height(),i=Math.round(t.top),t=Math.round(t.left);return{top:i,left:t,bottom:i+s,right:t+e,width:e,height:s}},getWidth(){return this.$editor.width()},getHtml(){return this.getLayout().html()},getEmail(t){return this.app.has("email")?this.app.email.getEmail(t):this.getContent()},getContent(t){return this.content.getContent(t)},getJson(){let t={};return this.app.has("email")?t=this.app.email.getJson():(t=this.getSourceJson()||{}).blocks=this.content.getJson(),t},getSourceJson(){return this.opts.get("data")},getSource(){return this.$source.val()},getRawHtml(){return this.rawhtml},getContentType(){return this.content.getType()},setContent(t){this.app.has("email")?this.app.email.setContent(t):this.app.create("insertion").set(t)},setJson(t){this.opts.set("data",t),this.app.has("email")?this.app.email.setJson(t):(this.content.set(t,"json"),this.build())},setHtml(t){this.getLayout().html(t)},setEmpty(){var t=this.app.block.create();this.app.create("insertion").setEmpty(),this.getLayout().append(t.getBlock()),this.build(),this.setFocus("end"),this.app.broadcast("editor.empty")},setFocus(t){var e;t?(e="start"===(t=!0===t?"start":t)?this.app.blocks.get({first:!0}):this.app.blocks.get({last:!0}),this.app.block.set(e,t),this.app.container.setFocus()):this.hasFocus()||(this.setBlurOther(),this.app.container.setFocus(),this.app.container.toggle(),this.app.broadcast("editor.focus"))},setBlurOther(){var e=d.instances.length;for(let t=0;t<e;t++)d.instances[t]!==this.app&&d.instances[t].editor&&d.instances[t].editor.setBlur()},setBlur(t){var e,s;this.hasFocus()&&this.$editor&&(e=this.app.broadcast("editor.before.blur",{e:t}),s=this.app.create("selection"),e.isStopped()?t&&t.preventDefault():(this.app.container.setBlur(),s.remove(),this.app.source.is()||(this.app.block.unset(),this.app.blocks.unset(),this.app.ui.close(),this.app.path.build(),this.app.ui.unset()),this.app.broadcast("editor.blur",{e:t})))},setSelectAll(t,e){var s;this.isSelectAll()||(s=this.app.create("selection"),this.$editor.addClass("rx-select-all"),t=t||this.app.blocks.get({firstLevel:!0}),this.app.block.unset(),this.app.blocks.set(t),s.select(this.getLayout()),!1!==e&&this.app.broadcast("editor.select"))},setSource(t){this.$source.val(t)},setOutput(t){var e;this.opts.is("output")&&(e=this.opts.get("output"),e=this.dom(e),["textarea","input"].includes(e.tagName())?e.val(t):e.html(t))},setWinFocus(){this.app.isMode("iframe")&&this.app.getWin().focus()},insertContent(t){this.app.create("insertion").insert(t)},isSelectAll(){return this.$editor.hasClass("rx-select-all")},isEmpty(){var t=this.app.create("utils"),e=this.getLayout().html();return t.isEmptyHtml(e,!0)},isEditor(t){return this.dom(t).get()===this.getLayout().get()},adjustHeight(){this.app.isMode("iframe")&&this.$editor&&!this.app.isStopped()&&setTimeout(function(){this.$editor.height(this.app.getFrameBody().height())}.bind(this),1)},_buildContent(){this.rawhtml=this.app.element.getHtml().trim(),this.content=this.app.create("content")},_buildBlurClass(){this.opts.get("clicktoedit")?this.app.container.setFocus():this.app.container.setBlur()},_buildAccessibility(){this.a11y=this.app.create("accessibility",this)},_buildEditable(){this.getLayout().attr("contenteditable",!0)},_buildDraggable(){this.app.$body.find("[data-rx-drop-id]").each(function(t){t.attr("draggable",!0),t.on("dragstart",function(t){var e=this.dom(t.target).attr("data-rx-drop-id");t.dataTransfer.setData("item",e)}.bind(this))}.bind(this))}}),d.add("module","theme",{init(){this.dataAttr="rx-data-theme"},start(){this._build()},stop(){this.app.container.get("main").removeAttr(this.dataAttr)},destroy(){this._mediaQuery().removeEventListener("change",this._change.bind(this))},set(t){this.app.container.get("main").attr(this.dataAttr,t),this.app.ui.updateTheme(t),this.app.broadcast("editor.theme",t)},get(){return this.app.container.get("main").attr(this.dataAttr)},_detect(){let t="light";if(localStorage.getItem("theme")&&"dark"===localStorage.getItem("theme"))t="dark";else{if(!window.matchMedia)return t;window.matchMedia("(prefers-color-scheme: dark)").matches&&(t="dark")}return t},_change(){var t=this._detect();this.set(t)},_build(){let t=this._detect(),e=this.opts.get("theme");this.opts.set("globalTheme",t),"auto"==e?this._mediaQuery().addEventListener("change",this._change.bind(this)):t=e,this.set(t)},_mediaQuery(){return window.matchMedia("(prefers-color-scheme: dark)")}}),d.add("module","addbar",{init(){this.customButtons={},this.removeButtons=[]},add(t,e){this.customButtons[t]=e,this.app.ui.registerButton(t,e)},remove(e){if(Array.isArray(e))for(let t=0;t<e.length;t++)this.removeButtons.push(e[t]);else this.removeButtons.push(e)},getItems(){var t,e,s=[...this.opts.get("popups.addbar")],i=this.opts.get("addbarItems")||{},i=d.extend(!0,{},i,this.customButtons),s=this.app.ui.loadButtons(s,i,"addbar",!1,this.removeButtons),a=["text","address","list","todo","quote","dlist"];for([t,e]of Object.entries(s))-1!==a.indexOf(t)&&e.setCommand("block.add");return s},popup(t,e){var s=[...this.opts.get("popups.addbar")],i=this.opts.get("addbarItems")||{},a=this.opts.get("addbar.hide")||[],i=(this.customButtons=d.extend(!0,{},i,this.customButtons),[...this.removeButtons,...a]);this.app.dropdown.create("addbar",{items:s,extend:this.customButtons,remove:i,type:"addbar"}),this.app.dropdown.open(t,e)}}),d.add("module","block",{init(){this.instance=!1,this.$block=!1,this.tool=!1},create(t){var e=this.app.create("block.text");return t&&e.getBlock().html(t),e},createHtml(t){return this.create(t).getOuterHtml()},trigger(t){this.is()&&this.instance.getPlaceholder()&&(this.instance.isEditable()&&this.instance.isEmpty(!1,!0)&&this.instance.setEmpty(!0),"childlist"!==t.type&&"characterData"!==t.type||this.instance.trigger(t))},isTool(){return this.tool},setTool(t){this.tool=t,this.app.observer.trigger=!t,"string"!=typeof t&&!0!==t||this.unset()},is(t){return t?this._isBlockActive(t):this.get()},setParent(s){if(this.is()){this.app.dropdown.close(),this.app.modal.close();let t,e="force";s&&s.cell?t=this.instance.getClosest("cell"):s&&s.column?(t=this.instance.getClosest("column"),e="column"):t=this.instance.getClosest(["list","wrapper","layout","todo","table"]),t&&this.set(t,e)}},set(t,e,s){if(t&&(!0===s||!this._isBlockActive(t))&&(this.app.editor.unsetSelectAll(),this.app.blocks.unset(),this.unset(),this.instance=this._getInstance(t),this.instance)){if(this.instance.isType("noneditable")&&!this.opts.is("noneditable.select"))return this.instance=!1;this.instance.isType("column")&&"column"!==e?(this.instance=this.instance.getFirstBlockInstance(),e="start"):this.instance.isParent()&&(this.instance=this.instance.getParent()),this.$block=this.instance.getBlock(),this.$block.addClass("rx-block-focus"),this.opts.is("block.outline")&&this.opts.is("control")&&!this.instance.isFocusable()&&this.instance.getControl()&&this.$block.addClass("rx-block-control-focus"),this._setCaret(e),this.app.toolbar.build(),this.app.extrabar.build(),this.app.control.build(),this.app.path.build(),this.app.broadcast("block.set",{instance:this.instance})}},setData(t){this.instance&&this.instance.setData(t)},unset(){this.instance&&(this.$block&&this.$block.removeClass("rx-block-focus rx-block-control-focus"),this.instance=!1,this.$block=!1,this.setTool(!1),this.app.control.close(),this.app.context.close(),this.app.path.build(),this.app.broadcast("block.unset"))},get(){return this.instance},getData(){return this.instance?this.instance.getData():null},unwrap(){if(this.is()&&this.instance.isType(["layout","wrapper"])){this.app.dropdown.close();var e=this.instance.getType(),s=this.instance.getBlock();let t=s.children().first();"wrapper"===e?s.unwrap():"layout"===e&&(t=t.children().first(),s.find("[data-rx-type=column]").unwrap(),s.unwrap()),this.set(t,"start"),this.app.editor.build(),this.app.broadcast("block.unwrap",{type:e})}},remove(t){var e,s;this.is()&&(this.app.dropdown.close(),this.app.modal.close(),e=this.instance.getType(),t=d.extend({},{traverse:!0},t),s="image"===e?this._getDataImage():{},t.traverse?this.instance.remove({traverse:!0}):(this.instance.remove(),this.unset()),"image"===e&&(this.app.image.setImageState(this.instance,s,!1),this.app.broadcast("image.remove",s)),this.app.broadcast("block.remove",{type:e}),this.app.editor.isEmpty())&&this.app.editor.setEmpty()},change(t,e){this.is()&&this.instance.change(t,e)},insert(t){if(this.is())return this.instance.insert(t)},add(t,e,s){this.app.dropdown.close(),this.app.modal.close();var i=this.app.create("insertion"),e=e.getTemplate();let a,r;return r=e?i.insert({html:e,position:"after"}):(a=this.app.create("block."+s),i.insert({instance:a,position:"after",type:"add"})),this.app.broadcast("block.add",{inserted:r}),r},duplicate(){var t;if(this.is())return this.app.dropdown.close(),this.app.modal.close(),t=this.instance.duplicate(),t=this.instance.insert({instance:t,position:"after",caret:"start",type:"duplicate"}),this.app.broadcast("block.duplicate",{instance:t}),t},moveUp(){this.is()&&this.instance.move("up")},moveDown(){this.is()&&this.instance.move("down")},_getInstance(t){return t&&t.app?t:this.dom(t).dataget("instance")},_getDataImage(){return{url:this.instance.getSrc(),id:this.instance.getId(),uid:this.instance.getDataImage()}},_isBlockActive(t){return this.instance&&this.dom(t).get()===this.$block.get()},_setCaret(t){let e=["embed","image","line","noneditable"];var s=["todo","list"],i=this.app.create("utils"),a=this.instance.getType();"force"===t&&(e=i.extendArray(e,["layout","wrapper","table","cell"])),"column"===t||-1!==e.indexOf(a)||this.instance.isInline()&&!this.instance.isEditable()||!t&&-1!==s.indexOf(a)||"force"===t&&-1!==s.indexOf(a)?this._setFocus():t&&"force"!==t&&this.instance.setCaret(t)},_setFocus(){let t=this.app.create("selection");this.app.scroll.save(),this.$block.attr("tabindex","-1"),this.$block.focus(),t.collapse(),setTimeout(function(){t.remove()},1),this.app.scroll.restore()}}),d.add("module","blocks",{init(){this.selected=[],this.focusClass="rx-block-meta-focus"},build(){var t="data-rx-first-level",e=this.app.editor.getLayout();e.find("["+t+"]").removeAttr(t),e.children("[data-rx-type]").attr(t,!0)},trigger(e){!this.is()||"childlist"!==e.type&&"characterData"!==e.type||this.get({selected:!0,instances:!0}).forEach(function(t){t.trigger(e)})},is(){return 0<this.selected.length},set(t){this.unset(),this.selected=Array.isArray(t)?t:t.getAll();let s;this.selected.forEach(function(t,e){(s=this.dom(t)).addClass(this.focusClass)}.bind(this)),this.app.path.build()},setInstances(t){this.unset();let e=[],s;t.forEach(function(t){(s=t.getBlock()).addClass(this.focusClass),e.push(s)}.bind(this)),this.selected=e,this.app.path.build()},unset(){this.selected=[],this.app.editor.getLayout().find("."+this.focusClass).removeClass(this.focusClass),this.app.block.setTool(!1)},has(t){return 0!==this.count(t)},count(t){return this.get(t).length},get(t){let e=this.app.editor.getLayout().find("[data-rx-type]"),s=[];return t&&(t.selected&&(e=e.filter("."+this.focusClass)),t.firstLevel&&(e=e.filter("[data-rx-first-level]")),!1===t.firstLevel&&(e=e.not("[data-rx-first-level]")),t.type&&(e=e.filter(this._getTypesSelector(t.type))),t.editable&&(e=e.filter("[contenteditable=true]")),t.except&&(e=e.not(this._getTypesSelector(t.except))),t.first&&(e=e.first()),t.last)&&(e=e.last()),t&&t.instances?(e.each(function(t){s.push(t.dataget("instance"))}),t.first||t.last?s[0]:s):e},removeAll(){if(this.app.editor.isSelectAll())return this._removeAllSelected(),this.get({first:!0});this.get({selected:!0}).each(function(t){t.closest("[data-rx-first-level]").remove()})},remove(a){if(this.app.editor.isSelectAll())this._removeAllSelected();else{let t=this.get({selected:!0}),e,s=t.last(),i=this._getNextElement(s);(e=t.getAll().reverse()).forEach(this._removeSelected.bind(this)),(e=this.get({selected:!0,type:["cell","column"],instances:!0})).forEach(this._fillEmptyBlocks.bind(this)),a&&0!==i.length?this.app.block.set(i,"start"):this.app.context.close()}},_removeAllSelected(){this.app.editor.setEmpty(),this.app.editor.unsetSelectAll(),this.app.editor.setFocus("start")},_removeSelected(t){let e=this.dom(t),s=e.dataget("instance"),i=s.getType(),a=(s.isParent(),"noneditable"===i&&!this.opts.is("noneditable.remove")),r=!1;a?r=!1:-1===["cell","row","column","figcaption"].indexOf(i)&&(-1===["wrapper","layout","table","todo","list"].indexOf(i)||"table"===i&&this._isTableSelected(e)||-1!==["todo","list","wrapper"].indexOf(i)&&s.isEmpty(!0)||"layout"===i&&this._isLayoutSelected(e,s))&&(r=!0),r&&s.remove({traverse:!1})},_fillEmptyBlocks(t){var e;t.isEmpty()&&(e=this.app.block.create(),t.getBlock().append(e.getBlock()))},_getTypesSelector(t){return Array.isArray(t)?"[data-rx-type="+t.join("],[data-rx-type=")+"]":"[data-rx-type="+t+"]"},_getNextElement(t){let e=t.nextElement(),s=t.dataget("instance"),i=s.getType(),a=s.getClosest(["cell","column"]);return-1!==["todoitem","listitem"].indexOf(i)&&s.isLastElement()?e=s.getParent().getBlock().nextElement():a&&a.isLastElement()&&(e=a.getParent().getBlock().nextElement()),e},_isLayoutSelected(t,e){let s=e.getColumns(),i=s.length,a=0;return s.forEach(function(t){t.getBlock().hasClass(this.focusClass)&&t.isEmpty()&&a++}.bind(this)),i===a},_isTableSelected(t){t=t.find("tr");return t.length===t.filter("."+this.focusClass).length}}),d.add("module","context",{init(){this.eventName="rx-context",this.instance=!1,this.line=!1},start(){var t;this.isEnabled()&&(t=this.app.ui.build("context",this.app.$body),this.$context=t.getElement(),this.$contextLine=t.getElementLine(),this.$contextButtons=this.app.ui.getContainer("context"),this.$context.hide())},stop(){this.isEnabled()&&(this.$context.remove(),this.app.scroll.getTarget().off("."+this.eventName))},remove(t){this.app.ui.removeButton("context",t)},addLine(t){this.line=t},add(t,e,s){this.app.ui.addButton("context",t,e,s)},unsetActive(t){this.app.ui.unsetActive("context",t)},unsetToggled(t,e){this.app.ui.unsetToggled("context",t,e)},getButton(t){return this.app.ui.getButton("context",t)},getElement(){return this.$context},getInstance(){return this.instance},isOpen(){if(this.isEnabled())return this.$context.hasClass("open")},isEnabled(){return this.opts.is("context")},close(){this._close()},open(t){var e,s,i,a;this.line=!1,this.isEnabled()&&!this.app.block.isTool()&&(this.opts.is("context.click")?this._open(t):(e=this.app.create("selection"),s=this.app.create("element"),i=!t||this._getBlockSelection(t),a=this._getInlineSelection(t),e.is()&&t&&s.isTool(t.target)?this.app.block.setTool(!0):i&&e.is()&&!e.isCollapsed()?this._open(t):a&&0!==a.length?(this.instance=a.dataget("instance"),this.instance.isContext()&&this._open(t)):this._close()))},updateEvents(){this.isEnabled()&&(this.app.scroll.getTarget().off("."+this.eventName),this.app.editor.getEditor().off("."+this.eventname),this._buildEvents())},updatePosition(t){if(this.isEnabled()&&!this.app.modal.isOpen()){var a,r,o=this.$context.width(),n=this.app.editor.getRect(),l=this.app.getDoc().scrollTop(),h=this.app.create("selection").getPosition("end");let t=0,e=0,s=(this.app.isMode("iframe")&&(a=this.app.editor.getRect(),t=a.top,e=a.left),h.left+e+2),i=h.bottom+t+l;this.app.blocks.is()&&0===h.left&&0===h.top&&(r=(a=this.app.blocks.get({last:!0,selected:!0,instances:!0})).getOffset(),s=r.left+e+2,i=r.top+a.getBlock().height()),this.app.editor.isSelectAll()&&(a=(r=this.app.blocks.get({last:!0})).offset(),s=a.left+e+2,i=a.top+t+r.height()+l),s+o>n.right&&(s=h.left+e-o-2),h.left-e==0&&h.right-t==0&&this.instance&&(a=this.instance.getOffset(),r=this.instance.getBlock().height(),s=a.left,i=a.top+r),this.app.ui.buildDepth("context",this.$context),this.$context.css({left:s+"px",top:i+2+"px"}),this.$context.attr({dir:this.opts.get("dir"),"rx-data-theme":this.app.theme.get()})}},_open(t){this.$contextLine.html("").hide(),this.instance&&this.$contextButtons.html(""),this.app.ui.buildButtons("context",this.instance),""===this.$contextButtons.html()&&(this.instance=!1),this.line&&this.$contextLine.html(this.line).show(),this._buildPosition(t),this._buildEvents(),this.app.modal.close(t),this.app.broadcast("context.open")},_close(){this.isEnabled()&&this.$context.hasClass("open")&&(this.$context.hide().removeClass("open"),this.instance=!1,this.app.scroll.getTarget().off("."+this.eventname),this.app.editor.getEditor().off("."+this.eventname),this.app.broadcast("context.close"))},_getBlockSelection(t){return 0===this.dom(t.target).closest("[data-rx-inline], [data-rx-type=noneditable], [data-rx-type=figcaption]").length},_getInlineSelection(t){return!!t&&this.dom(t.target).closest("[data-rx-inline]")},_buildPosition(t){this.$context.addClass("open"),this.updatePosition(t),this.$context.show()},_buildEvents(){var t=this.app.scroll.getTarget();this.app.scroll.isTarget()&&t.on("scroll."+this.eventname,this._scroll.bind(this)),t.on("resize."+this.eventName,this.updatePosition.bind(this)),this.app.editor.getEditor().on("scroll."+this.eventname,this._scroll.bind(this))},_scroll(){const s=()=>{this.app.modal.isOpen()&&this.app.editor.save()};var t=(t,e=0)=>{e=t.offset().top+e;return e+t.height()<a+this.$context.height()||e>a?(this.$context.hide(),!0):this.isOpen()?(this.$context.show(),s(),!1):void 0};this.app.modal.isOpen()&&this.app.editor.restore();var e=this.app.create("selection").getPosition("end"),i=this.app.getDoc().scrollTop();const a=e.bottom+i+2;this.$context.css("top",a+"px");let r=!1;this.app.scroll.isTarget()&&(e=this.app.scroll.getTarget(),r=t(e,20)),this.opts.is("maxHeight")&&!r&&t(this.app.editor.getEditor())},_isInstance(t){var e=this.app.block.get(),s=e&&e.isEditable(),e=e&&"pre"!==e.getType();return s&&e}}),d.add("module","control",{init(){this.eventName="rx-control",this.parentTypes={cell:[{name:"parent",title:"## table.select-table ##"},"cell-setting"],cellParent:[{name:"parent",title:"## table.select-table ##"},{name:"parent",title:"## table.select-cell ##",params:{cell:!0}}],column:[{name:"parent",title:"## layout.select-layout ##"},{name:"parent",title:"## layout.select-column ##",params:{column:!0}}]}},start(){this.isEnabled()&&this._buildToolbar()},stop(){this.isEnabled()&&this._removeControl()},add(t,e){this.app.ui.addButton("control",t,e)},remove(t){this.app.ui.removeButton("control",t)},isEnabled(){return this.opts.is("control")},build(){var t=this.app.block.get();t?this.open(t):this.close()},getButton(t){return this.app.ui.getButton("control",t)},getElement(){return this.$control},trigger(){this.isEnabled()&&this.getButton("toggle").getElement().click()},popup(e,s){if(this._shouldCloseDropdown())this.app.dropdown.close();else{let t=[...this.opts.get("popups.control")];this._getParentElement()&&(t=this._getParentButtons(t));var i=this.app.ui.getButtonsCustom("control"),a=this.app.ui.getButtonsRemove("control");this.app.dropdown.create("control",{items:t,extend:i,remove:a}),this.app.dropdown.open(e,s)}},open(t){this.isEnabled()&&(this.instance=t,this._hasControl()&&(this._setParentInstance(),this.instance)?(this._buildEvents(),this._prepareToOpen(),this._updatePositions(),this._buildReorder()):this.close())},close(){this.isEnabled()&&this.$control&&(this.$control.hide(),this._stopEvents(),this.instance=!1)},updateEvents(){this.isEnabled()&&(this._stopEvents(),this._buildEvents())},updatePosition(){var t,e;this.isEnabled()&&this.instance?({top:t,left:e}=this._calculatePosition(),this.$control.show(),(this._shouldHideForScrollTarget(t)||this._shouldHideForEditor(t))&&this.$control.hide(),this._setPosition(t,e)):this.close()},_calculatePosition(){var t=this.instance.getOffset(),e=this.$control.width(),{topOutlineFix:s,leftOutlineFix:i}=this._getOutlineFixes(),{frameOffsetTop:a,frameOffsetLeft:r}=this._getFrameOffsets(),o=parseInt(this.instance.getBlock().css("margin-left")),i=this._getAdjustedLeftOutlineFix(i,o);return{top:t.top+a-s,left:t.left+r-e-i}},_getOutlineFixes(){var t=parseInt(this.instance.getBlock().css("padding-top"));return{topOutlineFix:this.instance.isType("line")&&0===t?14:5,leftOutlineFix:5}},_getFrameOffsets(){let t=0,e=0;var s;return this.app.isMode("iframe")&&(s=this.app.editor.getRect(),t=s.top,e=s.left),{frameOffsetTop:t,frameOffsetLeft:e}},_getAdjustedLeftOutlineFix(t,e){return e<0?t+e:t},_shouldHideForScrollTarget(t){var e,s,i,a;return!!this.app.scroll.isTarget()&&(e=(a=this.app.scroll.getTarget()).offset().top+a.height(),s=a.offset().top,i=t+this.$control.height(),a=parseInt(a.css("padding-top")),e<i||t<s+a)},_shouldHideForEditor(t){var e,s;return!!this.opts.is("maxHeight")&&(e=(s=this.app.editor.getEditor()).offset().top+s.height(),s=s.offset().top,e<t+this.$control.height()||t<s)},_setPosition(t,e){this.app.ui.buildDepth("control",this.$control),this.$control.css({top:t+"px",left:e+"px"})},_removeControl(){this.$control.remove(),this.app.scroll.getTarget().off("."+this.eventName)},_shouldCloseDropdown(){return this.app.dropdown.isOpen()&&"control"===this.app.dropdown.getName()},_getParentElement(){return this.instance.getClosest(["list","wrapper","layout","todo","table"])},_getParentButtons(t){return this.instance.isType("cell")?t.push(...this.parentTypes.cell):this.instance.getClosest("cell")?t.unshift(...this.parentTypes.cellParent):this.instance.getClosest("column")?t.unshift(...this.parentTypes.column):t.unshift("parent"),t},_setParentInstance(){this.instance.isParent()&&(this.instance=this.instance.getParent())},_prepareToOpen(){this.app.ui.buildButtons("control"),this.$control.attr("rx-data-theme",this.app.theme.get()),this.$control.show()},_hasControl(){return!1!==this.instance.getControl()},_updatePositions(){this.updatePosition(),this.app.dropdown.updatePosition()},_stopEvents(){this.app.scroll.getTarget().off("."+this.eventName),this.app.editor.getEditor().off("."+this.eventName)},_buildReorder(){var t=this.getButton("toggle");this.opts.is("reorder")&&this.instance.isReorder()&&this.app.reorder.build(this,t,this.$control,this.instance)},_buildToolbar(){this.$control=this.app.ui.build("control",this.app.$body).getElement(),this.$control.hide()},_buildEvents(){var t=this.app.scroll.getTarget();t.on("resize."+this.eventName,this.updatePosition.bind(this)),t.on("scroll."+this.eventName,this.updatePosition.bind(this)),this.app.editor.getEditor().on("scroll."+this.eventName,this.updatePosition.bind(this))}}),d.add("module","embed",{modals:{add:{title:"## embed.embed ##",width:"100%",form:{embed:{type:"textarea",label:"## embed.description ##",rows:6},caption:{type:"input",label:"## embed.caption ##"},responsive:{type:"checkbox",text:"## embed.responsive-video ##"}},footer:{insert:{title:"## buttons.insert ##",command:"embed.insert",type:"primary"},cancel:{title:"## buttons.cancel ##",command:"modal.close"}}},edit:{title:"## embed.embed ##",width:"100%",form:{embed:{type:"textarea",label:"## embed.description ##",rows:6},caption:{type:"input",label:"## embed.caption ##"},responsive:{type:"checkbox",text:"## embed.responsive-video ##"}},footer:{save:{title:"## buttons.save ##",command:"embed.save",type:"primary"},cancel:{title:"## buttons.cancel ##",command:"modal.close"},remove:{title:"## buttons.delete ##",command:"embed.remove",type:"danger",right:!0}}}},observe(t,e){var s;return!!this.opts.is("embed")&&((s=this.app.block.get())&&s.isType("embed")&&(t.command="embed.edit"),t)},build(t){t?this._callScripts(t):this._findScripts()},popup(t,e){var s=this.app.create("stack");s.create("embed",this.modals.add),this.app.modal.open({name:"embed",stack:s,title:"Snippets",focus:"embed",button:e}),this.opts.is("embed.responsive")&&s.getInput("responsive").attr("checked",!0),this._buildCodemirror(s)},edit(t,e){var s=this.app.block.get(),s={embed:s.getContent().replace(/(?<=\b\w+="[^"]*)&amp;(?=[^"]*")/g,"&"),caption:s.getCaption(),responsive:s.isResponsive()},i=this.app.create("stack");i.create("embed",this.modals.edit),i.setData(s),this.app.modal.open({button:e,name:"embed",stack:i,focus:"embed"}),this._buildCodemirror(i)},insert(t){this.app.modal.close();var t=t.getData(),e=this._getEmbedCode(t);""!==e&&(t=this._createInstance(t,e),this.app.create("insertion").insert({instance:t}))},save(t){this.app.modal.close();var e=this.app.block.get(),t=t.getData(),s=this._getEmbedCode(t);""===s?this.app.block.remove():(s=this._createInstance(t,s,e),this._isNeedToChange(t,s,e)&&this.app.block.change(s))},remove(){this.app.modal.close(),this.app.block.remove()},_buildCodemirror(t){t=t.getInput("embed");this.app.codemirror.create({el:t,height:"200px",focus:!0}),this.app.modal.updatePosition()},_getEmbedCode(t){var t=t.embed.trim(),e=this.app.create("cleaner"),t=this.app.codemirror.val(t);return t=this._removeScript(t),t=e.sanitize(t),this._isHtmlString(t)||""===t?t:this._parseUrl(t)},_isHtmlString(t){return/^\s*<(\w+|!)[^>]*>/.test(t)},_isFigure(t){return/^<figure/.test(t)},_isNeedToChange(t,e,s){return s.getContent()!==e.getContent()||t.responsive!==s.isResponsive()||t.caption!==s.getCaption()||void 0},_removeScript(t){return t=this.opts.is("embed.script")?t:this.app.create("cleaner").removeTagsWithContent(t,["script"])},_parseUrl(e){var s='<iframe width="560" height="315" src="',i='" frameborder="0" allowfullscreen></iframe>',t=this.opts.get("regex.mp4video"),a=this.opts.get("regex.youtube"),r=this.opts.get("regex.vimeo");let o;if(e.match(t))e=e.replace(t,t=>`<video controls src="${t}"></video>`);else if(e.match(a)){let t="https://www.youtube.com";-1!==e.search("youtube-nocookie.com")&&(t="https://www.youtube-nocookie.com"),e=s+(o=e.replace(a,t+"/embed/$1"))+i}else e.match(r)&&(e=s+(o=e.replace(r,"https://player.vimeo.com/video/$2"))+i);return e},_createInstance(t,e,s){let i,a;return e=e.replace(/(?<=\b\w+="[^"]*)&amp;(?=[^"]*")/g,"&"),s?(a=s.duplicateEmpty(),(i=a.getBlock()).html(e)):(i=this._isFigure(e)?e:"<figure>"+e+"</figure>",i=this.dom(i)),this.app.create("block.embed",i,{caption:t.caption,responsive:t.responsive})},_findScripts(){var t=this.app.editor.getLayout().find("[data-rx-type=embed]").find("script").getAll();this.build.call(this,t)},_callScripts(i){for(let s=0;s<i.length;s++)if(""!==i[s].src){let e=i[s].src;var t=this.dom("<script>").attr({src:e,async:!0,defer:"true"}),a=(this.app.getDoc().find('head script[src="'+e+'"]').remove(),t.on("load",function(){var t;-1!==e.search("instagram")&&(t=this.app.getWinNode()).instgrm&&t.instgrm.Embeds.process(),this.build(i.slice(s+1))}.bind(this)),this.app.getDoc().get().getElementsByTagName("head")[0]);a&&a.appendChild(t.get())}}}),d.add("module","event",{init(){this.trigger=!0,this.pasteEvent=!1,this.blockMouseDown=!1,this.isPopupMouseUp=!1,this.isTabFocus=!1,this.docBlur=!0,this.eventChecked=!1,this.dragoverEvent=!1,this.imageDrag=!1,this.eventPause=!1,this.eventname="rx-events",this.preventEventname="rx-prevent-events";var t=this.app.isMode("default")?"":"-"+this.app.getMode();this.eventClass=this.app.create("event"+t,this)},build(){this.buildInterval=setInterval(()=>{this.app.isStarted()&&!this.app.isReadonly()&&(this._stopLinkEvents(),this.eventClass.start(),clearInterval(this.buildInterval))},1)},stop(){this.app.editor.getLayout().off("."+this.preventEventname),this.eventClass.stop()},run(){this.eventPause=!1,this._stopLinkEvents(),this.eventClass.start()},pause(){this.eventPause=!0,this.eventClass.stop(),this.app.editor.getLayout().off("."+this.preventEventname)},isPaused(){return this.eventPause},isPasteEvent(){return this.pasteEvent},setPasteEvent(){this.pasteEvent=!0},unsetPasteEvent(){this.pasteEvent=!1},_onclick(t){this.trigger&&(this.app.broadcast("editor.click",{e:t}),3!==t.detail||this._isToolClick(t)||setTimeout(()=>{this._setBlock(t,!0)},0))},_onkeydown(t,e){if(this.trigger&&!this.app.ui.isAnyOpen("dropdown","modal")&&!this.app.source.is()&&this.app.editor.hasFocus()){e&&this.app.broadcast("editor.keydown",{e:t});e=this.app.broadcast("document.keydown",this._buildEventKeysObj(t));if(e.isStopped())return t.preventDefault();var s=this.app.create("selection"),i=this.app.create("caret"),s=s.getInline(),a=t.which;s&&i.is(s,"end")&&a===this.app.keycodes.RIGHT&&"block"!==s.style.display?(t.preventDefault(),i.set(s,"after")):(this.app.context.close(t),this.opts.is("enterKey")||13!==t.which?this.app.state.listen(t)||(this._isEsc(t)&&(a=this.app.create("selection"),this.app.block.unset(),a.remove()),this.app.hotkeys.handle(t))||this.app.input.handle(e):t.preventDefault())}},_onkeyup(t){var e,s,i,a,r,o,n;this.trigger&&(this.app.broadcast("editor.keyup",this._buildEventKeysObj(t)).isStopped()?t.preventDefault():this.app.dropdown.isOpen()||(n=this.app.create("selection"),this.app.blocks.is()&&n.isCollapsed()&&this.app.block.set(n.getBlockControlled()),e=t.which,{DOWN:s,UP:i,BACKSPACE:a,LEFT:r,RIGHT:o}=this.app.keycodes,this.opts.is("command")&&this.app.command.build(t),e!==s&&e!==i||0===(n=n.getBlockControlled()).length||this.app.block.is(n)||this.app.block.set(n),e===a&&this.app.editor.isEmpty()&&this.app.editor.setEmpty(),[r,o,s,i].includes(e)&&this.app.observer.observe(),13===t.which&&setTimeout(()=>{var t=this.app.create("element"),e=this.app.block.get().getBlock(),t=t.isElementVisibleInScroll(e),e=this.app.editor.getEditor().get();t||e.scrollTo({top:e.scrollHeight-e.clientHeight,behavior:"smooth"})},10)))},_ontouchstart(t){this.trigger&&this.app.state.add(t)},_onmouseover(t){this.trigger&&this.app.broadcast("editor.mouseover",{e:t})},_onmouseup(t){this.trigger&&setTimeout(()=>{this._isToolClick(t)||(this._checkClick(t),setTimeout(()=>{this.app.context.open(t),this.app.observer.observe()},1),this.app.state.add(t),this.blockMouseDown=!1,this.app.broadcast("editor.mouseup",{e:t}))},0)},_onmousedown(t){this.trigger&&!this._isToolClick(t)&&(this.app.editor.isEditor(t.target)||(this.blockMouseDown=t),this.app.placeholder.handleClick(t),this.app.broadcast("editor.mousedown",{e:t}))},_ondrop(r){if(this.trigger){if(!this.opts.is("drop"))return r.preventDefault();if(this.app.broadcast("editor.drop",{e:r}).isStopped())return r.preventDefault();let t,e=r.dataTransfer,s=e.getData("item"),i=this.app.create("event-action"),a=this.opts.get("draggable");if(""!==s)r.preventDefault(),(t=a&&void 0!==a[s]?a[s]:(o=this.dom("[data-rx-drop-item="+s+"]"),(t=o.html()).trim()))&&i.drop(r,t,"after",!1);else if(this.opts.is("image")&&this.opts.is("image.upload")&&null!==e.files&&0<e.files.length)r.preventDefault(),this.app.image.drop(r,e);else{if(t=""===(t=e.getData("text/html")).trim()?e.getData("Text"):t,this.opts.get("filelink.upload")&&null!==e.files&&0<e.files.length)return r.preventDefault(),void this.app.filelink.drop(r,e);var o=i.drop(r,t);this.imageDrag&&0!==o.length&&o.dataget("instance").change(this.imageDrag,!1)}this._removeDrag(),this.imageDrag=!1,this.app.observer.trigger=!0,this.app.editor.setFocus()}},_ondragstart(t){var e,s;this.trigger&&(e=this._getBlockFirst(t.target),s=this.app.create("element"),0!==e.length&&s.isType(e,"image")&&(this.imageDrag=e.dataget("instance")),this.app.broadcast("editor.dragstart",{e:t}))},_ondragover(t){var e,s;this.trigger&&(t.preventDefault(),this.dragoverEvent=!0,this.app.observer.trigger=!1,this._removeDrag(),-1!==t.dataTransfer.types.indexOf("item")&&0!==(e=this._getBlock(t.target)).length&&(s=this.dom("<div>").addClass("rx-draggable-placeholder"),e.after(s)),this.app.broadcast("editor.dragover",{e:t}))},_ondragleave(t){this.trigger&&(t.preventDefault(),this.dragoverEvent=!0,this.app.observer.trigger=!0,this._removeDrag(),this.app.broadcast("editor.dragleave",{e:t}))},_onpaste(t){this._isEditorFocus()&&this.app.create("event-action").paste(t)},_oncopy(t){this._isEditorFocus()&&this.app.create("event-action").copy(t)},_oncut(t){this._isEditorFocus()&&this.app.create("event-action").cut(t)},_ondocmousedown(t){this.trigger&&(this.isPopupMouseUp=0!==this.dom(t.target).closest(".rx-modal-"+this.uuid+", .rx-dropdown-"+this.uuid).length,this.app.broadcast("document.mousedown",{e:t}))},_ondocclick(t){if(this.trigger&&!this._isToolClick(t))if(this.app.ui.isAnyOpen("dropdown","modal")&&this._isEditorContainer(t))this.app.ui.close(t,"dropdown","modal");else{if(!this._isOutsideEditor(t)||!1===this.trigger)return!0;this.app.modal.isOpen()?!1===this.isPopupMouseUp&&this.app.modal.close(!1):this.app.dropdown.isOpen()?!1===this.isPopupMouseUp&&this.app.dropdown.close(!1):this.docBlur&&this.app.editor.setBlur(t),this.app.broadcast("document.click",{e:t})}},_onwinfocus(){var t=this.app.block.get();let e;t&&!t.isEditable()&&setTimeout(function(){(e=this.app.create("selection")).remove()}.bind(this),0)},_buildEventKeysObj(t){var e=t.which,s=this.app.keycodes,i=[s.UP,s.DOWN,s.LEFT,s.RIGHT],a=!t.ctrlKey&&!t.metaKey&&(48<=e&&e<=57||65<=e&&e<=90);return{e:t,key:e,ctrl:t.ctrlKey||t.metaKey,shift:t.shiftKey,alt:t.altKey,select:(t.ctrlKey||t.metaKey)&&!t.altKey&&65===e,"select-block":(t.ctrlKey||t.metaKey)&&t.shiftKey&&!t.altKey&&65===e,enter:e===s.ENTER,space:e===s.SPACE,esc:e===s.ESC,tab:!(e!==s.TAB||t.shiftKey||t.altKey||t.ctrlKey||t.metaKey),delete:e===s.DELETE,backspace:e===s.BACKSPACE,alpha:a,arrow:-1!==i.indexOf(e),left:e===s.LEFT,right:e===s.RIGHT,up:e===s.UP,down:e===s.DOWN,"left-right":e===s.LEFT||e===s.RIGHT,"up-left":e===s.UP||e===s.LEFT,"down-right":e===s.DOWN||e===s.RIGHT}},_stopLinkEvents(){this.app.editor.getLayout().on("click."+this.preventEventname+" dblclick."+this.preventEventname,this._stopLinkEvent.bind(this))},_stopLinkEvent(t){0!==this.dom(t.target).closest("a").length&&t.preventDefault()},_stopComposition(t){let s=this.app.editor.getLayout(),i=e.which;s.on("keydown."+this.eventname,function(t){13===i?s.attr("contenteditable",!1):8!==i&&37!==i&&38!==i&&39!==i&&40!==i&&32!==i||s.attr("contenteditable",!0)}),s.on("mousedown."+this.eventname+" touchstart."+this.eventname,function(t){s.attr("contenteditable",!0)}),s.on("input."+this.eventname,function(t){this.app.editor.save(),s.attr("contenteditable",!0),this.app.editor.restore()}.bind(this))},_isEsc(t){return t.which===this.app.keycodes.ESC},_isEnter(t){return t.which===this.app.keycodes.ENTER},_isEditorFocus(){return!(this.app.dropdown.isOpen()||this.app.modal.isOpen()||this.app.source.is())&&(this.app.block.is()||this.app.blocks.is()||this.app.editor.isSelectAll())},_isEditorClick(t){if(this.app.editor.isEditor(t.target))return t.preventDefault(),!0},_isEditorContainerClick(t){var e;if(!this.app.isStopped())return e=this.app.container.get("editor").get(),t.target===e?(t.preventDefault(),!0):void 0},_isEditorContainer(t){var e=this.app.isMode("iframe")?"editor":"container";return 0!==this.dom(t.target).closest(".rx-"+e+"-"+this.uuid).length},_isOutsideEditor(t){t=this.dom(t.target);return 0===t.closest(".rx"+["-modal-","-form-","-toolbar-container-","-control-"].join(this.uuid+",.rx")+this.uuid).length&&0===t.closest(".rx-editor-"+this.uuid).length},_isToolClick(t){t=this.dom(t.target);return 0!==t.closest(".rx-button").length?!(this.docBlur=!1):0!==t.closest(".rx-in-tool").length&&(this.app.block.setTool(!0),!(this.docBlur=!1))},_checkClick(e){if(!this.eventChecked){var s=this.app.create("selection"),t=this.app.create("element"),i=this._getBlockFromTarget(e.target),a=i.dataget("instance");if(s.is()&&e&&t.isTool(e.target))this.app.block.setTool(!0);else if(this.app.blocks.is()&&!i.hasClass("rx-block-meta-focus")&&a&&a.isType("image"))this._setBlockByClick(e);else{let t=[];s.getRange()&&(t=s.getNodes({type:"block",partial:!0}),t=this._normalizeBlocks(t)),1===t.length&&!s.isCollapsed()&&this.blockMouseDown?this._setBlockByClick(this.blockMouseDown):!this.blockMouseDown&&this._isEditorClick(e)?this._setBlockByCoords(e):!s.getRange()||s.isCollapsed()?this._setBlockByClick(e):this._setMultipleBlocks(e)}}},_checkContainerClick(t){if((this.docBlur=!0,this.eventChecked=!1,this.blockMouseDown)&&0!==this.dom(t.target).closest(".rx-control").length)return void this._setBlockByClick(this.blockMouseDown,!0);let e=this.app.create("selection"),s=[];e.getRange()&&(s=e.getNodes({type:"block",partial:!0}),s=this._normalizeBlocks(s)),this._isEditorContainerClick(t)?this._setBlockByCoords(t):this.app.editor.isSelectAll()?this.eventChecked=!1:this.blockMouseDown&&1===s.length&&!e.isCollapsed()?(this.eventChecked=!0,this.docBlur=!1,this._setBlockByClick(this.blockMouseDown)):this.blockMouseDown&&!e.isCollapsed()&&(this.eventChecked=!0,this.docBlur=!1,this._setMultipleBlocks(t),setTimeout(function(){e.isCollapsed()&&this._setBlockByClick(t)}.bind(this),0))},_checkPopupsOpen(t){this._isEsc(t)&&this.app.ui.isAnyOpen("dropdown","modal","panel")&&this.app.ui.close("dropdown","modal","panel")},_checkPanelKeys(t){var e=t.which;if(this.app.panel.isOpen()&&(this._isEnter(t)||40===e||39===e||38===e||37===e))return t.preventDefault(),!0},_checkModalEnter(t){if(this.app.modal.isOpen()&&this._isEnter(t)){var e=this.app.modal.getStack();if(!1!==e.hasForm()&&"TEXTAREA"!==t.target.tagName)return t.preventDefault(),e.getButtonPrimary().dataget("instance").invokeCommand(),!0}},_checkTabFocus(t){this.isTabFocus="Tab"===t.key},_getBlockFromTarget(t){return this.dom(t).closest("[data-rx-type]")},_getBlock(t){return this.dom(t).closest("[data-rx-type]")},_getBlockFirst(t){return this.dom(t).closest("[data-rx-first-level]")},_removeDrag(){this.app.editor.getLayout().find(".rx-draggable-placeholder").remove()},_setBlockByCoords(s){let t=this.app.blocks.get({firstLevel:!0}),e=[],i=[],a=!1,r,o,n,l,h,p;t.each(function(t){n=t.get().getBoundingClientRect(),e.push([n.x,n.y,n.y+n.height])}),e.forEach(function(t,e){l=parseInt(s.clientY),h=parseInt(s.clientX),t[1]<l&&l<t[2]?a=e:(o=Math.hypot(t[0]-h,t[1]-l),i.push(parseInt(o)))}),r=!1!==a?a:i.indexOf(Math.min.apply(Math,i)),p=t.eq(r),this.app.editor.setFocus(),this.app.block.set(p,"start")},_setBlockByClick(t,e){var s,t=this._getBlockFromTarget(t.target);this.app.create("selection").getBlockControlled();0!==t.length&&(s=!t.dataget("instance").isEditable()&&"force",e=e||!1!==s,this.app.editor.setFocus(),this.app.block.set(t,s,e))},_setBlock(t,e){this.app.editor.setFocus();var s=this.app.create("selection");let i=t?this._getBlockFromTarget(t.target):s.getBlockControlled(),a=!1;0===i.length&&(i=this.app.blocks.get({first:!0}),a="start"),e&&(a=!1,s.select(i)),this.app.block.set(i,a)},_setMultipleBlocks(t){this.app.editor.setFocus(),this.app.editor.unsetSelectAll();var e=this.app.create("selection"),s=this.app.create("element");let i=!!t&&this._getBlockFromTarget(t.target);var a,t=e.getNodes({type:"block",partial:!0});i&&1===t.length?(this.app.block.set(i),this.app.blocks.unset()):e.isFullySelected()?(a=this.app.blocks.get({firstLevel:!0}),e=e.getNodes({type:"block"}),a.length===e.length?this.app.editor.setSelectAll(a):(this.app.block.unset(),this.app.blocks.set(t))):1<t.length?this._checkInside(s,t,"quote")?(i=s.getDataBlock(i,"quote"),this.app.block.set(i),this.app.blocks.unset()):this._checkInside(s,t,"noneditable")?(i=s.getDataBlock(i,"noneditable"),this.app.block.set(i),this.app.blocks.unset()):(e=this._normalizeBlocks(t),this.app.block.unset(),this.app.blocks.set(e)):(this.app.block.set(i),this.app.blocks.unset())},_checkInside(s,t,i){let a=0,e=t.length;return t.forEach(function(t,e){s.hasParent(t,i)&&a++}),a===e},_normalizeBlocks(e){let s=[],i;for(let t=0;t<e.length;t++)(i=this.dom(e[t])).attr("data-rx-type")||(i=i.closest("[data-rx-type]")),-1===s.indexOf(i.get())&&s.push(i.get());return s}}),d.add("module","extrabar",{init(){this.eventname="rx-toolbar"},start(){this.isEnabled()&&this._buildToolbar()},stop(){this.isEnabled()&&this.$toolbar.remove()},load(){this.build()},build(){this.isEnabled()&&this.app.ui.buildButtons("extrabar")},add(t,e){this.app.ui.addButton("extrabar",t,e)},remove(t){this.app.ui.removeButton("extrabar",t)},setActive(t){this.app.ui.setActive("extrabar",t)},setToggled(t){this.app.ui.setToggled("extrabar",t)},unsetActive(t){this.app.ui.unsetActive("extrabar",t)},unsetToggled(t,e){this.app.ui.unsetToggled("extrabar",t,e)},getButton(t){return this.app.ui.getButton("extrabar",t)},getElement(){return this.$toolbar},enable(...t){this.app.ui.enableToolbar("extrabar",t)},disable(...t){this.app.ui.disableToolbar("extrabar",t)},isEnabled(){return this.opts.is("extrabar")},_buildToolbar(){var t=this.app.container.get("toolbar");this.$toolbar=this.app.ui.build("extrabar",t).getElement()}}),d.add("module","format",{init(){this.removeButtons=[]},getItems(){var t=[...this.opts.get("popups.format")],e=this.opts.get("formatItems");if(e)for(var[s,i]of Object.entries(e))i.command="format.set";return this.app.ui.loadButtons(t,e,"format",!1,this.removeButtons)},popup(t,e){var s=[...this.opts.get("popups.format")],i=this.opts.get("formatItems"),a=this.app.observer.getKeys();if(i)for(var[r,o]of Object.entries(i))o.command="format.set";this.app.dropdown.create("format",{items:s,extend:i,keys:a,remove:this.removeButtons,type:"formatbar"}),this.app.dropdown.open(t,e)},remove(e){if(Array.isArray(e))for(let t=0;t<e.length;t++)this.removeButtons.push(e[t]);else this.removeButtons.push(e)},set(i,t,a){if(!this.app.block.isTool()){let t=this.app.create("selection"),e=this.app.block.get(),s=[];this.app.dropdown.close(),this.params=i||{},this.name=a,this.tag=this._buildTag(),this.type=this._buildType(),this.multiple=!1,this.isSelectAll=this.app.editor.isSelectAll(),this.$editor=this.app.editor.getLayout(),this.blocks=[],(this.isSelectAll||!t.isCollapsed(t))&&this.app.blocks.is()?(s=this.app.blocks.get({selected:!0,instances:!0}),this.multiple=!0):e&&s.push(e),0!==s.length&&(this.app.broadcast("format.before.set",{instances:s}),this._format(s))}},_format(t){let s,e=this.app.create("marker"),i=["text","heading","address","list","listitem","todo","todoitem","quote","pre"],a=this.app.create("element");this.isSelectAll||e.save(),t.forEach(function(e){if(-1!==i.indexOf(e.getType())){var t=this._hasSameTag(e);if(this.multiple||!t||this._isParams()||"heading"!==this.type&&"address"!==this.type)if(e.isType(["text","heading","address"]))s=this._convertText(this.type,e,a);else if(e.isType("listitem")){let t=!this._hasSameTag(e)&&this.listType?"list":this.type;e.getParentTop().tagName(this.tag)&&(t="text"),s=this._convertListItem(t,e,a)}else e.isType("todoitem")?s=this._convertTodoItem(this.type,e,a):e.isType(["pre","quote"])?s=this._convertPreQuote(this.type,e,a):e.isType("list")?s=this._convertList(this.type,e,a):e.isType("todo")?s=this._convertTodo(this.type,e,a):this.isSelectAll&&("heading"!==this.type&&"text"!==this.type||!e.isType(["list","todo"])?"list"===this.type&&!t&&e.isType("list")&&(s=this._convertAllSelectedList(e,a)):s=this._convertAllSelected(e));else s=this._convertToText(e,a);if(t&&e.isType(this.type)&&this.blocks.push(e),s)if(Array.isArray(s))for(let t=0;t<s.length;t++)this.blocks.push(s[t]);else this.blocks.push(s)}}.bind(this)),this.$editor.find(".rx-format-todo-to-listitem").each(function(t){this._convertFormattedTodoToList(t,a)}.bind(this)),this.$editor.find(".rx-format-todo-to-text").each(function(t){this._convertFormattedTodoToText(t,a)}.bind(this)),this.$editor.find(".rx-format-list-to-text").each(function(t){this._convertFormattedListToText(t,a)}.bind(this)),this.$editor.find(".rx-format-listitem-to-todo").each(function(t){this._convertFormattedListToTodo(t,a)}.bind(this));t=this.app.create("selection");t.is()&&(this._combineSelected(t,"list"),this._combineSelected(t,"todo")),setTimeout(function(){this._buildConverted(e)}.bind(this),0)},_buildConverted(e){var s=this.app.create("selection");if(this._setParams(s),this.isSelectAll){this.app.editor.unsetSelectAll(),this.app.editor.build(),this.app.editor.setSelectAll(!1,!1);var i=this.app.blocks.get();this.app.broadcast("format.set",{$nodes:i})}else{if(e.restore(),this.multiple){i=s.getNodes({type:"block",partial:!0});this.app.blocks.set(i),this.app.broadcast("format.set",{$nodes:this.dom(i)})}else{let t=s.getBlockControlled();i=!(!(t=0===t.length&&0!==(e=this.app.editor.getLayout().find(".rx-block-focus")).length?e.dataget("instance"):t).isEmpty||!t.isEmpty())&&"start";this.app.block.set(t,i),this.app.broadcast("format.set",{$nodes:this.dom(t)})}this.app.editor.build(),s.isCollapsed()||this.app.context.open()}},_setParams(t){if(t.is()){let e=t.getNodes({tags:[this.tag],partial:!0}),s=this.dom([]),i=this.app.create("element"),a=e.length,r=0,o=0,n=0;for(let t=0;t<a;t++){var l=this.dom(e[t]);s.add(l),this.params.classname&&l.hasClass(this.params.classname)&&r++,this.params.style&&i.hasStyle(l,this.params.style)&&o++,this.params.attrs&&i.hasAttrs(l,this.params.attrs)&&n++}0!==a&&(this._setClass(s,a,r),this._setStyle(s,a,o),this._setAttrs(s,a,n))}},_setAttrs(t,o,n){if(this.params.attrs){let r=this.params.attrs;t.each(function(t){var e=t.dataget("instance");if(e)if(o===n)for(var s of Object.keys(r))e.removeAttr(s);else for(var[i,a]of Object.entries(r))e.setAttr(i,a)})}},_setStyle(t,i,a){if(this.params.style){let e=this.app.create("cleaner"),s=this.params.style;i===a&&Object.keys(s).forEach(t=>s[t]=""),t.css(s),t.each(function(t){e.cacheElementStyle(t),""===t.attr("style")&&t.removeAttr("style")})}},_setClass(t,e,s){this.params.classname&&t[e===s?"removeClass":"addClass"](this.params.classname)},_combineSelected(t,e){var s=t.getNodes({types:[e],partial:!0});for(let t=0;t<s.length;t++){var i,a=this.dom(s[t]).dataget("instance");a&&(i=a.getPrev(e))&&i.getTag()===a.getTag()&&(i.getBlock().append(a.getBlock().children()),a.remove())}},_findConvertedItem(t,e,s,i,a){let r="[data-rx-type="+s+"]",o=i.find(r).first().prevElement().get(),n,l,h;if(o)for(h=a.cloneEmpty(i),"list"===e&&(h=a.replaceToTag(h,this.tag)),i.after(h),l=this.app.create("block."+e,h),this.blocks.push(l);o.nextSibling;)h.append(o.nextSibling);else h=i,"list"===e&&(h=a.replaceToTag(h,this.tag)),l=this.app.create("block."+e,h),this.blocks.push(l);if(n=h.find(r).last().get()){var p=a.cloneEmpty(i);for(h.after(p),this.app.create("block."+t,p);n.nextSibling;)p.append(n.nextSibling)}return h},_findConvertedText(t,e,s){let i="[data-rx-type=text],[data-rx-type=heading]",a=e.find(i).first().prevElement().get(),r,o;if(a)for(o=s.cloneEmpty(e),o=s.replaceToTag(o,this.tag),e.after(o);a.nextSibling;)o.append(a.nextSibling);else o=e;if(r=o.find(i).last().get()){var n=s.cloneEmpty(e);for(o.after(n),this.app.create("block."+t,n);r.nextSibling;)n.append(r.nextSibling)}return o},_convertAllSelectedList(t,e){t=t.getBlock();return this._replaceListToListElement("list",this.tag,t,e)},_convertAllSelected(t){let e=t.getBlock(),s=e.children(),i=[];return s.each(function(t){var t=t.dataget("instance"),e=t.getContent(),e="text"===this.type?this.app.create("block.text",{content:e}):this.app.create("block.heading",{level:this.tag.replace("h",""),content:e});t.getBlock().after(e.getBlock()),t.remove(),i.push(e)}.bind(this)),e.unwrap(),i},_convertFormattedListToText(t,e){var s;(0===t.find("li").length?t:("list"===(s=(e=this._findConvertedText("list",t,e)).nextElement()).attr("data-rx-type")&&0===s.get().children.length&&s.remove(),e)).unwrap(),t.removeClass("rx-format-todo-to-text")},_convertFormattedTodoToText(t,e){var s;(0===t.find("li").length?t:("todo"===(s=(e=this._findConvertedText("todo",t,e)).nextElement()).attr("data-rx-type")&&0===s.get().children.length&&s.remove(),e)).unwrap(),t.removeClass("rx-format-todo-to-text")},_convertFormattedListToTodo(t,e){var s=t.find("li").length;t.find("[data-rx-type=todoitem]").length===s?(t.removeAttr("data-rx-type"),t.children().removeAttr("data-rx-type"),s=this.app.create("block.todo",t),this.blocks.push(s)):"list"===(s=this._findConvertedItem("list","todo","todoitem",t,e).nextElement()).attr("data-rx-type")&&0===s.get().children.length&&s.remove(),t.removeClass("rx-format-listitem-to-todo")},_convertFormattedTodoToList(t,e){var s=t.find("li"),i=t.dataget("instance"),i=i?i.getAttrs():null;s.length===t.find("[data-rx-type=listitem]").length?((t=e.replaceToTag(t,this.tag)).removeAttr("data-rx-type"),t.children().removeAttr("data-rx-type"),(s=this.app.create("block.list",t)).setAttrs(i),this.blocks.push(s)):"todo"===(i=this._findConvertedItem("todo","list","listitem",t,e).nextElement()).attr("data-rx-type")&&0===i.get().children.length&&i.remove(),t.removeClass("rx-format-todo-to-listitem")},_convertToText(t,e){return this._replaceTo("text",this.opts.get("markup"),t,e)},_convertText(t,e,s){return"heading"===t?this._replaceTo("heading",this.tag,e,s):"text"===t||"address"===t?this._replaceTo("text",this.opts.get("markup"),e,s):"list"===t?this._replaceToList(e):"todo"===t?this._replaceToTodo(e):"quote"===t?this._replaceToQuote(e):void 0},_convertList(e,s,t){s.getBlock();let i=s.getItems(),a,r,o;if("text"===e||"heading"===e){for(let t=0;t<i.length;t++)o="text"===e?this.app.create("block.text",{content:i[t]}):this.app.create("block.heading",{level:this.tag.replace("h",""),content:i[t]}),0===t&&(r=o),s.getBlock().before(o.getBlock());r&&this.app.block.set(r.getBlock(),"start"),s.remove()}else{if("list"===e)return this._replaceListToList(this.tag,s,t);if("quote"===e){let e="";for(let t=0;t<i.length;t++)e+=i[t];o=this.app.create("block.quote",{content:e}),s.getBlock().before(o.getBlock()),this.app.block.set(o.getBlock(),"start"),s.remove()}else if("todo"===e){o=this.app.create("block.todo"),s.getBlock().before(o.getBlock()),o.setEmpty();for(let t=0;t<i.length;t++)a=this.app.create("block.todoitem",{content:i[t]}),o.getBlock().append(a.getBlock());this.app.block.set(o.getBlock(),"start"),s.remove()}}},_convertListItem(t,e,s){var i,a;return"text"!==t?"heading"!==t?"todo"===t?(i=e.getContent(),a=(i=this.app.create("block.todoitem",{content:i})).getBlock(),e.getBlock().after(a),e.remove(),a.closest("[data-rx-type=list]").addClass("rx-format-listitem-to-todo"),i):"list"===t?this._replaceListToList(this.tag,e,s):void 0:e.hasParentList()?void 0:this._replaceListTodoToText("heading","list",e):e.hasParentList()?void 0:this._replaceListTodoToText("text","list",e)},_convertTodo(e,s,t){s.getBlock();let i=s.getItems(),a,r,o;if("text"===e||"heading"===e){for(let t=0;t<i.length;t++)o="text"===e?this.app.create("block.text",{content:i[t].content}):this.app.create("block.heading",{level:this.tag.replace("h",""),content:i[t].content}),0===t&&(a=o),s.getBlock().before(o.getBlock());a&&this.app.block.set(a.getBlock(),"start"),s.remove()}else if("quote"===e){let e="";for(let t=0;t<i.length;t++)e+=i[t].content;o=this.app.create("block.quote",{content:e}),s.getBlock().before(o.getBlock()),this.app.block.set(o.getBlock(),"start"),s.remove()}else if("list"===e){o=this.app.create("block.list",{numbered:"ol"===this.tag}),s.getBlock().before(o.getBlock()),o.setEmpty();for(let t=0;t<i.length;t++)r=this.app.create("block.listitem",{content:i[t].content}),o.getBlock().append(r.getBlock());this.app.block.set(o.getBlock(),"start"),s.remove()}},_convertTodoItem(t,e,s){return"text"===t?this._replaceListTodoToText("text","todo",e):"heading"===t?this._replaceListTodoToText("heading","todo",e):"list"===t?this._replaceTodoToList(e):void 0},_convertPreQuote(t,e,s){return"text"===t?this._replaceToText(e):"heading"===t?this._replaceToHeading(e):"list"===t?this._replaceToList(e):"todo"===t?this._replaceToTodo(e):"quote"===t?this._replaceToQuote(e):void 0},_replaceToList(t){var e=t.getContent(),e=this.app.create("cleaner").removeBlockTags(e),s=this.app.create("block.list",{numbered:"ol"===this.tag}),e=(s.getFirstItemInstance().setContent(e),t.getBlock().attr("data-rx-style-cache"));return e&&s.getBlock().attr("style",e),t.getBlock().after(s.getBlock()),t.remove(),s},_replaceToTodo(t){var e=t.getContent(),e=this.app.create("cleaner").removeBlockTags(e),s=this.app.create("block.todo");return s.getFirstItemInstance().setContent(e),t.getBlock().after(s.getBlock()),t.remove(),s},_replaceToQuote(t){var e=t.getPlainText(),e=this.app.create("block.quote",{content:e}),s=t.getBlock().attr("data-rx-style-cache");return s&&e.getBlock().attr("style",s),t.getBlock().after(e.getBlock()),t.remove(),e},_replaceToHeading(t){var e=t.getContent(),e=this.app.create("block.heading",{level:this.tag.replace("h",""),content:e});return t.getBlock().after(e.getBlock()),t.remove(),e},_replaceToText(t){var e=t.getContent(),e=this.app.create("block.text",{content:e});return t.getBlock().after(e.getBlock()),t.remove(),e},_replaceListTodoToText(e,t,s){var i=s.getContent(!0),i="text"===e?this.app.create("block.text",{content:i}):this.app.create("block.heading",{level:this.tag.replace("h",""),content:i});let a=i.getBlock();var r=s.getBlock().find("li");return s.getBlock().after(a),r.each(t=>{t=t.dataget("instance"),t="text"===e?this.app.create("block.text",{content:t.getContent(!0)}):this.app.create("block.heading",{level:this.tag.replace("h",""),content:t.getContent(!0)});a.after(t.getBlock())}),s.remove(),a.closest("[data-rx-type="+t+"]").addClass("rx-format-"+t+"-to-text"),i},_replaceTodoToList(t){var e=t.getContent(),e=this.app.create("block.listitem",{content:e}),s=e.getBlock();return t.getBlock().after(s),t.remove(),s.closest("[data-rx-type=todo]").addClass("rx-format-todo-to-listitem"),e},_replaceListToList(t,e,s){let i=e.getBlock();if(!(i=e.isType("listitem")?e.getParentTop():i).tagName(t))return this._replaceListToListElement("list",t,i,s)},_replaceListToListElement(e,s,t,i){var a,r=t.dataget("instance"),r=r?r.getAttrs():null,t=i.replaceToTag(t,s);return t.removeAttr("data-rx-type"),t.children().removeAttr("data-rx-type"),(a=this.app.create("block."+e,t)).setAttrs(r),t.find("ol, ul").each(function(t){this._replaceListToListElement(e,s,t,i)}.bind(this)),a},_replaceTo(t,e,s,i){var a=s.getBlock(),r=s.getTag(),s=s.getAttrs();if(e!==r)return(r=i.replaceToTag(a,e)).removeAttr("data-rx-type class"),"text"!==t&&r.removeAttr("data-rx-tag"),(i=this.app.create("block."+t,r)).setAttrs(s),i},_buildTag(){let t=this.name;return"numberedlist"===this.name?t="ol":"bulletlist"===this.name?t="ul":"text"===this.name?t=this.opts.get("markup"):this.params.tag&&(t=this.params.tag),t},_buildType(){let t=this.params.type||this.name;return-1!==["text","p","div"].indexOf(this.tag)?t="text":-1!==["h1","h2","h3","h4","h5","h6"].indexOf(this.tag)?t="heading":-1!==["ol","ul"].indexOf(this.tag)&&(t="list"),t},_isParams(){return this.params.style||this.params.classname||this.params.attrs},_hasSameTag(t){var e=t.getTag();return!(!t.isType("quote")||"quote"!==this.tag)||!(!t.isType(["todo","todoitem"])||"todo"!==this.tag)||e===this.tag}}),d.add("module","hotkeys",{init(){if(this.opts.is("hotkeysRemove")){var e=this.opts.get("hotkeysRemove");for(let t=0;t<e.length;t++)this.remove(e[t])}if(this.opts.is("hotkeysAdd")){var t,s,i=this.opts.get("hotkeysAdd");for([t,s]of Object.entries(i))this.opts.set("hotkeys."+t,s)}this.hotkeys=this.opts.get("hotkeys"),this.hotkeysKeys={8:"backspace",9:"tab",10:"return",13:"return",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"del",59:";",61:"=",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",110:".",111:"/",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scroll",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},this.hotkeysShiftNums={"`":"~",1:"!",2:"@",3:"#",4:"$",5:"%",6:"^",7:"&",8:"*",9:"(",0:")","-":"_","=":"+",";":": ","'":'"',",":"<",".":">","/":"?","\\":"|"}},add(t,e){this.hotkeys[t]=e},remove(t){this.opts.set("hotkeys",this._remove(t,this.opts.get("hotkeys"))),this.opts.set("hotkeysBase",this._remove(t,this.opts.get("hotkeysBase")))},popup(t,e){var s=/(Mac|iPhone|iPod|iPad)/i.test(navigator.platform)?"Cmd":"Crtl",i={},a=this._buildPopupItems(i,0,this.opts.get("hotkeysBase"),s,"base");this._buildPopupItems(i,a,this.opts.get("hotkeys"),s),this.app.dropdown.create("hotkeys",{width:"320px",items:i}),this.app.dropdown.open(t,e)},handle(t){if((this.triggered=!1)===this.hotkeys)return!t.ctrlKey&&!t.metaKey||66!==t.which&&73!==t.which||t.preventDefault(),!0;if(t.ctrlKey||t.metaKey||t.shiftKey||t.altKey)for(var[e,s]of Object.entries(this.hotkeys))this._build(t,e,s);return this.triggered},_buildPopupItems(t,e,s,i,a){for(var[r,o]of Object.entries(s)){var n=this.dom("<div>"),l="base"===a?o:o.title,h=this.dom("<span>").addClass("rx-dropdown-item-title").html(this.lang.parse(l)),p=this.dom("<span>").addClass("rx-dropdown-item-hotkey"),d=("base"===a?r:o.name).replace("meta",i).split("+");for(let t=0;t<d.length;t++)"Cmd"===d[t]||"Ctrl"===d[t]?d[t]='<span class="rx-hk-meta">'+d[t]+"</span>":"alt"===d[t]?d[t]='<span class="rx-hk-alt">Alt</span>':"shift"===d[t]?d[t]='<span class="rx-hk-shift">Shift</span>':d[t]="<span>"+(-1===d[t].search(/&/)?d[t].toUpperCase():d[t])+"</span>";p.html(d.join("+")),n.append(h),n.append(p),t[e]={title:l,classname:"rx-dropdown-item",html:n.html()},e++}return e},_build(e,t,s){var i=t.split(","),a=i.length;for(let t=0;t<a;t++)"string"!=typeof i[t]||Object.prototype.hasOwnProperty.call(s,"trigger")||this._handler(e,i[t].trim(),s)},_handler(e,s,i){s=s.toLowerCase().split(" ");let a=this.hotkeysKeys[e.keyCode],t=91!==e.which&&String.fromCharCode(e.which).toLowerCase(),r="",o={},n=["meta","ctrl","alt","shift"];for(let t=0;t<n.length;t++){var l=n[t];e[l+"Key"]&&a!==l&&(r+=l+"+")}93===e.keyCode&&(r+="meta+"),a&&(o[r+a]=!0),t&&(o[r+t]=!0,o[r+this.hotkeysShiftNums[t]]=!0,"shift+"===r)&&(o[this.hotkeysShiftNums[t]]=!0);var h=s.length;for(let t=0;t<h;t++)if(o[s[t]])return e.preventDefault(),this.triggered=!0,void this.app.api(i.command,i.params,e)},_remove(s,i){return Object.keys(i).reduce(function(t,e){return e!==s&&(t[e]=i[e]),t},{})}}),d.add("module","image",{modals:{add:{title:"## modal.add-image ##",width:"100%"},edit:{title:"## modal.image ##",width:"100%",getter:"block.getData",form:{width:{type:"input",width:"100px",label:"## image.width ##",observer:"image.observeImageWidth"},alt:{type:"input",label:"## image.alt-text ##"},caption:{type:"input",label:"## image.caption ##",observer:"image.observeImageCaption"},url:{type:"input",label:"## image.link ##",observer:"image.observeImageLink"},target:{type:"checkbox",text:"## image.link-in-new-tab ##",observer:"image.observeImageLink"}},footer:{save:{title:"## buttons.save ##",command:"image.save",type:"primary"},cancel:{title:"## buttons.cancel ##",command:"modal.close"},remove:{title:"## buttons.delete ##",command:"image.remove",type:"danger",right:!0}}}},init(){this.dataStates=[]},popupWrap(t,e){var s,i,a=this.opts.get("wrap"),r={},o=this.app.block.get(),n=o?o.getClassname(a):"none";for([s,i]of Object.entries(a))r[s]={title:this.lang.get("wrap.wrap-"+s),command:"image.wrap",active:s===n,params:{classname:i}};this.app.dropdown.create("wrap",{items:r}),this.app.dropdown.open(t,e)},popupOutset(t,e){var s,i,a=this.opts.get("outset"),r={},o=this.app.block.get(),n=o?o.getClassname(a):"none";for([s,i]of Object.entries(a))r[s]={title:this.lang.get("outset.outset-"+s),command:"image.outset",active:s===n,params:{classname:i}};this.app.dropdown.create("wrap",{items:r}),this.app.dropdown.open(t,e)},popup(t,e){var s,i=this.opts.get("image.create");i?i(this.app):((i=this.app.create("stack")).create("image",this.modals.add),s=i.getBody(),this._createImageByUrl(s),this._createOrSection(s),this._createUploadBox(s),this._createSelectBox(s),this.app.modal.open({name:"image",stack:i,button:e}),this.opts.is("image.url")&&this.$urlinput.focus())},edit(t,e){var s,i=this.opts.get("image.edit");i?(s=this.app.block.get(),i(this.app,s)):((i=this.app.create("stack")).create("image-edit",this.modals.edit),s=i.getBody(),this._buildEditUpload(s),this.app.modal.open({name:"image-edit",stack:i,button:e}))},wrap(t){this.app.dropdown.close();var t=t.classname,e=this.opts.get("wrap"),s=this.app.block.get();s&&("none"!==t&&"wrap-center"!==t||s.setStyle({"max-width":""}),s.setClassname(t,e),this.app.control.updatePosition(),this.app.broadcast("image.wrap",{image:s}))},outset(t){this.app.dropdown.close();var t=t.classname,e=this.opts.get("outset"),s=this.app.block.get();s&&(s.setClassname(t,e),this.app.control.updatePosition(),this.app.broadcast("image.outset",{image:s}))},observe(t,e){if("image"===e){var s=this.app.block.get();s&&s.isType("image")&&(t.command="image.edit")}else{if("wrap"===e&&!this.opts.is("wrap"))return;if("outset"===e&&!this.opts.is("outset"))return}return t},observeStates(){var t,e,s=this._findImages();let i=[];s.each(this._addImageState.bind(this)),s.each(t=>{var e=t.attr("data-image");e&&(i[e]=t)});for([t,e]of Object.entries(this.dataStates))this.dataStates[t].status=!!i[t]},observeImageLink(t){return!!this.opts.is("image.link")&&t},observeImageCaption(t){var e=this.app.block.get();return!(!e||!e.isFigure())&&t},observeImageWidth(t){return!!this.opts.is("image.width")&&t},drop(t,e){var s=[];for(let t=0;t<e.files.length;t++){var i=e.files[t]||e.items[t].getAsFile();i&&s.push(i)}var a,r={url:this.opts.get("image.upload"),name:this.opts.get("image.name"),data:this.opts.get("image.data"),multiple:this.opts.get("image.multiple"),success:"image.insertByDrop",error:"image.error"};0<s.length&&(0!==(a=this.dom(t.target).closest("[data-rx-type]")).length&&this.app.block.set(a),this.app.create("upload").send(t,s,r))},parseInserted(t){if(this.opts.is("image.upload")){var a=[];let e={url:this.opts.get("image.upload"),name:this.opts.get("image.name"),data:this.opts.get("image.data"),multiple:!0,success:"image.insertFromInserted",error:"image.error"},s=(this.pasteInsertedImages=[],this.resolved=[],0),i=[];t.each(function(t){t=t.dataget("instance");t&&i.push(t)});for(let t=0;t<i.length;t++){var r=i[t];if("image"===r.getType()){var o=r.getSrc();if(-1!==o.search(/^data:/i)){var n=this._dataURLtoFile(o,"image"+t);a.push(n),this.pasteInsertedImages.push(r)}else if(-1!==o.search(/^blob:/i)){s++,this.pasteInsertedImages.push(r);let a=this;!function(t,s){var i=new XMLHttpRequest;i.open("GET",t,!0),i.responseType="blob",i.onload=function(t){var e;200==i.status&&(e=i.response,e=new File([e],"image"+s,{type:"image/png"}),a.resolved.push(e))},i.send()}(o,t)}}}if(0!==s){let t=setInterval(function(){this.resolved.length===s&&(clearInterval(t),this.app.create("upload").send(!1,this.resolved,e))}.bind(this),100)}0!==a.length&&this.app.create("upload").send(!1,a,e)}},paste(t,e){var s;this.opts.is("image.upload")&&(s={url:this.opts.get("image.upload"),name:this.opts.get("image.name"),data:this.opts.get("image.data"),multiple:this.opts.get("image.multiple"),success:"image.insertFromBlob",error:"image.error"},this.app.create("upload").send(e,[t],s))},insertFromClipboard(e){let t=e.getData("text/plain")||e.getData("text/html");if(""===(t=t.trim())){var s=e.items;let t=null;for(var i=0;i<s.length;i++)0===s[i].type.indexOf("image")&&(t=s[i].getAsFile());return null!==t?(this.paste(t),!0):void 0}},insertFromBlob(t){this.insert(t)},insertFromInserted(t){let e=0;for(var[s,i]of Object.entries(t))this.pasteInsertedImages[e].setImage(i),e++},insertByDrop(t,e){if(this.app.block.is()){var s=this.app.block.get(),i=(e.target,"image"===s.getType()),a=this.app.create("insertion");if(i)return void this.change(t);e&&s.isEditable()&&a.insertPoint(e)}this.insert(t)},insertByUrl(t){t.preventDefault();var t=this.$urlinput.val();""!==t.trim()&&(t={file:{url:t,id:this.app.create("utils").getRandomId()}},this.insert(t))},insertByUpload(t){this.insert(t)},insertFromSelect(t){t.preventDefault();var e=this.dom(t.target),s=e.data(),i=["id","alt","caption","url","width","height"];for(let t=0;t<i.length;t++){var a=e.attr("data-"+i[t]);null!==a&&(s[i[t]]=a)}this.insert({file:s},!0)},insert(t,e){this.app.modal.close(),this.imageslen=0,this.imagescount=0;var s,i,a=this.app.block.get(),r=this.opts.get("image.tag"),o=this.app.create("insertion");for([s,i]of Object.entries(t)){var n=this.dom("<"+r+">"),l=this._createImageFromResponseItem(i),l=(n.append(l),this.app.create("block.image",n)),n=(o.insert({instance:l,remove:!1}),e?"select":"upload");this.app.broadcast("image."+n,{instance:l,data:i}),this.$last=l.getBlock(),this.imageslen++}a&&a.isEditable()&&a.isEmpty()&&a.remove()},createUploadBox(t,e){if(t)return t=this.dom("<div>"),e.append(t),t},createSelectBox(t,e,s,i){t&&(this.$selectbox=this._createImagesBox(e,i),"object"==typeof t?this._parseList(t,s):(e=this.opts.is("reloadmarker")?{d:(new Date).getTime()}:{},this.ajax.request(this.opts.get("image.selectMethod"),{url:t,data:e,success:function(t){this._parseList(t,s)}.bind(this)})))},changeClone(t){for(var[e,s]of Object.entries(t)){this.$imageclone.attr("src",s.url);break}this.change(t,!1)},change(t,e){!1!==e&&this.app.modal.close();var s,i=this.app.block.get();for(s in t)if(t.hasOwnProperty(s))return i.setImage(t[s]),this.app.broadcast("image.change",t[s]),void this.app.broadcast("image.upload",{instance:i,data:t[s]});this.app.parser.buildPredefinedClasses()},save(t){t=t.getData();this.app.modal.close(),this.app.block.setData(t)},remove(){this.app.modal.close(),this.app.block.remove()},error(t){this.app.broadcast("image.upload.error",{response:t})},getStates(){return this.dataStates},setImageState(t,e,s){e.uid&&(this.dataStates[e.uid].status=s)},_buildUpload(t,e){this.opts.is("image.upload")&&(e={box:!0,placeholder:this.lang.get("image.upload-new-placeholder"),url:this.opts.get("image.upload"),name:this.opts.get("image.name"),data:this.opts.get("image.data"),multiple:this.opts.get("image.multiple"),success:e,error:"image.error"},this.app.create("upload",t,e))},_buildEditUpload(t){var e,s;this.opts.is("image.upload")&&(s=this.app.block.get(),(e=this._createFormItem()).addClass("rx-form-item-edit-image-box"),this.$imageclone=s.getImage().clone(),this.$imageclone.removeAttr("width height style"),(s=this.dom("<div>").addClass("rx-form-item-image")).append(this.$imageclone),e.append(s),this.$upload=this.dom("<div>"),e.append(this.$upload),t.prepend(e),this._buildUpload(this.$upload,"image.changeClone"))},_createImageFromResponseItem(e){let s=this.dom("<img>").attr("src",e.url).one("load",this._checkImageLoad.bind(this));var t;return["id","alt","width","height"].forEach(t=>{void 0!==e[t]&&s.attr(t,e[t])}),e.id&&s.attr("data-image",e.id),e.srcset&&s.attr("srcset",e.srcset),e.link&&((t=this.dom("<a>")).attr("href",e.link),s.wrap(t),s=t),s},_createSelectBox(t){this.createSelectBox(this.opts.get("image.select"),t,"image.insertFromSelect")},_createImagesBox(t,e){var s=this.dom("<div>").addClass("rx-modal-images-box");return e?(s.addClass("rx-modal-images-box-edit"),t.after(s)):t.append(s),s},_createOrSection(t){var e;this.opts.is("image.url")&&(this.opts.is("image.upload")||this.opts.is("image.select"))&&((e=this.dom("<div>").addClass("rx-modal-image-section-or")).html(this.lang.get("image.or")),t.append(e))},_createImageByUrl(t){var e;this.opts.is("image.url")&&(e=this._createFormItem(),this.$urlinput=this._createUrlInput(),this.$urlbutton=this._createUrlButton(),e.append(this.$urlinput),e.append(this.$urlbutton),t.append(e),this.$urlinput.focus())},_createUploadBox(t){this.$upload=this.createUploadBox(this.opts.get("image.upload"),t),this._buildUpload(this.$upload,"image.insertByUpload")},_createFormItem(){return this.dom("<div>").addClass("rx-form-container-flex")},_createUrlInput(){var t=this.dom("<input>").addClass("rx-form-input");return t.attr("placeholder",this.lang.get("image.url-placeholder")),t},_createUrlButton(){var t=this.dom("<button>").addClass("rx-form-button rx-form-button-primary");return t.html(this.lang.get("buttons.insert")),t.one("click",this.insertByUrl.bind(this)),t},_checkImageLoad(){this.imagescount++,this.imagescount===this.imageslen&&(this.app.block.unset(),this.app.block.set(this.$last),this.app.editor.adjustHeight())},_parseList(t,e){for(var[s,i]of Object.entries(t))if("object"==typeof i){var a=this.dom("<img>"),r=i.thumb||i.url,o=(a.addClass("rx-modal-event"),a.attr("src",r),a.attr("data-url",i.url),a.attr("data-callback",e),["id","alt","caption","link","width","height"]);for(let t=0;t<o.length;t++)Object.prototype.hasOwnProperty.call(i,o[t])&&a.attr("data-"+o[t],i[o[t]]);a.on("click.rx-modal-event-"+this.uuid,function(t){var e=this.dom(t.target).attr("data-callback");this.app.api(e,t)}.bind(this)),this.$selectbox.append(a)}},_blobToImage(i){return new Promise(t=>{const e=URL.createObjectURL(i);let s=new Image;s.onload=()=>{URL.revokeObjectURL(e),t(s)},s.src=e})},_dataURLtoFile(t,e){let s=t.split(","),i=s[0].match(/:(.*?);/)[1],a=atob(s[1]),r=a.length,o=new Uint8Array(r);for(;r--;)o[r]=a.charCodeAt(r);return new File([o],e,{type:i})},_findImages(){return this.app.editor.getLayout().find("[data-image]")},_addImageState(t){var e=t.attr("data-image");e&&(this.dataStates[e]={type:"image",status:!0,url:t.attr("src"),$img:t,id:e})}}),d.add("module","inline",{init(){this.offset=!1},popup(t,e){var s=[...this.opts.get("popups.inline")],i=this.opts.get("inlineItems"),a=this.app.observer.getKeys();if(i)for(var r of Object.values(i))r.command="inline.set";this.app.dropdown.create("inline",{items:s,extend:i,keys:a,type:"inlinebar"}),this.app.dropdown.open(t,e)},set(e,s,i){if(!0===i||!this.app.block.isTool()){let t=this.dom([]);var i=this.app.create("selection"),a=this.app.create("offset");if(s||this.app.dropdown.close(),this.params=e||{},this.instant=s,this.offset=a.get(),this.params.style){var r,o,n={};for([r,o]of Object.entries(this.params.style)){let t=r.replace(/([A-Z])/g," $1");n[t=t.split(" ").join("-").toLowerCase()]=o}this.params.style=n}if(i.getRange())return this.params.tag=this._replaceTags(),t=i.isCollapsed()?this._formatCollapsed():this._formatUncollapsed(),this.offset=a.get(),this.app.context.updatePosition(),this.app.broadcast("inline.set",{$nodes:t}),this.app.sync.trigger(),this.app.observer.observe(),t}},remove(e){var t,s=this.app.create("selection"),i=this.app.create("cleaner"),a=s.getNodes({type:"inline",link:!0}),r=s.getInlineTop();if(s.isCollapsed()&&r)s=this.app.create("caret"),t=r.tagName.toLowerCase(),r=this._insertSplit(r,t),s.set(r,"before");else{if(this.app.editor.save(),e.style){var o=Array.isArray(e.style)?e.style:[e.style];for(let t=0;t<a.length;t++){var n=this.dom(a[t]),l=a[t].tagName.toLowerCase();n.removeAttr("data-rx-style-cache");for(let t=0;t<o.length;t++)n.css(o[t],"");""===n.attr("style")&&n.removeAttr("style"),i.cacheElementStyle(n),"span"===l&&0===a[t].attributes.length&&n.unwrap()}}else if(e.classname)for(let t=0;t<a.length;t++){var h=this.dom(a[t]),p=a[t].tagName.toLowerCase();h.removeClass(e.classname),""===h.attr("class")&&h.removeAttr("class"),"span"===p&&0===a[t].attributes.length&&h.unwrap()}this.app.editor.restore(),this.app.observer.observe()}},removeFormat(){this.app.dropdown.close(),this.app.modal.close();var e,t=this.app.block.get(),s=this.app.create("selection");if(t){var t=t.getBlock(),i=(this.app.editor.save(t),s.getNodes({type:"inline",link:!0}));for(let t=0;t<i.length;t++)e=this.dom(i[t]),"A"===i[t].tagName?e.removeAttr("style data-rx-style-cache"):e.attr("data-rx-type")||e.unwrap();this.app.editor.restore(),this.app.observer.observe()}},restoreOffset(){var t=this.app.create("offset");this.offset&&t.set(this.offset)},_formatCollapsed(){let t;var e=this.app.create("selection"),s=this.app.create("caret"),i=this.app.create("utils"),a=(this.app.create("offset"),this.app.create("element")),r=e.getInline(),e=e.getInlineTop(!1,this.params.tag),a=a.getInlines(r),o=this.dom(r),n=this._getTags(),l=this._isSameTag(r,n),h=this._isSameTag(e,n),p=!(!this.params||!this.params.caret)&&this.params.caret;return this.app.editor.save(),r?i.isEmptyHtml(r.innerHTML)?l?!this._isParams()||this._hasAllSameParams(r)?(s.set(r,p||"after"),o.remove()):t=this._hasSameClassname(r)?(this.instant||this.app.editor.restore(),this._setStyle(r)):this._hasSameStyle(r)?(this.instant||this.app.editor.restore(),this._setClassname(r)):(this.instant||this.app.editor.restore(),this._setParams(r)):this._hasCommonTags(a,n)?(i=this._findMatchingIndex(a,n),o=a.splice(i,1)[0],this.dom(o).unwrap(),a.reverse(),s.set(a[a.length-1],"start")):(t=this._insertInline(this.params.tag,p),t=this._setParams(t)):r&&(l?!this._isParams()||this._hasAllSameParams(r)?this._makeSplit(r,p):t=this._hasSameClassname(r)?(t=this._insertInline(this.params.tag,p),this._setStyle(t)):this._hasSameStyle(r)?(t=this._insertInline(this.params.tag,p),this._setClassname(t)):(t=this._insertInline(this.params.tag,p),this._setParams(t)):h?!this._isParams()||this._hasAllSameParams(e)?this._makeSplit(e,p,r):t=this._hasSameClassname(e)?(t=this._insertInline(this.params.tag,p),this._setStyle(t)):this._hasSameStyle(e)?(t=this._insertInline(this.params.tag,p),this._setClassname(t)):(t=this._insertInline(this.params.tag,p),this._setParams(t)):(t=this._insertInline(this.params.tag,p),t=this._setParams(t))):(t=this._insertInline(this.params.tag,p),t=this._setParams(t),this.app.editor.saveInline(t)),this.dom(t)},_formatUncollapsed(){var t=this.app.create("selection"),e=this.app.create("caret"),s=(this.app.create("element"),!1),i=this.app.editor.isSelectAll(),a=this.dom(t.getNodes({type:"block",partial:!0})),t=t.getNodes({type:"inline"});return this.app.editor.save(),this._convertTags(a,t),this.app.editor.restore(),this.app.editor.save(),this._convertToStrike(),this.app.editor.restore(),this.app.getDocNode().execCommand("strikethrough"),this.app.editor.save(),s=this._revertToInlines(a),this.app.editor.restore(),this._clearEmptyStyle(),this.app.editor.save(),s.each(this._applyParams.bind(this)),this.app.editor.restore(),a.each(function(t){t.get().normalize()}),this.app.editor.save(),this._revertTags(a),this.app.editor.restore(),this.params.caret&&(t=s.last(),e.set(t,this.params.caret)),i&&this.app.editor.setSelectAll(),s},_isParams(){return this.params.style||this.params.classname},_applyParams(t){var e=t.tagName(),s=this._getTags(),i=t.parent();0!==i.length&&this._isSameTag(i.get(),s)&&i.text()===t.text()?this._applyParamsToNode(i,e):this._applyParamsToNode(t,e)},_applyParamsToNode(t,e){t.removeAttr("data-rx-style-cache"),""===t.attr("class")&&t.removeAttr("class"),0===t.get().attributes.length?this._isParams()&&"span"===this.params.tag?(this._setParams(t),this._clearSpanInside(t)):"span"===e&&t.unwrap():this._isParams()&&(this._setParams(t),this._clearSpanInside(t))},_setParams(t){return t=this._setClassname(t),t=this._setStyle(t)},_setClassname(t){var e,t=this.dom(t);return this.params.classname&&(this.params.group?(e="inlineGroups."+this.params.group,(e=!!this.opts.is(e)&&this.opts.get(e))&&t.removeClass(e.join(" "))):t.removeAttr("class"),t.addClass(this.params.classname)),t.get()},_setStyle(t){var t=this.dom(t),e=this.app.create("cleaner");return this.params.style&&(t.css(this.params.style),e.cacheElementStyle(t)),t.get()},_hasAllSameParams(t){return this._hasSameClassname(t)&&this._hasSameStyle(t)},_hasSameClassname(t){t=this.dom(t);return!!t.attr("class")&&(!this.params.classname||t.hasClass(this.params.classname))},_hasSameStyle(t){var t=this.dom(t),e=this.app.create("element");return!this.params.style||e.compareStyle(t,this.params.style)},_hasCommonTags(t,e){return e.some(e=>t.some(t=>t.tagName.toLowerCase()===e))},_findMatchingIndex(t,s){return t.findIndex(e=>s.some(t=>e.tagName.toLowerCase()===t))},_makeSplit(t,e,i){var a=this.app.create("caret"),r=this.app.create("element"),o=a.is(t,"end");let n=t;if(i){n=o?t:this._insertSplit(t);var l=r.getInlines(i,this.params.tag);let e=l[0].cloneNode();e.innerHTML="";var h=e;let s=h;var p=l.length-1;l.reverse();for(let t=0;t<p;t++)(e=l[t].cloneNode()).innerHTML="",this.dom(h).append(e),s=e;r=o?"after":"before";this.dom(n)[r](h),a.set(s,"start")}else o?e="after":n=this._insertSplit(t),a.set(n,e||"before")},_insertSplit(t,e){var s=this.app.create("utils"),i=this.app.create("element"),a=this.dom(t),s=s.extractHtmlFromCaret(t),e=this.dom("<"+(e||this.params.tag)+" />"),r=document.createElement("div");return r.appendChild(s),(e=i.cloneAttrs(t,e)).append(r.innerHTML),a.after(e),e},_insertInline(t,e){return this.app.create("insertion").insertNode(document.createElement(t),e||"start")},_isSameTag(t,e){return t&&-1!==e.indexOf(t.tagName.toLowerCase())},_getTags(){let t=[this.params.tag];return"b"===this.params.tag||"strong"===this.params.tag?t=["b","strong"]:"i"!==this.params.tag&&"em"!==this.params.tag||(t=["i","em"]),t},_replaceTags(){var t=this.opts.get("replaceTags")[this.params.tag];return t||this.params.tag},_convertToStrike(){let t=this.app.create("selection"),e=this.app.create("utils"),s=t.getNodes({type:"inline",link:!0,buttons:!0}),i=t.getText().replace(/[-[\]/{}()*+?.\\^$|]/g,"$&"),a=this._getTags(),r,o,n,l,h=!1;for(let t=0;t<s.length;t++){var p;r=s[t],o=this.dom(r),n=s[t].tagName.toLowerCase(),l=this._hasAllSameParams(r),"a"===n&&"span"===this.params.tag&&this._isFullySelected(r,i)?(p=e.cssToObject(o.attr("style")),o.addClass("rx-inline-convertable"),o.removeAttr("data-rx-style-cache"),p&&p["text-decoration"]&&o.attr("data-rx-inline-line",p["text-decoration"])):-1!==a.indexOf(n)&&("span"===this.params.tag&&this._isFullySelected(r,i)?(o.addClass("rx-inline-convertable"),o.removeAttr("data-rx-style-cache")):l&&"a"!==this.params.tag?this._replaceToStrike(o):"span"===this.params.tag?(this.params.style&&this._hasSameStyle(o)&&(h=!0),(h=this.params.classname&&this._hasSameClassname(o)?!0:h)?(o.addClass("rx-inline-convertable"),o.removeAttr("data-rx-style-cache")):o.addClass("rx-inline-unconvertable")):l||this._replaceToStrike(o))}},_convertInlineBlocks(t){t.find("[data-rx-inline]").each(function(t){!0===t.attr("contenteditable")&&t.addClass("rx-inlineblock-editable").attr("contenteditable",!1)})},_convertTag(e,t){let s=this.app.create("element"),i;this.params.tag!==e?t.find(e).each(function(t){(i=s.replaceToTag(t,"span")).addClass("rx-convertable-"+e)}):"del"===this.params.tag&&t.find(e).each(function(t){s.replaceToTag(t,"strike")})},_convertTags(t){let s=this.app.create("utils");this._convertTag("del",t),this._convertTag("u",t),this._convertTag("a",t),this._convertInlineBlocks(t),t.find("span").each(function(t){var e=s.cssToObject(t.attr("style"));e&&e["text-decoration"]&&(t.css("text-decoration",""),t.attr("data-rx-convertable-style",e["text-decoration"]),t.addClass("rx-convertable-restore-style"))})},_replaceToStrike(e){e.replaceWith(function(t){return this.dom("<strike>").append(e.contents())}.bind(this))},_revertInlineBlocks(t){t.find(".rx-inlineblock-editable").removeClass("rx-inlineblock-editable").attr("contenteditable",!0)},_revertTag(e,t){let s=this.app.create("element");t.find("span.rx-convertable-"+e).each(function(t){s.replaceToTag(t,e).removeAttr("class")}.bind(this))},_revertTags(t){this._revertTag("a",t),this._revertTag("u",t),this._revertTag("del",t),this._revertInlineBlocks(t)},_revertToInlines(t){let s=this.dom([]),i=this.app.create("element");return"u"!==this.params.tag&&t.find("u").unwrap(),t.each(function(t){t.find("*").each(function(t){t.get().style.textDecorationLine&&(t.css("text-decoration-line",""),t.wrap("<u>"),""===t.attr("style"))&&t.removeAttr("style")})}),t.find(".rx-inline-convertable").each(function(e){e.find("strike").each(function(t){e.text()===t.text()&&t.unwrap()}),e.removeClass("rx-inline-convertable");var t=e.attr("data-rx-inline-line");t&&(e.css("text-decoration",t),e.removeAttr("data-rx-inline-line")),i.removeEmptyAttr(e,"class"),this._hasAllSameParams(e)?e.unwrap():s.add(e)}.bind(this)),t.find("span.rx-inline-unconvertable").each(function(t){t.removeClass("rx-inline-unconvertable"),i.removeEmptyAttr(t,"class")}.bind(this)),t.find("span.rx-convertable-restore-style").each(function(t){t.removeClass("rx-convertable-restore-style");var e=t.attr("data-rx-convertable-style");e&&"null"!==e&&t.css("text-decoration",e),t.removeAttr("data-rx-convertable-style")}),t.find("strike").each(function(t){t=i.replaceToTag(t,this.params.tag),s.add(t)}.bind(this)),s},_clearEmptyStyle(){let t=this.app.create("selection"),e=t.getNodes({type:"inline"}),s=0,i=e.length,a,r=0;for(s;s<i;s++)if(this._clearEmptyStyleAttr(e[s]),a=e[s].childNodes)for(r;r<a.length;r++)this._clearEmptyStyleAttr(a[r])},_clearEmptyStyleAttr(t){3!==t.nodeType&&""===t.getAttribute("style")&&t.removeAttribute("style")},_clearSpanInside(t){t.find("span").each(function(t){if(this.params.classname&&t.removeAttr("class"),this.params.styles)for(var e of Object.keys(this.params.styles))t.css(e,"");""===t.attr("class")&&t.removeAttr("class"),""===t.attr("style")&&t.removeAttr("style"),0===t.get().attributes.length&&t.unwrap()}.bind(this))},_isFullySelected(t,e){var s=this.app.create("utils"),t=s.removeInvisibleChars(t.textContent);return e===t||-1!==e.search(new RegExp("^"+s.escapeRegExp(t)+"$"))}}),d.add("module","link",{dropdowns:{format:{link:{title:"## link.link ##",command:"link.popupCreate",icon:!1,shortcut:"Ctrl+k"},unlink:{title:"## link.unlink ##",command:"link.unlink",icon:!1}},change:{link:{title:"## link.edit-link ##",command:"link.popupEdit",icon:!1,shortcut:"Ctrl+k"},unlink:{title:"## link.unlink ##",command:"link.unlink",icon:!1}}},modals:{create:{title:"## modal.link ##",width:"600px",form:{text:{type:"input",label:"## link.text ##"},url:{type:"input",label:"## link.url ##"},target:{type:"checkbox",text:"## link.link-in-new-tab ##"}},footer:{insert:{title:"## buttons.insert ##",command:"link.insert",type:"primary"},cancel:{title:"## buttons.cancel ##",command:"modal.close"}}},edit:{title:"## modal.link ##",width:"600px",form:{text:{type:"input",label:"## link.text ##"},url:{type:"input",label:"## link.url ##"},target:{type:"checkbox",text:"## link.link-in-new-tab ##"}},footer:{save:{title:"## buttons.save ##",command:"link.save",type:"primary"},cancel:{title:"## buttons.cancel ##",command:"modal.close"}}}},popup(t,e){var s=this.get().length,i=this.app.create("selection");i.getText();!t&&0===s||!i.is()||0===s?this.popupCreate(t,e=!!t&&e):1===s&&(this.app.dropdown.create("link",{items:this.dropdowns.change}),this.app.dropdown.open(t,e))},popupCreate(t,e){var s=this.app.create("selection").getText(),i=this.opts.get("link.create");i?i(this.app,s):((i=this.app.create("stack")).create("image",this.modals.create),i.setData({text:s||"",target:this.opts.get("link.target")}),this.app.modal.open({name:"link",focus:"text",stack:i,button:e}))},popupEdit(t,e){var s=this.get(),i=this._getLinkData(s),a=this.opts.get("link.edit");a?a(this.app,s,i):((a=this.app.create("stack")).create("image",this.modals.edit),a.setData(i),this.app.modal.open({name:"link",focus:"url",stack:a,button:e}))},set(t){let e=this.app.block.get();var s,i=this.app.create("selection");let a;e&&e.isEditable()&&e.isEmpty()&&""===i.getText()?(a=this.dom("<a>"),e.getBlock().append(a)):e?(s=this.app.inline.set({tag:"a"}),a=this.dom(s.first())):(a=this.dom("<a>"),(e=this.app.block.create()).getBlock().append(a),this.app.blocks.get({first:!0}).before(e.getBlock()),this.app.block.set(e)),t.text||(t.text=i.getText()),this.app.editor.save(),(t=this._setData(t,a))?(i.select(a),this.app.broadcast("link.add",{element:a,data:t})):this.app.editor.restore(),this.app.observer.observe()},save(t){this.app.modal.close();var e=this.get(),t=(this.app.editor.save(),t.getData()),t=this._setData(t,e);this.app.editor.restore(),this.app.observer.observe(),this.app.broadcast("link.change",{element:e,data:t})},insert(t){this.app.modal.close(),this.set(t.getData())},open(t,e){e=e.getParams();e.href&&this.app.getWinNode().open(e.href,"_blank")},observe(t,e,s){var i=this.app.create("selection");if("context"===s&&"link"===e&&i.is()){s=this.getLinks();if(1===s.length){e=s.eq(0).attr("href");if(!e)return;this.app.context.addLine('<a href="'+e+'">'+this._truncateLinkText(e)+"</a>"),this.app.context.add("unlink")}else 1<s.length&&this.app.context.add("unlink")}return t},unlink(){this.app.modal.close(),this.app.dropdown.close(),this.app.context.close();let t=this.app.create("selection"),e=t.getNodes({tags:["a"]}),s;0!==e.length&&(this.app.editor.save(),e.forEach(function(t){t={url:(s=this.dom(t)).attr("href"),text:s.text()};this.app.broadcast("link.remove",{data:t}),s.unwrap()}.bind(this)),this.app.editor.restore(),this.app.observer.observe())},getLinks(){return this._getLinks()},get(){var t=this._getLinks();return 0!==t.length?t.eq(0):this.dom()},_setData(t,e){if(t=this._cleanUrl(t),""!==(t=this._encodeUrl(t)).url)return t=this._setUrl(e,t),1===e.length&&(t=this._setText(e,t)),(t=this._setTarget(e,t)).element=e,t;e.unwrap(),this.app.editor.restore()},_setUrl(t,e){return t.attr("href",e.url),e},_setText(t,e){return e.text=""===e.text?e.url:e.text,t.text(e.text),e},_setTarget(t,e){return e.target?t.attr("target","_blank"):t.removeAttr("target"),e},_getLinkData(t){let e={};return 0!==t.length&&(e={text:t.text(),url:t.attr("href"),target:t.attr("target")||this.opts.get("link.target")},e=this._encodeUrl(e)),e},_getLinks(){var t=this.app.create("selection");return t.is()&&0!==(t=t.getNodes({tags:["a"]})).length?this.dom(t):this.dom()},_truncateLinkText(t){var e=this.opts.get("link.truncate");return(t=t.replace(/^https?\:\/\//i,"")).length>e?t.substring(0,e)+"...":t},_cleanUrl(t){var e=this.app.create("cleaner");return t.url=e.escapeHtml(t.url),t.url=-1!==t.url.search(/^javascript:/i)?"":t.url,t},_encodeUrl(t){return t.url=t.url?t.url.replace(/&amp;/g,"&"):"",t}}),d.add("module","list",{dropdowns:{list:["bulletlist","numberedlist"],haslist:["bulletlist","numberedlist","indent","outdent"]},popup(t,e){var s=this._isList()?this.dropdowns.haslist:this.dropdowns.list;this.app.dropdown.create("list",{items:s}),this.app.dropdown.open(t,e)},indent(){var t=this.app.create("selection"),e=t.getBlock(),s=this.dom(e);let i=s.prevElement();var a=i.get(),t=(t.isFullySelected(s)||t.isCollapsed())&&e&&a&&"LI"===a.tagName;return t&&(this.app.editor.save(e),e=(i=this.dom(a)).children("ul, ol"),a=s.closest("ul, ol"),0!==e.length?e.append(s):(e=a.tagName(),(a=this.dom("<"+e+">")).append(s),i.append(a)),this.app.editor.restore(),this.app.control.updatePosition()),t},outdent(){var t=this.app.create("selection"),e=t.getBlock(),s=this.dom(e);let i=!1;if((t.isFullySelected(s)||t.isCollapsed())&&e){var t=s.parent(),a=t.closest("li"),r=s.prevElement(),o=s.nextElement(),r=r.get(),o=o.get(),n=!1===r,r=!1!==r&&!1!==o;if(n){var l,h,o=this.app.block.get();if(!o.hasParentList())return this.app.dropdown.close(),this.app.context.close(),this.app.editor.save(!1),l=o.getParent().getBlock(),h=this.app.block.create(o.getContent()),l.before(h.getBlock()),o.getBlock().remove(),0===l.children().length&&l.remove(),this.app.editor.build(),this.app.block.set(h),this.app.editor.restore(),i}if(this.app.editor.save(e),0!==a.length){if(r){for(var p=this._getAllNext(s.get()),d=this.dom("<"+t.tagName()+">"),c=0;c<p.length;c++)d.append(p[c]);a.after(s),s.append(d)}else a.after(s),0===t.children().length?t.remove():n&&s.append(t);i=!0}this.app.editor.restore(),this.app.control.updatePosition()}return i},_isList(){var t=this.app.block.get();return t&&t.isType("listitem")},_getAllNext(t){for(var e=[];t;){if(!(t=this.dom(t).nextElement().get()))return e;e.push(t)}return e}}),d.add("module","observer",{init(){this.styles=!1,this.observer=!1,this.trigger=!0},build(){var t;this.opts.is("sync")&&window.MutationObserver&&(t=this.app.editor.getLayout().get(),this.observer=this._build(t),this.observer.observe(t,{attributes:!0,subtree:!0,childList:!0,characterData:!0,characterDataOldValue:!0}))},stop(){this.observer&&this.observer.disconnect(),this.trigger=!0},addKeys(t,e,s){this.opts.set("active."+t+"."+e,s)},getKeys(){return this.styles={},this._getKeys()},getStyles(){return this.styles},observeUnset(){this._observeUnset()},observe(){var t;(this.opts.is("toolbar")||this.opts.is("extrabar")||this.app.context.isOpen())&&(this.styles={},t=this._getKeys(),this._observeUnset(),0!==t.length)&&this.app.ui.setActiveKeys(["toolbar","extrabar","context"],t,this.styles)},_build(e){return new MutationObserver(function(t){this._observe(t[t.length-1],e)}.bind(this))},_getKeys(){let e=this.app.block.get(),s=this.opts.get("active.tags"),t=this.opts.get("active.blocks"),i=!!e&&e.getType(),a=!!e&&e.getTag(),r=this.app.create("selection"),o=r.is()?r.getNodes({type:"inline",selected:"inside",link:!0,buttons:!0}):[],n=this._getObservedTags(a,o),l=[],h=[],p;if(e){var d,c=["table","layout","wrapper"];for(let t=0;t<c.length;t++)e.getClosest(c[t])&&l.push(c[t]);e.isType("todoitem")&&l.push("todo"),e.isType("listitem")&&(d=e.getParentTopInstance())&&(d=d.getTag(),n.push(d))}for(let t=0;t<n.length;t++)!(p=s[n[t]])||"ul"===n[t]&&(i&&"todo"===i||-1!==l.indexOf("todo"))||(h=h.concat(p));if(i){(p=t[i])&&(h=h.concat(p));for(let t=0;t<l.length;t++)h.push(l[t])}return h},_getObservedTags(t,e){var s,i,a=[],r=this.app.create("utils");if(t&&a.push(t),0<e.length)for(var o=0;o<e.length;o++)s=e[o],(i=r.cssToObject(s.getAttribute("style")))&&i.color&&(this.styles.color=i.color),i&&i.background&&(this.styles.background=i.background),a.push(s.tagName.toLowerCase());return a},_observeUnset(){this.app.toolbar.unsetActive(),this.app.extrabar.unsetActive(),this.app.context.unsetActive()},_observe(t,e){"attributes"===t.type&&t.target===e||this.trigger&&(this.app.broadcast("observer.change"),this.app.editor.adjustHeight(),this.app.placeholder.trigger(),this.app.block.trigger(t),this.app.blocks.trigger(t),this.app.sync.trigger())}}),d.add("module","path",{init(){this.classname="rx-pathbar",this.activeClass="active",this.pathItemClass="rx-pathbar-item"},start(){this.opts.is("pathbar")&&(this.$pathbar=this.dom("<div>").attr("dir",this.opts.get("dir")),this.$pathbar.addClass(this.classname+" "+this.classname+"-"+this.uuid),this.app.container.get("pathbar").append(this.$pathbar),this._buildRoot(),this._buildActive())},build(){this.opts.is("pathbar")&&(this._clear(),this._buildRoot(),this.app.blocks.is()||(this._buildItems(),this._buildActive()))},enable(){this.opts.is("pathbar")&&this.$pathbar.removeClass("disable")},disable(){this.opts.is("pathbar")&&this.$pathbar.addClass("disable")},_clear(){this.$pathbar.find("."+this.pathItemClass).off(".rx-path-"+this.uuid),this.$pathbar.html("")},_createItem(){return this.dom("<span>").addClass(this.pathItemClass)},_buildRoot(){var t=this.opts.get("pathbar.title")||this.lang.get("pathbar.title");this._buildItem(!1,t)},_buildItems(){var t,e=this.app.block.get();e&&((t=e.getBlock().parents("[data-rx-type]")).nodes.reverse(),t.each(this._buildParentItem.bind(this)),this._buildItem(e))},_buildParentItem(t){t=t.dataget("instance");t.isType(["row"])||this._buildItem(t)},_buildItem(t,e){var s=this._createItem();s.dataset("instance",t),s.on("click.rx-path-"+this.uuid,this._selectItem.bind(this)),this._buildTitle(s,e||t.getTitle()),this.$pathbar.append(s)},_buildTitle(t,e){e=this.dom("<span>").html(e);t.append(e)},_buildActive(){this.$pathbar.find("."+this.pathItemClass).removeClass(this.activeClass).last().addClass(this.activeClass)},_selectItem(t){var e;t.stopPropagation(),t.preventDefault(),this.$pathbar.hasClass("disable")||(t=this.dom(t.target).closest("."+this.pathItemClass).dataget("instance"),this.app.dropdown.close(),this.app.context.close(),this.app.modal.close(),t?(e=!!t.isType("column")&&"column",this.app.block.set(t,e)):(this._clear(),this._buildRoot(),this._buildActive(),this.app.block.unset(),this.app.blocks.unset()))}}),d.add("module","placeholder",{init(){this.placeholderClass="rx-placeholder"},build(){var t=this.opts.get("placeholder"),e=this.app.element.getPlaceholder();(t||e)&&this.app.editor.getLayout().attr("placeholder",e||t)},handleClick(t){this.dom(t.target).hasClass(this.placeholderClass)&&(t.preventDefault(),t.stopPropagation(),this.app.editor.setFocus("start"))},trigger(){this.$editor=this.app.editor.getLayout(),this.app.editor.isEmpty()?this.show():this.hide()},set(t){this.$editor.attr("placeholder",t)},toggle(){this.observerTimer&&clearTimeout(this.observerTimer),this.observerTimer=setTimeout(this.trigger.bind(this),10)},show(){this.$editor.addClass(this.placeholderClass)},hide(){this.$editor.removeClass(this.placeholderClass)}}),d.add("module","state",{init(){this.storage=!1,this.undoStorage=[],this.redoStorage=[]},load(){this.clear(),this.app.isMode("iframe")?this.app.editor.getEditor().on("load",this._load.bind(this)):this._load()},stop(){this.clear()},get(){return this.undoStorage},clear(){this.storage=!1,this.undoStorage=[],this.redoStorage=[]},trigger(){var t=this._createState();this._addState(t)},add(t){t&&(t.ctrlKey||t.metaKey||this._isUndo(t)||this._isRedo(t))||!this.app.observer.trigger||(t=this._createState(),this._setState(t))},listen(t){return this._isUndo(t)?(t.preventDefault(),this.undo(),!0):this._isRedo(t)?(t.preventDefault(),this.redo(),!0):void 0},undo(){var t,e;this._hasUndo()&&(t=this.app.create("parser"),e=this._getUndo())&&(this._setRedo(),this.app.ui.close(),this.app.has("email")&&(this.app.email.reset(),this.app.email.setOptions(e.options)),t=t.parse(e.html,{type:"html",nodes:!0}),this._rebuild(t,e,"undo"))},redo(){var t,e;this._hasRedo()&&(t=this.app.create("parser"),e=this.redoStorage.pop())&&(this._addState(e),this.app.ui.close(),this.app.has("email")&&(this.app.email.reset(),this.app.email.setOptions(e.options)),t=t.parse(e.html,{type:"html",nodes:!0}),this._rebuild(t,e,"redo"),this.undoStorage.splice(this.undoStorage.length-1,1))},_load(){var t=this._createState();this.undoStorage.push(t),this.storage=t},_rebuild(t,e,s){let i=this.app.create("offset");var a=this.app.editor.getLayout();a.html(t),this.app.editor.build(),this.app.has("email")&&this.app.email._build(!0);let r=a.find(".rx-block-state");0!==r.length?setTimeout(()=>{this.app.block.set(r),i.set(e.offset,r),r.removeClass("rx-block-state")},1):!1===e.offset?this.app.editor.setFocus("start"):(i.set(e.offset),this.app.event._setMultipleBlocks()),setTimeout(()=>{this.app.observer.observe(),this.app.broadcast("state."+s,e)},2)},_isUndo(t){var e=t.which;return(t.ctrlKey||t.metaKey)&&90===e&&!t.shiftKey&&!t.altKey},_isRedo(t){var e=t.which;return(t.ctrlKey||t.metaKey)&&(90===e&&t.shiftKey||89===e&&!t.shiftKey)&&!t.altKey},_hasUndo(){return 0!==this.undoStorage.length},_hasRedo(){return 0!==this.redoStorage.length},_getUndo(){var t=this.undoStorage.length-2;return-1!=t&&this.undoStorage.splice(1+t,1),this.undoStorage[t]},_createState(){let t="";var e="json"===this.app.editor.getContentType();let s;if(this.app.has("email"))t=this.app.email.getContent(),s=this.app.email.getOptions();else{if(e){var i,a=this.app.blocks.get({instances:!0});for(let t=0;t<a.length;t++)a[t]&&(i=a[t].getAttrs())&&(i=JSON.stringify(i),a[t].getBlock().attr("data-rx-attrs",i))}t=this.app.editor.getLayout().html()}var e=this.app.create("utils"),r=this.app.create("unparser"),o=this.app.create("offset"),n=this.app.block.get(),n=!(!n||!n.isEditable())&&n.getBlock();let l=o.get(n);return this.app.blocks.is()?l=o.get():t=e.wrap(t,function(t){t.find(".rx-block-focus").addClass("rx-block-state")}.bind(this)),{html:r.unparse(t,{state:!0}),offset:l,emailOptions:s}},_setState(t){var e=this.undoStorage.length-1;0<=e&&(this.undoStorage[e]=t)},_addState(t){var e=this.undoStorage[this.undoStorage.length-1];void 0!==e&&e.html===t.html||(this.undoStorage.push({html:t.html,offset:t.offset,synced:!0}),this._removeOverStorage())},_setRedo(){var t=this._createState(),e=this.opts.get("state.limit");this.redoStorage.push(t),this.redoStorage=this.redoStorage.slice(0,e)},_removeOverStorage(){var t=this.opts.get("state.limit");this.undoStorage.length>t&&(this.undoStorage=this.undoStorage.slice(0,this.undoStorage.length-t))}}),d.add("module","statusbar",{init(){this.classname="rx-statusbar"},start(){this.$statusbar=this.dom("<div>").attr("dir",this.opts.get("dir")),this.$statusbar.addClass(this.classname+" "+this.classname+"-"+this.uuid),this.app.container.get("statusbar").append(this.$statusbar)},is(){return""!==this.$statusbar.html()},enable(){this.$statusbar.removeClass("disable")},disable(){this.$statusbar.addClass("disable")},add(t,e){return this.update(t,e)},update(t,e){let s=this.get(t);return(s=0===s.length?this._buildItem(t):s).html(e)},getHeight(){return this.is()?this.$statusbar.height():0},getElement(){return this.$statusbar},get(t){return this.$statusbar.find(t?"[data-name="+t+"]":"[data-name]")},remove(t){this.get(t).remove()},clear(){this.$statusbar.html("")},_buildItem(t){var e=this.dom("<span>").addClass(this.classname+"-item");return e.attr("data-name",t),this.$statusbar.append(e),e}}),d.add("module","sync",{build(){this.syncedHtml=this.app.element.getHtml()},destroy(){this.typingTimer&&clearTimeout(this.typingTimer)},trigger(){this.typingTimer&&clearTimeout(this.typingTimer),this.typingTimer=setTimeout(this.update.bind(this),300)},update(){var t=this._getHtml();this.is(t)&&this._sync(t)},invoke(){var t=this._getHtml();this.syncedHtml=t,this._sync(t)},is(t){let e=!1;return this.syncedHtml!==t&&(this.syncedHtml=t,e=!0),e},_getHtml(){var t=this.app.create("unparser"),e=this.app.editor.getHtml();return t.unparse(e)},_sync(t){var e,t=this.app.broadcast("editor.before.change",{html:t});t.isStopped()||(e=t.get("html"),this.app.editor.setOutput(e),this.app.editor.setSource(e),this.app.autosave.send(),this.app.state.trigger(),this.app.broadcast("editor.change",t))}}),d.add("module","table",{dropdowns:{items:{addhead:{title:"## table.add-head ##",command:"table.addHead"},addcolumnbefore:{title:"## table.add-column-before ##",command:"table.addColumnBefore"},addcolumnafter:{title:"## table.add-column-after ##",command:"table.addColumnAfter"},addrowbelow:{title:"## table.add-row-below ##",command:"table.addRowBelow"},addrowabove:{title:"## table.add-row-above ##",command:"table.addRowAbove"},removehead:{title:"## table.remove-head ##",command:"table.removeHead",divider:"top"},removecolumn:{title:"## table.remove-column ##",command:"table.removeColumn"},removerow:{title:"## table.remove-row ##",command:"table.removeRow"},removetable:{title:"## table.delete-table ##",command:"table.removeTable",divider:"top",danger:!0}}},modals:{cell:{title:"## table.table-cell ##",width:"300px",form:{width:{type:"input",label:"## table.width ##"},nowrap:{type:"checkbox",text:"## table.nowrap ##"}},footer:{insert:{title:"## buttons.save ##",command:"table.save",type:"primary"},cancel:{title:"## buttons.cancel ##",command:"modal.close"}}}},observe(t,e,s){return!!this.opts.is("table")&&("dropdown"!==s&&(s=this.app.block.get())&&s.getClosest("table")&&(t.command="table.popup"),t)},popup(t,e){var s=this.app.block.get(),i=this.dropdowns.items;(s.isNondeletable()||s.isNondeletableParent())&&delete i.removetable,this.app.dropdown.create("table",{items:i}),this.app.dropdown.open(t,e)},addHead(){var t=this.app.block.get(),t=(t.isType("cell")?t:t.getClosest("cell")).getTable().getBlock(),e=(this.removeHead(),t.find("tr").first().children("td, th").length),s=this.dom("<thead>"),e=this._buildRow(!1,e,"<th>");s.append(e),t.prepend(s),this.app.block.set(e.children("td, th").first(),"start")},addRowBelow(){this._addRow("below")},addRowAbove(){this._addRow("above")},addColumnBefore(){this._addColumn("before")},addColumnAfter(){this._addColumn("after")},removeHead(){this.app.modal.close(),this.app.dropdown.close();var t=this.app.block.get(),t=(t.isType("cell")?t:t.getClosest("cell")).getTable().getBlock(),e=t.find("thead");0!==e.length&&(e.remove(),this.app.block.set(t,"start"))},removeRow(){this.app.modal.close(),this.app.dropdown.close(),this.app.control.close();var t=this.app.block.get(),t=t.isType("cell")?t:t.getClosest("cell"),e=t.getTable(),t=t.getRow(),s=t.getBlock().closest("thead"),s=((0!==s.length?s:t).remove(),e.getRows());0!==s.length?this.app.block.set(e.getFirstBlock(),"start"):e.remove({traverse:!0})},removeColumn(){this.app.modal.close(),this.app.dropdown.close(),this.app.control.close();var e=this.app.block.get(),e=e.isType("cell")?e:e.getClosest("cell"),s=e.getTable();let i=e.getBlock();var e=i.closest("table"),a=i.closest("tr");let r=0;if(a.find("td, th").each(function(t,e){t.get()===i.get()&&(r=e)}),e.find("tr").each(function(t){t=t.find("td, th").get(r);this.dom(t).remove()}.bind(this)),0!==s.getCells().length){a=(a=r-1)<0?0:a;let t;t=0!=a?(t=this.dom(e.find("tr").first().find("td, th").get(a))).dataget("instance").getFirstElement():s.getFirstBlock(),this.app.block.set(t,"start")}else s.remove({traverse:!0})},removeTable(){this.app.modal.close(),this.app.dropdown.close(),this.app.block.get().getClosest("table").remove({traverse:!0}),this.app.editor.isEmpty()&&this.app.editor.setEmpty()},cellSetting(t,e){var s=this.app.block.get(),i=this.app.create("stack");i.create("cell-setting",this.modals.cell),i.setData({width:s.getWidth(),nowrap:s.getNowrap()}),this.app.modal.open({name:"cell-setting",stack:i,focus:"width",button:e})},save(t){this.app.modal.close();var t=t.getData(),e=this.app.block.get();""!==t.width&&e.setWidth(t.width),e.setNowrap(t.nowrap),this.app.control.updatePosition()},_addColumn(a){this.app.modal.close(),this.app.dropdown.close();var t=this.app.block.get(),t=(t.isType("cell")?t:t.getClosest("cell")).getBlock(),e=t.closest("table"),s=t.closest("tr");let r=t.get().cellIndex,o=s.get().rowIndex,n;e.find("tr").each(function(t,e){var t=t.find("td, th").get(r),t=this.dom(t),s=t.clone(),i=(s.removeClass("rx-block-focus").html(""),this.app.create("block.cell",s),this.app.block.create());s.append(i.getBlock()),o===e&&(n=s),t[a](s)}.bind(this)),n&&(t=n.dataget("instance"),this.app.block.set(t.getFirstElement(),"start"))},_addRow(t){this.app.modal.close(),this.app.dropdown.close();var t="below"===t?"after":"before",e=this.app.block.get().getClosest("row").getBlock(),s=e.closest("tr"),e=e.closest("thead"),i=s.children("td, th").length,i=this._buildRow(s,i,"<td>"),e=(0!==e.length?e.after(i):s[t](i),i.dataget("instance"));this.app.block.set(e.getFirstElement(),"start")},_buildRow(e,s,i){let a,r;if(!1===e){e=this.dom("<tr>");for(let t=0;t<s;t++){var o=this.dom(i);this.app.create("block.cell",o),e.append(o)}}else(e=e.clone()).find("td, th").removeClass("rx-block-focus").html("");return this.app.create("block.row",e),e.find("td, th").each(function(t){a=this.app.create("block.cell",t),r=this.app.block.create(),a.getBlock().append(r.getBlock())}.bind(this)),e}}),d.add("module","toolbar",{start(){this.isEnabled()&&(this.$toolbox=this.app.container.get("toolbox"),this._buildToolbar(),this._buildRaised(),this._buildSticky())},stop(){this.isEnabled()&&this.$toolbar.remove()},load(){this.build()},build(){this.isEnabled()&&this.app.ui.buildButtons("toolbar")},add(t,e){this.app.ui.addButton("toolbar",t,e)},remove(t){this.app.ui.removeButton("toolbar",t)},setActive(t){this.app.ui.setActive("toolbar",t)},setToggled(t){this.app.ui.setToggled("toolbar",t)},unsetActive(t){this.app.ui.unsetActive("toolbar",t)},unsetToggled(t,e){this.app.ui.unsetToggled("toolbar",t,e)},getButton(t){return this.app.ui.getButton("toolbar",t)},getElement(){return this.$toolbar},enable(...t){this.enableSticky(),this.app.ui.enableToolbar("toolbar",t)},disable(...t){this.disableSticky(),this.app.ui.disableToolbar("toolbar",t)},enableSticky(){this.sticky.enableSticky()},disableSticky(){this.sticky.disableSticky()},isSticky(){return this.sticky.isSticky()},isEnabled(){return this.opts.is("toolbar")},isRaised(){return this.opts.is("toolbar.raised")},isExternal(){return this.opts.is("toolbar.target")},rebuildSticky(){this.sticky.observeSticky()},_buildToolbar(){var t=this.app.container.get("toolbar");this.$toolbar=this.app.ui.build("toolbar",t).getElement()},_buildSticky(){this.sticky=new t(this,this.app),this.sticky.enableSticky()},_buildRaised(){this.opts.is("toolbar.raised")&&this.$toolbox.addClass("rx-raised")}});class t{constructor(t,e){this.toolbar=t,this.app=e,this.opts=e.opts,this.eventname="rx-toolbar",this.$toolbox=this.app.container.get("toolbox")}isSticky(){var t=this.app.container.get("main"),e=this.toolbar.isRaised()?parseInt(this.$toolbox.css("margin-top")):0,t=t.offset().top+parseInt(t.css("border-top-width"))+e,e=this.$toolbox.offset().top;return t<e||e<t}enableSticky(){this.opts.is("toolbar.sticky")&&!this.opts.is("toolbar.target")&&(this.opts.is("scrollOverflow")?this._startStickyOverflowEvent():(this._applyStickyStyles(),this._startStickyEvent()),this.opts.is("scrollOverflow"))&&this._observeOverflowSticky()}disableSticky(){this.opts.is("toolbar.sticky")&&(this._removeStickyStyles(),this._stopStickyEvent())}observeSticky(){if(!this._isSource()){var e=this.app.scroll.getTarget();let t=0-(this.app.scroll.isTarget()?parseInt(e.css("padding-top")):0)+parseInt(this.opts.get("toolbar.stickyTopOffset"));this.app.isProp("fullscreen")&&(t=0),this.$toolbox.css({top:t+"px"}),this.broadcastSticky()}}broadcastSticky(){this.isSticky()?(this.$toolbox.addClass("rx-sticky-on"),this.app.broadcast("toolbar.sticky")):(this.$toolbox.removeClass("rx-sticky-on"),this.app.broadcast("toolbar.static"))}_isSource(){return!!this.app.source.is()&&(this.$toolbox.css("top",0),!0)}_applyStickyStyles(){this.$toolbox.addClass("rx-sticky"),this.$toolbox.css("top",this.opts.get("toolbar.stickyTopOffset")+"px")}_removeStickyStyles(){this.$toolbox.removeClass("rx-sticky rx-fixed-on"),this.$toolbox.css({position:"","z-index":"","max-width":"",top:""})}_getStickyTarget(){return this.app.scroll.getTarget()}_startStickyOverflowEvent(){var t=this._getStickyTarget();const e=this.app.container.get("main");setTimeout(()=>e.attr("data-initial-width",e.width()),0),t.on("scroll."+this.eventname,this._observeOverflowSticky.bind(this)),t.on("resize."+this.eventname,this._resizeOverflowSticky.bind(this))}_startStickyEvent(){this._getStickyTarget().on("scroll."+this.eventname,this.observeSticky.bind(this))}_stopStickyEvent(){this._getStickyTarget().off("."+this.eventname)}_resizeOverflowSticky(){var t=this.app.container.get("main");t.css("width",""),t.attr("data-initial-width",t.width()),this.$toolbox.hasClass("rx-fixed-on")&&this.$toolbox.css("max-width",t.width()+"px")}_observeOverflowSticky(){var t,e,s,i,a,r;this._isSource()||(a=this.app.editor.getRect(),t=this.app.container.get("main"),e=this.app.scroll.getTarget(),r=t.offset().top,s=t.data("initial-width"),i=this.$toolbox.height(),a=a.bottom-80,r<=(r=e.get().pageYOffset)&&r<=a?(this._applyFixedStyles(t,s,i),this.app.broadcast("toolbar.sticky")):(this._removeFixedStyles(t),this.app.broadcast("toolbar.static")))}_applyFixedStyles(t,e,s){this.$toolbox.css({position:"fixed","z-index":1060,"max-width":t.width()+"px",top:"0px"}),t.css({width:e+"px","padding-top":s+"px"}),this.$toolbox.addClass("rx-fixed-on")}_removeFixedStyles(t){this.$toolbox.css({position:"","z-index":"","max-width":"",top:""}),t.css({width:"","padding-top":""}),this.$toolbox.removeClass("rx-fixed-on")}}d.add("module","scroll",{init(){this.scrolltop=!1},save(){this.scrolltop=this.getTarget().scrollTop()},restore(){!1!==this.scrolltop&&(this.getTarget().scrollTop(this.scrolltop),this.scrolltop=!1)},getScrollTop(){return this.getTarget().scrollTop()},isTarget(){return this.opts.is("scrollTarget")},resetTarget(){this.reserved&&(this.opts.set("scrollTarget",this.reserved),this.reserved=!1)},setTarget(t){this.reserved=this.opts.get("scrollTarget"),this.opts.set("scrollTarget",t)},getTarget(){return this.dom(this.opts.get("scrollTarget")||window)}}),d.add("module","reorder",{build(t,e,s,i){e&&(this.control=t,this.$control=s,this.instance=i,this.$button=e.getElement(),this.$button.on("click.rx-reorder-button",this._pressStop.bind(this)),this.$button.on("mousedown.rx-reorder-button touchstart.rx-reorder-button",this._press.bind(this)))},_pressStop(t){t.stopPropagation(),t.preventDefault(),clearTimeout(this.dragTimeout),this.$button.removeClass("rx-in-dragging")},_press(t){t.stopPropagation(),t.preventDefault(),this.touchStartTime=(new Date).getTime(),this.isDragging=!1,this.dragTimeout=setTimeout(()=>{this.isDragging=!0,this._startDragging()},200),this.$button.on("touchend.rx-reorder-button mouseup.rx-reorder-button",this._checkTap.bind(this))},_checkTap(t){var e=(new Date).getTime()-this.touchStartTime,s=this.app.create("utils");e<200&&!this.isDragging&&(clearTimeout(this.dragTimeout),this._pressStop(t),s.isMobileDevice())&&this.control.trigger(),this.$button.off("touchend.rx-reorder-button mouseup.rx-reorder-button",this._checkTap.bind(this))},_startDragging(){this.$button.addClass("rx-in-dragging"),this._bindWindowEvents()},_bindWindowEvents(){this.app.getWin().on("mouseup.rx-reorder-button touchend.rx-reorder-button",this._release.bind(this)),this.app.getWin().on("mousemove.rx-reorder-button touchmove.rx-reorder-button",this._move.bind(this))},_release(t){this.$button.hasClass("rx-handle")&&(this._resetDragState(),this._setCaretAfterRelease())},_resetDragState(){this.$button.removeClass("rx-handle rx-in-dragging"),this.app.getWin().off(".rx-reorder-button"),this.app.observer.trigger=!0,this.oldY=0,this.dragging=!1,this._trashDragItem(),this.app.control.updatePosition(),this.$control.show(),this.app.ui.closeTooltip()},_setCaretAfterRelease(){setTimeout(()=>{this.app.block.set(this.instance,"start",!0),this.app.event.trigger=!0},1)},_move(t){var e,s;t.preventDefault(),this.$button.hasClass("rx-in-dragging")&&(this.$button.hasClass("rx-handle")||this._initializeDrag(t),this.app.dropdown.close(),s=this._calculateDeltaY(t.pageY),e=this._getDirection(s),this._moveItem(this.$dragItem,s),this.oldY=t.pageY,this._handleAutoScroll(t.pageY,e),s=this._getContainer(),this._placeItem(s))},_initializeDrag(t){var e=this.instance.getBlock().get();this.$button.addClass("rx-handle"),this.dragging=!0,this.$dragItem=this._makeDragItem(e,t.target),this.$control.hide(),this.app.event.trigger=!1},_getDirection(t){return 0<t?"up":t<0&&"down"},_calculateDeltaY(t){return 0===this.oldY?0:this.oldY-t},_handleAutoScroll(t,e){var{topStop:s,bottomStop:i,topEdge:a,bottomEdge:r}=this._getScrollBoundaries();this._isScrollUp(t,s,a,e)?this._scroll(-10):this._isScrollDown(t,i,r,e)&&this._scroll(10)},_getContainer(){var t=this.instance.getClosest(["list","todo","cell","column","wrapper"]);return t?t.getBlock():this.app.editor.getLayout()},_getScrollBoundaries(){var t,e,s=this.app.editor.getRect(),i=this.app.getDoc().scrollTop();let a=i>s.top?i+40:s.top+40,r=this.app.getWin().height()+i-40,o=s.top,n=s.top+this.app.editor.getEditor().height();return this.app.scroll.isTarget()&&(e=(t=this.app.scroll.getTarget()).offset(),o=e.top,a=i>s.top?e.top+40:a,n=e.top+t.height(),r=n-40),{topStop:a,bottomStop:r,topEdge:o,bottomEdge:n}},_isScrollUp(t,e,s,i){return"up"===i&&t<e&&s<t},_isScrollDown(t,e,s,i){return"down"===i&&e<t&&t<s},_placeItem(t){var e=t.children(),s=e.length;for(let t=0;t<s;t++){var i=e.eq(t).get(),a=this.dom(i);i!==this.$clickItem.get()&&this._isOver(a)&&this._swapItems(i)}},_isOver(t){var e=this.$dragItem.offset().top,s=t.offset(),t=t.height();return e>s.top&&e<s.top+t},_scroll(t){var e=this.app.scroll.isTarget()?this.app.scroll.getTarget():this.app.getWin(),s=e.scrollTop();e.scrollTop(s+t)},_swapItems(t){var e=this.$dragItem.offset().top,s=this.$clickItem,t=this.dom(t),i=t.offset(),a=t.height()/2;t[a+i.top>e?"before":"after"](s)},_moveItem(t,e){e=t.offset().top-e;t.css("top",e+"px"),this.$control.css("top",e+"px")},_makeDragItem(t){this._trashDragItem();var t=this.dom(t),e=t.offset(),s=this.app.theme.get(),i=(this.$clickItem=t,this.$clickItem.addClass("rx-drag-active"),t.clone()),a=(i.removeClass("rx-drag-active rx-element-active"),i.css({"font-family":t.css("font-family"),"font-size":t.css("font-size"),"line-height":t.css("line-height"),margin:0,padding:0}),this.dom("<div>").addClass("rx-dragging"));return a.append(i),a.attr("rx-data-theme",s),a.css({opacity:.95,position:"absolute","z-index":999,left:e.left+"px",top:e.top+"px",width:t.width()+"px"}),this.app.getFrameBody().append(a),a},_trashDragItem(){this.$dragItem&&this.$clickItem&&(this.$clickItem.removeClass("rx-drag-active"),this.$clickItem=null,this.$dragItem.remove(),this.$dragItem=null)}}),d.add("module","dropdown",{init(){this.defs={type:!1,button:!1,width:!1,maxWidth:!1,items:!1,remove:!1,extend:!1,getter:!1,setter:!1,builder:!1,observer:!1,html:!1,listen:!0,keys:[]}},isOpen(){return 0!==this.app.$body.find(".rx-dropdown").length},isPositionTop(){var t;return!!this.dropdown&&(t=this.dropdown.getElement(),this.isOpen())&&"top"===t.attr("data-rx-pos")},open(t,e){this.app.editor.save(),this.app.broadcast("dropdown.before.open",{dropdown:this}),this._open(t,e),this.app.modal.close(),this.app.observer.observe(),this.app.broadcast("dropdown.open",{dropdown:this})},close(){var t;this.$dropdown&&(this._stopEvents(),this.button&&this.button.isButton&&(t=this.button.getName(),this.app.toolbar.unsetToggled(t),this.app.extrabar.unsetToggled(t),this.app.context.unsetToggled(t),this.button.getElement().removeClass("rx-in-dropdown toggled")),this.$dropdown.remove(),this.app.$body.find(".rx-colorpicker-"+this.uuid).remove(),this.app.broadcast("dropdown.close"))},closeAll(){this.app.$body.find(".rx-dropdown").each(function(t){t=t.dataget("instance");t&&t.close()})},getName(){return this.name},updatePosition(t){this.$dropdown&&(this._buildPosition(t),this._buildHeight())},getElement(){return this.$dropdown},create(t,e){this.params=d.extend({},this.defs,e),this.name=t,this.params.html&&(this.params.listen=!1),this.closeAll(),this._build()},_open(t,e){this.button=e,this.params.html?this._buildHtml():this._buildItems(),this._buildName(),this._buildWidth(),this._buildPosition(),this._buildHeight(),this._buildActiveKeys(),this._startEvents(),this.app.ui.buildDepth("dropdown",this.$dropdown),this.button&&this.button.isButton&&this.button.getElement().addClass("rx-in-dropdown toggled"),this.$dropdown.show(),this.params.listen&&this.app.getDoc().on("keydown.rx-dropdown",this._listen.bind(this))},_buildWidth(){this.params.width&&this.$dropdown.css("width",this.params.width),this.params.maxWidth&&this.$dropdown.css("max-width",this.params.maxWidth)},_buildPosition(t){let{button:e,type:s,prev:i}=this.app.ui.getState();let a=2,r,o,n,l,h,p;var d,c=this.app.scroll.getTarget(),u=this.app.toolbar.getElement(),g="toolbar"===s?this.app.container.get("toolbar").get().scrollLeft:0,m=this.app.editor.getRect();this.$dropdown.attr("data-panel")||(a="context"===s?-2:"toolbar"===s?0:a,s,i&&"addbar"===s&&(e=i.button,"toolbar"===i.type)&&(s="toolbar"),d=this.app.$body.get().getBoundingClientRect(),"control"===s?(r=this.app.control.getElement().width(),o=this.app.control.getElement().offset()):e&&e.isButton?(r=e.getWidth(),o=e.getOffset(),n=e.getHeight()):(r=0,o=u.offset(),n=u.height(),s="toolbar"),h=["toolbar","context"].includes(s)?(l=o.top+n+1,o.left):(l=o.top+1,o.left+r+a),"panel"===s&&(o=this.app.panel.getRect(),l=o.top,h=o.left,a=0),this.app.panel.hide(),this.$dropdown.show(),p=this.$dropdown.width(),h=["toolbar","context"].includes(s)?(h=m.left<h?o.left+g+a:h,(h=m.right<h+p?o.left-p+r:h)<0?0:h):(h=m.left<h?o.left+r+a:h,m.right<h+p?o.left-p-a:h),["panel","context"].includes(s)&&d.bottom<l+200?(l=l-this.$dropdown.height()-n-4,this.$dropdown.attr("data-rx-pos","top")):this.$dropdown.removeAttr("data-rx-pos"),this._buildHide(t,c,l),"panel"===s?this.$dropdown.attr("data-panel",!0):this.$dropdown.removeAttr("data-panel"),this.$dropdown.css({top:l+"px",left:h+"px"}))},_buildHide(t,e,s){var i=e.offset().top,e=parseInt(e.css("padding-top"));if(t&&s<i+e)return this.$dropdown.hide(),!0;if(this.opts.is("maxHeight")&&"toolbar"!==this.app.ui.getState().type){t=this.app.editor.getEditor(),i=t.offset().top+t.height(),e=t.offset().top;if(i<s||s<e)return this.$dropdown.hide(),!0}return!1},_buildHeight(){let t,e,s,i=this.app.scroll.getTarget(),a=this.$dropdown.offset();s=(t=this.app.scroll.isTarget()?(e=a.top-i.offset().top,i.height()-parseInt(i.css("border-bottom-width"))):(e=a.top-i.scrollTop(),i.height()))-e-10,this.$dropdown.css("max-height",s+"px")},_buildActiveKeys(){0!==this.params.keys.length&&this._setActiveKeys(this.params.keys)},_buildName(){this.$dropdown.attr("data-rx-dropdown-name",this.name),this.$dropdown.addClass("rx-dropdown-"+this.name)},_buildHtml(){this.$dropdownItems.append(this.params.html)},_buildItems(){var t=this.params.items;let e=this.params.extend||{},s=["text","address","list","todo","quote","dlist"],i="dropdown",a=[];"control"===this.app.ui.getState().type&&"control"===this.name&&(i="control",(r=this.opts.get("control.add"))&&(e=d.extend(!0,{},e,r)),r=this.opts.get("control.hide"))&&(a=[...a,...r]),this.params.remove&&(a=this.params.remove);var r=this.params.type||"dropdown";this.app.ui.loadButtons(t,e,r,this.$dropdownItems,a),this.app.ui.buildBlockButtons(i,this.$dropdownItems,a),"addbar"===this.name&&this.$dropdown.find(".rx-button-addbar").each(function(t){var e=t.attr("data-name");-1!==s.indexOf(e)&&t.dataget("instance").setCommand("block.add")})},_build(){this.$dropdown=this.dom("<div>").addClass("rx-dropdown rx-dropdown-"+this.uuid),this.$dropdown.hide(),this.$dropdown.dataset("instance",this),this.$dropdown.attr({dir:this.opts.get("dir"),"rx-data-theme":this.app.theme.get()}),this.params.type&&this.$dropdown.addClass("rx-dropdown-type-"+this.params.type),this.$dropdownItems=this.dom("<div>").addClass("rx-dropdown-items"),this.$dropdown.append(this.$dropdownItems),this.app.$body.append(this.$dropdown)},_startEvents(){this.app.scroll.getTarget().on("resize.rx-dropdown scroll.rx-dropdown",this.updatePosition.bind(this)),this.app.editor.getEditor().on("scroll.rx-dropdown",this.updatePosition.bind(this))},_stopEvents(){this.app.scroll.getTarget().off(".rx-dropdown"),this.app.editor.getEditor().off(".rx-dropdown"),this.app.getDoc().off(".rx-dropdown")},_listen(t){switch(t.which){case 9:case 40:t.preventDefault(),this._select("next");break;case 38:t.preventDefault(),this._select("prev");break;case 13:t.preventDefault(),this._set(t)}},_select(t){var e,s,i,a=this.$dropdown.find(".rx-button");0!==a.length&&(e=this.$dropdown.find(".active"),a.removeClass("active"),(e=this._selectItem(e,a,t)).addClass("active"),a=e.outerHeight(),t=e.position().top,e=this.$dropdown.scrollTop(),s=t+2*a,i=this.$dropdown.outerHeight(),this.$dropdown.scrollTop(e+i<s?s-i:t-a<e?t-a:e))},_selectItem(t,e,s){let i;var a=0!==t.length,r="next"===s?0:e.length-1;return a&&(i=t[s]()),i=a&&i&&0!==i.length?i:e.eq(r)},_set(t){var e=this.$dropdown.find(".active").dataget("instance");e&&e.trigger(t)},_setActiveKeys(e){for(let t=0;t<e.length;t++)this.$dropdown.find("[data-name="+e[t]+"]").addClass("active")},_unsetActive(){this.$dropdown.find(".rx-button-dropdown").removeClass("active")}}),d.add("module","modal",{init(){this.saved=!1},start(){this._build(),this._buildStacks(),this._buildHeader()},stop(){this._stopEvents(),this._stop()},isOpen(){return this.$modal&&this.$modal.hasClass("open")},open(t){if(this.params=d.extend({},{name:!1,stack:!1,button:!1,focus:!1},t),this.button=this.params.button,this.stack=this.params.stack,this.name=this.params.name,this.button&&this.button.isButton){this.app.toolbar.unsetToggled(!1,this.button.getName()),this.app.extrabar.unsetToggled(!1,this.button.getName()),this.app.context.unsetToggled(!1,this.button.getName());t=this.button.getElement();if(t.hasClass("rx-in-modal"))return void this.close();t.addClass("rx-in-modal toggled")}this.app.editor.save(),this.app.dropdown.close(),this._open()},close(t){this.isOpen()&&(t||this.app.editor.restore(),this._stopEvents(),this.$modal.hide(),this.$modal.removeClass("open"),this.button&&this.button.isButton&&this.button.getElement().removeClass("rx-in-modal toggled"),this.app.broadcast("modal.close",{modal:this,stack:this.stack}),this.button=!1,this.stack=!1,this.name=!1)},getHeader(){return this.$header},getBody(){return this.stack.getBody()},getFooter(){return this.stack.getFooter()},getStack(){return this.stack},getElement(){return this.$modal},getName(){return this.name},getButton(){return this.button},updateWidth(t){var e=this.app.container.get("main"),s=e.width(),i=parseInt(e.css("border-left-width")),e=parseInt(e.css("border-right-width"));let a="100%"===t;("100%"===t||s<parseInt(t))&&(880<s&&(a=!1),t=(t=(880<s?880:s)-i-e)<300?300:t,t+="px"),this.$modal.css({width:t}),this.$modal.attr("data-width",t),this.$modal.attr("data-fullwidth",a)},updatePosition(t){this._buildPosition(t),setTimeout(this._buildHeight.bind(this),0),this.app.ui.buildDepth("modal",this.$modal)},updateOnScroll(){this.isOpen()&&(this._buildPosition(),setTimeout(this._buildHeight.bind(this),0))},_open(){this.app.broadcast("modal.before.open",{modal:this,stack:this.stack}),this.$stacks.html(""),this.$stacks.append(this.stack.getStack()),this._renderName(),this._renderHeader(),this.stack.render(),this._buildPosition(),setTimeout(this._buildHeight.bind(this),0),this.app.ui.buildDepth("modal",this.$modal),this._startEvents(),this.$modal.show(),this.$modal.addClass("open"),this.stack.renderFocus(this.params.focus),this.app.broadcast("modal.open",{modal:this,stack:this.stack})},_startEvents(){var t=this.app.scroll.getTarget();t.on("resize.rx-modal",this.updatePosition.bind(this)),t.on("scroll.rx-modal",this.updateOnScroll.bind(this)),this.app.editor.getEditor().on("scroll.rx-modal",this.updateOnScroll.bind(this))},_stopEvents(){this.app.scroll.getTarget().off(".rx-modal"),this.app.editor.getEditor().off(".rx-modal")},_stop(){this.$modal&&this.$modal.remove()},_renderHeader(){var t=this.stack.getTitle();this.$header.html(""),t&&(this.$header.html(this.lang.parse(t)),this._buildClose())},_renderName(){this.$modal.attr("rx-modal-name",this.name)},_build(){this.$modal=this.dom("<div>").addClass("rx-modal rx-modal-"+this.uuid),this.$modal.hide(),this.$modal.attr({dir:this.opts.get("dir"),"rx-data-theme":this.app.theme.get()}),this.app.$body.append(this.$modal)},_buildClose(){var t=this.dom("<span>").addClass("rx-modal-close");t.one("click",this._catchClose.bind(this)),this.$header.append(t)},_buildHeader(){this.$header=this.dom("<div>").addClass("rx-modal-header"),this.$modal.prepend(this.$header)},_buildStacks(){this.$stacks=this.dom("<div>").addClass("rx-modal-stacks"),this.$modal.append(this.$stacks)},_buildPosition(){let{button:a,type:r,prev:o}=this.app.ui.getState();var n=this.app.container.get("toolbox"),l=this.app.$body.get().getBoundingClientRect(),h=this.app.container.get("main").get().getBoundingClientRect(),p=this.$modal.attr("data-fullwidth"),d=this.$modal.attr("data-panel");if(!d){o&&"addbar"===r&&(a=o.button,"toolbar"===o.type)&&(r="toolbar");let t=parseInt(this.$modal.attr("data-width")),e=0,s=0,i=0;!1===a?(e=n.offset().top+n.height(),s=h.left):(d="control"===r?this.app.control.getButton("toggle"):a,c=(d=("panel"===r?this.app.panel:d).getRect())?d.left-l.left:0,l=d?l.right-d.right:0,p?("toolbar"===r?e=n.offset().top+n.height():(e=d.top+d.height,i=10,t-=20,this.$modal.css({width:t+"px"})),s=h.left+i):(s=h.left,e=d.top+d.height,l>=t?s=d.left:c>=t&&(s=d.left+d.width-t))),this.opts.is("maxHeight")&&(n=(p=this.app.editor.getEditor()).offset().top+p.height(),h=p.offset().top,e>n||h>e?this.$modal.hide():this.app.modal.isOpen()&&this.$modal.show());var c,l=this.app.scroll.getTarget();t>l.width()?this.$modal.css({width:l.width()+"px"}):this.$modal.css({width:t+"px"}),"panel"===r?this.$modal.attr("data-panel",!0):this.$modal.removeAttr("data-panel"),this.app.panel.hide(),this.$modal.css({top:e+"px",left:s+"px"})}},_buildHeight(){let t,e;var s=this.app.scroll.getTarget(),i=this.$modal.offset();let a;a=(t=this.app.scroll.isTarget()?(e=i.top-s.offset().top+parseInt(s.css("padding-top")),s.height()-parseInt(s.css("border-bottom-width"))):(e=i.top-s.scrollTop(),s.height()))-e,this.$modal.css("max-height",a+"px")},_catchClose(t){t.preventDefault(),t.stopPropagation(),this.close()}}),d.add("module","codemirror",{init(){this.cm=!1},create(t){var e,s;if(this.is())return e="object"==typeof(e=this.opts.get("codemirror"))?e:{},s=(s=this.opts.get("codemirrorSrc"))||CodeMirror,this.cm=s.fromTextArea(this.dom(t.el).get(),e),t.height&&this.cm.setSize(null,t.height),t.focus&&this.cm.focus(),this.cm},destroy(){this.cm&&(this.cm.toTextArea(),this.cm=!1)},is(){return this.opts.get("codemirror")},val(t){return t=this.is()&&this.cm?this.cm.getValue():t}}),d.add("module","autosave",{send(){this.opts.is("autosave.url")&&this._send()},_getName(){let t;var e=this.opts.get("autosave.name");return t=e||(t=this.app.element.getName())||"content"+this.uuid},_send(){let e=this._getName();var t=this.opts.get("autosave.url"),s=this.opts.get("autosave.method"),i=this.opts.get("autosave.data"),a=this.app.create("utils");let r={};r[e]=this.app.element.getHtml(),r=a.extendData(r,i),this.ajax.request(s,{url:t,data:r,before:function(t){if(this.app.broadcast("autosave.before.send",{xhr:t,name:e,data:r}).isStopped())return!1}.bind(this),success:function(t){this._complete(t,e,r)}.bind(this)})},_complete(t,e,s){var i=t&&t.error?"autosave.error":"autosave.send";this.app.broadcast(i,{name:e,data:s,response:t})}}),d.add("module","input",{handle(t){var e=t.get("e"),s=t.get("key");this._doSelectAll(e,t)||(t.is(["enter","delete","backspace","alpha","space"])&&this.app.control.updatePosition(),t.is("enter")&&t.is("shift")?this.handleShiftEnter(e,s,t):t.is("enter")?this.handleEnter(e,s,t):t.is("space")&&t.is("shift")?this.handleShiftSpace(e,s,t):t.is("space")?this.handleSpace(e,s,t):t.is("tab")&&this.opts.is("tab.key")?this.handleTab(e,s,t):t.is("arrow")?t.is("ctrl")&&t.is("up")?this.handleArrowCtrl(e,s,t):t.is(["shift","alt","ctrl"])||this.handleArrow(e,s,t):t.is(["delete","backspace"])?this.handleDelete(e,s,t):t.is("alpha")&&(e=this.app.block.get())&&e.isType("cell")&&(e.setEmpty(),s=e.getFirstElement(),this.app.block.set(s,"start")))},handleSpace(t,e,s){var i,a=this.app.block.get(),r=this.app.create("selection"),o=this.app.create("caret");a&&a.isType(["column","embed"])?t.preventDefault():this.app.blocks.is()?(i=this.app.blocks.get({first:!0,selected:!0}),r.truncate(),o.set(i,"end"),this.app.image.observeStates()):a&&(a.handleSpace&&a.handleSpace(t,e,s)?this.app.image.observeStates():a.isInline()?(!a.isEditable()||a.isEditable()&&a.isAllSelected())&&(t.preventDefault(),o.set(a.getBlock(),"after"),a.remove()):a.isEditable()&&a.isAllSelected()?(t.preventDefault(),a.setEmpty()):a.isEditable()||(t.preventDefault(),a.isType("cell")?(t.preventDefault(),a.getBlock().html(""),r=this.app.block.create(),a.getBlock().append(r.getBlock()),this.app.editor.build(),this.app.block.set(r.getBlock(),"start")):(a.insertEmpty({position:"after",caret:"start",type:"input"}),a.remove({broadcast:!0}),this.app.image.observeStates())))},handleEnter(e,t,s){var i=this.app.block.get(),a=this.app.create("selection"),r=this.app.create("insertion"),o=this.app.create("caret");if(i&&i.isType("column"))e.preventDefault(),i.insertEmpty({position:"prepend",caret:"start",type:"input"});else if(this.app.blocks.is()){e.preventDefault();let t=this.app.blocks.get({last:!0,selected:!0});a.truncate(),void setTimeout(()=>{this.app.block.set(t),this.app.image.observeStates()},0)}else if(i&&!(i.isNondeletable()||!i.isInline()&&this._deleteInsideSelection(e)))if(i.isInline())e.preventDefault(),(!i.isEditable()||i.isEditable()&&i.isAllSelected())&&(o.set(i.getBlock(),"after"),i.remove());else{if(i.isEditable()){if(i.isAllSelected())return e.preventDefault(),void i.setEmpty();if(!a.isCollapsed())return e.preventDefault(),void(i.isType("pre")?r.insertNewline():r.insertBreakline())}else if(!i.isEditable())return e.preventDefault(),i.isType("list")?0===(o=i.getBlock().closest("li")).length?void i.insertEmpty({position:"after",caret:"start",type:"input"}):(i.remove(),void this.app.block.set(o,"end")):i.isType("cell")?(e.preventDefault(),i.getBlock().html(""),a=this.app.block.create(),i.getBlock().append(a.getBlock()),this.app.editor.build(),void this.app.block.set(a.getBlock(),"start")):(i.insertEmpty({position:"after",caret:"start",type:"input"}),void this.app.image.observeStates());i.handleEnter?(i.handleEnter(e,t,s),this.app.image.observeStates()):i.isEditable()&&(e.preventDefault(),i.isEmpty()||i.isCaretEnd()||i.isCaretStart()?(r=i.isCaretStart()?"before":"after",i.insertEmpty({position:r,caret:"start",remove:!1,type:"input"})):this.app.create("element").splitAtCaret(i.getBlock()))}},handleTab(t,e,s){let i=this.app.block.get(),a=this.app.create("insertion"),r=this.app.create("selection");this.app.blocks.is()?(t.preventDefault(),i=this.app.blocks.get({last:!0,selected:!0}),r.collapse("end"),this.app.block.set(i),this.app.context.close()):i&&i.handleTab&&i.handleTab(t,e,s)||(i&&this.opts.is("tab.spaces")&&i.isEditable()?(t.preventDefault(),e=this.opts.get("tab.spaces"),s=document.createTextNode(Array(e+1).join(" ")),a.insertNode(s,"end")):i&&this._traverseNext(t,i))},handleArrowCtrl(t,e,s){var i=this.app.create("selection");this.app.editor.unsetSelectAll(),i.remove(),this.app.editor.setFocus("start")},handleArrow(e,t,s){let i=this.app.block.get();this.app.create("caret");var a=this.app.create("utils"),r=this.app.create("selection");if(this.app.editor.isSelectAll())e.preventDefault(),o=s.is("down-right")?this.app.blocks.get({last:!0}):this.app.blocks.get({first:!0}),n=s.is("down-right")?"end":"start",this.app.editor.unsetSelectAll(),this.app.block.set(o,n);else if(this.app.blocks.is())e.preventDefault(),i=s.is("down-right")?this.app.blocks.get({last:!0,selected:!0}):this.app.blocks.get({first:!0,selected:!0}),r.collapse(s.is("down-right")?"end":"start"),this.app.block.set(i),this.app.context.close();else if(i&&!(i.isEditable()&&s.is(["left","right"])&&this._trimInvisibleChar(e,s.is("left")?"left":"right")||i.handleArrow&&i.handleArrow(e,t,s))){if(a.isFirefox()){var{isFirstLine:o,isLastLine:n}=r.isCursorInFirstOrLastLine();if(s.is("up")){t=i.findPreviousElement();if(t&&t.isType("text")&&t.isEmpty()&&o)return e.preventDefault(),void this.app.block.set(t,"start")}else if(s.is("down")){a=i.findNextElement();if(a&&a.isType("text")&&a.isEmpty()&&n)return e.preventDefault(),void this.app.block.set(a,"start")}}if(!i.isEditable()||i.isType(["todo","list"]))return s.is("up-left")?this._traversePrev(e,i):s.is("down-right")?this._traverseNext(e,i):void 0;if(i.isEditable()&&s.is("down-right")&&i.isCaretEnd()){let t;r=i.getClosest("table");r?(e.preventDefault(),(t=r.getNext())?this.app.block.set(t,"start"):(o=this.app.block.create(),r.insert({instance:o,position:"after",type:"input"}))):(t=i.getNext())&&(e.preventDefault(),this.app.block.set(t,"start"))}}},handleDelete(t,e,s){var i,a=this.app.block.get(),r=s.is("backspace"),o=s.is("delete"),n=this.app.create("selection"),l=this.app.create("caret");a&&a.isNondeletable()||(a&&a.isType("column")||this.app.editor.isEmpty()?t.preventDefault():this.app.blocks.is()?(t.preventDefault(),i=this.app.blocks.get({first:!0,selected:!0}),n.truncate(),this.app.block.set(i,"end"),this.app.block.get().appendNext(),this.app.context.close(),this.app.image.observeStates()):a&&a.isEditable()&&this._trimInvisibleChar(t,s.is("backspace")?"left":"right",o)||((i=n.getInline())&&1===i.innerHTML.length&&r&&!l.is(i,"start")?(t.preventDefault(),i.innerHTML=""):a&&(a.handleDelete&&a.handleDelete(t,e,s)||(a.isInline()?this._deleteInlineBlock(t,a):a.isEditable()?a.isEditable()&&this._deleteEditable(t,a,s):this._deleteNotEditable(t,a)),this.app.image.observeStates())))},handleShiftEnter(t){var e,s=this.app.block.get(),i=this.app.create("insertion"),a=this.app.create("selection"),r=this.app.create("caret");this.app.blocks.is()?(t.preventDefault(),e=this.app.blocks.get({first:!0,selected:!0}),a.truncate(),r.set(e,"end"),i.insertBreakline()):this._deleteInsideSelection(t)||s&&(s.isInline()?(t.preventDefault(),s.isEditable()||(r.set(s.getBlock(),"after"),s.remove())):s.isEditable()?(t.preventDefault(),i.insertBreakline()):(t.preventDefault(),s.insertEmpty({position:"after",caret:"start",type:"input"})))},handleShiftSpace(t){var e,s=this.app.block.get(),i=this.app.create("insertion"),a=this.app.create("selection"),r=this.app.create("caret");this.app.blocks.is()?(t.preventDefault(),e=this.app.blocks.get({first:!0,selected:!0}),a.truncate(),r.set(e,"end"),i.insertHtml("&nbsp;","end")):s.isInline()||s.isEditable()&&(s.isAllSelected()?(t.preventDefault(),s.setEmpty()):s.isType("pre")||(t.preventDefault(),i.insertHtml("&nbsp;","end")))},handleTextareaTab(t){if(9!==t.keyCode)return!0;t.preventDefault();var t=t.target,e=t.value,s=t.selectionStart;t.value=e.substring(0,s)+"    "+e.substring(t.selectionEnd),t.selectionStart=t.selectionEnd=s+4},_deleteInlineBlock(t,e){var s=this.app.create("caret"),i=e.getBlock(),a=i.parent().closest("[data-rx-type]");e.isEditable()&&!e.isAllSelected()||(t.preventDefault(),s.set(i,"after"),e.remove(),this.app.block.set(a),this.app.context.close())},_deleteEditable(t,e,s){var i=e.getNext(),a=e.getPrev(),r=s.is("backspace"),s=s.is("delete"),o=this.app.create("selection");if(e.isAllSelected())t.preventDefault(),e.isType("quote")?this.app.block.remove():e.setEmpty(),this.app.context.close();else if(s&&i&&e.isCaretEnd()){if(t.preventDefault(),i.isEditable()||i.isType(["list","todo"])){if("pre"===i.getType()&&e.isEmpty())return void e.remove({broadcast:!0});e.appendNext()}else this.app.block.set(i),e.isEmpty()&&e.remove({broadcast:!0});this.app.context.close()}else if(s&&!i&&e.isCaretEnd())e.getClosest(["column","cell"])&&t.preventDefault();else if(r&&a&&e.isCaretStart()){this.app.create("caret");if(t.preventDefault(),a.isEditable()||a.isType(["list","todo"])){if("pre"===a.getType()&&e.isEmpty())return void e.remove({broadcast:!0});e.appendToPrev(),this.app.control.updatePosition()}else this.app.block.set(a,"force"),e.isEmpty()&&e.remove({broadcast:!0});this.app.context.close()}else r&&!a&&e.isCaretStart()?e.getClosest(["column","cell"])&&t.preventDefault():o.isCollapsed()||(t.preventDefault(),o.truncate(),this.app.context.close())},_deleteNotEditable(t,e){var s=e.getNext(),i=e.getPrev(),a=e.getType();let r={};var o=e.getClosest(["column","cell"]);t.preventDefault(),"image"===a&&(r={url:e.getSrc(),id:e.getId(),uid:e.getDataImage()},this.app.image.setImageState(e,r,!1)),e.remove({broadcast:!0}),"image"===a&&this.app.broadcast("image.remove",r),o&&o.isEmpty(!0)?(t=this.app.block.create(),o.insert({instance:t,position:"append"}),this.app.block.set(t,"start")):s?this.app.block.set(s,"start"):i?this.app.block.set(i,"end"):this.app.editor.isEmpty()?this.app.editor.setEmpty():this.app.block.unset()},_deleteInsideSelection(t){var e,s=this.app.create("selection"),i=this.app.create("caret");return!s.isCollapsed()&&1<(e=s.getNodes({type:"block"})).length&&(t.preventDefault(),s.truncate(),i.set(e[0],"end"),!0)},_doSelectAll(e,t){if(this._isAllSelected(t))return this._setEditorEmpty(e,t),!0;if(t.is("select-block")){var s,i=this.app.block.get();let t;i&&i.isEditable()&&(s=this.app.create("selection"),t=i.getBlock(),i.isType("todoitem")?t=i.getContentItem():i.isType("quote")&&(t=i.getCurrentItem()),e.preventDefault(),s.select(t),this.app.context.open(e))}else if(t.is("select"))return e.preventDefault(),this.app.editor.setSelectAll(),this.app.context.open(e),!0},_traverseNext(t,e){var s=e.getNext();(s=s||e.getNextParent())&&(t.preventDefault(),this.app.block.set(s,"start"))},_traversePrev(t,e){var s=e.getPrev();(s=s||e.getPrevParent())&&(t.preventDefault(),this.app.block.set(s,"end"))},_isAllSelected(t){return this.app.editor.isSelectAll()&&t.is(["enter","delete","backspace","alpha","space"])},_setEditorEmpty(t,e){e.is(["alpha","space"])||t.preventDefault(),this.app.editor.setEmpty()},_trimInvisibleChar(t,e,s){let i="left"===e?"before":"after",a=this.app.create("selection"),r=this.app.create("offset"),o=a.getCurrent(),n=this._isInvisibleChar(a,o,i),l;if(n&&"left"===e)l=o,this.dom(l).replaceWith(l.textContent.replace(/\uFEFF/g,""));else if(n&&s&&o&&o.nextSibling)l=o.nextSibling,this.dom(l).replaceWith(l.textContent.replace(/\uFEFF/g,""));else if(n&&"right"===e)return t.preventDefault(),s=r.get(),r.set(!1,{start:s.start+1,end:s.end+1}),!0},_isInvisibleChar(t,e,s){var i=this.app.create("utils"),t=t.getText(s);return e&&3===e.nodeType&&0===i.searchInvisibleChars(t)}}),d.add("module","progress",{stop(){this.hide()},show(t){this.hide(),this.$progress=this.dom("<div>").addClass("rx-editor-progress"),this.$progress.attr("id","rx-progress"),this.$progressBar=this.dom("<span>"),this.$progress.append(this.$progressBar),("boolean"!=typeof variable&&t?t:this.app.$body).append(this.$progress)},hide(){this.app.$body.find("#rx-progress").remove()}}),d.add("module","layout",{popup(t,e){var s,i,a=this.opts.get("layouts"),a=d.extend(!0,{},a);for([s,i]of Object.entries(a))i.command="layout.insert",i.params=d.extend(!0,{},i);this.app.dropdown.create("layout",{items:a}),this.app.dropdown.open(t,e)},insert(t){this.app.dropdown.close();t=this.app.create("block.layout",t);this.app.create("insertion").insert({instance:t})}}),d.add("module","panel",{init(){this.classname="rx-panel"},stop(){this.close(),this.app.getDoc().off(".rx-panel")},isOpen(){return this.$panel&&this.$panel.hasClass("open")},build(t,e){return this.$panel=this.app.$body.find(".rx-panel"),this.module=t,this.callback=e,0===this.$panel.length?(this.$panel=this.dom("<div>").addClass(this.classname),this.app.$body.append(this.$panel)):this.$panel.html(""),this.$panel},open(s){if(this.$panel){this.$panel.addClass("open");let t=0,e=0;var i;this.app.isMode("iframe")&&(i=this.app.editor.getRect(),t=i.top,e=i.left),this.$panel.css({top:s.top+t+"px",left:s.left+e+"px"}),this.opts.is("bsmodal")?this.$panel.css("z-index",1061):this.app.isProp("fullscreen")?this.$panel.css("z-index",10001):this.$panel.css("z-index",""),this.app.getDoc().off(".rx-panel"),this.app.getDoc().on("keydown.rx-panel",this._listen.bind(this)),this.app.editor.getEditor().on("click.rx-panel",this.hide.bind(this))}},close(){this.$panel&&(this.$panel.remove(),this.$panel=!1,this.app.getDoc().off(".rx-panel"),this.app.editor.getEditor().off(".rx-panel"))},hide(){this.$panel&&this.$panel.hide()},getElement(){return this.$panel},getRect(){var t=this.$panel.offset();return t.height=0,t.width=0,t},getItems(){return this.$panel.find(".rx-panel-item")},getActiveItem(){return this.$panel.find(".active")},getFirstItem(){return this.getItems().first()},getLastItem(){return this.getItems().last()},setActive(t){this.getItems().removeClass("active"),t.addClass("active");var e=t.outerHeight(),t=t.position().top,s=this.$panel.scrollTop(),i=t+2*e,a=this.$panel.outerHeight();this.$panel.scrollTop(s+a<i?i-a:t-e<s?t-e:s)},setNextActive(t){var e=t.next();0!==e.length||0!==(t=t.closest(".rx-panel-section")).length&&0!==t.next().length&&0!==(e=t.next().find(".rx-panel-item").first()).length?this.setActive(e):(t=this.getFirstItem(),this.setActive(t))},setPrevActive(t){var e=t.prev();0!==e.length||0!==(t=t.closest(".rx-panel-section")).length&&0!==t.prev().length&&0!==(e=t.prev().find(".rx-panel-item").last()).length?this.setActive(e):(t=this.getLastItem(),this.setActive(t))},_listen(t){var e=t.which,s=this.app.keycodes;if(this.isOpen()&&e===s.ENTER)return 0===(s=this.getActiveItem()).length?void this.close():(t.preventDefault(),void this.module[this.callback].call(this.module,t,s));!this.isOpen()||40!==e&&38!==e&&39!==e&&37!==e||(0===(t=this.getActiveItem()).length?(s=this.getFirstItem(),this.setActive(s)):40===e||39===e?this.setNextActive(t):38!==e&&37!==e||this.setPrevActive(t))}}),d.add("module","command",{init(){this.handleStr="",this.handleLen=1,this.handleTrigger="/"},build(t){var e=t.which,t=t.ctrlKey||t.metaKey,s=this.app.keycodes;e===s.ESC?this.app.editor.restore():e===s.DELETE||e===s.SHIFT||t||-1!==[37,38,39,40].indexOf(e)||(e===s.SPACE?(this.handleLen=1,this._hide()):(e===s.BACKSPACE&&(this.handleLen=this.handleLen-2,this.handleLen<=0?(this.handleLen=1,this._hide()):this.handleLen<=1&&this._hide()),this._emit()))},_emit(){var t=this.app.create("selection"),e=this.handleTrigger,s=new RegExp("^"+e);this.handleStr=t.getText("before",this.handleLen),this.handleStr2=t.getText("before",this.handleLen+1),s.test(this.handleStr)&&(this.handleStr=this.handleStr.replace(e,""),this.handleLen++,0<this.handleLen-1)&&this._load()},_load(){this._createPanel(),0===this._buildPanel(this.$panel,this.handleStr)&&this._hide()},_createPanel(){this.$panel=this.app.panel.build(this,"_insertFromPanel"),this.$panel.addClass("rx-panel-command rx-panel-stack").css("max-width","372px");var t=this.app.getDoc().scrollTop(),e=this.app.create("selection").getPosition();this.app.panel.open({top:e.bottom+t,left:e.left}),this.app.editor.save()},_buildPanel(e,s){var i=this.app.create("utils");let a=0;var r,o,n={add:"Add",format:"Turn into"};this.items={add:this.app.addbar.getItems(),format:this.app.format.getItems()};for([r,o]of Object.entries(this.items)){var l=this.dom('<div class="rx-panel-section">'),h=this.dom('<div class="rx-panel-title">'),p=this.dom('<div class="rx-panel-box">');let t=0;var d,c,u,g,m,b=n[r],f=(h.html(b),l.append(h),l.append(p),!(!s||""===s)&&new RegExp(i.escapeRegExp(s),"gi"));for([d,c]of Object.entries(o))c.getTitle()&&(u=c.getTitleText(),f&&-1===d.search(f)&&-1===u.search(f)||(u=this.dom('<span class="rx-panel-item">'),g=this.dom('<span class="rx-panel-item-icon">').html(c.getIcon()),m=this.dom('<span class="rx-panel-item-title">').html(c.getTitle()),u.attr({"data-name":d,"data-section":r}),u.append(g),u.append(m),u.on("click",this._insertFromPanel.bind(this)),p.append(u),t++));0<t&&(a++,e.append(l))}return a},_insertFromPanel(t,e){this.app.editor.restore();let s=e||this.dom(t.target);var e=(s=s.closest(".rx-panel-item")).data("name"),i=s.data("section"),a=this.handleTrigger,r=this.app.create("selection"),o=this.app.create("offset"),r=r.getCurrent(),n=a+this.handleStr;let l=r.textContent;var h=o.get(r),a=(a+this.handleStr).length,p=l.lastIndexOf(n);0<=p&&(l=l.substring(0,p)+""+l.substring(p+n.length)),r.textContent=l,h.start=h.start-a+"".length,h.end=h.end-a+"".length,o.set(h,r),this.items[i][e].trigger(t,"panel"),this._hideForce()},_hide(){this.app.panel.close()},_hideForce(){this._hide(),this.handleStr="",this.handleLen=1}}),d.add("module","ui",{init(){this.register={},this.containers={},this.buttonsCustom={},this.buttonsRemove={},this.buttonsBlockSpecific={},this.state={type:!1,button:!1,instance:!1}},stop(){this.closeTooltip()},closeTooltip(){this.app.$body.find(".rx-tooltip").remove()},close(e,...t){e&&!e.preventDefault&&(t.unshift(e),e=null),this._handleContexts(t,["dropdown","modal","control","context","panel"]).forEach(t=>this.app[t].close(e))},unset(...t){this._handleContexts(t,["toolbar","extrabar","context"]).forEach(t=>this.app[t].unsetActive())},disable(...t){this._handleContexts(t,["path","extrabar","statusbar","toolbar"]).forEach(t=>this.app[t].disable())},disableToolbar(t,e){this._findButtons(t).each(t=>this._enableDisable(t,e,"disable"))},enable(...t){this._handleContexts(t,["path","extrabar","statusbar","toolbar"]).forEach(t=>this.app[t].enable())},enableToolbar(t,e){this._findButtons(t).each(t=>this._enableDisable(t,e,"enable"))},_enableDisable(t,e,s){var i;0<e.length&&(i=t.data("name"),!e.includes(i))||t.dataget("instance")[s]()},isAnyOpen(...t){return t.some(t=>this.app[t]&&this.app[t].isOpen())},updateTheme(e){["tooltip","control","context","panel"].forEach(t=>this.app.$body.find(".rx-"+t).attr("rx-data-theme",e)),["dropdown","modal"].forEach(t=>this.app.$body.find(`.rx-${t}-`+this.uuid).each(t=>t.attr("rx-data-theme",e)))},updatePosition(...t){t.forEach(t=>this.app[t].updatePosition())},updateEvents(...t){t.forEach(t=>this.app[t].updateEvents())},observeButtons(t){t.find(".rx-button").each(t=>t.dataget("instance")?.observe())},loadToolbar(t,e){var s=this.app.block.get();return e!==(!!s&&s.getType())?(e=this.buildButtons(t),this.loadBlockButtons(t)):this.observeButtons(this.getContainer(t)),e},loadBlockButtons(t){this.buildBlockButtons(t,this.getContainer(t))},build(t,e){return new v(this,t,e)},loadButtons(t,e,s,i,a){t=this._buildButtonObj(s,t),e=this._buildButtonObj(s,e);var r=this._getToggledButtons(i),t=this._makeButtons(s,i,t,e,a);return i&&i.html(""),this._createButtons(t,r,s,i)},buildButtons(t,e){var s=this._getButtonsFromOpts(t,e),i=this._getCustomButtons(t,e),a="control"===t?[]:this.getButtonsRemove(t),r=this.getContainer(t),o=this._getToggledButtons(r),s=this._makeButtons(t,r,s,i,a),i=((r||"context"===t&&e)&&r.html(""),this._createButtons(s,o,t,r),this._buildButtonsOrder(t,r),this.app.block.get());return!!i&&i.getType()},buildBlockButtons(s,i,a=[]){var t=this.app.block.get();t&&(t=t.getButtons(s)||{},Object.entries(t).forEach(([t,e])=>{e=this._buildObject(s,t,e);a.includes(t)||this._isHiddenButton(s,t)||this.app.create("button",t,e,i,s)}))},buildDepth(t,e){let s="";t=["modal","dropdown"].includes(t);this.opts.is("bsmodal")?s=t?1061:1060:this.app.isProp("fullscreen")&&(s=t?10002:10001),e.css("z-index",s)},getContainer(t){return this.containers[t]??=this.dom([])},getButtonsCustom(t){return this.buttonsCustom[t]??={}},getButtonsBlockSpecific(t){return this.buttonsBlockSpecific[t]??={}},getButtonsRemove(t){return this.buttonsRemove[t]??=[]},addContainer(t,e){this.containers[t]=e},registerButton(t,e){this.register[t]=e},addButton(t,e,s,i){var a;this.app.isStarted()?(a=this._buildObject(t,e,s),this.app.create("button",e,a,this.getContainer(t),t)):(i?(this.buttonsBlockSpecific[t]??={},this.buttonsBlockSpecific[t][e]=s):(this.buttonsCustom[t]??={},this.buttonsCustom[t][e]=s),this.registerButton(e,s))},removeButton(t,e){this.buttonsRemove[t]??=[],Array.isArray(e)?this.buttonsRemove[t].push(...e):this.buttonsRemove[t].push(e)},setButton(){},setButtonColor(t,e){var s,t=t.dataget("instance");t?.has("color")&&(e&&Object.keys(e).length?({color:e,background:s}=e,e&&s?(t.setBackground(s),t.setColor(e)):t.setBackground(e||s)):t.resetBackground())},setState(t){var e=this.state;this.state=t,e&&(this.state.prev=e)},setActive(t,e){this.unsetActive(t),this._findButtonInstance(t,e)?.setActive()},setActiveKeys(t,e,s){t.forEach(t=>this._setButtonsActiveByKeys(t,e)),t.forEach(t=>this._setButtonsStyle(t,s))},setToggled(t,e){this.unsetToggled(t),this._findButtonInstance(t,e)?.setToggled()},getState(){return this.state},getButton(t,e){return this._findButtonInstance(t,e)},unsetActive(t,e){e?(e=this._findButtonInstance(t,e))&&e.unsetActive():this._findButtons(t).each(t=>{t.dataget("instance").unsetActive(),t.dataget("instance").resetBackground()})},unsetToggled(t,e,s){e?(e=this._findButtonInstance(t,e))&&e.unsetToggled():this._findButtons(t).each(t=>{var e=t.dataget("instance");e.unsetToggled(),s&&e.getName()===s||t.removeClass("rx-in-modal")})},_handleContexts(t,e){return 0===t.length?e:t},_setButtonsActiveByKeys(e,t){t.forEach(t=>this._findButtonInstance(e,t)?.setActive())},_setButtonsStyle(t,e){this._findButtons(t).each(t=>this.setButtonColor(t,e))},_findButton(t,e){return this.getContainer(t).find("[data-name="+e+"]")},_findButtonInstance(t,e){t=this._findButton(t,e);if(0!==t.length)return t.dataget("instance")},_findButtons(t){return this.getContainer(t).find(".rx-button")},_makeButtons(t,e,s,i,a){var r=this._getExtendFromOpts(t),o=this._getBlockButtons(t),t=this.opts.get(t+".hide")||[],s=[...s,...i,...r,...o];let n=[...a,...t];return(s=this._shiftLastPositionButtons(s)).filter(t=>!n.includes(t.name))},_buildButtonsOrder(t,e){const s=this._findButtons(t).getAll(),i=document.createDocumentFragment(),a=this.opts.get("buttons."+t);t=d.opts.buttons[t];a&&t!==a&&(a.forEach(e=>{var t=s.find(t=>t.getAttribute("data-name")===e);t&&i.appendChild(t)}),s.forEach(t=>{a.includes(t.getAttribute("data-name"))||i.appendChild(t)}),e.html(""),e.append(i))},_buildObject(t,e,s){var i=this._getButtonObj(e);return(i=i?d.extend(!0,{},i,s):d.extend(!0,{},s)).name=void 0!==i.name?i.name:e,!this._isHiddenButton(t,e)&&i},_buildButtonObj(s,t){let i=[];return Array.isArray(t)?t.forEach(t=>{let e={};"object"==typeof t&&(t=(e=t).name);t=this._buildObject(s,t,e);t&&i.push(t)}):Object.entries(t).forEach(([t,e])=>{t=this._buildObject(s,t,e);t&&i.push(t)}),i},_shiftLastPositionButtons(t){var e=t.findIndex(t=>"last"===t.position);return-1!==e&&([e]=t.splice(e,1),t.push(e)),t},_getButtonsFromOpts(t,e){let s=[...this.opts.get("buttons."+t)];return"context"===t&&e&&(s=[]),this._buildButtonObj(t,s)},_getCustomButtons(t,e){let s="control"===t?{}:this.getButtonsCustom(t);return"context"===t&&e&&(s=this.getButtonsBlockSpecific(t)),this._buildButtonObj(t,s)},_getExtendFromOpts(t){var e=this.opts.get(t+".add")||{};return this._buildButtonObj(t,e)},_getBlockButtons(t){var e=this.app.block.get(),e="control"!==t&&e&&e.getButtons(t)||{};return this._buildButtonObj(t,e)},_getToggledButtons(t){const e={};return t&&t.find(".toggled").each(t=>{t=t.dataget("instance");t&&(e[t.getName()]={title:t.getTitle(),icon:t.getIcon(),command:t.getCommand()})}),e},_createButtons(t,s,i,a){const r={};return t.forEach(t=>{var e=this.app.create("button",t.name,t,a,i);r[t.name]=e,s[t.name]&&(e.setToggled(),e.setIcon(s[t.name].icon),e.setCommand(s[t.name].command),e.setTitle(s[t.name].title))}),r},_isHiddenButton(t,e){var s=this.app.block.get(),i={add:"addbar",html:"source",format:"format",line:"line",pre:"pre",quote:"quote",layout:"layouts",wrapper:"wrapper",table:"table",image:"image"};return void 0!==i[e]&&!this.opts.is(i[e])||!("trash"!==e||!s||!s.isType("noneditable")||this.opts.is("noneditable.remove"))||!("trash"!==e||!s||!s.isNondeletable())||!("trash"!==e&&"duplicate"!==e||!s||!s.isType("column"))},_getButtonObj(t){var e=this.opts.get("buttonsObj"),e=e[t]||!1;return!e&&this.app.ui.register[t]?this.app.ui.register[t]:e}});class v{constructor(t,e,s){this.ui=t,this.type=e,this.uuid=t.uuid,this.$container=s,this.build()}build(){this.$toolbar=new o("<div>").addClass("rx-"+this.type+" rx-"+this.type+"-"+this.uuid),this.$toolbarButtons=new o("<div>").addClass("rx-"+this.type+"-buttons"),this.$toolbarLine=new o("<div>").addClass("rx-"+this.type+"-line").hide(),this.$toolbar.append(this.$toolbarButtons),"context"===this.type&&this.$toolbar.append(this.$toolbarLine),this.$container.append(this.$toolbar),this.ui.addContainer(this.type,this.$toolbarButtons)}getElement(){return this.$toolbar}getElementLine(){return this.$toolbarLine}}d.add("tool","checkbox",{mixins:["tool"],type:"checkbox",input:{tag:"input",type:"checkbox",classname:"-form-checkbox"},getValue(){return this.$input.val()},_buildInput(){var t;this.$box=this.dom("<label>").addClass(this.prefix+"-form-checkbox-item"),this.$box.append(this.$input),this._has("text")&&(t=this.dom("<span>").html(this.lang.parse(this.obj.text)),this.$box.append(t)),this.$tool.append(this.$box)}}),d.add("tool","input",{mixins:["tool"],type:"input",input:{tag:"input",type:"text",classname:"-form-input"},_buildInput(){this.$tool.append(this.$input)}}),d.add("tool","number",{mixins:["tool"],type:"number",input:{tag:"input",type:"number",classname:"-form-input"},_buildInput(){this.$input.attr({min:0}).css("max-width","100px"),this.$tool.append(this.$input)}}),d.add("tool","segment",{mixins:["tool"],type:"segment",input:{tag:"input",type:"hidden",classname:"-form-input"},setValue(t){this.$segment.find("."+this.prefix+"-form-segment-item").removeClass("active"),this.$segment.find("[data-segment="+t+"]").addClass("active"),this.$input.val(t)},_buildInput(){this.$segment=this.dom("<div>").addClass(this.prefix+"-form-segment");var t,e,s=this.obj.segments;for([t,e]of Object.entries(s)){var i=this.dom("<span>").addClass(this.prefix+"-form-segment-item");i.attr("data-segment",t).on("click",this._catchSegment.bind(this)),e.icon?i.html(e.icon):i.html(e.name),this.$segment.append(i)}this.$segment.append(this.$input),this.$tool.append(this.$segment)},_catchSegment(t){t.preventDefault(),t.stopPropagation();var t=this.dom(t.target).closest("."+this.prefix+"-form-segment-item"),e=t.attr("data-segment");this.$segment.find("."+this.prefix+"-form-segment-item").removeClass("active"),t.addClass("active"),this.$input.val(e),this.app.api(this.setter,this.popup)}}),d.add("tool","select",{mixins:["tool"],type:"select",input:{tag:"select",classname:"-form-select"},_buildInput(){for(var t in this.obj.options){var e;this.obj.options.hasOwnProperty(t)&&((e=this.dom("<option>")).val(t),e.html(this.lang.parse(this.obj.options[t])),this.$input.append(e))}this.$tool.append(this.$input)}}),d.add("tool","textarea",{mixins:["tool"],type:"textarea",input:{tag:"textarea",classname:"-form-textarea"},setFocus(){this.$input.focus(),this.$input.get().setSelectionRange(0,0),this.$input.scrollTop(0)},_buildInput(){this._has("rows")&&this.$input.attr("rows",this._get("rows")),this.$input.attr("data-gramm_editor",!1),this.$tool.append(this.$input)}}),d.add("tool","upload",{mixins:["tool"],type:"upload",input:{tag:"input",type:"hidden",classname:"-form-input"},setValue(t){t=t||"",this.upload&&this.upload.setImage(t),this.$input.val(t)},_buildInput(){this.$tool.append(this.$input),this._buildUpload()},_buildUpload(){this.$upload=this.dom("<input>").attr("type","file"),this.$tool.append(this.$upload);var t={};this._has("trigger")&&this._get("trigger")&&(t={instance:this,method:"trigger"}),this.upload=this.app.create("upload",this.$upload,this.obj.upload,t)}}),d.add("tool","color",{mixins:["tool"],type:"color",input:{tag:"input",type:"text",classname:"-form-input"},setValue(t){this.$input.val(t=t||""),this.$toggle.css("background-color",t=""===t?"#ffffff":t)},_buildInput(){this.$item=this.dom('<div class="rx-form-color-container">'),this.$toggle=this.dom('<div class="rx-form-color-toggle">'),this.$item.append(this.$input),this.$item.append(this.$toggle),this.$input.on("keyup blur",this._changeColor.bind(this)),this.$toggle.on("click",this._toggleColorpicker.bind(this)),this.$tool.append(this.$item)},_changeColor(){var t=this.$input.val();5!==(t=this.app.create("utils").normalizeColor(t)).length&&3<t.length&&this.$toggle.css("background-color",t)},_setColor(t,e){e||this._closeColorpicker(),t=this.app.create("utils").normalizeColor(t),this.trigger(t)},_toggleColorpicker(t){var e;t.preventDefault(),t.stopPropagation(),this.$colorpicker?this._closeColorpicker():(t=this.getValue(),e=this.app.create("colorpicker"),this.$colorpicker=e.build({$toggle:this.$toggle,colors:this.opts.get("colors"),instant:!0,style:{color:t},method:function(t,e){this._setColor(t,e)}.bind(this)}),this.app.$doc.on("click.rx-colorpicker",this._closeColorpicker.bind(this)))},_closeColorpicker(){this.app.$body.find(".rx-colorpicker-"+this.uuid).remove(),this.app.scroll.getTarget().off(".rx-colorpicker"),this.app.$doc.off(".rx-colorpicker"),this.$colorpicker=!1}}),d.add("block","address",{mixins:["block"],props:{type:"address",editable:!0,inline:!1,control:{format:{position:{after:"add",first:!0}}}},defaults:{content:{getter:"getContent",setter:"setContent"}},create(){return this.dom("<address>")},handleDelete(t,e,s){if(s.is("backspace")&&this.isCaretEnd()&&this._removeEmptyBrTags())return t.preventDefault(),!0},handleEnter(t){if(t.preventDefault(),!this.isEmpty()&&!this.isCaretEnd()||!this._removeEmptyBrTags())return this._insertBreakline();this._insertAfterEmptyBlock()},_removeEmptyBrTags(){var t=this.$block.children(),e=t.length,t=t.eq(e-1),e=this.$block.html().trim();return!(!(e=this.app.create("utils").removeInvisibleChars(e)).endsWith("<br>")&&!e.endsWith("<br/>")||(t.remove(),0))},_insertAfterEmptyBlock(){this.insertEmpty({position:"after",caret:"start",type:"input"})},_insertBreakline(){return this.app.create("insertion").insertBreakline(),!0}}),d.add("block","dlist",{mixins:["block"],props:{type:"dlist",editable:!0,inline:!1,control:{format:{position:{after:"add",first:!0}}}},defaults:{items:{getter:"getItems"}},create(){return this.dom("<dl>").append(this.dom("<dt>").html("Term")).append(this.dom("<dd>").html("Description"))},build(){this._buildItems()},setCaret(t){var e=this.app.create("caret"),s="start"===t?this.getFirstItem():this.getLastItem();e.set(s,t)},getLastItem(){return this.$block.children().last()},getFirstItem(){return this.$block.children().first()},getItems(){const s=[];return this.$block.find("dt").each(t=>{var e=this.unparseInlineBlocks(t.clone()).html(),t=t.nextElement(),t=t&&t.tagName("dd")?this.unparseInlineBlocks(t.clone()).html():"";s.push({term:e,desc:t})}),s},handleEnter(t){t.preventDefault();var t=this.app.create("insertion"),e=this.app.create("selection"),s=this.app.create("utils"),i=this.app.create("caret"),e=this.dom(e.getBlock()),a=e.tagName();if(!i.is(e,"end")||this.isCaretEnd())return this.isEmpty()||this.isCaretEnd()?(s=s.isEmptyHtml(e.html()),"dt"===a&&s?(e.remove(),this.insertEmpty({position:"after",caret:"start",type:"input"})):this._insertCorrespondingTag(e,a,i)):this.isCaretStart()||t.insertBreakline(),!0;this._insertCorrespondingTag(e,a,i)},_insertCorrespondingTag(t,e,s){e=this.dom("dt"===e?"<dd>":"<dt>");t.after(e),s.set(e,"start")},_buildItems(){var t=this.data.get("items");t&&(this.$block.html(""),t.forEach(t=>{this.$block.append(this.dom("<dt>").html(t.term)),this.$block.append(this.dom("<dd>").html(t.desc))}))}}),d.add("block","embed",{mixins:["block"],parser:!1,props:{type:"embed",focusable:!0,editable:!1,inline:!1,control:{embed:{position:{after:"add"}}}},defaults:{content:{getter:"getContent",setter:"setContent"},caption:{getter:"getCaption",setter:"setCaption"},responsive:{getter:"getResponsive",setter:"setResponsive"}},start(){this.embedClassname=this.opts.get("embed.classname"),this.responsiveClassname=this.opts.get("embed.responsiveClassname")},create(){return this.dom("<figure>")},parse(){this.$embed=this.embedClassname?this.$block.find("."+this.embedClassname):this.$block;var t=0===this.$embed.length?this._initializeEmbed():this.$embed.html();this.parseCaption(),this.setContent(t),this._handleResponsive()},build(){this.$embed=this._createEmbed(),this._handleResponsive()},getContent(){return decodeURI(this.$block.attr("data-embed-content")).trim()},getCaption(){return this.figcaption?this.figcaption.getContent():null},getResponsive(){return this.$embed.hasClass(this.responsiveClassname)||null},getVideoTitle(){return this.$embed.find("video").attr("title")},getVideoPoster(){return this.$embed.find("video").attr("poster")},isResponsive(){return this.getResponsive()},setContent(t){t=t.trim(),this.$embed.html(t),this.$block.attr("data-embed-content",encodeURI(t))},setCaption(t){this.figcaption?this.figcaption.setContent(t):this._buildCaption(t)},setResponsive(t){t&&this.$embed.addClass(this.responsiveClassname)},_initializeEmbed(){var t=this.$block.find("figcaption"),e=this.$block.clone(),e=(e.find("figcaption").remove(),e.html());return this.$embed=this._createEmbed(),0!==t.length&&this.$block.append(t),e},_handleResponsive(){this.opts.is("embed.responsive")&&this.$embed.addClass(this.responsiveClassname)},_createEmbed(){var t;return this.embedClassname?(t=this.dom("<div>").addClass(this.embedClassname),this.$block.html(""),this.$block.append(t),t):this.$block}}),d.add("block","figcaption",{mixins:["block"],props:{type:"figcaption",editable:!0,inline:!1,control:!1},defaults:{content:{getter:"getContent",setter:"setContent"}},create(){return this.dom(this.opts.get("figcaption.template"))},parse(){this._buildPlaceholder()},build(){this._buildPlaceholder()},getFigure(){return this.$block.closest("figure").dataget("instance")},handleDelete(t,e,s){if(s.is("delete")&&this.isCaretEnd())return t.preventDefault(),!0},handleArrow(t,e,s){if(s.is("up-left")&&this.isCaretStart()||s.is("down-right")&&this.isCaretEnd())return t.preventDefault(),this.app.block.set(this.getFigure()),!0},handleTab(t){return t.preventDefault(),this.app.block.set(this.getFigure()),!0},handleEnter(t){return t.preventDefault(),this.isEmpty()||this.isCaretEnd()||this.isCaretStart()||this.app.create("insertion").insertBreakline(),!0},_buildPlaceholder(){this.$block.attr("data-placeholder")||this.setPlaceholder(this.lang.get("placeholders.figcaption"))}}),d.add("block","heading",{mixins:["block"],props:{type:"heading",editable:!0,inline:!1,control:{format:{position:{after:"add",first:!0}}}},defaults:{content:{getter:"getContent",setter:"setContent"},level:{getter:"getLevel",setter:"setLevel"}},create(){return this.dom("<h"+(this.data.get("level")||2)+">")},setLevel(t){var e=this.app.create("element");this.getLevel()!==Number(t)&&(this.$block=e.replaceToTag(this.$block,"h"+t))},getLevel(){return Number(this.getTag().replace("h",""))},handleEnter(t){return t.preventDefault(),this.isEmpty()||this.isCaretEnd()?this.insertEmpty({position:"after",caret:"start",remove:!1,type:"input"}):this.isCaretStart()?this.insert({instance:this.duplicateEmpty(),position:"before",type:"input"}):this.app.create("element").splitAtCaret(this.$block),!0}}),d.add("block","image",{mixins:["block"],props:{type:"image",focusable:!0,editable:!1,inline:!1,control:{image:{position:{after:"add"}},wrap:{position:{after:"image"}},outset:{position:{after:"image"}}}},defaults:{src:{getter:"getSrc",setter:"setSrc"},srcset:{getter:"getSrcset",setter:"setSrcset"},url:{getter:"getUrl",setter:"setUrl"},alt:{getter:"getAlt",setter:"setAlt"},width:{getter:"getWidth",setter:"setWidth"},height:{getter:"getHeight"},img:{getter:"getImageStyle"},target:{getter:"getTarget",setter:"setTarget"},caption:{getter:"getCaption",setter:"setCaption"},wrap:{getter:"getWrap"}},create(){return this.dom("<"+this.opts.get("image.tag")+">")},parse(){this._parseImage(),this._parseLink(),this.parseCaption()},build(){this._buildImageTag(),this._buildImage(),this._buildLink()},getSrc(){return this.$image.attr("src")},getAlt(){return this.$image.attr("alt")},getSrcset(){return this.$image.attr("srcset")},getUrl(){return this.$link?this.$link.attr("href"):null},getTarget(){return this.$link&&"_blank"===this.$link.attr("target")},getWrap(){var t=this.$block.tagName();return t===this.opts.get("image.tag")?null:t},getCaption(){return this.figcaption?this.figcaption.getContent():null},getWidth(){return this._getStyle("width")},getHeight(){return this._getStyle("height")},getImageStyle(){return this._getStyle()},getDataImage(){return this.$image.attr("data-image")},getImage(){return this.$image},setImage(t){this.$image.attr("src",t.url),t.id&&this.$image.attr("data-image",t.id),t.srcset&&this.$image.attr("srcset",t.srcset)},setAlt(t){this.$image.attr("alt",t.replace(/"/g,"'"))},setSrc(t){this.$image.attr("src",t)},setSrcset(t){this.$image.attr("srcset",t)},setWidth(t,e){var s,i;""!==(t=t?t.trim():"")?(t=(s=t.includes("%"))?t:parseInt(t),i=0!==this.$image.width()&&this.$image.width()/this.$image.height(),e=this._determineHeight(e,t,i),s?(this.$image.removeAttr("height"),this._setWidth(t)):(this._setWidth(t+"px"),this._setHeight(e))):this._resetImageDimensions(),this.app.create("cleaner").cacheElementStyle(this.$image),this.app.broadcast("image.position"),this.app.control.updatePosition()},setCaption(t){this.figcaption?this.figcaption.setContent(t):this._buildCaption(t)},setUrl(t){this.$link?""===t?(this.$link.unwrap(),this.$link=!1):this.$link.attr("href",t):""!==t&&this._createLink(t)},setTarget(t){this.$link&&(t&&""!==t?this.$link.attr("target","_blank"):this.$link.removeAttr("target"))},_determineHeight(t,e,s){return t=this.data.is("height")?!1===s?parseInt(this.data.get("height")):Math.round(e/s):!1!==s&&(t||Math.round(e/s))},_setWidth(t){this.$image.css({width:t}).attr({width:t.replace("px","")})},_setHeight(t){!1!==t&&this.$image.css({height:t+"px"}).attr({height:t})},_resetImageDimensions(){this.$image.removeAttr("width height"),this.$image.css({width:"",height:""}),""===this.$image.attr("style")&&this.$image.removeAttr("style")},_createLink(t){this.$link=this.dom("<a>"),this.$image.wrap(this.$link),this.$link.attr("href",t)},_getStyle(t){var e=this.app.create("utils").cssToObject(this.$image.attr("style"));return t?this._getStyleValue(e,t):this._getAllStyles(e)},_getStyleValue(t,e){t=t[e]?t[e].replace("px",""):this.$image.attr(e);return t||null},_getAllStyles(t){return 0<Object.keys(t).length?{style:t}:null},_parseImage(){var t=this.data.get("img");this.$image=this.$block.find("img"),t&&this._buildImageParams(t)},_parseLink(){var t=this.$block.find("a");0===t.closest("figcaption").length&&0!==t.length&&(this.$link=t)},_buildImageTag(){var t=this.getTag(),e=this.opts.get("image.tag"),s=this.data.get("wrap"),i=this.app.create("element");(t!==e||s&&t!==s)&&(this.$block=i.replaceToTag(this.$block,s||e,!0))},_buildImage(){var t=this.data.getValues();this.$image=this.dom("<img>"),this.$block.append(this.$image),this._buildImageParams(t)},_buildImageParams(e){["src","alt","srcset"].forEach(t=>{e.hasOwnProperty(t)&&this.$image.attr(t,e[t])}),e.img&&e.img.style&&this.$image.css(e.img.style)},_buildLink(){var t=this.data.getValues();t.url&&(this.$link=this.dom("<a>").attr("href",t.url),this.$image.wrap(this.$link),t.target)&&this.$link.attr("target","_blank")}}),d.add("block","wrapper",{mixins:["block"],nested:!0,props:{type:"wrapper",focusable:!0,inline:!1,control:{unwrap:{position:{after:"add"}}}},defaults:{wrap:{getter:"getWrap",setter:"setWrap"},children:{getter:"getChildren"}},create(){var t=this.dom(this.opts.get("wrapper.template"));return this.app.has("email")&&t.addClass("email-wrapper"),t},build(){this.params.children||this.fillEmpty()},parse(){this.app.has("email")&&this.$block.addClass("email-wrapper")},setCaret(t){var e=this.getFirstBlock();0!==e.length&&e.dataget("instance")?this.app.block.set(e,t):this._focusAndCollapseSelection()},setWrap(t){var e=this.app.create("element");this.$block=e.replaceToTag(this.$block,t)},getWrap(){var t=this.$block.tagName();return"div"===t?null:t},getFirstBlock(){return this.$block.children().first()},fillEmpty(){this.isEmpty()&&this.$block.append(this.app.block.create().getBlock())},_focusAndCollapseSelection(){const t=this.app.create("selection");this.app.scroll.save(),this.$block.attr("tabindex","-1").focus(),t.collapse(),setTimeout(()=>t.remove(),1),this.app.scroll.restore()}}),d.add("block","layout",{mixins:["block"],nested:!0,props:{type:"layout",focusable:!0,inline:!1,control:{unwrap:{position:{after:"add"}}}},defaults:{children:{getter:"getChildren"}},create(){var t=this.opts.get("layout.grid"),e=this.dom("<div>");return t?e.addClass(t):e.attr(this.opts.get("dataBlock"),"layout").addClass("rx-layout-grid")},parse(){var t=this.opts.get("layout.grid"),e=this.opts.get("layout.column");t?this._handleGridSetup(e):this.$block.addClass("rx-layout-grid")},build(){this.params.children||(this.params.pattern?this._buildFromPattern():(this._createAndAppendColumn("50%"),this._createAndAppendColumn("50%")))},setCaret(t){var e="start"===t?this.getFirstBlock():this.getLastBlock();this.app.block.set(e,t)},getFirstBlock(){return this.getFirstColumn().children().first()},getLastBlock(){return this.getLastColumn().children().last()},getFirstColumn(){return this.$block.find("[data-rx-type=column]").first()},getLastColumn(){return this.$block.find("[data-rx-type=column]").last()},getColumns(){return this.$block.find("[data-rx-type=column]").map(t=>this.dom(t).dataget("instance"))},_handleGridSetup(t){t||(this.$block.children().each(t=>{this.app.create("block.column",t)}),this.app.create("predefined").parse(this.$block))},_buildFromPattern(){var t=this.params.pattern.split("|");this.params.grid&&this.$block.addClass(this.params.grid),t.forEach(t=>{t=this._parsePatternPart(t),t=this.app.create("block.column",t);this.$block.append(t.getBlock())})},_parsePatternPart(t){return t.includes("%")?{width:t}:"-"!==t?{classname:t}:{}},_createAndAppendColumn(t){t=this.app.create("block.column",{width:t});this.$block.append(t.getBlock())}}),d.add("block","column",{mixins:["block"],nested:!0,props:{type:"column",focusable:!0,inline:!1},defaults:{children:{getter:"getChildren"},width:{getter:"getWidth",setter:"setWidth"}},create(){var t=this.opts.get("layout.grid"),e=this.opts.get("layout.column"),s=this.dom("<div>");return t&&!e?s:e?s.addClass(e):s.attr(this.opts.get("dataBlock"),"column")},build(){var t;!this.params.children&&this.isEmpty()&&(t=this.app.block.create(),this.$block.append(t.getBlock()))},getFirstBlock(){return this.$block.children().first()},getLastBlock(){return this.$block.children().last()},getFirstBlockInstance(){return this.getFirstBlock().dataget("instance")},getLastBlockInstance(){return this.getLastBlock().dataget("instance")},isLastElement(){return 0===this.$block.nextElement().length},setWidth(t){this.opts.get("layout.grid")||this.$block.css("flex-basis",t)},getWidth(){return this.opts.get("layout.grid")?null:this.$block.css("flex-basis")}}),d.add("block","line",{mixins:["block"],props:{type:"line",focusable:!0,editable:!1,inline:!1},create(){return this.dom(this.opts.get("line.template"))}}),d.add("block","list",{mixins:["block"],props:{type:"list",focusable:!0,inline:!1,control:{format:{position:{after:"add",first:!0}}}},defaults:{numbered:{getter:"getNumbered"},items:{getter:"getItems"}},create(){return this.dom(`<${this._createTag()}>`).append(this.dom("<li>"))},parse(){this.parseItems("ul, ol","list"),this.parseItems("li","listitem")},build(){this._buildItems(),this.parseItems("ul, ol","list"),this.parseItems("li","listitem")},setCaret(t){var e="start"===t?this.getFirstItem():this.getLastItem();this.app.block.set(e,t)},getFirstItem(){return this.$block.find("li").first()},getFirstItemInstance(){return this.getFirstItem().dataget("instance")},getLastItem(){return this.$block.find("li").last()},getLastItemInstance(){return this.getLastItem().dataget("instance")},getNumbered(){return"ol"===this.getTag()},getItems(){return this.$block.children().getAll().map(t=>this.dom(t).dataget("instance").getContent())},_createTag(){return this.data.get("numbered")?"ol":"ul"},_buildItems(){var t=this.data.get("items");t&&(this.$block.empty(),t.forEach(t=>this.$block.append(this.dom("<li>").html(t))))}}),d.add("block","listitem",{mixins:["block"],props:{type:"listitem",editable:!0,inline:!1,control:{format:{position:{after:"add",first:!0}}}},defaults:{content:{getter:"getContent",setter:"setContent"}},create(){return this.dom("<li>")},isListEnd(){return this.getParent().isCaretEnd()},isFirstElement(){return 0===this.$block.prevElement().length},isLastElement(){return 0===this.$block.nextElement().length},hasParentList(){return 0!==this.$block.parent().closest("li").length},hasChild(){return 0!==this.$block.find("ul, ol").length},getChild(){return this.$block.find("ul, ol").first()},getParentTop(){return this.$block.parents("ul, ol").last()},getParentTopInstance(){return this.getParentTop().dataget("instance")},getParentItem(){return this.$block.parent().closest("li").dataget("instance")},getParent(){return this.$block.parent().closest(this._buildTraverseSelector("list")).dataget("instance")},getContent(t=!1){let e=this.$block.clone();return t?e.find("ul, ol").remove():e.find("ul, ol").before("<br>").unwrap(),(e=this.unparseInlineBlocks(e)).html().replace(/<\/?li[^>]*>/g,"\n").replace(/\s\s+/g," ").replace(/\t/g,"").trim()},handleArrow(t,e,s){return s.is("up-left")?this._traverse("prev",t,s):s.is("down-right")?this._traverse("next",t,s):void 0},handleDelete(t,e,s){return s.is("backspace")&&this.isCaretStart()&&this.isFirstElement()&&!this.hasParentList()?(t.preventDefault(),this._handleBackspaceDelete(),!0):s.is("delete")&&this.isListEnd()&&!this.hasParentList()?(t.preventDefault(),this._handleForwardDelete(),!0):void setTimeout(()=>{this.$block.find("span").not("[data-rx-style-cache]").unwrap(),this.$block.get().normalize()},0)},handleTab(t){if(!this.opts.is("tab.spaces")||this.isCaretStart())return t.preventDefault(),this.app.list.indent(),!0},handleEnter(t){t.preventDefault();t=this.app.create("caret").is(this.$block,"end",["ul","ol"]);return this.hasChild()&&t?this._handleEnterWithChildAtEnd():this.isEmpty()||this.isCaretEnd()?this._handleEnterAtEmptyOrEnd():this.isCaretStart()?this._handleEnterAtStart():this._handleEnterInMiddle(),this.app.observer.observe(),!0},_handleEnterWithChildAtEnd(){var t=this.app.create("utils"),e=this.getChild(),s=this._createItem(),i=e.clone();e.remove(),this.app.block.set(s,"start"),s.getBlock().append(t.createInvisibleChar()),s.getBlock().append(i)},_handleEnterAtEmptyOrEnd(){var t,e=this.app.create("selection").getBlockControlled(),e=!!e&&this.dom(e).dataget("instance");e&&!this.hasParentList()&&e.isEmpty()?(t=this.isListEnd()?"after":"split",this.getParent().insertEmpty({position:t,caret:"start",type:"input"}),e.remove()):(t=this._createItem(),this.app.block.set(t,"start"),this.app.broadcast("list.item",{instance:t}))},_handleEnterAtStart(){this._createItem("before"),this.app.block.set(this)},_handleEnterInMiddle(){var t=this.app.create("element").split(this.$block),e=this._createItem();e.setContent(t.html()),t.remove(),this.app.block.set(e,"start"),this.app.broadcast("list.item",{instance:e})},_handleBackspaceDelete(){var t=this.getParent(),e=this.getContent(),e=this.app.block.create(e);this.remove(),t.getBlock().before(e.getBlock()),this.app.block.set(e,"start")},_handleForwardDelete(){var t,e,s=this.getParent().getNext();s&&(s.isType("quote")?(e=s.getBlock().text(),this._insertHtml(e),s.remove()):s.isEditable()?(e=s.getHtml(),this._insertHtml(e),s.remove()):s.isType("todo")?(e=s.getFirstItem(),t=s.getFirstContent().html(),e.remove(),this._insertHtml(t),s.isEmpty()&&s.remove()):s.isType("list")?(e=s.getBlock().children(),this.$block.append(e),s.remove()):this.app.block.set(s,"start"))},_traverse(s,i,t){var a="prev"===s?!this.isFirstElement()||!this.isCaretStart():!this.isLastElement()||!this.isCaretEnd();if(!a){i.preventDefault();let t=this.getParent();a="prev"===s?"getPrev":"getNext";let e=(t=this.hasParentList()?this.getParentItem():t)[a]();return(e=e||t[a+"Parent"]())?this.app.block.set(e,"prev"===s?"end":"start"):(this.app.block.set(t),"prev"===s&&this.app.create("caret").set(t.getChild(),"before")),!0}},_createItem(t){var e=this.app.create("block.listitem");return this.$block[t=t||"after"](e.getBlock()),e}}),d.add("block","noneditable",{mixins:["block"],parser:!1,props:{type:"noneditable",focusable:!0,editable:!1,inline:!1},defaults:{content:{getter:"getContent",setter:"setContent"}},create(){return this.dom("<div>").attr(this.opts.get("dataBlock"),"noneditable")},handleDelete(t,e,s){if(!this.opts.is("noneditable.remove")&&(s.is("delete")||s.is("backspace")))return t.preventDefault(),!0}}),d.add("block","pre",{mixins:["block"],props:{type:"pre",editable:!0,inline:!1,control:{format:{position:{after:"add",first:!0}}}},defaults:{content:{getter:"getContent",setter:"setContent"},caption:{getter:"getCaption",setter:"setCaption"}},create(){return this.dom(this.opts.get("pre.template"))},parse(){this.parseCaption()},getPlainText(){return this._getPlainText(this._getCodeElement())},getContent(){return this._getCodeElement().html().trim()},getCaption(){return this.figcaption?this.figcaption.getContent():null},setContent(t){this._getCodeElement().html(t)},setCaption(t){this.figcaption?this.figcaption.setContent(t):this._buildCaption(t)},setCaret(t){this.app.create("caret").set(this._getCodeElement(),t)},handleArrow(t,e,s){if(!this.getNext()&&this.isCaretEnd()&&s.is("down"))return t.preventDefault(),s=this.app.block.create(),this.insert({instance:s,position:"after",caret:"start",remove:!1,type:"input"}),!0},handleTab(t){return t.preventDefault(),this._insertSpaces(this.opts.get("pre.spaces")),!0},handleEnter(t){return t.preventDefault(),this._insertNewlineIfNeeded(),!0},_insertNewlineIfNeeded(){var t=this.$block.html().search(/\n$/),e=this.app.create("insertion");this.isCaretEnd()&&-1===t?e.insertNewline("after",!0):e.insertNewline()},_insertSpaces(t){t=document.createTextNode(" ".repeat(t));this.app.create("insertion").insertNode(t,"end"),this._fixDoubleNewlines()},_fixDoubleNewlines(){var t=this.app.create("selection").getCurrent().previousSibling,e=t&&t.textContent;e&&-1!==e.search(/\n\n/g)&&(t.textContent=e.replace(/\n\n/g,"\n"))},_getCodeElement(){var t=this.$block.find("code"),e=this.$block.find("pre");return t.length?t:e.length?e:this.$block}}),d.add("block","quote",{mixins:["block"],props:{type:"quote",editable:!0,inline:!1,control:{format:{position:{after:"add",first:!0}}}},defaults:{content:{getter:"getContent",setter:"setContent"},caption:{getter:"getCaption",setter:"setCaption"}},create(){return this.dom(this.opts.get("quote.template"))},parse(){this._parseItem(),this._parseCaption()},build(){this._parseItem(),this._parseCaption()},isEmpty(t){return this._isEmpty(this.getCurrentItem(),t)},getPlaceholder(){return this.getItem().attr("data-placeholder")},getCurrentItem(){var t=this.app.create("selection");return this._isCaption(t.getParent())?this.$quotecaption:this.$quoteitem},getItem(){return this.$quoteitem},setCaret(t){this.app.create("caret").set(this.$quoteitem,t)},setContent(t){this.$quoteitem.html(t)},setEmpty(){this.getCurrentItem().html("")},setPlaceholder(t){this._setAttr(this.getItem(),"data-placeholder",t)},setCaption(t){this.$quotecaption.html(t)},getContent(){return this.$quoteitem.html()},getCaption(){return this.$quotecaption?this.$quotecaption.html():null},handleDelete(t,e,s){var i=this.app.create("caret"),a=this.app.create("selection"),r=this.app.create("utils"),o=this._getItemFromSelection(a),a=this._getCaptionFromSelection(a),n=this.dom(a),l=this.getPrev();if(s.is("backspace")&&this._isCaption(a)&&i.is(a,"start")){if(r.isEmptyHtml(n.html())&&!n.attr("data-placehoder"))return t.preventDefault(),this.$quotecaption.remove(),!0;t.preventDefault(),this.$quotecaption.find("br").remove()}else s.is("delete")&&this._isCaption(a)&&i.is(a,"end")||s.is("delete")&&this._isItem(o)&&i.is(o,"end")?t.preventDefault():s.is("backspace")&&this._isItem(o)&&i.is(o,"start")&&l&&l.isEditable()&&(t.preventDefault(),this.app.block.set(l,"end"),this._insertHtml(this.getPlainText()),this.remove());return!0},handleArrow(t,e,s){if(!this.getNext()&&this.isCaretEnd()&&s.is("down"))return t.preventDefault(),this._createNewInputAfter(),!0},handleEnter(t){t.preventDefault();var e=this.app.create("selection"),s=this.app.create("insertion"),i=this.app.create("caret"),e=this._getCaptionFromSelection(e),i=i.is(e,"end");return this._isCaption(e)?i?(t.preventDefault(),this._createNewInputAfter()):this.$quotecaption.tagName("cite")&&s.insertBreakline(!1,!1):s.insertBreakline(),!0},_createNewInputAfter(){var t=this.app.block.create();this.insert({instance:t,position:"after",caret:"start",remove:!1,type:"input"})},_isCaption(t){return t&&this.$quotecaption&&t===this.$quotecaption.get()},_isItem(t){return t&&t===this.$quoteitem.get()},_getItemFromSelection(t){return t.getBlock()},_getCaptionFromSelection(t){return this.$quotecaption&&this.$quotecaption.tagName("cite")?t.getClosest("cite"):t.getParent()},_parseItem(){this.$quoteitem=this.$block.find("p").first()},_parseCaption(){var t=this.isFigure()?this.$block.find("figcaption"):this.$block.find("p").last(),e=t.find("cite");this.$quotecaption=e.length?e:!!t.length&&t}}),d.add("block","table",{mixins:["block"],nested:"td, th",props:{type:"table",focusable:!0,inline:!1,control:{table:{position:{after:"add"}}}},defaults:{head:{getter:"getHead"},foot:{getter:"getFoot"},items:{getter:"getItems"}},create(){return this.dom(this.opts.get("table.template"))},build(){this._buildItems(),this._parseAndBuild(),this.fillEmpty()},parse(){this._parseAndBuild()},setCaret(t){var e="start"===t?this.getFirstBlock():this.getLastBlock();this.app.block.set(e,t)},getFirstBlock(){return this.getFirstCell().children().first()},getFirstCell(){return this.$block.find("th, td").first()},getLastBlock(){return this.getLastCell().children().last()},getLastCell(){return this.$block.find("th, td").last()},getRows(){return this.$block.find("tr")},getCells(){return this.$block.find("th, td")},getHead(){return 0<this.$block.find("thead").length},getFoot(){return 0<this.$block.find("tfoot").length},getItems(){const s=this.opts.get("tags.block").join(",");var t=this.$block.find("tr");let i=[];return t.each(t=>{let e=[];t.find("th, td").each(t=>{t=t.clone(),(t=this.unparseInlineBlocks(t)).find(s).unwrap(),e.push(t.html().trim())}),i.push(e)}),i},fillEmpty(){this.getCells().each(function(t){var e;t.dataget("instance").isEmpty()&&(e=this.app.block.create(),t.append(e.getBlock()))}.bind(this))},_parseAndBuild(){this._buildNowrap(),this.parseItems("tr","row"),this.parseItems("td, th","cell")},_buildItems(){var t=this.data.get("items");if(t){const r=this.data.get("head"),s=this.data.get("foot"),o=t.length,n=r?this.dom("<thead>"):null,l=this.dom("<tbody>"),h=s?this.dom("<tfoot>"):null;t.forEach((t,e)=>{const i=0===e;e=e===o-1;const a=this.dom("<tr>");(i&&r?n:e&&s?h:l).append(a),t.forEach(t=>{var e=i&&r?"th":"td",e=this.dom(`<${e}>`),s=this.app.create("block.text",{table:!0});s.getBlock().html(t),e.append(s.getBlock()),a.append(e)})}),this.$block.empty(),r&&this.$block.append(n),this.$block.append(l),s&&this.$block.append(h)}},_buildNowrap(){var t=this.opts.get("table.nowrap");this.$block.find("th, td").filter("."+t).addClass("rx-nowrap")}}),d.add("block","cell",{mixins:["block"],props:{type:"cell",inline:!1,focusable:!0,reorder:!1},defaults:{content:{getter:"getContent",setter:"setContent"},width:{getter:"getWidth",setter:"setWidth"},nowrap:{getter:"getNowrap",setter:"setNowrap"}},create(){return this.dom("<td>")},getTable(){return this.getClosest("table")},getRow(){return this.getClosest("row")},getNextCell(){return this._getSiblingCell("getNext","getNextRow","getFirst")},getPrevCell(){return this._getSiblingCell("getPrev","getPrevRow","getLast")},getFirstElement(){return this.$block.find("[data-rx-type]").first()},getWidth(){return this.$block.attr("width")||""},getNowrap(){return this.$block.hasClass("rx-nowrap")},setWidth(e){this._applyToEachCell(t=>{(e=e.endsWith("%")?e:e.replace("px",""))?t.attr("width",e):t.removeAttr("width")})},setNowrap(e){const s=this.opts.get("table.nowrap")+" rx-nowrap";this._applyToEachCell(t=>e?t.addClass(s):t.removeClass(s))},setEmpty(){var t=this.app.block.create();this.$block.html(""),this.$block.append(t.getBlock())},setCaret(t){this.app.create("caret").set(this.getFirstElement(),t)},isLastElement(){var t=this.getTable().getBlock().find("th, td").last();return this.$block.get()===t.get()},handleTab(t){t.preventDefault();t=this.getNextCell()||this.getClosest("table").getNext();return t&&this.app.block.set(t,"start"),!0},_getSiblingCell(t,e,s){let i=this[t]();return i||(t=(t=this.getRow())&&t[e](),i=t&&t[s]("cell")),i},_applyToEachCell(s){const i=this._getCellIndex();this.getTable().getBlock().find("tr").each((t,e)=>{t=this.dom(t.get().cells[i]);s(t)})},_getCellIndex(){var t=this.$block.closest("tr").find("td, th").getAll();return Array.from(t).indexOf(this.$block.get())}}),d.add("block","row",{mixins:["block"],props:{type:"row",inline:!1,focusable:!0,control:!1},create(){return this.dom("<tr>")},setCaret(t){this.app.create("caret").set(this.getFirstElement(),t)},getTable(){return this.getClosest("table")},getFirstElement(){return this.$block.find("td, th").first().find("[data-rx-type]").first()},getLastElement(){return this.$block.find("td, th").last().find("[data-rx-type]").first()},getNextRow(){return this._getAdjacentRow("next")},getPrevRow(){return this._getAdjacentRow("prev")},_getAdjacentRow(t){let e=this["next"===t?"getNext":"getPrev"]();var s=this.$block.parent();return e=e||s.tagName("table")?e:s["next"===t?"nextElement":"prevElement"]().find("tr")["next"===t?"first":"last"]().dataget("instance")}}),d.add("block","text",{mixins:["block"],props:{type:"text",editable:!0,inline:!1,control:{format:{position:{after:"add",first:!0}}}},defaults:{content:{getter:"getContent",setter:"setContent"}},create(){return this.params.table?this.dom('<div data-rx-tag="tbr">'):this.opts.is("breakline")?this.dom('<div data-rx-tag="br">'):this.dom(`<${this.opts.get("markup")}>`)},handleEnter(t){t.preventDefault();let e;var s;return this.isEmpty()||this.isCaretEnd()?(e=this._createNewBlockForEnter(),this.insert({instance:e,position:"after",caret:"start",remove:!1,type:"input"})):this.isCaretStart()?(e=this.duplicateEmpty(),this.insert({instance:e,position:"before",type:"input"})):(t=this.app.create("element"),s=this.getBlock(),t=t.split(s),this.app.block.set(t,"start")),!0},_createNewBlockForEnter(){let t="tbr"===this.$block.attr("data-rx-tag")?this.app.create("block.text",{table:!0}):this.app.block.create();return this.opts.is("clean.enter")||(t=this.duplicateEmpty()).getBlock().removeAttr("id"),t=this.opts.is("clean.enterinline")?this._cloneInline(t):t},_cloneInline(t){var e=this.app.create("selection"),i=this.app.create("element"),e=e.getInline();if(e){i=i.getInlines(e);let s=null;i.forEach((t,e)=>{"A"!==t.tagName&&((t=t.cloneNode()).removeAttribute("id"),t.innerHTML="",s=0===e?t:s.appendChild(t))}),s&&(t=this.app.block.create(s.outerHTML))}return t}}),d.add("block","todo",{mixins:["block"],props:{type:"todo",focusable:!0,inline:!1,control:{format:{position:{after:"add",first:!0}}}},defaults:{items:{getter:"getItems"}},create(){var t,e=this.dom("<ul>");return this.data.get("items")||(t=this.app.create("block.todoitem"),e.append(t.getBlock())),e},parse(){this.parseItems("li","todoitem")},build(){this._buildItems(),this.parseItems("li","todoitem")},setCaret(t){var e="start"===t?this.getFirstItem():this.getLastItem();this.app.block.set(e,t)},getItems(){return this.$block.css("border","5px solid red"),this.$block.children().getAll().map(t=>{t=this.dom(t).dataget("instance");return{content:t.getContent(),checked:t.getChecked()}})},getFirstItem(){return this.$block.children().first()},getFirstItemInstance(){return this.getFirstItem().dataget("instance")},getFirstContent(){return this.getFirstItem().find("div").first()},getLastItem(){return this.$block.children().last()},getLastItemInstance(){return this.getLastItem().dataget("instance")},getLastContent(){var t=this.app.create("utils").findTodoItemTag();return this.getLastItem().find(t).last()},_buildItems(){var t=this.data.get("items");t&&t.forEach(t=>{t=this.app.create("block.todoitem",t);this.$block.append(t.getBlock())})}}),d.add("block","todoitem",{mixins:["block"],props:{type:"todoitem",inline:!1,editable:!0,control:{format:{position:{after:"add",first:!0}}}},defaults:{content:{setter:"setContent",getter:"getContent"},checked:{setter:"setChecked",getter:"getChecked"}},create(){return this.dom("<li>")},parse(){this._parse()},build(){this.$block.html(this.opts.get("todo.templateItem")),this._parse()},setCaret(t){this.app.create("caret").set(this.$content,t)},isFirstElement(){return 0===this.$block.prevElement().length},isLastElement(){return 0===this.$block.nextElement().length},isListEnd(){return this.getParent().isCaretEnd()},getContentItem(){return this.$content},getParent(){return this.$block.parent().closest(this._buildTraverseSelector("todo")).dataget("instance")},getContent(){return this.unparseInlineBlocks(this.$content.clone()).html().trim()},getChecked(){return"1"===this.$block.attr("data-checked")},setContent(t){this.$content.html(t)},setChecked(t){this.$input.attr("checked",t),this.$block.attr("data-checked",t?"1":"0")},setPlaceholder(t){this.$content.attr("data-placeholder",t)},setEmpty(){this.$content.html("")},handleArrow(t,e,s){return s.is("left")&&this.isCaretStart()||s.is("up")?this._traverse(t,"prev"):s.is("right")&&this.isCaretEnd()||s.is("down")?this._traverse(t,"next"):void 0},handleDelete(t,e,s){return s.is("delete")?this._handleDeleteForward(t):s.is("backspace")?this._handleDeleteBackward(t):void 0},handleTab(t){return this._traverse(t,"next")},handleEnter(t){return t.preventDefault(),this.isEmpty()||this.isCaretEnd()?this._handleEmptyOrEnd():this.isCaretStart()?this._createAndSetItem("before"):this._handleContentSplit(),!0},_handleDeleteForward(t){let e=this.getNext();var s=this.getParent();return this.isCaretEnd()&&e&&e.isType("todoitem")?(t.preventDefault(),this._insertItem("delete",e),!0):this.isCaretEnd()&&this.isLastElement()&&(e=this.getNextParent())?(t.preventDefault(),e.isType("quote")?(t=e.getBlock().text(),this._insertHtml(t,!1),e.remove()):e.isEditable()?(t=e.getHtml(),this._insertHtml(t,!1),e.remove()):e.isType("todo")?(t=e.getBlock().children(),s.getBlock().append(t),e.remove()):e.isType("list")?(t=(s=e.getBlock().children().first()).html(),s.remove(),this._insertHtml(t,!1),e.isEmpty()&&e.remove()):this.app.block.set(e,"start"),!0):void 0},_handleDeleteBackward(t){var e=this.getNext(),s=this.getPrev(),i=this.getParent();return this.isCaretStart()&&s&&s.isType("todoitem")?(t.preventDefault(),this._insertItem("backspace",s),!0):this.isCaretStart()&&this.isFirstElement()&&(e=this.getPrevParent())?(t.preventDefault(),e.isEditable()?(s=this.getContent(),this.app.block.set(e,"end"),this._insertHtml(s),this.remove(),i.isEmpty()&&i.remove()):e.isType("todo")?(t=i.getBlock().children(),e.getBlock().append(t),this.app.block.set(t.first(),"start",!0),i.remove()):e.isType("list")?(s=this.getContent(),t=e.getLastItem(),this.app.block.set(t,"end"),this._insertHtml(s),this.remove(),i.isEmpty()&&i.remove()):this.app.block.set(e,"start"),!0):void 0},_insertItem(t,e){let s;"delete"===t?(s=e.getPlainText(),e.remove()):(s=this.getPlainText(),this.remove(),this.app.block.set(e,"end")),this._insertHtml(s,!1)},_handleEmptyOrEnd(){var t=this.app.create("selection").getBlockControlled(),t=!!t&&this.dom(t).dataget("instance");t&&this.isListEnd()&&t.isEmpty()?(this.getParent().insertEmpty({position:"after",caret:"start",type:"input"}),t.remove()):this._createAndSetItem()},_handleContentSplit(){var t=this.app.create("element").split(this.$content),e=this._createItem();e.setContent(t.html()),t.remove(),this.app.block.set(e,"start")},_createAndSetItem(t="after"){t=this._createItem(t);this.app.block.set(t,"start")},_traverse(t,e){t.preventDefault();var t="next"===e,e=t?"getNext":"getPrev",s=t?"getNextParent":"getPrevParent",i=t?"start":"end",t=this[t?"isLastElement":"isFirstElement"]()?this.getParent():this,e=t[e]();if(!e&&!(e=t[s]()))return!0;this.app.block.set(e,i)},_createItem(t){var e=this.app.create("block.todoitem");return this.$block[t=t||"after"](e.getBlock()),e},_parse(){let t=this.$block.html();var e=this.$block.attr("data-placeholder"),s=this.opts.get("todo.templateItem"),i=this.opts.get("todo.templateItemDone"),a=this.$block.find("input"),r=this.app.create("utils").findTodoItemTag(),r=this.$block.find(r),e=(this.$input=0!==a.length?a:this.dom(this.opts.get("todo.templateInput")),this.$input.attr("tabindex","-1"),this.$content=0!==r.length?r:this.dom(this.opts.get("todo.templateContent")),this.$content.attr("contenteditable",!0),e&&this.setPlaceholder(e),this.opts.get("todo.template"));e&&(t=this._extractCheckboxContent(t,s,i)),this._updateItemState(t,a,r,s,i),this._appendNewElements(a,r),this.$input.on("click.rx-todo",this._clickInput.bind(this)),this.$input.on("pointerdown.rx-todo",this._clickInput.bind(this))},_updateItemState(t,e,s,i,a){var r=i.replace(/\s/g,"");t.startsWith(a)?(t=t.replace(a,""),this._setAttributes(!0,"1")):(t.startsWith(r)||t.startsWith(i))&&(t=t.replace(t.startsWith(r)?r:i,""),this._setAttributes(!1,"0")),0===e.length&&0===s.length&&(t=t.trim(),this.$content.html(t),this.$block.html(""))},_setAttributes(t,e){this.$input.attr("checked",t),this.$block.attr("data-checked",e)},_appendNewElements(t,e){0===t.length&&this.$block.append(this.$input),0===e.length&&this.$block.append(this.$content)},_clickInput(t){t.preventDefault(),t.stopPropagation(),this.app.event.isPaused()||(this.$input.get().checked=!this.$input.get().checked,this.app.block.set(this.$block),t=this.$input.attr("checked")?"1":"0",this.$block.attr("data-checked",t))},_extractCheckboxContent(t,e,s){var i=this.app.create("utils"),a=document.createElement("div"),a=(a.innerHTML=t,a.textContent||""),e=i.escapeRegExp(e),i=i.escapeRegExp(s),s=new RegExp("("+e+"|"+i+")\\s*(.*)","g").exec(a);return s?s[0].trim():t}}),d.add("block","mergetag",{mixins:["block"],props:{type:"mergetag",editable:!1,control:!1,inline:!0,context:!0},defaults:{content:{getter:"getContent",setter:"setContent"}},create(){return this.dom("<span>").attr(this.opts.get("dataBlock"),"mergetag")}}),window.Redactor=d,window.addEventListener("load",function(){d("[data-redactor]")}),"object"==typeof module&&module.exports&&(module.exports=d,module.exports.Redactor=d)}();
export default Redactor;